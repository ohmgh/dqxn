---
phase: 09-themes-demo-chaos
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/pack/themes/build.gradle.kts
  - android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemeFileParser.kt
  - android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemesPackThemeProvider.kt
  - android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemesThemeModule.kt
  - android/pack/themes/src/main/resources/themes/*.theme.json
  - android/pack/themes/src/test/kotlin/app/dqxn/android/pack/themes/ThemesPackThemeProviderTest.kt
  - android/pack/themes/src/test/kotlin/app/dqxn/android/pack/themes/ThemeJsonValidationTest.kt
autonomous: true
requirements: [F6.1, F6.2, F6.3, F6.4]

must_haves:
  truths:
    - "22 premium themes load without error from JSON resource files"
    - "All 22 themes are gated behind the 'themes' entitlement"
    - "Each theme has valid hex colors and gradient stops in [0.0, 1.0] range"
    - "Themes pack compiles with dqxn.pack plugin and no :core:* dependencies"
  artifacts:
    - path: "android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemesPackThemeProvider.kt"
      provides: "ThemeProvider implementation loading 22 themes from JSON"
      contains: "ThemeProvider"
    - path: "android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemeFileParser.kt"
      provides: "Pack-local JSON parser (cannot use :core:design ThemeJsonParser)"
      contains: "parseHexColor"
    - path: "android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemesThemeModule.kt"
      provides: "Hilt @Binds @IntoSet for ThemeProvider"
      contains: "IntoSet"
    - path: "android/pack/themes/src/test/kotlin/app/dqxn/android/pack/themes/ThemeJsonValidationTest.kt"
      provides: "Per-file structural validation for all 22 JSON files"
  key_links:
    - from: "ThemesPackThemeProvider"
      to: "ThemeFileParser"
      via: "pack-local JSON parsing"
      pattern: "parseThemeJson"
    - from: "ThemesThemeModule"
      to: "ThemesPackThemeProvider"
      via: "Hilt @Binds @IntoSet ThemeProvider"
      pattern: "IntoSet.*ThemeProvider"
---

<objective>
Create the themes pack with 22 premium themes loaded from JSON resource files. Each theme is gated behind the `themes` entitlement.

Purpose: Delivers F6.1 (22 premium themes), F6.2 (themes entitlement gates Theme Studio access), F6.3/F6.4 (SOLAR_AUTO/ILLUMINANCE_AUTO entitlement gating -- modes already exist in ThemeAutoSwitchEngine, phase 9 only needs entitlement gating on themes themselves).

Output: `:pack:themes` module with ThemesPackThemeProvider, 22 migrated JSON files, pack-local parser, Hilt module, and comprehensive tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-themes-demo-chaos/09-RESEARCH.md
@android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/theme/EssentialsThemeProvider.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeJsonParser.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeSchema.kt
@android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate 22 theme JSON files + create pack-local parser</name>
  <files>
    android/pack/themes/build.gradle.kts
    android/pack/themes/src/main/resources/themes/*.theme.json (22 files)
    android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemeFileParser.kt
  </files>
  <action>
    **1. Update build.gradle.kts** to add `kotlinx.serialization` plugin and dependency:
    ```kotlin
    plugins {
      id("dqxn.pack")
      alias(libs.plugins.kotlin.serialization)
    }
    android { namespace = "app.dqxn.android.pack.themes" }
    dependencies {
      implementation(libs.kotlinx.serialization.json)
    }
    ```

    **2. Copy and migrate all 22 theme JSON files** from the old codebase at `/Users/ohm/Workspace/dqxn.old/android/feature/packs/themes/src/main/resources/themes/` to `android/pack/themes/src/main/resources/themes/`.

    The old format has:
    - `colors.highlight` and `colors.widgetBorder` (not in new schema)
    - `gradients.background.stops` as simple string arrays (e.g., `["#0F0C29", "#302B63", "#24243E"]`)
    - `defaults.backgroundStyle` and `defaults.glowEffect`

    The new format needs:
    - `colors.background`, `colors.surface`, `colors.onSurface` (derived from old gradient stops)
    - `backgroundGradient.stops` as objects: `[{"color": "#FF0F0C29", "position": 0.0}, ...]`
    - Old `highlight` preserved as separate optional field
    - Gradient stops get evenly distributed positions (2 stops = 0.0/1.0, 3 stops = 0.0/0.5/1.0, etc.)
    - All colors must be `#AARRGGBB` or `#RRGGBB` format

    Migration mapping for each theme JSON:
    - `colors.primary` → `colors.primary` (unchanged)
    - `colors.secondary` → `colors.secondary` (unchanged)
    - `colors.accent` → `colors.accent` (unchanged)
    - `colors.highlight` → `colors.highlight` (new optional field for pack-local schema)
    - `colors.widgetBorder` → `colors.onSurface` (rename)
    - `gradients.background.stops[0]` → `colors.background` (first stop color)
    - `gradients.background.stops[last]` → `colors.surface` (last stop color)
    - `gradients.background` → `backgroundGradient` with explicit `{color, position}` stops. Add `FF` alpha prefix if missing.
    - `gradients.widgetBackground` → `widgetBackgroundGradient` same treatment
    - `defaults.backgroundStyle` → `defaults.backgroundStyle` (preserved)
    - `defaults.glowEffect` → `defaults.glowEffect` (preserved)
    - Remove `requiredAnyEntitlement` from JSON (handled in code by ThemesPackThemeProvider)

    **3. Create ThemeFileParser.kt** at `android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemeFileParser.kt`:
    - Pack-local `@Serializable` schema types mirroring `ThemeFileSchema` from `:core:design` but with additional `highlight`, `widgetBorder` → `onSurface` naming, and `defaults` support
    - Pack-local `parseHexColor()` function (same pure-Kotlin impl as `:core:design`, ~15 lines)
    - `parseThemeJson(json: String): DashboardThemeDefinition?` function that deserializes JSON string to pack-local schema, converts to `DashboardThemeDefinition`
    - Map `highlight` to `highlightColor` parameter if present, otherwise falls back to `accentColor` default
    - Map `defaults.backgroundStyle` to `defaultBackgroundStyle`, `defaults.glowEffect` to `defaultHasGlowEffect`
    - Use `kotlinx.serialization.json.Json { ignoreUnknownKeys = true }` for forward compatibility
    - All themes get `packId = "themes"` and `themeId = "themes:{id}"` prefix
    - `requiredAnyEntitlement` is NOT set by the parser -- that's done by the provider (post-parse)
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:themes:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>22 theme JSON files migrated to new format in resources directory. Pack-local ThemeFileParser compiles and can parse the new format. No dependency on :core:design.</done>
</task>

<task type="auto">
  <name>Task 2: ThemesPackThemeProvider + Hilt module + all tests</name>
  <files>
    android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemesPackThemeProvider.kt
    android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemesThemeModule.kt
    android/pack/themes/src/test/kotlin/app/dqxn/android/pack/themes/ThemesPackThemeProviderTest.kt
    android/pack/themes/src/test/kotlin/app/dqxn/android/pack/themes/ThemeJsonValidationTest.kt
  </files>
  <action>
    **1. Create ThemesPackThemeProvider.kt:**
    ```kotlin
    @Singleton
    public class ThemesPackThemeProvider @Inject constructor() : ThemeProvider {
      override val packId: String = "themes"
      override fun getThemes(): List<ThemeSpec> = loadedThemes

      private val loadedThemes: List<DashboardThemeDefinition> by lazy {
        THEME_FILES.mapNotNull { filename ->
          val json = javaClass.classLoader!!.getResourceAsStream("themes/$filename")
            ?.bufferedReader()?.readText() ?: return@mapNotNull null
          parseThemeJson(json)?.copy(requiredAnyEntitlement = setOf("themes"))
        }
      }
    }
    ```
    - `THEME_FILES` = list of all 22 `.theme.json` filenames
    - Every returned theme gets `requiredAnyEntitlement = setOf("themes")` post-parse
    - This gates Theme Studio (F6.2), SOLAR_AUTO (F6.3), and ILLUMINANCE_AUTO (F6.4) since those modes require the `themes` entitlement

    **2. Create ThemesThemeModule.kt** -- Hilt `@Module` with `@Binds @IntoSet` binding `ThemesPackThemeProvider` to `ThemeProvider`, same pattern as `EssentialsThemeModule`.

    **3. Create ThemesPackThemeProviderTest.kt:**
    - Test `getThemes()` returns exactly 22 themes
    - Test all themes have `requiredAnyEntitlement = setOf("themes")`
    - Test all themes have `packId = "themes"`
    - Test all theme IDs start with `"themes:"`
    - Test no duplicate theme IDs
    - Test each theme has non-empty `displayName`
    - Test mix of `isDark` true and false themes present

    **4. Create ThemeJsonValidationTest.kt:**
    - `@ParameterizedTest` with `@MethodSource` providing all 22 filenames
    - For each JSON file:
      - Parse succeeds (not null)
      - Has non-empty `themeId` and `displayName`
      - `isDark` is explicitly set
      - `primaryTextColor`, `secondaryTextColor`, `accentColor`, `widgetBorderColor` are non-zero colors
      - `backgroundBrush` is non-null
      - `widgetBackgroundBrush` is non-null
    - Separate test: load all 22 raw JSON strings, verify `kotlinx.serialization` deserializes without exception
    - Separate test: verify gradient stop positions are in [0.0, 1.0] range by deserializing to pack-local schema
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:themes:testDebugUnitTest --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>ThemesPackThemeProvider loads 22 themes with entitlement gating. All tests pass: 22 themes loaded, all gated, all valid hex colors, all gradient stops in range, no duplicates.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:themes:testDebugUnitTest --console=plain
```
All theme validation and provider tests pass. 22 themes loaded from JSON resources.
</verification>

<success_criteria>
- 22 theme JSON files present in `src/main/resources/themes/`
- ThemesPackThemeProvider returns 22 `DashboardThemeDefinition` instances
- All 22 themes have `requiredAnyEntitlement = setOf("themes")`
- All color values valid, all gradient stops in [0.0, 1.0]
- No dependency on `:core:design` or any `:core:*` module
- All tests green
</success_criteria>

<output>
After completion, create `.planning/phases/09-themes-demo-chaos/09-01-SUMMARY.md`
</output>
