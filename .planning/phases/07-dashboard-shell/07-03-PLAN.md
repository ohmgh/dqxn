---
phase: 07-dashboard-shell
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/EditModeCoordinator.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/WidgetGestureHandler.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/BlankSpaceGestureHandler.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DragUpdate.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/ResizeUpdate.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/EditModeCoordinatorTest.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/grid/WidgetGestureHandlerTest.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/grid/BlankSpaceGestureHandlerTest.kt
autonomous: true
requirements:
  - F1.5
  - F1.6
  - F1.7
  - F1.8
  - F1.11
  - F1.21
  - F2.16
  - F2.18
  - F10.4

must_haves:
  truths:
    - "EditModeCoordinator toggles edit mode and manages focused widget state"
    - "Drag gesture uses graphicsLayer offset, not Modifier.offset"
    - "Resize handles enforce aspect ratio when widget declares one"
    - "Widget focus shows overlay toolbar, tapping content unfocuses"
    - "Long-press on blank space enters edit mode with 400ms threshold and 8px cancellation"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/EditModeCoordinator.kt"
      provides: "Edit mode toggle, focus, drag/resize state management"
      contains: "class EditModeCoordinator"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/WidgetGestureHandler.kt"
      provides: "Per-widget gesture state machine for tap/drag/resize"
      contains: "class WidgetGestureHandler"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/BlankSpaceGestureHandler.kt"
      provides: "Background tap/long-press gesture detection"
      contains: "class BlankSpaceGestureHandler"
  key_links:
    - from: "EditModeCoordinator"
      to: "LayoutCoordinator"
      via: "constructor injection for layout state access during drag/resize validation"
      pattern: "layoutCoordinator.*LayoutCoordinator"
    - from: "WidgetGestureHandler"
      to: "GridPlacementEngine"
      via: "snap-to-grid and no-straddle enforcement on gesture completion"
      pattern: "gridPlacementEngine.*GridPlacementEngine"
---

<objective>
EditModeCoordinator with focus management, WidgetGestureHandler for drag/resize, and BlankSpaceGestureHandler for edit mode entry.

Purpose: Gesture handling is the highest-risk UI subsystem. This plan isolates the gesture state machine and edit mode coordination from the grid composable (Plan 06), enabling independent testing of gesture logic.

Output: EditModeCoordinator managing edit/focus state, gesture handlers with correct pointer event filtering, drag/resize data types.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-dashboard-shell/07-RESEARCH.md
@.planning/migration/phase-07.md
@.planning/migration/replication-advisory.md
@.planning/phases/07-dashboard-shell/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: EditModeCoordinator + gesture types + WidgetGestureHandler + BlankSpaceGestureHandler</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/EditModeCoordinator.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/WidgetGestureHandler.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/BlankSpaceGestureHandler.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DragUpdate.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/ResizeUpdate.kt
  </files>
  <action>
**DragUpdate.kt / ResizeUpdate.kt:** Package `app.dqxn.android.feature.dashboard.grid`. Continuous gesture state types for `MutableStateFlow` (latest-value-wins, NOT Channel).

```kotlin
@Immutable
data class DragUpdate(
    val widgetId: String,
    val currentOffsetX: Float,  // pixels, for graphicsLayer translationX
    val currentOffsetY: Float,  // pixels, for graphicsLayer translationY
    val isDragging: Boolean,
)

@Immutable
data class ResizeUpdate(
    val widgetId: String,
    val handle: ResizeHandle,
    val targetSize: GridSize,
    val targetPosition: GridPosition?,  // non-null for non-BottomRight handles
    val isResizing: Boolean,
)

enum class ResizeHandle { TOP_LEFT, TOP_RIGHT, BOTTOM_LEFT, BOTTOM_RIGHT }
```

**EditModeCoordinator.kt:** Package `app.dqxn.android.feature.dashboard.coordinator`. `@Inject constructor` with `layoutCoordinator: LayoutCoordinator`, `gridPlacementEngine: GridPlacementEngine`, `haptics: DashboardHaptics`, `reducedMotionHelper: ReducedMotionHelper`, `logger: DqxnLogger`.

State: `data class EditState(val isEditMode: Boolean, val focusedWidgetId: String?, val showStatusBar: Boolean)` — `@Immutable`.

Continuous gesture flows (NOT in EditState — different update frequencies):
- `val dragState: StateFlow<DragUpdate?> = _dragState.asStateFlow()` (null = no drag)
- `val resizeState: StateFlow<ResizeUpdate?> = _resizeState.asStateFlow()` (null = no resize)

Methods:
- `enterEditMode()` — sets isEditMode=true, fires `haptics.editModeEnter()`, clears focus
- `exitEditMode()` — sets isEditMode=false, clears focus, fires `haptics.editModeExit()`
- `focusWidget(widgetId: String?)` — sets focusedWidgetId, fires `haptics.widgetFocus()` if non-null
- `startDrag(widgetId: String, startX: Float, startY: Float)` — records drag start position, fires `haptics.dragStart()`
- `updateDrag(offsetX: Float, offsetY: Float)` — updates _dragState (graphicsLayer offset, NOT layout position)
- `endDrag()` — snaps to grid via GridPlacementEngine.snapToGrid(), enforces no-straddle via enforceNoStraddle(), commits position via LayoutCoordinator.handleMoveWidget(), clears _dragState, fires `haptics.snapToGrid()`
- `startResize(widgetId: String, handle: ResizeHandle)` — fires `haptics.resizeStart()`
- `updateResize(deltaWidthUnits: Int, deltaHeightUnits: Int)` — computes new size + position compensation for non-BottomRight handles per replication advisory section 6. TopLeft: `gridX -= deltaWidth, gridY -= deltaHeight`. TopRight: `gridY -= deltaHeight`. BottomLeft: `gridX -= deltaWidth`. Enforces MIN_WIDGET_UNITS = 2. Enforces aspect ratio from WidgetSpec if declared (F2.16).
- `endResize()` — commits via LayoutCoordinator.handleResizeWidget(), clears _resizeState

Widget add/remove animations (F1.21): `handleWidgetAdded(widgetId)` / `handleWidgetRemoved(widgetId)` — track animation state for `fadeIn + scaleIn` spring on add, `fadeOut + scaleOut` on delete (animation composable reads this state in Plan 06).

Focus interaction model (F2.18): focused widget shows overlay toolbar (delete/settings). Tapping widget content area unfocuses. Interactive widget actions (Shortcuts tap) only work in non-focused, non-edit mode. `isInteractionAllowed(widgetId): Boolean` — returns true only if NOT in edit mode AND widget is NOT focused.

**WidgetGestureHandler.kt:** Package `app.dqxn.android.feature.dashboard.grid`. NOT a composable — a stateless utility class that provides `Modifier` extensions for widget-level gestures. `@Inject constructor` with `editModeCoordinator: EditModeCoordinator`, `gridPlacementEngine: GridPlacementEngine`, `haptics: DashboardHaptics`.

Key method: `fun Modifier.widgetGestures(widgetId: String, widgetSpec: WidgetSpec): Modifier` — uses `pointerInput` with manual `awaitEachGesture` + `awaitPointerEvent` (NOT `detectDragGesturesAfterLongPress`). Behavior:
- Non-edit mode: tap → focus widget (if not focused) or unfocus (if focused). No drag/resize.
- Edit mode, not focused: tap → focus
- Edit mode, focused: drag via `awaitPointerEvent` with `PointerEventPass.Initial` for interception. 8px cancellation threshold for scroll discrimination per replication advisory section 6. Resize via 4 corner handles (`HANDLE_SIZE = 32.dp`, touch target 48dp per F1.7).
- `requireUnconsumed = true` on non-edit-mode events to allow widget Clickable to fire.
- Capture `wasInEditModeAtStart` at gesture start for consistent pass selection.

Resize handles: positioned at widget corners. Immediate start (no long-press). Touch targets 48dp (F1.7). Size constraints: MIN_WIDGET_UNITS = 2.

**BlankSpaceGestureHandler.kt:** Package `app.dqxn.android.feature.dashboard.grid`. Stateless utility. `@Inject constructor` with `editModeCoordinator: EditModeCoordinator`.

`fun Modifier.blankSpaceGestures(): Modifier` — uses `pointerInput` with `awaitEachGesture`. Long-press: 400ms threshold with 8px cancellation. `requireUnconsumed = true` — only fires if no widget consumed the event. On long-press → `editModeCoordinator.enterEditMode()`. On tap (in edit mode) → `editModeCoordinator.exitEditMode()`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>EditModeCoordinator manages edit/focus state with continuous drag/resize flows. WidgetGestureHandler provides correct pointer event handling per replication advisory. BlankSpaceGestureHandler handles blank space tap/long-press for edit mode entry.</done>
</task>

<task type="auto">
  <name>Task 2: EditModeCoordinator tests + gesture handler tests</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/EditModeCoordinatorTest.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/grid/WidgetGestureHandlerTest.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/grid/BlankSpaceGestureHandlerTest.kt
  </files>
  <action>
**EditModeCoordinatorTest.kt:** JUnit5 + `@Tag("fast")`. Tests:
- `enterEditMode sets isEditMode true and clears focus`
- `exitEditMode sets isEditMode false and clears focus`
- `focusWidget sets focusedWidgetId`
- `focusWidget null clears focus`
- `startDrag emits DragUpdate with isDragging true`
- `updateDrag updates offsets in dragState`
- `endDrag snaps to grid and commits position`
- `endDrag with no-straddle violation snaps to boundary`
- `startResize emits ResizeUpdate`
- `updateResize TopLeft compensates position` — deltaWidth=2 → gridX decreases by 2
- `updateResize BottomRight does not change position`
- `updateResize enforces MIN_WIDGET_UNITS = 2`
- `updateResize enforces aspect ratio` — widget with 1:1 aspect ratio, resize width only → height auto-adjusted
- `isInteractionAllowed returns false in edit mode`
- `isInteractionAllowed returns false when widget is focused`
- `isInteractionAllowed returns true in non-edit non-focused mode`

Use MockK for LayoutCoordinator, GridPlacementEngine, DashboardHaptics. Verify haptic calls.

**WidgetGestureHandlerTest.kt:** JUnit5 + `@Tag("fast")`. Tests for the stateless gesture logic (not composable interaction — that's compose-ui-test territory in Plan 06):
- `gesture state machine: non-edit tap does not start drag`
- `gesture state machine: edit mode focused widget drag starts`
- `8px cancellation threshold respected`
- `wasInEditModeAtStart captures mode at start, not mid-gesture`

**BlankSpaceGestureHandlerTest.kt:** JUnit5 + `@Tag("fast")`. Tests:
- `long-press on blank space enters edit mode`
- `tap in edit mode exits edit mode`
- `requireUnconsumed pattern: consumed events ignored`
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --console=plain --tests "*.EditModeCoordinatorTest" --tests "*.WidgetGestureHandlerTest" --tests "*.BlankSpaceGestureHandlerTest" 2>&1 | tail -10</automated>
  </verify>
  <done>EditModeCoordinator tests verify edit/focus state, drag/resize flows with position compensation and aspect ratio. Gesture handler tests verify state machine and cancellation threshold.</done>
</task>

</tasks>

<verification>
- `./gradlew :feature:dashboard:compileDebugKotlin --console=plain` succeeds
- `./gradlew :feature:dashboard:testDebugUnitTest --console=plain` passes all EditMode and gesture tests
- Drag uses graphicsLayer offset pattern (Float pixel offsets, not GridPosition)
- Resize handles compensate position for non-BottomRight handles
- Aspect ratio constraint enforced when declared
- 48dp resize handle touch targets (F1.7)
</verification>

<success_criteria>
- EditModeCoordinator manages edit mode entry/exit with focus tracking
- Drag gesture uses graphicsLayer float offsets with grid snap on release
- Resize enforces aspect ratio, minimum size, and position compensation
- Gesture handlers use manual awaitEachGesture (not detectDragGesturesAfterLongPress)
- BlankSpaceGestureHandler uses 400ms long-press with 8px cancellation
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-shell/07-03-SUMMARY.md`
</output>
