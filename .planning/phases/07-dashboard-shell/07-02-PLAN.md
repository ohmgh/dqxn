---
phase: 07-dashboard-shell
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinator.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/gesture/DashboardHaptics.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/gesture/ReducedMotionHelper.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinatorTest.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/gesture/DashboardHapticsTest.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/gesture/ReducedMotionHelperTest.kt
autonomous: true
requirements:
  - F1.17
  - F10.9
  - NF39

must_haves:
  truths:
    - "ThemeCoordinator manages active theme with preview/revert cycle"
    - "ThemeCoordinator's displayTheme returns preview theme when set, otherwise current theme"
    - "DashboardHaptics provides 8 semantic haptic methods with API 30+ branching"
    - "ReducedMotionHelper reads animator_duration_scale and returns whether reduced motion is active"
    - "Quick theme toggle cycles through theme modes"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinator.kt"
      provides: "Theme state management with auto-switch integration"
      contains: "class ThemeCoordinator"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/gesture/DashboardHaptics.kt"
      provides: "Semantic haptic feedback for all dashboard interactions"
      contains: "class DashboardHaptics"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/gesture/ReducedMotionHelper.kt"
      provides: "System reduced motion setting detection"
      contains: "class ReducedMotionHelper"
  key_links:
    - from: "ThemeCoordinator"
      to: "ThemeAutoSwitchEngine"
      via: "constructor injection for auto-switch observation"
      pattern: "themeAutoSwitchEngine.*ThemeAutoSwitchEngine"
    - from: "ThemeCoordinator"
      to: "UserPreferencesRepository"
      via: "persists theme selections"
      pattern: "userPreferencesRepository.*UserPreferencesRepository"
---

<objective>
ThemeCoordinator with preview/revert cycle, DashboardHaptics with 8 semantic methods, and ReducedMotionHelper.

Purpose: Independent coordinator and utility classes that have no dependency on LayoutCoordinator, enabling Wave 1 parallel execution with Plan 01.

Output: ThemeCoordinator managing theme state, DashboardHaptics for edit mode/drag/resize haptics, ReducedMotionHelper for animation control.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-dashboard-shell/07-RESEARCH.md
@.planning/arch/state-management.md
@.planning/migration/phase-07.md
@.planning/migration/replication-advisory.md
@.planning/phases/05-core-infrastructure/05-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ThemeCoordinator + DashboardHaptics + ReducedMotionHelper</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinator.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/gesture/DashboardHaptics.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/gesture/ReducedMotionHelper.kt
  </files>
  <action>
**ThemeCoordinator.kt:** Package `app.dqxn.android.feature.dashboard.coordinator`. `@Inject constructor` with `themeAutoSwitchEngine: ThemeAutoSwitchEngine`, `builtInThemes: BuiltInThemes`, `userPreferencesRepository: UserPreferencesRepository`, `logger: DqxnLogger`.

State class: `data class ThemeState(val currentTheme: DashboardThemeDefinition, val darkTheme: DashboardThemeDefinition, val lightTheme: DashboardThemeDefinition, val autoSwitchMode: AutoSwitchMode, val previewTheme: DashboardThemeDefinition?)` with `val displayTheme: DashboardThemeDefinition get() = previewTheme ?: currentTheme` — `@Immutable`.

Methods:
- `initialize(scope: CoroutineScope)` — observes `themeAutoSwitchEngine.currentTheme` and `userPreferencesRepository` for theme selections. Eagerly collects `isDarkActive` from engine to derive `currentTheme` from `darkTheme`/`lightTheme` selection.
- `handleSetTheme(themeId: String)` — resolves theme from `builtInThemes`, persists selection to `userPreferencesRepository`.
- `handlePreviewTheme(theme: DashboardThemeDefinition?)` — sets `previewTheme` in state. Null clears preview (reverts).
- `handleCycleThemeMode()` — cycles LIGHT -> DARK -> SYSTEM -> SOLAR_AUTO -> ILLUMINANCE_AUTO -> LIGHT. Persists to UserPreferencesRepository. F10.9 quick theme toggle.

Key pattern from replication advisory section 3: preview theme set BEFORE navigation to prevent flash. `displayTheme` derivation is the single source for `LocalDashboardTheme`.

**DashboardHaptics.kt:** Package `app.dqxn.android.feature.dashboard.gesture`. `@Inject constructor` with `@param:ApplicationContext context: Context`, `reducedMotionHelper: ReducedMotionHelper`. Wraps `Vibrator` (or `VibratorManager` API 31+). 8 semantic methods per replication advisory section 6:
- `editModeEnter()` — `EFFECT_HEAVY_CLICK` API 30+ or `VibrationEffect.createOneShot(50, 200)`
- `editModeExit()` — `EFFECT_CLICK` API 30+ or oneShot(30, 150)
- `dragStart()` — `EFFECT_TICK` API 30+ or oneShot(20, 100)
- `snapToGrid()` — `EFFECT_TICK`
- `boundaryHit()` — `EFFECT_DOUBLE_CLICK` API 30+ (distinct from grid snap per F1.27)
- `resizeStart()` — `EFFECT_TICK`
- `widgetFocus()` — `EFFECT_CLICK`
- `buttonPress()` — `EFFECT_CLICK`

All methods check `reducedMotionHelper.isReducedMotion` — if true, still vibrate (haptics are not motion) but skip the `EFFECT_HEAVY_CLICK` variants, use lighter alternatives.

**ReducedMotionHelper.kt:** Package `app.dqxn.android.feature.dashboard.gesture`. `@Inject constructor` with `@param:ApplicationContext context: Context`. Read-only property `val isReducedMotion: Boolean` that reads `Settings.Global.getFloat(context.contentResolver, Settings.Global.ANIMATOR_DURATION_SCALE, 1f) == 0f`. Per NF39: when true, wiggle animation disabled, spring replaced with snap/instant transitions. Glow remains.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>ThemeCoordinator manages theme state with preview/revert. DashboardHaptics provides 8 semantic haptic methods. ReducedMotionHelper detects system reduced motion setting.</done>
</task>

<task type="auto">
  <name>Task 2: ThemeCoordinator tests + DashboardHaptics tests + ReducedMotionHelper tests</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinatorTest.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/gesture/DashboardHapticsTest.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/gesture/ReducedMotionHelperTest.kt
  </files>
  <action>
**ThemeCoordinatorTest.kt:** JUnit5 + `@Tag("fast")` + MockK. Tests:
- `initialize collects current theme from auto-switch engine`
- `handleSetTheme updates currentTheme and persists to repository`
- `handlePreviewTheme sets preview, displayTheme returns preview`
- `handlePreviewTheme null clears preview, displayTheme returns currentTheme`
- `handleCycleThemeMode cycles through all 5 modes`
- `auto-switch engine dark mode change updates currentTheme`
- `displayTheme derivation: preview takes priority over currentTheme`

Use `StandardTestDispatcher` + `Turbine` for flow testing. Mock `ThemeAutoSwitchEngine`, `BuiltInThemes`, `UserPreferencesRepository`.

**DashboardHapticsTest.kt:** JUnit5 + `@Tag("fast")` + MockK. Mock Vibrator. Tests:
- `editModeEnter invokes vibrator`
- `snapToGrid invokes vibrator`
- `boundaryHit invokes vibrator with distinct effect`
- `all 8 methods callable without crash` (smoke test)
- Verify Vibrator.vibrate called with expected VibrationEffect

**ReducedMotionHelperTest.kt:** JUnit5 + `@Tag("fast")` + MockK. Mock ContentResolver. Tests:
- `isReducedMotion returns true when animator_duration_scale is 0`
- `isReducedMotion returns false when animator_duration_scale is 1`
- `isReducedMotion returns false when setting is not found (default 1f)`
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --console=plain --tests "*.ThemeCoordinatorTest" --tests "*.DashboardHapticsTest" --tests "*.ReducedMotionHelperTest" 2>&1 | tail -10</automated>
  </verify>
  <done>ThemeCoordinator tests verify preview/revert cycle and auto-switch integration. DashboardHaptics tests verify all 8 haptic methods. ReducedMotionHelper tests verify animator_duration_scale reading.</done>
</task>

</tasks>

<verification>
- `./gradlew :feature:dashboard:compileDebugKotlin --console=plain` succeeds
- `./gradlew :feature:dashboard:testDebugUnitTest --console=plain` passes ThemeCoordinator, DashboardHaptics, ReducedMotionHelper tests
- ThemeCoordinator.displayTheme correctly derives from preview/current
- DashboardHaptics has 8 distinct haptic methods with API 30+ branching
- ReducedMotionHelper reads system setting correctly
</verification>

<success_criteria>
- ThemeCoordinator handles set, preview, cycle operations with persistence
- DashboardHaptics provides all 8 semantic haptic feedbacks (F1.17)
- ReducedMotionHelper correctly detects reduced motion (NF39)
- Quick theme toggle cycles 5 modes (F10.9)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-shell/07-02-SUMMARY.md`
</output>
