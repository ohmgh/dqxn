---
phase: 07-dashboard-shell
plan: 06
type: execute
wave: 4
depends_on: ["07-02", "07-03", "07-04", "07-05"]
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlot.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/DashboardLayer.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/NotificationBannerHost.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/CriticalBannerHost.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/DashboardButtonBar.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetErrorFallback.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/ConfirmationDialog.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGridTest.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlotTest.kt
autonomous: true
requirements:
  - F1.2
  - F1.3
  - F1.4
  - F1.9
  - F1.13
  - F1.14
  - F1.15
  - F1.16
  - F2.3
  - F2.14
  - F2.19
  - F3.14
  - NF1
  - NF2
  - NF3
  - NF7
  - NF-L1

must_haves:
  truths:
    - "DashboardGrid renders widgets via custom Layout + MeasurePolicy, not LazyLayout"
    - "Viewport culling: off-screen widgets have zero render cost"
    - "Each widget wrapped in graphicsLayer for isolated RenderNode"
    - "WidgetSlot provides error boundary with fallback UI on crash"
    - "Dashboard persists at Layer 0 beneath overlays (dashboard-as-shell)"
    - "Bottom bar auto-hides after 3s inactivity with 76dp touch targets"
    - "Widget accessibility: semantics contentDescription from renderer"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt"
      provides: "Custom Layout composable with grid-unit coordinate system"
      contains: "fun DashboardGrid"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlot.kt"
      provides: "Error boundary composable with LocalWidgetData provision"
      contains: "fun WidgetSlot"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/DashboardLayer.kt"
      provides: "Layer 0 root composable with semantics registration"
      contains: "fun DashboardLayer"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/DashboardButtonBar.kt"
      provides: "Auto-hiding bottom bar with settings, profiles, add-widget"
      contains: "fun DashboardButtonBar"
  key_links:
    - from: "DashboardGrid"
      to: "WidgetSlot"
      via: "renders each widget through WidgetSlot error boundary"
      pattern: "WidgetSlot.*widget"
    - from: "WidgetSlot"
      to: "LocalWidgetData"
      via: "provides per-widget data via CompositionLocal"
      pattern: "LocalWidgetData provides"
    - from: "DashboardLayer"
      to: "SemanticsOwnerHolder"
      via: "registers semantics owner for agentic tree inspection"
      pattern: "SemanticsOwnerHolder.*register"
---

<objective>
Dashboard grid composable, widget slot error boundary, Layer 0/1 structure, bottom bar, and notification banner hosts.

Purpose: This plan assembles the visual layer of the dashboard using all coordinators built in Plans 01-05. The grid composable is the highest-risk UI artifact -- it must maintain 60fps with 12+ widgets using custom `Layout` + `MeasurePolicy`, `graphicsLayer` isolation, and viewport culling.

Output: DashboardGrid with custom MeasurePolicy, WidgetSlot error boundary, DashboardLayer with semantics registration, DashboardButtonBar, banner hosts, ConfirmationDialog.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-dashboard-shell/07-RESEARCH.md
@.planning/arch/compose-performance.md
@.planning/migration/phase-07.md
@.planning/migration/replication-advisory.md
@.planning/phases/07-dashboard-shell/07-01-SUMMARY.md
@.planning/phases/07-dashboard-shell/07-02-SUMMARY.md
@.planning/phases/07-dashboard-shell/07-03-SUMMARY.md
@.planning/phases/07-dashboard-shell/07-04-SUMMARY.md
@.planning/phases/07-dashboard-shell/07-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: DashboardGrid + WidgetSlot + DashboardLayer + DashboardButtonBar + banner hosts + shared UI</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlot.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/DashboardLayer.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/NotificationBannerHost.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/CriticalBannerHost.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/DashboardButtonBar.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetErrorFallback.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/ConfirmationDialog.kt
  </files>
  <action>
**DashboardGrid.kt:** Package `app.dqxn.android.feature.dashboard.grid`. `@Composable fun DashboardGrid(widgets: ImmutableList<DashboardWidgetInstance>, viewportCols: Int, viewportRows: Int, editState: EditState, dragState: DragUpdate?, resizeState: ResizeUpdate?, widgetBindingCoordinator: WidgetBindingCoordinator, widgetRegistry: WidgetRegistry, reducedMotionHelper: ReducedMotionHelper, onCommand: (DashboardCommand) -> Unit, modifier: Modifier = Modifier)`.

Custom `Layout` + `MeasurePolicy` (NOT LazyLayout per CLAUDE.md):
1. Filter visible widgets via `remember(widgets, viewportCols, viewportRows)` (NF7 viewport culling).
2. For each visible widget, emit `key(widget.instanceId) { WidgetSlot(...) }`.
3. MeasurePolicy: each widget measured with constraints from `widget.size * GRID_UNIT_SIZE`. Placed at `widget.position * GRID_UNIT_SIZE`. Z-index from `widget.zIndex` via `placeRelative(zIndex = widget.zIndex.toFloat())`.
4. Each widget wrapped in `Modifier.graphicsLayer { }` for isolated RenderNode (NF1).
5. Apply drag offset via `graphicsLayer { translationX = dragState.currentOffsetX; translationY = dragState.currentOffsetY }` when dragging (NOT Modifier.offset).
6. Apply edit mode visual feedback: wiggle animation `infiniteRepeatable(tween(150ms), RepeatMode.Reverse)` rotating +-0.5 degrees (F1.11). Bracket pulse `infiniteRepeatable(tween(800ms, FastOutSlowIn), Reverse)` 3->6dp. Disabled when `reducedMotionHelper.isReducedMotion` (NF39).
7. Widget add animation: `fadeIn + scaleIn` spring on add. Widget remove: `fadeOut + scaleOut` (F1.21).
8. Modifier.testTag("dashboard_grid") on the Layout.

Apply `widgetGestures` modifier from WidgetGestureHandler on each widget.
Apply `blankSpaceGestures` modifier from BlankSpaceGestureHandler on the background.

**WidgetSlot.kt:** Package `app.dqxn.android.feature.dashboard.binding`. `@Composable fun WidgetSlot(widget: DashboardWidgetInstance, widgetBindingCoordinator: WidgetBindingCoordinator, widgetRegistry: WidgetRegistry, editModeCoordinator: EditModeCoordinator, modifier: Modifier = Modifier)`.

Error boundary (F2.14):
1. Resolve renderer via `widgetRegistry.findByTypeId(widget.typeId)`. If null → render `UnknownWidgetPlaceholder` (F2.13).
2. Collect `widgetBindingCoordinator.widgetData(widget.instanceId)` via `collectAsState()` (Layer 0 — NOT collectAsStateWithLifecycle per CLAUDE.md).
3. Provide data via `CompositionLocalProvider(LocalWidgetData provides data, LocalWidgetScope provides widgetCoroutineScope)`.
4. Wrap `renderer.Render()` in `try/catch` composable error boundary. On crash → render `WidgetErrorFallback`, report via `DashboardCommand.WidgetCrash`.
5. Provide `LocalWidgetPreviewUnits` during resize gesture for content-aware relayout.
6. Gate interactive widget actions via `editModeCoordinator.isInteractionAllowed(widget.instanceId)` (F2.18): pass this boolean to the renderer's interactive mode. When `false`, widget renders in non-interactive/display-only mode (taps on widget content consumed by focus/edit gesture system, not forwarded to renderer). WidgetSlot receives `editModeCoordinator: EditModeCoordinator` as a parameter and collects `editState` to derive the gating signal reactively.
7. Apply `Modifier.semantics { contentDescription = renderer.accessibilityDescription(data) }` for F2.19 widget accessibility.
8. Apply `Modifier.testTag("widget_${widget.instanceId}")`.

Collect `widgetBindingCoordinator.widgetStatus(widget.instanceId)` — render status overlay from WidgetStatusCache (F2.5, F3.14 coordinator-level status overlay infrastructure). Overlays: EntitlementRevoked, SetupRequired, ConnectionError, DataStale with user-facing messages from string resources (F3.15).

**DashboardLayer.kt:** Package `app.dqxn.android.feature.dashboard.layer`. Root Layer 0 composable. Persists beneath all overlays (F1.13 dashboard-as-shell). Registers `SemanticsOwnerHolder` (debug only) for agentic `dump-semantics`.

Structure:
```
Box {
    DashboardGrid(...)           // Widgets on grid
    // Edit mode overlays (boundary lines, handles) rendered inside DashboardGrid
}
```

Configuration boundary lines (F1.26): when `editState.isEditMode`, overlay boundary line composables with labels ("folded portrait", etc.). Lines from `configurationBoundaries: List<ConfigurationBoundary>`.

Orientation lock (F1.15): read from `userPreferencesRepository.orientationLock`, apply `Activity.requestedOrientation` via side effect.

Keep screen on (F1.16): read from `userPreferencesRepository.keepScreenOn`, apply `FLAG_KEEP_SCREEN_ON` via `DisposableEffect`.

Status bar toggle (F1.2): read from `editState.showStatusBar`, apply `WindowInsetsControllerCompat.show/hide(systemBars())`.

Lifecycle pause/resume (NF-L1): `LifecycleResumeEffect` → `widgetBindingCoordinator.resumeAll()` on resume, `pauseAll()` on pause.

**NotificationBannerHost.kt:** Layer 0.5. Renders non-critical banners stacked at top. Animates in/out. Reads `notificationCoordinator.activeBanners`. Test tag: `banner_{id}`.

**CriticalBannerHost.kt:** Layer 1.5 (above overlays). Renders CRITICAL banners that must be visible even over settings/pickers. Safe mode banner with "Reset" and "Report" actions.

**DashboardButtonBar.kt:** Package `app.dqxn.android.feature.dashboard.ui`. Auto-hiding bottom bar (F1.9). Contents: Settings button (always), profile icons (when 2+ profiles, active highlighted), Add Widget button (edit mode only). 76dp touch targets (F10.4). Auto-hide after 3s inactivity via `LaunchedEffect` + `delay`. Tap to reveal. Floats over canvas (no layout shift). Quick theme toggle button (F10.9 — cycles theme mode). Test tags: `bottom_bar`, `settings_button`, `add_widget_button`, `profile_{id}`, `edit_mode_toggle`.

**WidgetErrorFallback.kt:** Package `app.dqxn.android.feature.dashboard.ui`. Fallback UI for crashed widgets. Shows error icon + "Widget error" text + tap to retry.

**ConfirmationDialog.kt:** Package `app.dqxn.android.feature.dashboard.ui`. Reusable modal with scrim + animation. Uses `DashboardMotion.dialogEnter/dialogExit` from `:core:design`. Port from old codebase. Reused by overlays in Phase 10.

Note: `UnknownWidgetPlaceholder.kt` and `LocalWidgetPreviewUnits.kt` are created in Plan 04 (`:sdk:ui` pure types with no Plan 06 dependencies). Import them here.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>DashboardGrid renders widgets via custom Layout with viewport culling and graphicsLayer isolation. WidgetSlot provides error boundary with LocalWidgetData and interaction gating via isInteractionAllowed. DashboardLayer assembles Layer 0 with semantics registration. DashboardButtonBar auto-hides with 76dp touch targets. Banner hosts handle notification display.</done>
</task>

<task type="auto">
  <name>Task 2: DashboardGrid tests + WidgetSlot tests</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGridTest.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlotTest.kt
  </files>
  <action>
**DashboardGridTest.kt:** JUnit5 + `@Tag("fast")`. Unit tests for grid logic (NOT compose-ui-test — those are heavy and belong in Plan 08 on-device):
- `viewport culling filters out off-screen widgets` — given 5 widgets with 2 outside viewport, verify only 3 returned by filter logic
- `widget z-index ordering correct` — widgets with higher zIndex placed later
- `grid unit size calculation: 16dp` — verify GRID_UNIT_SIZE constant
- `widget placement coordinates: position * GRID_UNIT_SIZE` — verify MeasurePolicy math

**WidgetSlotTest.kt:** JUnit5 + `@Tag("fast")` + MockK. Tests:
- `unknown typeId renders UnknownWidgetPlaceholder` (F2.13) — mock WidgetRegistry returning null
- `widget crash caught by error boundary, renders WidgetErrorFallback` (F2.14) — mock renderer that throws
- `widget crash reports DashboardCommand.WidgetCrash`
- `status overlay rendered for SetupRequired state` (F3.14)
- `status overlay rendered for EntitlementRevoked state`
- `accessibility description set on semantics` (F2.19) — verify contentDescription matches renderer output
- `isInteractionAllowed false renders widget in non-interactive mode` (F2.18) — mock editModeCoordinator returning false, verify renderer receives non-interactive flag
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --console=plain --tests "*.DashboardGridTest" --tests "*.WidgetSlotTest" 2>&1 | tail -10</automated>
  </verify>
  <done>DashboardGrid tests verify viewport culling and z-index ordering. WidgetSlot tests verify error boundary, unknown widget placeholder, status overlays, and accessibility.</done>
</task>

</tasks>

<verification>
- `./gradlew :feature:dashboard:compileDebugKotlin --console=plain` succeeds
- `./gradlew :feature:dashboard:testDebugUnitTest --console=plain` passes grid and slot tests
- DashboardGrid uses custom Layout + MeasurePolicy (NOT LazyLayout)
- Each widget has graphicsLayer for isolated RenderNode
- Viewport culling applied (NF7)
- WidgetSlot provides error boundary (F2.14)
- Bottom bar has 76dp touch targets (F10.4)
- Semantics test tags applied: dashboard_grid, widget_{id}, bottom_bar, banner_{id}
</verification>

<success_criteria>
- DashboardGrid renders with custom Layout at 60fps target with graphicsLayer isolation (NF1)
- Viewport culling: off-screen widgets not rendered (NF7)
- WidgetSlot error boundary catches render crashes, shows fallback (F2.14)
- UnknownWidgetPlaceholder shown for deregistered types (F2.13)
- Widget accessibility via semantics contentDescription (F2.19)
- DashboardButtonBar auto-hides with 76dp touch targets (F1.9, F10.4)
- Layer 0/1 structure: dashboard-as-shell (F1.13)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-shell/07-06-SUMMARY.md`
</output>
