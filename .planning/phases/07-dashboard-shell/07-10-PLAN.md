---
phase: 07-dashboard-shell
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinatorTest.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetDataBinderTest.kt
autonomous: true
requirements: [NF19, F2.4]
gap_closure: true

must_haves:
  truths:
    - "WidgetBindingCoordinatorTest uses StandardTestDispatcher (no UnconfinedTestDispatcher)"
    - "WidgetDataBinderTest uses Turbine with StandardTestDispatcher for flow collection"
    - "All 7 existing WidgetBindingCoordinatorTest tests pass after migration"
    - "All 7 existing WidgetDataBinderTest tests pass after migration"
  artifacts:
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinatorTest.kt"
      provides: "CLAUDE.md-compliant test dispatchers"
      contains: "StandardTestDispatcher"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetDataBinderTest.kt"
      provides: "Turbine-based flow testing"
      contains: "turbineScope\\|test\\{"
  key_links:
    - from: "WidgetBindingCoordinatorTest.createCoordinator"
      to: "StandardTestDispatcher"
      via: "default dispatcher parameter"
      pattern: "StandardTestDispatcher"
---

<objective>
Migrate WidgetBindingCoordinatorTest and WidgetDataBinderTest from UnconfinedTestDispatcher to StandardTestDispatcher per CLAUDE.md rule: "never UnconfinedTestDispatcher."

Purpose: Every test in WidgetBindingCoordinatorTest uses `runTest(UnconfinedTestDispatcher())` and the createCoordinator helper defaults to `UnconfinedTestDispatcher(testScheduler)`. WidgetDataBinderTest uses `launch(UnconfinedTestDispatcher())` for flow collection. Both violate CLAUDE.md's explicit rule. Migrate to StandardTestDispatcher + Turbine (already in test dependencies).

Output: Both test files using StandardTestDispatcher, all existing tests passing.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinatorTest.kt
@android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetDataBinderTest.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinator.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetDataBinder.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate WidgetBindingCoordinatorTest to StandardTestDispatcher</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinatorTest.kt
  </files>
  <action>
The agent that wrote these tests used `runTest(UnconfinedTestDispatcher())` because "backgroundScope does not advance with StandardTestDispatcher advanceUntilIdle()." The fix is to NOT use `backgroundScope` — create a child scope of the test scope instead (same pattern as DashboardTestHarness):

```kotlin
val initJob = Job(coroutineContext[Job])
val initScope = this + initJob
coordinator.initialize(initScope)
// ... test body ...
initJob.cancel() // cleanup before runTest exits
```

This gives the coordinator a scope whose coroutines ARE driven by the test's scheduler.

Changes needed:

1. Remove all `runTest(UnconfinedTestDispatcher())` → `runTest` (plain, uses StandardTestDispatcher by default)
2. Change `createCoordinator` default dispatcher from `UnconfinedTestDispatcher(testScheduler)` to `StandardTestDispatcher(testScheduler)`
3. Remove the `import kotlinx.coroutines.test.UnconfinedTestDispatcher` line
4. Replace `coordinator.initialize(backgroundScope)` with child-scope pattern above in each test
5. Add `initJob.cancel()` cleanup before test ends (or after assertions)
6. Add `advanceUntilIdle()` calls after `coordinator.bind(widget)` and after `provider.emissionFlow.emit(...)` where needed
7. In the `widget crash reported to SafeModeManager` test, replace `coordinator.initialize(this)` with the child-scope pattern

Verify all 7 tests still pass. The coordinator's `bindingScope` uses `scope.coroutineContext + bindingSupervisor + defaultDispatcher`. With StandardTestDispatcher, launched coroutines are queued and run when `advanceUntilIdle()` is called. This is the correct behavior for deterministic testing.

IMPORTANT: If any test hangs or fails after migration, the issue is likely a missing `advanceUntilIdle()` or the bindingSupervisor creating a job tree that the test scheduler can't drive. In that case, ensure the SupervisorJob is a child of the test Job (it already is — `bindingSupervisor = SupervisorJob()` standalone, but `bindingScope = CoroutineScope(scope.coroutineContext + bindingSupervisor + defaultDispatcher)` should inherit the test scheduler).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.WidgetBindingCoordinatorTest" --console=plain 2>&amp;1 | tail -20</automated>
  </verify>
  <done>All 7 WidgetBindingCoordinatorTest tests pass with StandardTestDispatcher. No UnconfinedTestDispatcher imports remain.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate WidgetDataBinderTest to Turbine + StandardTestDispatcher</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetDataBinderTest.kt
  </files>
  <action>
The current tests use `launch(UnconfinedTestDispatcher()) { flow.collect { ... } }` for flow collection. Replace with Turbine's `test {}` block or `turbineScope` for multi-flow testing.

Example migration for `bind with single provider emits WidgetData with correct slot`:

Before:
```kotlin
val collected = mutableListOf<WidgetData>()
val job = launch(UnconfinedTestDispatcher()) {
    dataFlow.collect { collected.add(it) }
}
speedFlow.emit(SpeedSnapshot(timestamp = 1000L, speed = 60.0))
val latest = collected.last()
// assertions...
job.cancel()
```

After:
```kotlin
dataFlow.test {
    speedFlow.emit(SpeedSnapshot(timestamp = 1000L, speed = 60.0))
    // scan seed (Empty) might be first item
    val items = mutableListOf<WidgetData>()
    // Drain available items
    while (true) {
        val item = expectMostRecentItem()
        items.add(item)
        break
    }
    val latest = items.last()
    // assertions...
    cancelAndIgnoreRemainingEvents()
}
```

Or simpler with `awaitItem()`:
```kotlin
dataFlow.test {
    speedFlow.emit(SpeedSnapshot(timestamp = 1000L, speed = 60.0))
    skipItems(1) // skip scan seed (WidgetData.Empty)
    val data = awaitItem()
    assertThat(data.hasData()).isTrue()
    // ...
    cancelAndIgnoreRemainingEvents()
}
```

Apply this pattern to all 7 tests that use `launch(UnconfinedTestDispatcher())`. Tests that don't collect flows (like `provider fallback` and `provider resolution priority order`) don't need Turbine.

Add import: `import app.cash.turbine.test`

Remove: `import kotlinx.coroutines.test.UnconfinedTestDispatcher` (if no longer used)

IMPORTANT: The `merge+scan` tests may need careful handling of emission ordering with Turbine. If `awaitItem()` times out, use `expectMostRecentItem()` after a small delay or `advanceUntilIdle()`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.WidgetDataBinderTest" --console=plain 2>&amp;1 | tail -20</automated>
  </verify>
  <done>All 7 WidgetDataBinderTest tests pass with Turbine + StandardTestDispatcher. No UnconfinedTestDispatcher imports remain.</done>
</task>

</tasks>

<verification>
```
cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.WidgetBindingCoordinatorTest" --tests "*.WidgetDataBinderTest" --console=plain
```
All 14 tests pass. No `UnconfinedTestDispatcher` imports in either file.
</verification>

<success_criteria>
- Zero uses of UnconfinedTestDispatcher in WidgetBindingCoordinatorTest and WidgetDataBinderTest
- All 14 existing tests pass with StandardTestDispatcher
- CLAUDE.md compliance restored
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-shell/07-10-SUMMARY.md`
</output>
