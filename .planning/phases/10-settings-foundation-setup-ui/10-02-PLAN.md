---
phase: 10-settings-foundation-setup-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcher.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/BooleanSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/EnumSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/IntSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/FloatSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/StringSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/InfoSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/InstructionSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/AppPickerSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/DateFormatSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/TimezoneSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SoundPickerSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SettingComponents.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcherTest.kt
autonomous: true
requirements:
  - F2.9
  - F10.4

must_haves:
  truths:
    - "SettingRowDispatcher routes all 12 SettingDefinition subtypes to correct row composables"
    - "Three-layer visibility gating works: hidden, visibleWhen, entitlement"
    - "Value changes from row composables propagate via onValueChanged callback"
    - "All interactive elements have minimum 76dp touch targets"
    - "EnumSettingRow renders chips (<=10), dropdown (>10), or preview cards based on option count"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcher.kt"
      provides: "12-branch when dispatch with AnimatedVisibility"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SettingComponents.kt"
      provides: "SettingLabel, SelectionChip, PreviewSelectionCard shared components"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcherTest.kt"
      provides: "Parameterized test for 12 subtypes + visibility + entitlement"
  key_links:
    - from: "SettingRowDispatcher.kt"
      to: "SettingDefinition subtypes"
      via: "when dispatch"
      pattern: "is SettingDefinition\\."
    - from: "SettingRowDispatcher.kt"
      to: "EntitlementManager"
      via: "isAccessible check"
      pattern: "isAccessible"
---

<objective>
Schema-driven settings row system: the `SettingRowDispatcher` hub that routes all 12 `SettingDefinition` subtypes to individual row composables, plus the shared building-block components.

Purpose: This is the foundational UI dispatch layer consumed by both setup wizard (Plan 04) and widget settings sheet (Plan 05). All settings-driven UI goes through this dispatcher.
Output: SettingRowDispatcher with 12 row composables, shared SettingComponents, and parameterized dispatch test.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md

@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/settings/SettingDefinition.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/entitlement/Gated.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/entitlement/EntitlementManager.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/settings/SettingsEnums.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/SetupDefinition.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/motion/DashboardMotion.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/DashboardSpacing.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/DashboardTypography.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/TextEmphasis.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/CardSize.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: SettingRowDispatcher + shared components + first 6 row types</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcher.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SettingComponents.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/BooleanSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/EnumSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/IntSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/FloatSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/StringSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/InfoSettingRow.kt
  </files>
  <action>
    1. **SettingComponents.kt**: Shared building blocks used by all row types:
       - `SettingLabel(label, description?, theme)`: Row with label (`DashboardTypography.itemTitle`) + optional description (`DashboardTypography.description` at `TextEmphasis.Medium`). Minimum height 76dp (F10.4).
       - `SelectionChip(text, isSelected, onClick, theme)`: Material 3 FilterChip with `CardSize.SMALL.cornerRadius`, accent color when selected. Minimum 76dp height.
       - `PreviewSelectionCard(isSelected, content, onClick, theme)`: Card with border highlight when selected using accent color. `CardSize.MEDIUM.cornerRadius`.
       - `formatGmtOffset(zoneId: String): String` utility function.
       - `executeInstructionAction(context: Context, action: InstructionAction)`: Launches `OpenUrl` (Intent.ACTION_VIEW) or `LaunchApp` (package manager launch intent).

    2. **SettingRowDispatcher.kt**: Central dispatch composable:
       ```kotlin
       @Composable
       fun SettingRowDispatcher(
           definition: SettingDefinition<*>,
           currentValue: Any?,
           currentSettings: Map<String, Any?>,
           entitlementManager: EntitlementManager,
           theme: DashboardThemeDefinition,
           onValueChanged: (String, Any?) -> Unit,
           onNavigate: ((SettingNavigation) -> Unit)? = null,
       )
       ```
       - Layer 1: `if (definition.hidden) return` (hard skip)
       - Layer 2: `visibleWhen?.invoke(currentSettings) != false` (null = always visible -- critical: prevents flickering on initial empty map load per Pitfall 1)
       - Layer 3: `definition.isAccessible(entitlementManager)` entitlement check
       - `AnimatedVisibility(visible = isVisible && hasEntitlement, enter = DashboardMotion.expandEnter, exit = DashboardMotion.expandExit)`
       - 12-branch `when` dispatching to individual row composables
       - `else` fallback: `SettingLabel(definition.label, definition.description, theme)` for unrecognized types (e.g., UriSetting). Never crash on unknown types.

    3. **BooleanSettingRow**: `SettingLabel` + M3 `Switch`. Toggle fires `onValueChanged(definition.key, !currentValue)`.

    4. **EnumSettingRow**: 3 render modes based on option count and `optionPreviews`:
       - If `optionPreviews` non-null: `PreviewSelectionCard` grid (chunked rows of 5)
       - If options <= 10: `SelectionChip` row with `FlowRow`
       - If options > 10: `ExposedDropdownMenuBox`
       Compare with `value == option || value?.toString() == option.name` per Pitfall 3 (type-prefixed serialization).

    5. **IntSettingRow**: If `getEffectivePresets(currentSettings)` returns presets, render as `SelectionChip` row. Otherwise render as `SettingLabel` with current value display. No slider -- discrete presets only.

    6. **FloatSettingRow**: Discrete selection chips/presets, NOT slider (sliders conflict with pager swipe per anti-pattern). Chips for preset values if defined, otherwise render value display with +/- buttons respecting `min/max/step`.

    7. **StringSettingRow**: `OutlinedTextField` with `textFieldValue` state, `maxLength` filter via `TextFieldDefaults`, keyboard auto-defocus on Done action. `isEditing` local state to toggle between display and edit modes. Uses `DashboardTypography.itemTitle` for label.

    8. **InfoSettingRow**: 4-style color mapping using `SemanticColors` from `:core:design`:
       - `InfoStyle.INFO` -> `SemanticColors.Info`
       - `InfoStyle.WARNING` -> `SemanticColors.Warning`
       - `InfoStyle.SUCCESS` -> `SemanticColors.Success`
       - `InfoStyle.ERROR` -> `SemanticColors.Error`
       Icon + text with appropriate tint. Renders as a card with `CardSize.MEDIUM.cornerRadius`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - SettingRowDispatcher compiles with 12-branch dispatch + 3-layer visibility gating
    - First 6 row types (Boolean, Enum, Int, Float, String, Info) render with design tokens
    - SettingComponents (SettingLabel, SelectionChip, PreviewSelectionCard) available
    - All interactive elements >= 76dp touch targets
  </done>
</task>

<task type="auto">
  <name>Task 2: Remaining 5 row types + InstructionSettingRow + dispatcher test</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/InstructionSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/AppPickerSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/DateFormatSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/TimezoneSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SoundPickerSettingRow.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcherTest.kt
  </files>
  <action>
    1. **InstructionSettingRow**: Step number badge + action button + description. `executeInstructionAction()` fires locally AND calls `onNavigate(SettingNavigation.OnInstructionAction(...))` per Pitfall 7 (dual execution -- row handles launch, callback handles verification tracking). Step badge renders with accent color circle + white number.

    2. **AppPickerSettingRow**: Shows current app name resolved from package name (or "None selected"). Taps fire `onNavigate(SettingNavigation.ToAppPicker(key, currentPackage))`. Package name -> app name resolution via `PackageManager.getApplicationLabel()` with fallback to package name. 76dp row height.

    3. **DateFormatSettingRow**: Shows live date preview formatted with current `DateFormatOption`. Taps fire `onNavigate(SettingNavigation.ToDateFormatPicker(key, currentValue))`. Display current date/time with selected format. Use `java.time` APIs.

    4. **TimezoneSettingRow**: Displays city name + GMT offset. Three display states:
       - `null` -> system timezone with "System Default" subtitle
       - `"SYSTEM"` -> system timezone display without subtitle (avoid duplicate per advisory)
       - else -> parse zone ID, extract city from last "/" segment, format GMT offset via `formatGmtOffset()`
       Taps fire `onNavigate(SettingNavigation.ToTimezonePicker(key, currentValue))`.

    5. **SoundPickerSettingRow**: Shows current ringtone name via `RingtoneManager.getRingtone(context, uri).getTitle(context)` with fallback to "Default". Button launches system `ACTION_RINGTONE_PICKER` via `ActivityResultLauncher` integration. Note: actual `ActivityResultLauncher` registration happens at the parent composable level; this row fires a callback that triggers the launcher.

    6. **SettingRowDispatcherTest.kt**: Robolectric test with `createComposeRule()`:
       - **Parameterized render test**: Create one instance of each 12 `SettingDefinition` subtype with defaults, render through `SettingRowDispatcher`, assert non-empty content via semantics (`onAllNodesWithText` or `onNodeWithTag`). Use test tags on each row type for identification.
       - **Visibility gating test**: Create a `BooleanSetting` with `hidden = true`, verify nothing renders. Create one with `visibleWhen = { it["other"] == true }`, verify hidden when `currentSettings = emptyMap()` (per Pitfall 1 -- `null != false` is `true`, so visible when map empty), then visible when `currentSettings = mapOf("other" to true)`.
       - **Entitlement gating test**: Create a setting with `requiredAnyEntitlement = listOf("plus")`, mock `EntitlementManager` returning false for "plus", verify setting not rendered. Return true -> verify rendered.
       - **Value change test**: Render a `BooleanSetting`, toggle the switch, verify `onValueChanged` callback fires with correct key and new value.

       Use `StandardTestDispatcher` (never Unconfined). Mock `EntitlementManager` and `DashboardThemeDefinition` with MockK.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SettingRowDispatcherTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - All 12 SettingDefinition subtypes dispatch to correct row composables
    - InstructionSettingRow fires both local action AND navigation callback (dual execution)
    - TimezoneSettingRow handles null/SYSTEM/specific zone display correctly
    - SoundPickerSettingRow displays ringtone name from URI
    - SettingRowDispatcherTest passes: 12-subtype render, visibility gating, entitlement gating, value change propagation
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- SettingRowDispatcher routes all 12 SettingDefinition subtypes without crash
- Three-layer visibility (hidden, visibleWhen, entitlement) correctly hides/shows rows
- EnumSettingRow renders chips/dropdown/preview based on option count
- Value changes propagate through onValueChanged callback
- visibleWhen treats null map values as default-visible (Pitfall 1)
- EnumSetting compares with toString fallback (Pitfall 3)
- InstructionSettingRow dual-executes action + nav callback (Pitfall 7)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-02-SUMMARY.md`
</output>
