---
phase: 10-settings-foundation-setup-ui
plan: 10
type: execute
wave: 4
depends_on:
  - "10-07"
  - "10-08"
  - "10-09"
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
  - android/feature/dashboard/build.gradle.kts
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostTest.kt
autonomous: true
requirements:
  - F2.7
  - F2.8
  - F8.9
  - F10.4

must_haves:
  truths:
    - "OverlayNavHost has 4 new routes: WidgetPicker, Settings, WidgetSettings, Setup"
    - "Type-safe @Serializable route classes replace string-based routing"
    - "DashboardScreen wires button bar clicks to overlay navigation"
    - "WidgetSettings uses ExitTransition.None / EnterTransition.None per advisory"
    - "Back navigation from each overlay returns to dashboard correctly"
    - "editingWidgetId derived from back-stack scan for WidgetSettings route"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt"
      provides: "@Serializable route classes for type-safe navigation"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt"
      provides: "NavHost with 4 populated routes + transition specs"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostTest.kt"
      provides: "Route rendering + back navigation tests"
  key_links:
    - from: "DashboardScreen.kt"
      to: "OverlayNavHost"
      via: "navController navigation calls"
      pattern: "navController\\.navigate"
    - from: "OverlayNavHost.kt"
      to: "OverlayRoutes.kt"
      via: "composable<RouteType> registration"
      pattern: "composable<"
    - from: "DashboardScreen.kt"
      to: "editingWidgetId back-stack scan"
      via: "navController.currentBackStack scanning for WidgetSettings"
      pattern: "hasRoute<.*WidgetSettings>"
---

<objective>
Wire all Phase 10 overlay surfaces into the OverlayNavHost and connect DashboardScreen button bar to navigation.

Purpose: This is the integration plan that connects all individual UI components (Plans 04-09) into the navigation graph. The OverlayNavHost gets its first real routes, DashboardScreen gets its button bar callbacks, and the editingWidgetId back-stack scan enables widget preview mode.
Output: Populated OverlayNavHost, type-safe routes, DashboardScreen navigation wiring, integration tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/migration/replication-advisory.md (section 1, 2, 4)

@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt
@android/feature/dashboard/build.gradle.kts

# Prior plan summaries
@.planning/phases/10-settings-foundation-setup-ui/10-07-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-08-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-09-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Type-safe routes + OverlayNavHost population</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
    android/feature/dashboard/build.gradle.kts
  </files>
  <action>
    1. **build.gradle.kts**: Add `:feature:settings` dependency to `:feature:dashboard`:
       ```kotlin
       implementation(project(":feature:settings"))
       ```
       Unidirectional dependency -- `:feature:settings` does NOT depend on `:feature:dashboard`.

    2. **OverlayRoutes.kt**: Type-safe route classes using `@Serializable`:
       ```kotlin
       @Serializable data object EmptyRoute
       @Serializable data object WidgetPickerRoute
       @Serializable data object SettingsRoute
       @Serializable data class WidgetSettingsRoute(val widgetId: String)
       @Serializable data class SetupRoute(val providerId: String)
       ```
       Replaces string-based `ROUTE_EMPTY = "empty"`.

    3. **OverlayNavHost.kt**: Replace empty NavHost with populated routes using `composable<RouteType>` syntax:
       - `composable<EmptyRoute>` -- empty (Layer 0 visible)
       - `composable<WidgetPickerRoute>` with `DashboardMotion.hubEnter/hubExit`
       - `composable<SettingsRoute>` with source-varying transitions per advisory section 2 & 4
       - `composable<WidgetSettingsRoute>` with `exitTransition = ExitTransition.None`, `popEnterTransition = EnterTransition.None` per advisory section 2
       - `composable<SetupRoute>` with `DashboardMotion.hubEnter/hubExit`
       - **ClearPreviewTheme** on Settings enter per advisory section 3 race condition fix.
       - Remove `ROUTE_EMPTY` constant. Replace all references with `EmptyRoute`.

    4. Add required parameters to OverlayNavHost: registries, stores, evaluator (injected at DashboardScreen level, passed through).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - OverlayNavHost has 5 route registrations (Empty, WidgetPicker, Settings, WidgetSettings, Setup)
    - Type-safe @Serializable routes replace string-based routing
    - Transition specs per advisory (ExitTransition.None for WidgetSettings, source-varying for Settings)
  </done>
</task>

<task type="auto">
  <name>Task 2: DashboardScreen navigation wiring + editingWidgetId + tests</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostTest.kt
  </files>
  <action>
    1. **DashboardScreen.kt**: Wire button bar callbacks:
       - `onSettingsClick`: `navController.navigate(SettingsRoute)`
       - `onAddWidgetClick`: `navController.navigate(WidgetPickerRoute)`
       - **editingWidgetId back-stack scan**: `derivedStateOf` scanning `navController.currentBackStack.value` for `WidgetSettingsRoute` (NOT just currentEntry -- child routes preserve peek).
       - **hasOverlay**: Migrate to type-safe check `currentEntry?.destination?.hasRoute<EmptyRoute>() == false`.
       - Pass new dependencies to OverlayNavHost from ViewModel.

    2. **DashboardViewModel.kt**: Add public val parameters for overlay access:
       - `val dataProviderRegistry: DataProviderRegistry`
       - `val providerSettingsStore: ProviderSettingsStore`
       - `val entitlementManager: EntitlementManager`
       - `val setupEvaluator: SetupEvaluator`
       - `val pairedDeviceStore: PairedDeviceStore`

    3. **OverlayNavHostTest.kt**: Robolectric Compose test:
       - **Empty route renders**: NavHost with EmptyRoute, verify no overlay content.
       - **Settings route renders**: Navigate to SettingsRoute, verify content appears.
       - **WidgetPicker route renders**: Navigate to WidgetPickerRoute, verify content appears.
       - **Back from Settings**: Navigate, go back, verify EmptyRoute.
       - **WidgetSettings back-stack preservation**: Navigate to WidgetSettingsRoute then SetupRoute, verify WidgetSettingsRoute still in back stack.
       Mock all dependencies with MockK.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.OverlayNavHostTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Button bar navigates to Settings and WidgetPicker overlays
    - editingWidgetId derived from back-stack scan
    - hasOverlay uses type-safe route check
    - OverlayNavHostTest passes all route and navigation tests
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest :feature:settings:testDebugUnitTest --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- OverlayNavHost has 5 routes (Empty, WidgetPicker, Settings, WidgetSettings, Setup)
- Type-safe @Serializable routes used throughout
- DashboardScreen button bar clicks navigate to correct overlays
- editingWidgetId derived from back-stack scan
- Transition specs per advisory applied
- Back navigation returns to dashboard correctly
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-10-SUMMARY.md`
</output>
