---
phase: 10-settings-foundation-setup-ui
plan: 08
type: execute
wave: 3
depends_on:
  - "10-04"
  - "10-05"
  - "10-02"
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheet.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/FeatureSettingsContent.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/DataProviderSettingsContent.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetInfoContent.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/PackBrowserContent.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheetTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt
autonomous: true
requirements:
  - F2.7
  - F2.8
  - F8.1
  - F8.7
  - F8.9

must_haves:
  truths:
    - "WidgetSettingsSheet shows 3 tabs: Feature, Data Source, Info"
    - "FeatureSettingsContent renders widget settings schema via SettingRowDispatcher"
    - "DataProviderSettingsContent shows available providers for widget's data types"
    - "WidgetInfoContent shows widget description, issues, and NF-D1 speed disclaimer"
    - "WidgetPicker shows live previews using scaled WidgetRenderer.Render() with demo data"
    - "WidgetPicker groups widgets by pack with entitlement badges"
    - "Gated widgets show lock icon but are still previewable"
    - "Entitlement revocation shows one-time toast explaining change"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheet.kt"
      provides: "3-tab widget settings pager"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
      provides: "Widget picker grid with live previews grouped by pack"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheetTest.kt"
      provides: "3-tab navigation + schema rendering tests"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt"
      provides: "Widget grouping + live preview + entitlement badge + revocation toast tests"
  key_links:
    - from: "FeatureSettingsContent.kt"
      to: "SettingRowDispatcher.kt"
      via: "Settings schema rendering"
      pattern: "SettingRowDispatcher"
    - from: "WidgetPicker.kt"
      to: "WidgetRegistry"
      via: "Widget discovery"
      pattern: "widgetRegistry\\.getAll"
    - from: "WidgetPicker.kt"
      to: "WidgetRenderer.Render"
      via: "Live preview composable"
      pattern: "Render\\("
---

<objective>
Widget settings sheet (3-tab pager) and widget picker with live previews, entitlement badges, and revocation toast.

Purpose: These are the two primary widget-interaction overlay surfaces. WidgetSettingsSheet is the per-widget configuration UI (Feature/Data Source/Info tabs). WidgetPicker is the widget selection grid shown from the Add Widget button -- F2.7 requires live previews using scaled composables fed by single-shot data providers with sane defaults.
Output: WidgetSettingsSheet with 3 tab contents, WidgetPicker with live previews and pack grouping, PackBrowserContent, tests including entitlement revocation toast.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/migration/replication-advisory.md (section 1, 7)
@.planning/REQUIREMENTS.md (F2.7, F8.9)

@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetSpec.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetRenderer.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/registry/WidgetRegistry.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/registry/DataProviderRegistry.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/entitlement/EntitlementManager.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/entitlement/Gated.kt

# Prior plan summaries for SettingRowDispatcher + OverlayScaffold
@.planning/phases/10-settings-foundation-setup-ui/10-02-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-04-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: WidgetSettingsSheet + 3 tab contents</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheet.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/FeatureSettingsContent.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/DataProviderSettingsContent.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetInfoContent.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheetTest.kt
  </files>
  <action>
    1. **WidgetSettingsSheet.kt**: 3-tab pager wrapping OverlayScaffold.
       - Parameters: `widgetId: String`, `widgetRegistry: WidgetRegistry`, `dataProviderRegistry: DataProviderRegistry`, `providerSettingsStore: ProviderSettingsStore`, `entitlementManager: EntitlementManager`, `onDismiss: () -> Unit`, `onNavigate: (SettingNavigation) -> Unit`, `onNavigateToSetup: (String) -> Unit`, `onNavigateToPackBrowser: (String) -> Unit`.
       - Look up widget via `widgetRegistry.get(widgetTypeId)` to get `WidgetSpec`.
       - `HorizontalPager` with 3 pages + `TabRow` at top:
         - Tab 0: "Feature" -> `FeatureSettingsContent`
         - Tab 1: "Data Source" -> `DataProviderSettingsContent`
         - Tab 2: "Info" -> `WidgetInfoContent`
       - Title shows widget display name from `WidgetSpec.displayName`.
       - Uses `OverlayScaffold(overlayType = OverlayType.Preview)` per replication advisory section 1.
       - Dismissal: `onDismiss()` callback, NOT `popBackStack()` per advisory.

    2. **FeatureSettingsContent.kt**: Widget feature settings tab.
       - Loads current settings from `providerSettingsStore.getAllSettings(packId, providerId)` via `collectAsStateWithLifecycle()` (Layer 1 -- overlay lifecycle).
       - Renders `WidgetSpec.settingsSchema` items through `SettingRowDispatcher`.
       - Value changes write through to `providerSettingsStore.setSetting()` immediately.

    3. **DataProviderSettingsContent.kt**: Data source selection tab.
       - Shows available providers via `dataProviderRegistry.getByDataType(dataType)`.
       - Current provider highlighted with accent color.
       - Provider cards show: name, data type, connection status indicator, priority badge.
       - Providers with setup requirements show "Setup Required" badge; tap navigates via `onNavigateToSetup(providerId)`.

    4. **WidgetInfoContent.kt**: Widget info + issues tab.
       - Displays: widget type name, pack name, `WidgetSpec.description`, compatible data types list.
       - **NF-D1 speed disclaimer**: For speed-related widgets, include disclaimer text from string resource.
       - Issues section from `WidgetStatusCache` with resolution actions.

    5. **WidgetSettingsSheetTest.kt**: Robolectric Compose test:
       - **Tab navigation**: Verify 3 tabs render, swipe between tabs, verify content changes.
       - **Schema rendering**: Mock WidgetSpec with BooleanSetting + EnumSetting, verify rendering.
       - **Provider listing**: Mock DataProviderRegistry returning 2 providers, verify both render.
       - **Speed disclaimer**: For speedometer typeId, verify disclaimer text renders.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetSettingsSheetTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - WidgetSettingsSheet renders 3-tab pager with correct content per tab
    - FeatureSettingsContent renders settings schema via SettingRowDispatcher
    - DataProviderSettingsContent lists providers with status and priority
    - WidgetInfoContent shows description, disclaimer for speed widgets, issues
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: WidgetPicker with live previews + PackBrowserContent + entitlement tests</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/PackBrowserContent.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt
  </files>
  <action>
    1. **WidgetPicker.kt**: Widget selection grid with **live previews** (F2.7).
       - Parameters: `widgetRegistry: WidgetRegistry`, `entitlementManager: EntitlementManager`, `onSelectWidget: (String) -> Unit` (typeId), `onDismiss: () -> Unit`.
       - Group widgets by pack: `widgets.groupBy { it.typeId.substringBefore(':') }.toImmutableMap()`.
       - Per-pack section with pack name header.
       - **Live preview implementation** (F2.7 -- "live previews, scaled composables fed by single-shot data providers with sane defaults"):
         - Each widget card contains a scaled-down live preview: `Box(Modifier.size(previewWidth, previewHeight).graphicsLayer(scaleX = scale, scaleY = scale))` wrapping `WidgetRenderer.Render()`.
         - Feed `LocalWidgetData` with demo/stub `DataSnapshot` values from `WidgetSpec.previewData` (or sensible defaults if no preview data defined -- e.g., speed=60, rpm=3000, time=current).
         - Scale factor: calculate from card width / widget's preferred render width. Typical: 0.3-0.4x.
         - Use `graphicsLayer` for the scale to keep it as an isolated render node (no recomposition of parent).
         - Preview is **read-only** -- no touch interaction within the preview composable.
       - Below preview: widget display name, one-line description, data type icons.
       - **Entitlement badge** (F8.7): Lock icon overlay on gated widget previews. All widgets shown regardless of entitlement (preview-regardless-of-entitlement). Adding a gated widget checks `Gated.isAccessible(entitlementManager)` -- if not accessible, show toast instead of adding.
       - **Entitlement revocation toast** (F8.9): When a widget was previously accessible but `Gated.isAccessible()` now returns false (revocation detected), show one-time toast: "Some features are no longer available. Your layout is preserved." Track shown state in `remember` to avoid repeat.
       - Uses `OverlayScaffold(overlayType = OverlayType.Hub)` (full-screen).
       - Minimum touch targets 76dp on widget cards (F10.4).

    2. **PackBrowserContent.kt**: Pack list accessible from Settings.
       - Shows all packs with: name, widget count, entitlement status.
       - Each pack card navigable to filtered widget list.
       - Uses `OverlayScaffold(overlayType = OverlayType.Hub)`.

    3. **WidgetPickerTest.kt**: Robolectric Compose test:
       - **Grouping**: Create 3 widgets from 2 packs, verify grouped under correct pack headers.
       - **Live preview rendering**: Verify that WidgetRenderer.Render() is invoked inside the picker (check for preview test tag `"widget_preview_{typeId}"`).
       - **Entitlement badge**: Create widget with `requiredAnyEntitlement = listOf("plus")`, mock EntitlementManager returning false, verify lock icon renders.
       - **Selection callback**: Tap a widget card, verify `onSelectWidget` fires with correct typeId.
       - **Gated widget blocks**: Mock EntitlementManager returning false, tap gated widget, verify `onSelectWidget` NOT called.
       - **Entitlement revocation toast** (F8.9): Mock EntitlementManager returning false for a previously-accessible widget. Verify toast text "no longer available" appears in semantics tree.

       Mock WidgetRegistry, EntitlementManager, WidgetRenderer with MockK.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetPickerTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - WidgetPicker shows live previews via scaled WidgetRenderer.Render() with demo data
    - Widgets grouped by pack with correct headers
    - Entitlement badges render on gated widgets (lock icon)
    - Preview-regardless-of-entitlement: all widgets shown with live previews
    - Gate-at-persistence: gated widget selection blocked
    - Entitlement revocation toast verified (F8.9)
    - All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetSettingsSheetTest" --tests "*.WidgetPickerTest" --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- WidgetSettingsSheet renders 3 tabs with correct content
- WidgetPicker shows live previews via scaled composables (F2.7)
- WidgetPicker groups widgets by pack, shows entitlement badges
- Gate-at-persistence: gated widgets previewable but not addable (F8.7)
- Entitlement revocation toast shown once (F8.9)
- NF-D1 speed disclaimer shown for speed/speed-limit widgets
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-08-SUMMARY.md`
</output>
