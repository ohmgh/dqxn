---
phase: 10-settings-foundation-setup-ui
plan: 06
type: execute
wave: 3
depends_on:
  - "10-01"
  - "10-02"
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettings.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/DeleteAllDataDialog.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/AnalyticsConsentDialog.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModelTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsTest.kt
autonomous: true
requirements:
  - F12.5
  - F14.2
  - F14.4

must_haves:
  truths:
    - "MainSettings renders 4 sections: Appearance, Behavior, Data & Privacy, Danger Zone"
    - "Analytics consent toggle defaults to OFF and persists preference"
    - "Delete All Data clears all DataStore instances and recreates default profile"
    - "Diagnostics navigation route exists (stub destination for Phase 11)"
    - "Consent dialog explains data collected and right to revoke before enabling"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettings.kt"
      provides: "4-section settings screen composable"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt"
      provides: "ViewModel with deleteAllData and analytics consent logic"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModelTest.kt"
      provides: "deleteAllData and analytics consent tests"
  key_links:
    - from: "MainSettingsViewModel.kt"
      to: "UserPreferencesRepository, ProviderSettingsStore, LayoutRepository"
      via: "Injected repository/store instances for clearAll"
      pattern: "clearAll"
    - from: "MainSettingsViewModel.kt"
      to: "AnalyticsTracker"
      via: "setEnabled for consent toggle"
      pattern: "setEnabled"
---

<objective>
Main settings screen with 4 sections, analytics consent toggle (PDPA/GDPR), and Delete All Data functionality.

Purpose: Global app settings hub. Analytics consent (F12.5) must default to OFF (opt-in). Delete All Data (F14.4) must clear all DataStores for GDPR compliance. Diagnostics navigation (F14.2) creates the route entry point for Phase 11.
Output: MainSettings composable, MainSettingsViewModel, consent/delete dialogs, tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md

@android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/settings/ProviderSettingsStore.kt
@android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepository.kt
@android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsTracker.kt
@android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStore.kt

# Prior plan summaries
@.planning/phases/10-settings-foundation-setup-ui/10-01-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: MainSettingsViewModel + delete all data + analytics consent</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModelTest.kt
  </files>
  <action>
    1. **MainSettingsViewModel.kt**: `@HiltViewModel` with injected dependencies:
       ```kotlin
       @HiltViewModel
       class MainSettingsViewModel @Inject constructor(
           private val userPreferencesRepository: UserPreferencesRepository,
           private val providerSettingsStore: ProviderSettingsStore,
           private val layoutRepository: LayoutRepository,
           private val pairedDeviceStore: PairedDeviceStore,
           private val widgetStyleStore: WidgetStyleStore,
           private val connectionEventStore: ConnectionEventStore,
           private val analyticsTracker: AnalyticsTracker,
       ) : ViewModel()
       ```

       Exposed state:
       - `analyticsConsent: StateFlow<Boolean>` -- collected from `userPreferencesRepository.analyticsConsent` via `stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), false)`.
       - `showStatusBar: StateFlow<Boolean>` -- from `userPreferencesRepository.showStatusBar`.
       - `orientationLock: StateFlow<String>` -- from `userPreferencesRepository.orientationLock`.
       - `keepScreenOn: StateFlow<Boolean>` -- from `userPreferencesRepository.keepScreenOn`.

       Actions:
       - `setAnalyticsConsent(enabled: Boolean)`: If enabling, set preference AND call `analyticsTracker.setEnabled(true)`. If disabling, call `analyticsTracker.setEnabled(false)` AND set preference. Order matters: disable tracker BEFORE persisting to prevent any events firing during the window.
       - `deleteAllData()`: suspend function that calls `clearAll()` on all 6 stores/repos in sequence: `userPreferencesRepository.clearAll()`, `providerSettingsStore.clearAll()`, `layoutRepository.clearAll()`, `pairedDeviceStore.clearAll()` (or equivalent clear method), `widgetStyleStore.clearAll()`, `connectionEventStore.clear()`. Then `analyticsTracker.setEnabled(false)` and `analyticsTracker.resetAnalyticsData()` (if available, otherwise call Firebase resetAnalyticsData through the tracker interface). After clearing, the app should be in factory state with a default profile.
       - `toggleStatusBar()`: delegates to `userPreferencesRepository.setShowStatusBar(!current)`.
       - `setOrientationLock(lock: String)`: delegates to repository.
       - `setKeepScreenOn(enabled: Boolean)`: delegates to repository.

    2. **MainSettingsViewModelTest.kt**: JUnit5 + MockK + Turbine:
       - **Analytics consent default**: Verify `analyticsConsent` starts as `false`.
       - **Enable analytics**: Call `setAnalyticsConsent(true)`, verify `analyticsTracker.setEnabled(true)` called, verify preference persisted as `true`.
       - **Disable analytics**: Call `setAnalyticsConsent(false)`, verify `analyticsTracker.setEnabled(false)` called BEFORE preference write.
       - **Delete all data**: Call `deleteAllData()`, verify `clearAll()` called on all stores/repos. Verify `analyticsTracker.setEnabled(false)` called. Use `coVerify` for suspend functions.
       - **Status bar toggle**: Verify `setShowStatusBar` called with toggled value.

       Use `StandardTestDispatcher` + `runTest`. Mock all repositories/stores.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.MainSettingsViewModelTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Analytics consent defaults to false (opt-in per PDPA/GDPR)
    - setAnalyticsConsent correctly enables/disables tracker and persists
    - deleteAllData clears all 6 stores/repos
    - Status bar and orientation lock delegate to preferences repository
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: MainSettings composable + dialogs + compose test</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettings.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/DeleteAllDataDialog.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/AnalyticsConsentDialog.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsTest.kt
  </files>
  <action>
    1. **MainSettings.kt**: 4-section settings screen in `OverlayScaffold(overlayType = OverlayType.Hub)`:

       **Section 1: Appearance**
       - Theme mode selection (navigate to ThemeSelector -- stub route for Phase 11)
       - Status bar toggle (calls `viewModel.toggleStatusBar()`)

       **Section 2: Behavior**
       - Orientation lock (landscape/portrait/auto)
       - Keep screen on toggle
       - Dash Packs (navigate to PackBrowserContent)

       **Section 3: Data & Privacy**
       - Analytics consent toggle. Shows current state from `viewModel.analyticsConsent`. Toggling ON shows `AnalyticsConsentDialog` first -- only enables after user confirms. Toggling OFF disables immediately.
       - Diagnostics (F14.2): navigation row -> diagnostics route (stub in Phase 10, full UI in Phase 11).

       **Section 4: Danger Zone**
       - Delete All Data button with destructive styling (red/error tint). Tapping shows `DeleteAllDataDialog`.

       Each section has header using `DashboardTypography.sectionHeader` at `TextEmphasis.Medium`.
       Rows use `DashboardSpacing.ItemGap` between items, `DashboardSpacing.SectionGap` between sections.
       All interactive elements >= 76dp (F10.4).

    2. **DeleteAllDataDialog.kt**: Confirmation dialog using `AlertDialog` with destructive styling:
       - Title: "Delete All Data"
       - Body: "This will permanently delete all your dashboards, settings, paired devices, and analytics data. This action cannot be undone."
       - Confirm button: red/error tint, text "Delete Everything"
       - Cancel button: standard
       - Animation: `DashboardMotion.dialogEnter/dialogExit` on dialog container.
       - On confirm: calls `viewModel.deleteAllData()` in coroutine scope, dismisses dialog.

    3. **AnalyticsConsentDialog.kt**: Consent explanation dialog:
       - Title: "Enable Analytics"
       - Body: "DQXN collects anonymous usage data to improve the app experience. Data collected includes: app usage patterns, widget configuration choices, crash reports. No personal information or location data is collected. You can revoke consent at any time from Settings."
       - Confirm button: "Enable Analytics"
       - Cancel button: "Not Now"
       - On confirm: calls `viewModel.setAnalyticsConsent(true)`, dismisses.
       - On cancel: dismisses without enabling (consent stays false).

    4. **MainSettingsTest.kt**: Robolectric Compose test:
       - **4 sections render**: Verify all 4 section headers appear via semantics text matching.
       - **Analytics toggle**: Mock ViewModel with analyticsConsent=false. Tap analytics toggle -> verify consent dialog appears. Confirm -> verify setAnalyticsConsent(true) called.
       - **Delete All Data flow**: Tap "Delete All Data" -> verify confirmation dialog appears with warning text. Tap "Delete Everything" -> verify deleteAllData() called.
       - **Diagnostics row**: Verify "Diagnostics" text renders and is clickable.

       Mock `MainSettingsViewModel` methods with MockK. Use `createComposeRule()`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.MainSettingsTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - MainSettings renders all 4 sections with correct design tokens
    - Analytics consent toggle shows dialog before enabling, disables immediately
    - Delete All Data shows confirmation dialog with destructive styling
    - Diagnostics navigation row renders (stub route for Phase 11)
    - All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.MainSettings*" --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- MainSettings renders 4 sections with correct design token usage
- Analytics consent defaults OFF, dialog shown before enabling, immediate disable
- Delete All Data clears all 6 stores/repos and calls analyticsTracker.setEnabled(false)
- Diagnostics navigation row exists (stub destination for Phase 11)
- ConfirmationDialog uses destructive styling for Delete All Data
- Consent dialog explains data collected and right to revoke
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-06-SUMMARY.md`
</output>
