---
phase: 10-settings-foundation-setup-ui
plan: 06
type: execute
wave: 2
depends_on:
  - "10-01"
  - "10-02"
  - "10-03"
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImpl.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupDefinitionRenderer.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupPermissionCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupToggleCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/PairedDeviceCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceLimitCounter.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/InstructionCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/InfoCard.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImplTest.kt
autonomous: true
requirements:
  - F3.4
  - F3.5
  - F3.14

must_haves:
  truths:
    - "SetupDefinitionRenderer dispatches all 7 SetupDefinition subtypes to correct cards"
    - "SetupPermissionCard shows 3 states: granted, can-request, permanently-denied"
    - "DeviceScanCard uses DeviceScanStateMachine for BLE pairing flow"
    - "SetupEvaluator has both evaluate() and evaluateWithPersistence() variants"
    - "Setting wrapper delegates to SettingRowDispatcher (two-layer dispatch)"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImpl.kt"
      provides: "Concrete SetupEvaluator with evaluate() and evaluateWithPersistence()"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupDefinitionRenderer.kt"
      provides: "7-type dispatch with three-layer visibility"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImplTest.kt"
      provides: "Real-time vs persistence evaluation tests"
  key_links:
    - from: "SetupDefinitionRenderer.kt"
      to: "SettingRowDispatcher.kt"
      via: "Setting wrapper two-layer dispatch"
      pattern: "SettingRowDispatcher"
    - from: "DeviceScanCard.kt"
      to: "DeviceScanStateMachine.kt"
      via: "State machine consumption"
      pattern: "DeviceScanStateMachine"
---

<objective>
Setup card composables, SetupDefinitionRenderer dispatch, and SetupEvaluator implementation.

Purpose: These are the building blocks for the setup wizard. Each card type renders one SetupDefinition subtype. The renderer dispatches to the correct card. The evaluator checks provider readiness. This plan creates all the atomic pieces; Plan 07 assembles them into the paginated SetupSheet flow.
Output: SetupEvaluatorImpl, SetupDefinitionRenderer, 7 setup card composables, evaluator tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/migration/replication-advisory.md (section 7)

@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/SetupDefinition.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/SetupEvaluator.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/VerificationStrategy.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/ServiceType.kt
@android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStore.kt

# Plan 01 provides SemanticColors + data extensions
@.planning/phases/10-settings-foundation-setup-ui/10-01-SUMMARY.md
# Plan 02 provides OverlayScaffold, build config
@.planning/phases/10-settings-foundation-setup-ui/10-02-SUMMARY.md
# Plan 03 provides DeviceScanStateMachine
@.planning/phases/10-settings-foundation-setup-ui/10-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SetupEvaluatorImpl + SetupDefinitionRenderer + evaluator test</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImpl.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupDefinitionRenderer.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImplTest.kt
  </files>
  <action>
    1. **SetupEvaluatorImpl.kt**: Concrete implementation of `SetupEvaluator` interface from `:sdk:contracts`. Two variants:
       - `evaluate(schema, context)`: Real-time check. For `RuntimePermission`: checks `ContextCompat.checkSelfPermission`. For `SystemServiceToggle`: calls the `checkEnabled` lambda. For `SystemService`: checks system service status. For `DeviceScan`: checks `isDeviceConnected()` (real-time). `minSdk` gating: if `RuntimePermission.minSdk > Build.VERSION.SDK_INT`, return `null` (skip entirely).
       - `evaluateWithPersistence(schema, context, pairedDeviceStore)`: Persistence-aware variant. Same as `evaluate()` except `DeviceScan` checks `pairedDeviceStore.wasPaired(definitionId)` -- device previously paired = satisfied even if currently disconnected.
       Both return `List<SetupResult>` with `(definitionId, satisfied, definition)`. `Setting`, `Instruction`, `Info` types always return `satisfied = true` (display-only, never block).
       Injectable via Hilt `@Inject constructor` + `@Singleton` scope.

    2. **SetupDefinitionRenderer.kt**: 7-type dispatch composable with three-layer visibility (same pattern as SettingRowDispatcher -- `hidden`, `visibleWhen`, `entitlement`). `when` on `SetupDefinition` subtype:
       - `RuntimePermission` -> `SetupPermissionCard`
       - `SystemServiceToggle` -> `SetupToggleCard`
       - `SystemService` -> `SetupToggleCard` (shared card, different check logic)
       - `DeviceScan` -> `DeviceScanCard`
       - `Instruction` -> `InstructionCard`
       - `Info` -> `InfoCard`
       - `Setting` -> `SettingRowDispatcher` (two-layer dispatch per replication advisory)

    3. **SetupEvaluatorImplTest.kt**: Unit tests with MockK:
       - Permission granted -> satisfied=true
       - Permission denied -> satisfied=false
       - minSdk > current -> null (skipped)
       - SystemServiceToggle enabled -> satisfied=true
       - DeviceScan with real-time: not connected -> satisfied=false
       - DeviceScan with persistence: wasPaired=true -> satisfied=true even if disconnected
       - Setting/Info/Instruction -> always satisfied=true
       All tests use `StandardTestDispatcher`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SetupEvaluatorImplTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - SetupEvaluatorImpl handles all 7 definition types with correct satisfaction logic
    - evaluate() uses real-time checks, evaluateWithPersistence() uses stored pairing state
    - SetupDefinitionRenderer dispatches all 7 types including Setting -> SettingRowDispatcher
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Setup card composables (Permission, Toggle, DeviceScan, PairedDevice, DeviceLimit, Instruction, Info)</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupPermissionCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupToggleCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/PairedDeviceCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceLimitCounter.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/InstructionCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/InfoCard.kt
  </files>
  <action>
    1. **SetupPermissionCard.kt**: 3-state permission card:
       - State 1 (All granted): Accent-tinted "Granted" label, no button.
       - State 2 (Can request): "Grant" button -> `launchMultiplePermissionRequest()` via `rememberLauncherForActivityResult(RequestMultiplePermissions)`. Native API, NOT Accompanist.
       - State 3 (Permanently denied): "Open Settings" button -> `Intent(ACTION_APPLICATION_DETAILS_SETTINGS)`.
       - **Critical**: `hasRequestedPermissions` local state guards against false permanent-denial detection (Pitfall 2). Pre-request state is indistinguishable from permanent denial without this guard.
       - 76dp minimum touch targets on buttons.

    2. **SetupToggleCard.kt**: Binary satisfied/unsatisfied state. Shows "Enable" button linking to system settings via intent when unsatisfied. Green checkmark when satisfied. Works for both `SystemServiceToggle` and `SystemService` types.

    3. **DeviceScanCard.kt**: UI wrapper around `DeviceScanStateMachine` (from Plan 03). Collects `stateMachine.state` as Compose state. Renders:
       - PreCDM: "Scan" button (disabled if at device limit)
       - Waiting: Loading indicator + "Searching..."
       - Verifying: Progress indicator + "Verifying (attempt N/3)..."
       - Success: Green checkmark + device name
       - Failed: Error message + auto-return indicator
       Already-paired devices shown as `PairedDeviceCard` list above scan button. CDM launch via `CompanionDeviceManager.associate()` wrapped in try-catch for `ActivityNotFoundException`/`UnsupportedOperationException` (Pitfall 4).

    4. **PairedDeviceCard.kt**: 3-state border: connected (accent), disconnected (secondary), forgetting (error). "Forget" button with AlertDialog confirmation and `forgettingMac: String?` guard against double-tap.

    5. **DeviceLimitCounter.kt**: "N/M devices" text, only visible when `pairedCount >= 2`.

    6. **InstructionCard.kt**: Bridge to `InstructionSettingRow` from Plan 05, adding step number badge rendering and verification state display.

    7. **InfoCard.kt**: Bridge to `InfoSettingRow` from Plan 04 with `SemanticColors` styling.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - SetupPermissionCard correctly implements 3-state logic with hasRequestedPermissions guard
    - DeviceScanCard wraps DeviceScanStateMachine with CDM error handling
    - PairedDeviceCard shows 3-state border with forget confirmation
    - All cards compile with correct design token usage
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SetupEvaluatorImplTest" :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- SetupEvaluatorImpl handles all 7 definition types with correct satisfaction logic
- SetupDefinitionRenderer dispatches all 7 types including Setting -> SettingRowDispatcher
- SetupPermissionCard handles 3 states with hasRequestedPermissions guard (Pitfall 2)
- DeviceScanCard integrates DeviceScanStateMachine with CDM error handling (Pitfall 4)
- Two-layer dispatch works: Setting wrapper -> SettingRowDispatcher
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-06-SUMMARY.md`
</output>
