---
phase: 10-settings-foundation-setup-ui
plan: 09
type: execute
wave: 3
depends_on:
  - "10-01"
  - "10-04"
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettings.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/DeleteAllDataDialog.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/AnalyticsConsentDialog.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModelTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsTest.kt
autonomous: true
requirements:
  - F12.5
  - F14.2
  - F14.4

must_haves:
  truths:
    - "MainSettings renders 4 sections: Appearance, Behavior, Data & Privacy, Danger Zone"
    - "Analytics consent toggle defaults to OFF and persists preference"
    - "Delete All Data clears all DataStore instances and recreates default profile"
    - "Diagnostics navigation route exists (stub destination for Phase 11)"
    - "Consent dialog explains data collected and right to revoke before enabling"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettings.kt"
      provides: "4-section settings screen composable"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt"
      provides: "ViewModel with deleteAllData and analytics consent logic"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModelTest.kt"
      provides: "deleteAllData and analytics consent tests"
  key_links:
    - from: "MainSettingsViewModel.kt"
      to: "UserPreferencesRepository, ProviderSettingsStore, LayoutRepository, WidgetStyleStore, PairedDeviceStore, ConnectionEventStore"
      via: "Injected repository/store instances for clearAll"
      pattern: "clearAll"
    - from: "MainSettingsViewModel.kt"
      to: "AnalyticsTracker"
      via: "setEnabled for consent toggle"
      pattern: "setEnabled"
---

<objective>
Main settings screen with 4 sections, analytics consent toggle (PDPA/GDPR), and Delete All Data functionality.

Purpose: Global app settings hub. Analytics consent (F12.5) must default to OFF (opt-in). Delete All Data (F14.4) must clear all DataStores for GDPR compliance. Diagnostics navigation (F14.2) creates the route entry point for Phase 11.
Output: MainSettings composable, MainSettingsViewModel, consent/delete dialogs, tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md

@android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/settings/ProviderSettingsStore.kt
@android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepository.kt
@android/data/src/main/kotlin/app/dqxn/android/data/style/WidgetStyleStore.kt
@android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStore.kt
@android/data/src/main/kotlin/app/dqxn/android/data/device/ConnectionEventStore.kt
@android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsTracker.kt

# Plan 01 provides clearAll on all stores + analyticsConsent
@.planning/phases/10-settings-foundation-setup-ui/10-01-SUMMARY.md
# Plan 04 provides SettingRowDispatcher (for potential reuse in settings rows)
@.planning/phases/10-settings-foundation-setup-ui/10-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: MainSettingsViewModel + delete all data + analytics consent</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModelTest.kt
  </files>
  <action>
    1. **MainSettingsViewModel.kt**: `@HiltViewModel` with injected dependencies:
       ```kotlin
       @HiltViewModel
       class MainSettingsViewModel @Inject constructor(
           private val userPreferencesRepository: UserPreferencesRepository,
           private val providerSettingsStore: ProviderSettingsStore,
           private val layoutRepository: LayoutRepository,
           private val pairedDeviceStore: PairedDeviceStore,
           private val widgetStyleStore: WidgetStyleStore,
           private val connectionEventStore: ConnectionEventStore,
           private val analyticsTracker: AnalyticsTracker,
       ) : ViewModel()
       ```

       Exposed state:
       - `analyticsConsent: StateFlow<Boolean>` -- from `userPreferencesRepository.analyticsConsent` via `stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), false)`.
       - Other preference flows as needed (showStatusBar, orientationLock, keepScreenOn).

       Actions:
       - `setAnalyticsConsent(enabled: Boolean)`: If enabling, set preference AND call `analyticsTracker.setEnabled(true)`. If disabling, call `analyticsTracker.setEnabled(false)` AND set preference. Order matters: disable tracker BEFORE persisting.
       - `deleteAllData()`: suspend function that calls `clearAll()` on all 6 stores/repos: `userPreferencesRepository.clearAll()`, `providerSettingsStore.clearAll()`, `layoutRepository.clearAll()`, `pairedDeviceStore.clearAll()`, `widgetStyleStore.clearAll()`, `connectionEventStore.clear()`. Then `analyticsTracker.setEnabled(false)`.

    2. **MainSettingsViewModelTest.kt**: JUnit5 + MockK + Turbine:
       - **Analytics consent default**: Verify `analyticsConsent` starts as `false`.
       - **Enable analytics**: Call `setAnalyticsConsent(true)`, verify `analyticsTracker.setEnabled(true)` called.
       - **Disable analytics**: Call `setAnalyticsConsent(false)`, verify `analyticsTracker.setEnabled(false)` called BEFORE preference write.
       - **Delete all data**: Call `deleteAllData()`, verify `clearAll()` called on ALL 6 stores/repos (UserPreferences, ProviderSettings, LayoutRepository, WidgetStyleStore, PairedDeviceStore, ConnectionEventStore). Verify `analyticsTracker.setEnabled(false)` called.
       Use `StandardTestDispatcher` + `runTest`. Mock all repositories/stores.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.MainSettingsViewModelTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Analytics consent defaults to false (opt-in per PDPA/GDPR)
    - setAnalyticsConsent correctly enables/disables tracker and persists
    - deleteAllData clears all 6 stores/repos including WidgetStyleStore and PairedDeviceStore
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: MainSettings composable + dialogs + compose test</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettings.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/DeleteAllDataDialog.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/AnalyticsConsentDialog.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsTest.kt
  </files>
  <action>
    1. **MainSettings.kt**: 4-section settings screen in `OverlayScaffold(overlayType = OverlayType.Hub)`:
       **Section 1: Appearance** - Theme mode selection (stub route), Status bar toggle.
       **Section 2: Behavior** - Orientation lock, Keep screen on toggle, Dash Packs navigation.
       **Section 3: Data & Privacy** - Analytics consent toggle (dialog before enabling, immediate disable). Diagnostics navigation row (F14.2, stub route).
       **Section 4: Danger Zone** - Delete All Data button with destructive styling.
       Design tokens: `DashboardTypography.sectionHeader`, `TextEmphasis.Medium`, `DashboardSpacing.ItemGap/SectionGap`. All interactive >= 76dp (F10.4).

    2. **DeleteAllDataDialog.kt**: Confirmation dialog with destructive styling. Title: "Delete All Data". Confirm: red "Delete Everything". Animation: `DashboardMotion.dialogEnter/dialogExit`.

    3. **AnalyticsConsentDialog.kt**: Consent explanation dialog. Title: "Enable Analytics". Body explains collected data and right to revoke. Confirm: "Enable Analytics". Cancel: "Not Now".

    4. **MainSettingsTest.kt**: Robolectric Compose test:
       - **4 sections render**: Verify all 4 section headers.
       - **Analytics toggle**: Tap analytics -> consent dialog appears -> confirm -> setAnalyticsConsent(true) called.
       - **Delete All Data flow**: Tap button -> confirmation dialog -> "Delete Everything" -> deleteAllData() called.
       - **Diagnostics row**: Verify clickable row renders.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.MainSettingsTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - MainSettings renders all 4 sections with correct design tokens
    - Analytics consent toggle shows dialog before enabling
    - Delete All Data shows confirmation with destructive styling
    - Diagnostics navigation row renders
    - All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.MainSettings*" --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- MainSettings renders 4 sections with correct design token usage
- Analytics consent defaults OFF, dialog shown before enabling, immediate disable
- Delete All Data clears all 6 stores/repos (including WidgetStyleStore and PairedDeviceStore)
- Diagnostics navigation row exists (stub destination for Phase 11)
- Consent dialog explains data collected and right to revoke
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-09-SUMMARY.md`
</output>
