---
phase: 10-settings-foundation-setup-ui
plan: 04
type: execute
wave: 2
depends_on:
  - "10-01"
  - "10-02"
  - "10-03"
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupSheet.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupDefinitionRenderer.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupNavigationBar.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupPermissionCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupToggleCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/PairedDeviceCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceLimitCounter.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/InstructionCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/InfoCard.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImpl.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImplTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupSheetTest.kt
autonomous: true
requirements:
  - F3.3
  - F3.4
  - F3.5
  - F3.14

must_haves:
  truths:
    - "SetupSheet renders multi-page paginated flow with forward gating"
    - "SetupDefinitionRenderer dispatches all 7 SetupDefinition subtypes to correct cards"
    - "SetupPermissionCard shows 3 states: granted, can-request, permanently-denied"
    - "DeviceScanCard uses DeviceScanStateMachine for BLE pairing flow"
    - "SetupEvaluator has both evaluate() and evaluateWithPersistence() variants"
    - "evaluationTrigger pattern forces re-evaluation after async events"
    - "Setting wrapper delegates to SettingRowDispatcher (two-layer dispatch)"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupSheet.kt"
      provides: "Fullscreen paginated setup flow"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImpl.kt"
      provides: "Concrete SetupEvaluator with evaluate() and evaluateWithPersistence()"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImplTest.kt"
      provides: "Real-time vs persistence evaluation tests"
  key_links:
    - from: "SetupSheet.kt"
      to: "SetupDefinitionRenderer.kt"
      via: "Per-item rendering within page"
      pattern: "SetupDefinitionRenderer"
    - from: "SetupDefinitionRenderer.kt"
      to: "SettingRowDispatcher.kt"
      via: "Setting wrapper two-layer dispatch"
      pattern: "SettingRowDispatcher"
    - from: "DeviceScanCard.kt"
      to: "DeviceScanStateMachine.kt"
      via: "State machine consumption"
      pattern: "DeviceScanStateMachine"
---

<objective>
Setup wizard UI: multi-page paginated flow for provider setup, all 7 setup definition card types, and SetupEvaluator implementation.

Purpose: The setup wizard is the provider readiness gateway -- permissions, system services, BLE device pairing, and instructions. This plan builds the complete setup flow consumed when users tap "Setup Required" on a widget or navigate to provider setup from widget settings.
Output: SetupSheet, 10 setup card composables, SetupEvaluatorImpl, tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/migration/replication-advisory.md (section 7)

@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/SetupDefinition.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/SetupPageDefinition.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/SetupEvaluator.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/VerificationStrategy.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/ServiceType.kt
@android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStore.kt

# Prior plan summaries needed for SettingRowDispatcher + DeviceScanStateMachine
@.planning/phases/10-settings-foundation-setup-ui/10-02-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SetupEvaluatorImpl + setup card composables</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImpl.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupDefinitionRenderer.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupPermissionCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupToggleCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/PairedDeviceCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceLimitCounter.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/InstructionCard.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/InfoCard.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupEvaluatorImplTest.kt
  </files>
  <action>
    1. **SetupEvaluatorImpl.kt**: Concrete implementation of `SetupEvaluator` interface from `:sdk:contracts`. Two variants:

       - `evaluate(schema, context)`: Real-time check. For `RuntimePermission`: checks `ContextCompat.checkSelfPermission`. For `SystemServiceToggle`: calls the `checkEnabled` lambda. For `SystemService`: checks system service status. For `DeviceScan`: checks `isDeviceConnected()` (real-time). `minSdk` gating: if `RuntimePermission.minSdk > Build.VERSION.SDK_INT`, return `null` (skip entirely).

       - `evaluateWithPersistence(schema, context, pairedDeviceStore)`: Persistence-aware variant. Same as `evaluate()` except `DeviceScan` checks `pairedDeviceStore.wasPaired(definitionId)` -- device previously paired = satisfied even if currently disconnected. Used in setup flow to allow proceeding without device present.

       Both return `List<SetupResult>` with `(definitionId, satisfied, definition)`.

       `Setting`, `Instruction`, `Info` types always return `satisfied = true` (display-only, never block).

       Injectable via Hilt `@Inject constructor` + `@Singleton` scope.

    2. **SetupDefinitionRenderer.kt**: 7-type dispatch composable with three-layer visibility (same pattern as SettingRowDispatcher -- `hidden`, `visibleWhen`, `entitlement`). `when` on `SetupDefinition` subtype:
       - `RuntimePermission` -> `SetupPermissionCard`
       - `SystemServiceToggle` -> `SetupToggleCard`
       - `SystemService` -> `SetupToggleCard` (shared card, different check logic)
       - `DeviceScan` -> `DeviceScanCard`
       - `Instruction` -> `InstructionCard`
       - `Info` -> `InfoCard`
       - `Setting` -> `SettingRowDispatcher` (two-layer dispatch per replication advisory)

    3. **SetupPermissionCard.kt**: 3-state permission card:
       - State 1 (All granted): Accent-tinted "Granted" label, no button.
       - State 2 (Can request): "Grant" button -> `launchMultiplePermissionRequest()` via `rememberLauncherForActivityResult(RequestMultiplePermissions)`. Native API, NOT Accompanist.
       - State 3 (Permanently denied): "Open Settings" button -> `Intent(ACTION_APPLICATION_DETAILS_SETTINGS)`.
       - **Critical**: `hasRequestedPermissions` local state guards against false permanent-denial detection (Pitfall 2). Pre-request state is indistinguishable from permanent denial without this guard.
       - 76dp minimum touch targets on buttons.

    4. **SetupToggleCard.kt**: Binary satisfied/unsatisfied state. Shows "Enable" button linking to system settings via intent when unsatisfied. Green checkmark when satisfied. Works for both `SystemServiceToggle` and `SystemService` types.

    5. **DeviceScanCard.kt**: UI wrapper around `DeviceScanStateMachine` (from Plan 03). Collects `stateMachine.state` as Compose state. Renders:
       - PreCDM: "Scan" button (disabled if at device limit)
       - Waiting: Loading indicator + "Searching..."
       - Verifying: Progress indicator + "Verifying (attempt N/3)..."
       - Success: Green checkmark + device name
       - Failed: Error message + auto-return indicator
       Already-paired devices shown as `PairedDeviceCard` list above scan button. CDM launch via `CompanionDeviceManager.associate()` wrapped in try-catch for `ActivityNotFoundException`/`UnsupportedOperationException` (Pitfall 4).

    6. **PairedDeviceCard.kt**: 3-state border: connected (accent), disconnected (secondary), forgetting (error). "Forget" button with AlertDialog confirmation and `forgettingMac: String?` guard against double-tap.

    7. **DeviceLimitCounter.kt**: "N/M devices" text, only visible when `pairedCount >= 2`.

    8. **InstructionCard.kt**: Bridge to `InstructionSettingRow` from Plan 02, adding step number badge rendering and verification state display.

    9. **InfoCard.kt**: Bridge to `InfoSettingRow` from Plan 02 with `SemanticColors` styling.

    10. **SetupEvaluatorImplTest.kt**: Unit tests with MockK:
        - Permission granted -> satisfied=true
        - Permission denied -> satisfied=false
        - minSdk > current -> null (skipped)
        - SystemServiceToggle enabled -> satisfied=true
        - DeviceScan with real-time: not connected -> satisfied=false
        - DeviceScan with persistence: wasPaired=true -> satisfied=true even if disconnected
        - Setting/Info/Instruction -> always satisfied=true
        All tests use `StandardTestDispatcher`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SetupEvaluatorImplTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - SetupEvaluatorImpl handles all 7 definition types with correct satisfaction logic
    - evaluate() uses real-time checks, evaluateWithPersistence() uses stored pairing state
    - SetupDefinitionRenderer dispatches all 7 types including Setting -> SettingRowDispatcher
    - SetupPermissionCard correctly implements 3-state logic with hasRequestedPermissions guard
    - DeviceScanCard wraps DeviceScanStateMachine with CDM error handling
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: SetupSheet paginated flow + navigation + test</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupSheet.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupNavigationBar.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupSheetTest.kt
  </files>
  <action>
    1. **SetupSheet.kt**: Fullscreen paginated setup flow (NOT a bottom sheet despite the name).
       - Parameters: `setupSchema: List<SetupPageDefinition>`, `providerId: String`, `providerSettingsStore: ProviderSettingsStore`, `pairedDeviceStore: PairedDeviceStore`, `evaluator: SetupEvaluator`, `entitlementManager: EntitlementManager`, `onComplete: () -> Unit`, `onDismiss: () -> Unit`.
       - `currentPage: Int` state with `AnimatedContent` directional transitions (`slideInHorizontally/slideOutHorizontally` based on `targetState > initialState`).
       - **Settings loading**: One-shot `produceState` from `providerSettingsStore.getAllSettings(packId, providerId)`. Local `currentSettings: MutableMap<String, Any?>` for in-memory mutations. Immediate write-through on change (no debounce).
       - **evaluationTrigger** counter pattern (Pitfall: without counter, LaunchedEffect won't re-run after permission grants):
         ```kotlin
         var evaluationTrigger by remember { mutableIntStateOf(0) }
         LifecycleResumeEffect(Unit) { evaluationTrigger++; onPauseOrDispose {} }
         LaunchedEffect(providerId, evaluationTrigger) {
             satisfiedDefinitions = evaluator.evaluateWithPersistence(...)
                 .filter { it.satisfied }.map { it.definitionId }.toSet()
         }
         ```
       - **Forward navigation gating**: `Setting` types always satisfied; only requirement types block. Done button on final page uses same check.
       - **Buttons alpha-dimmed (50%) when disabled but remain tappable** -- do NOT use `enabled = false` on buttons per Pitfall 6.
       - **Two exclusive BackHandlers** (Pitfall 5):
         - BackHandler(enabled = currentPage > 0) { currentPage-- }
         - BackHandler(enabled = currentPage == 0) { onDismiss() }
         Don't unify -- exclusivity is load-bearing.
       - Per-page: iterate `page.items`, render each through `SetupDefinitionRenderer`.
       - `onComplete` fires on Done tap, but settings are already persisted per-change (no transaction boundary).

    2. **SetupNavigationBar.kt**: Bottom bar with:
       - Page indicator dots
       - "Next" button (alpha 50% when page not satisfied, but tappable)
       - "Done" button on final page (same gating)
       - Back button (goes to previous page)
       - All buttons 76dp minimum touch target (F10.4).

    3. **SetupSheetTest.kt**: Robolectric Compose test:
       - **Multi-page navigation**: Create 2-page schema, verify page 1 renders, tap Next, verify page 2 renders.
       - **Forward gating**: Page with unsatisfied RuntimePermission, verify Next button is alpha-dimmed (not disabled -- tappable but dimmed).
       - **Back navigation**: Navigate to page 2, tap Back, verify page 1 renders.
       - **Completion**: Satisfied final page, tap Done, verify `onComplete` callback fires.
       - **Dismissal**: On page 0, press Back, verify `onDismiss` fires.
       - **Setting type always satisfies**: Page with only Setting items, verify forward navigation ungated.

       Mock `SetupEvaluator`, `ProviderSettingsStore`, `EntitlementManager` with MockK.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SetupSheetTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - SetupSheet renders multi-page flow with AnimatedContent transitions
    - Forward gating blocks only on unsatisfied requirement types
    - evaluationTrigger counter re-evaluates on lifecycle resume
    - Two exclusive BackHandlers work correctly for page back vs dismiss
    - Buttons are alpha-dimmed (not disabled) when gated
    - SetupSheetTest passes: navigation, gating, completion, dismissal
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.Setup*" --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- SetupSheet renders multi-page paginated flow
- SetupDefinitionRenderer dispatches all 7 types with three-layer visibility
- SetupPermissionCard handles 3 states with hasRequestedPermissions guard
- DeviceScanCard integrates DeviceScanStateMachine with CDM error handling
- SetupEvaluator has both evaluate() and evaluateWithPersistence() variants
- Two BackHandler instances maintain exclusivity
- evaluationTrigger forces re-evaluation after async events
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-04-SUMMARY.md`
</output>
