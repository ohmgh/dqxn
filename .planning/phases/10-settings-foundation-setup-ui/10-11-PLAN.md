---
phase: 10-settings-foundation-setup-ui
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt
autonomous: true
gap_closure: true
requirements: [F2.7, F8.7]

must_haves:
  truths:
    - "WidgetPicker renders each widget's Render() composable inside a scaled-down preview area with demo data"
    - "WidgetPicker shows a GPS icon badge on widgets whose compatible snapshots indicate location/speed data"
    - "WidgetPicker shows no hardware icon on widgets that don't require GPS or BLE"
    - "Preview rendering failure for one widget does not crash the picker or affect other widgets"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
      provides: "Live preview via widget.Render() + hardware icon badges"
      contains: "widget.Render("
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt"
      provides: "Tests for live preview rendering + hardware icon badge logic"
      contains: "hardware icon"
  key_links:
    - from: "WidgetPicker.kt"
      to: "WidgetRenderer.Render()"
      via: "CompositionLocalProvider(LocalWidgetData provides WidgetData.Empty)"
      pattern: "CompositionLocalProvider.*LocalWidgetData"
    - from: "WidgetPicker.kt"
      to: "WidgetSpec.compatibleSnapshots"
      via: "snapshot class name heuristic for GPS/BLE/NONE"
      pattern: "deriveHardwareIcon\\|HardwareRequirement"
---

<objective>
Close two verification gaps in WidgetPicker.kt, both sub-criteria of F2.7 and F8.7:

1. **No live widget preview** — WidgetPicker currently renders a plain Box where the live preview should be. Must call `widget.Render()` inside a `CompositionLocalProvider(LocalWidgetData provides WidgetData.Empty)` with a `graphicsLayer` scale-down effect.

2. **No data type icons (GPS/BLE/none)** — F2.7 requires "required data type icons" in the widget picker. Must derive hardware requirement from `WidgetSpec.compatibleSnapshots` class names and render a small GPS/BLE/no-icon badge.

Purpose: Complete F2.7 and F8.7 widget picker requirements. Without live previews, users cannot visually identify widgets before adding them. Without hardware icons, users cannot anticipate which widgets need GPS or BLE.

Output: Updated WidgetPicker.kt with live previews + hardware icon badges, updated WidgetPickerTest.kt with tests for both features.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/phases/10-settings-foundation-setup-ui/10-VERIFICATION.md
@.planning/phases/10-settings-foundation-setup-ui/10-08-SUMMARY.md
@android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
@android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetRenderer.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetSpec.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetData.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetStyle.kt
@android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/LocalWidgetData.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add live widget preview rendering + hardware icon badges to WidgetPicker</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
  </files>
  <action>
Modify WidgetPickerCard in WidgetPicker.kt to add two features:

**1. Live preview via widget.Render()**

Inside the existing "Live preview area" Box (lines 182-200), replace the empty Box content with a `CompositionLocalProvider` that feeds demo data to the widget's `Render()` composable:

```kotlin
CompositionLocalProvider(LocalWidgetData provides WidgetData.Empty) {
    // Scale-down preview with graphicsLayer for isolated RenderNode
    Box(
        modifier = Modifier
            .fillMaxSize()
            .graphicsLayer {
                scaleX = 0.5f
                scaleY = 0.5f
            },
        contentAlignment = Alignment.Center,
    ) {
        widget.Render(
            isEditMode = false,
            style = WidgetStyle.Default,
            settings = persistentMapOf(),
            modifier = Modifier.fillMaxSize(),
        )
    }
}
```

Wrap the entire preview area content in a `key(widget.typeId)` block and use a `var renderFailed by remember { mutableStateOf(false) }` pattern. If `renderFailed` is true, skip the Render() call and show the plain Box fallback (theme background only). This ensures one widget's render failure doesn't cascade.

Since Compose forbids try-catch around @Composable calls, use `SideEffect` or the existing error fallback pattern: if the Render() composable throws during composition, it will be caught by Compose's error handling. The `renderFailed` flag is a secondary safety net — set it in a `DisposableEffect`'s `onDispose` callback if an error state is detected. Actually, the simplest safe approach: wrap in a `Box` with `Modifier.clipToBounds()` and let the Compose framework handle render errors. The WidgetSlot in dashboard already uses the error boundary pattern from Phase 7 — for preview purposes, the scaled-down preview in a clipped box is sufficient protection.

**Imports needed:**
- `import app.dqxn.android.sdk.ui.widget.LocalWidgetData`
- `import app.dqxn.android.sdk.contracts.widget.WidgetData`
- `import app.dqxn.android.sdk.contracts.widget.WidgetStyle`
- `import androidx.compose.ui.graphics.graphicsLayer` (already imported via other compose imports)
- `import kotlinx.collections.immutable.persistentMapOf`
- `import androidx.compose.foundation.layout.size` (if needed)

Keep the lock icon overlay for gated widgets — it renders ON TOP of the preview (the existing `if (!isAccessible)` block stays, positioned in the outer Box with `contentAlignment = Alignment.Center` overlapping the preview).

**2. Hardware requirement icon badge**

Add a `HardwareRequirement` private enum at the top of the file:

```kotlin
private enum class HardwareRequirement { GPS, BLUETOOTH, NONE }
```

Add a derivation function that inspects `WidgetSpec.compatibleSnapshots` class names to determine the hardware icon:

```kotlin
private fun deriveHardwareRequirement(
    compatibleSnapshots: Set<KClass<out DataSnapshot>>,
): HardwareRequirement {
    val names = compatibleSnapshots.mapNotNull { it.simpleName }
    return when {
        names.any { name ->
            name.contains("Speed", ignoreCase = true) ||
            name.contains("Solar", ignoreCase = true) && !name.contains("Timezone", ignoreCase = true)
        } -> HardwareRequirement.GPS
        names.any { name ->
            name.contains("Ble", ignoreCase = true) ||
            name.contains("Bluetooth", ignoreCase = true)
        } -> HardwareRequirement.BLUETOOTH
        else -> HardwareRequirement.NONE
    }
}
```

**Key mapping rationale:**
- SpeedSnapshot → GPS (GpsSpeedProvider is the primary/only speed provider)
- SolarSnapshot (from SolarLocationDataProvider) → GPS (requires location permissions). However, SolarTimezoneDataProvider also produces SolarSnapshot without GPS. Since the widget is compatible with both providers, and the location-based one requires GPS, showing the GPS icon is correct (warns users they MAY need GPS).
- AccelerationSnapshot → NOT GPS (uses device accelerometer, not location)
- OrientationSnapshot → NOT GPS (uses magnetometer)
- All others (TimeSnapshot, BatterySnapshot, AmbientLightSnapshot, SpeedLimitSnapshot) → NONE

Render the hardware icon as a small badge in the bottom-end corner of the preview area Box:

```kotlin
val hwReq = remember(widget.compatibleSnapshots) {
    deriveHardwareRequirement(widget.compatibleSnapshots)
}

// After the preview content, inside the outer Box:
if (hwReq != HardwareRequirement.NONE) {
    Icon(
        imageVector = when (hwReq) {
            HardwareRequirement.GPS -> Icons.Filled.LocationOn
            HardwareRequirement.BLUETOOTH -> Icons.Filled.Bluetooth
            else -> return@Box
        },
        contentDescription = when (hwReq) {
            HardwareRequirement.GPS -> "Requires GPS"
            HardwareRequirement.BLUETOOTH -> "Requires Bluetooth"
            else -> null
        },
        tint = theme.secondaryTextColor.copy(alpha = 0.8f),
        modifier = Modifier
            .align(Alignment.BottomEnd)
            .padding(4.dp)
            .size(16.dp)
            .testTag("widget_hw_${widget.typeId}"),
    )
}
```

Note: `Icons.Filled.LocationOn` and `Icons.Filled.Bluetooth` are in the extended icons library which is already in build.gradle.kts (`libs.compose.material.icons.extended`).

**Important: keep the existing lock icon overlay** — both can coexist. Lock icon is centered, hardware icon is bottom-end.

Content descriptions for hardware icons should use string resources from `strings.xml`. Add two new strings:
```xml
<string name="widget_picker_requires_gps">Requires GPS</string>
<string name="widget_picker_requires_bluetooth">Requires Bluetooth</string>
```
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
    <sampling_rate>run after task commits, before Task 2 begins</sampling_rate>
  </verify>
  <done>
    WidgetPickerCard calls widget.Render() inside CompositionLocalProvider(LocalWidgetData provides WidgetData.Empty) with graphicsLayer scale-down. Hardware icon badge renders for GPS-requiring widgets (Speed, Solar). Non-GPS/BLE widgets show no hardware icon. Lock icon overlay preserved for gated widgets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for live preview rendering + hardware icon badge logic</name>
  <files>
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt
  </files>
  <action>
Add 4 new tests to the existing WidgetPickerTest.kt:

**Test 1: `widget preview calls Render composable`**
- Create a test widget using `mockk<WidgetRenderer>(relaxed = true)` (existing pattern)
- Set `compatibleSnapshots` to `emptySet()`
- Set content with `freeEntitlementManager`
- Verify the preview area tag exists: `onNodeWithTag("widget_preview_essentials:clock-digital", useUnmergedTree = true).assertExists()`
- Verify that `widget.Render()` was called via MockK `verify`: `verify { widget.Render(any(), any(), any(), any()) }`
- Note: MockK relaxed mocks return Unit for @Composable functions — the Render() call will succeed but render nothing visible. The test confirms the call happens.

**Test 2: `GPS hardware icon shown for speed-compatible widget`**
- Create a test widget with `compatibleSnapshots` containing a mock KClass whose `simpleName` is `"SpeedSnapshot"`
- Create the mock KClass: `val speedKClass = mockk<KClass<out DataSnapshot>>()` with `every { speedKClass.simpleName } returns "SpeedSnapshot"`
- Set `every { renderer.compatibleSnapshots } returns setOf(speedKClass)`
- Set content, verify `onNodeWithTag("widget_hw_essentials:speedometer", useUnmergedTree = true).assertExists()`

**Test 3: `no hardware icon for time-only widget`**
- Create a test widget with `compatibleSnapshots` containing a mock KClass whose `simpleName` is `"TimeSnapshot"`
- Set content, verify `onNodeWithTag("widget_hw_essentials:clock-digital", useUnmergedTree = true).assertDoesNotExist()`

**Test 4: `GPS icon for solar-compatible widget`**
- Create a test widget with typeId `"essentials:solar"` and `compatibleSnapshots` containing a mock KClass whose `simpleName` is `"SolarSnapshot"`
- Set content, verify `onNodeWithTag("widget_hw_essentials:solar", useUnmergedTree = true).assertExists()`

**Helper updates:**
- Update `createTestWidget` helper to accept a `compatibleSnapshots` parameter (default `emptySet()`):
  ```kotlin
  private fun createTestWidget(
      typeId: String,
      displayName: String,
      requiredEntitlements: Set<String>? = null,
      compatibleSnapshots: Set<KClass<out DataSnapshot>> = emptySet(),
  ): WidgetRenderer
  ```
- Wire `every { renderer.compatibleSnapshots } returns compatibleSnapshots` in the helper

**Import additions needed:**
- `import app.dqxn.android.sdk.contracts.provider.DataSnapshot`
- `import kotlin.reflect.KClass`
- `import io.mockk.verify`
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetPickerTest" --console=plain 2>&1 | tail -20</automated>
    <sampling_rate>run after task commits</sampling_rate>
  </verify>
  <done>
    12 tests pass in WidgetPickerTest (8 existing + 4 new). New tests verify: (1) Render() composable is called inside preview area, (2) GPS icon shown for speed-compatible widget, (3) no icon for time-only widget, (4) GPS icon for solar-compatible widget.
  </done>
</task>

</tasks>

<verification>
```bash
# All WidgetPicker tests pass (8 existing + 4 new)
cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetPickerTest" --console=plain

# Full feature:settings test suite still passes
cd android && ./gradlew :feature:settings:testDebugUnitTest --console=plain

# Verify live preview wiring exists in source
grep -n "widget.Render(" android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
grep -n "LocalWidgetData provides" android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
grep -n "HardwareRequirement" android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
grep -n "widget_hw_" android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
```
</verification>

<success_criteria>
1. `widget.Render()` is called inside WidgetPickerCard's preview area Box via `CompositionLocalProvider(LocalWidgetData provides WidgetData.Empty)`
2. Preview area uses `graphicsLayer` scale-down (0.5f) for scaled composable appearance
3. GPS icon badge renders on widgets with Speed/Solar-compatible snapshots
4. No icon renders on widgets with Time/Battery/AmbientLight-only snapshots
5. Lock icon overlay preserved and coexists with hardware icon
6. All 12 WidgetPickerTest tests pass (8 existing + 4 new)
7. Full `:feature:settings` test suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-11-SUMMARY.md`
</output>
