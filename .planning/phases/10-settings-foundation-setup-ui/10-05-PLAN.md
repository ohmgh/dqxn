---
phase: 10-settings-foundation-setup-ui
plan: 05
type: execute
wave: 2
depends_on:
  - "10-01"
  - "10-02"
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheet.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/FeatureSettingsContent.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/DataProviderSettingsContent.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetInfoContent.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/PackBrowserContent.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheetTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt
autonomous: true
requirements:
  - F2.7
  - F2.8
  - F8.1
  - F8.7
  - F8.9

must_haves:
  truths:
    - "WidgetSettingsSheet shows 3 tabs: Feature, Data Source, Info"
    - "FeatureSettingsContent renders widget settings schema via SettingRowDispatcher"
    - "DataProviderSettingsContent shows available providers for widget's data types"
    - "WidgetInfoContent shows widget description, issues, and NF-D1 speed disclaimer"
    - "WidgetPicker groups widgets by pack with entitlement badges"
    - "Gated widgets show lock icon but are still previewable"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheet.kt"
      provides: "3-tab widget settings pager"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
      provides: "Widget picker grid grouped by pack"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheetTest.kt"
      provides: "3-tab navigation + schema rendering tests"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt"
      provides: "Widget grouping + entitlement badge tests"
  key_links:
    - from: "FeatureSettingsContent.kt"
      to: "SettingRowDispatcher.kt"
      via: "Settings schema rendering"
      pattern: "SettingRowDispatcher"
    - from: "WidgetPicker.kt"
      to: "WidgetRegistry"
      via: "Widget discovery"
      pattern: "widgetRegistry\\.getAll"
    - from: "WidgetInfoContent.kt"
      to: "WidgetSpec.description"
      via: "Widget description display"
      pattern: "description"
---

<objective>
Widget settings sheet (3-tab pager) and widget picker (grouped grid with entitlement badges).

Purpose: These are the two primary widget-interaction overlay surfaces. WidgetSettingsSheet is the per-widget configuration UI (Feature/Data Source/Info tabs). WidgetPicker is the widget selection grid shown from the Add Widget button.
Output: WidgetSettingsSheet with 3 tab contents, WidgetPicker with pack grouping and entitlement gating, PackBrowserContent for pack navigation, tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/migration/replication-advisory.md (section 1, 7)

@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetSpec.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetRenderer.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/registry/WidgetRegistry.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/registry/DataProviderRegistry.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/entitlement/EntitlementManager.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/entitlement/Gated.kt

# Prior plan summaries for SettingRowDispatcher + OverlayScaffold
@.planning/phases/10-settings-foundation-setup-ui/10-01-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: WidgetSettingsSheet + 3 tab contents</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheet.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/FeatureSettingsContent.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/DataProviderSettingsContent.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/widget/WidgetInfoContent.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/widget/WidgetSettingsSheetTest.kt
  </files>
  <action>
    1. **WidgetSettingsSheet.kt**: 3-tab pager wrapping OverlayScaffold.
       - Parameters: `widgetId: String`, `widgetRegistry: WidgetRegistry`, `dataProviderRegistry: DataProviderRegistry`, `providerSettingsStore: ProviderSettingsStore`, `entitlementManager: EntitlementManager`, `onDismiss: () -> Unit`, `onNavigate: (SettingNavigation) -> Unit`, `onNavigateToSetup: (String) -> Unit`, `onNavigateToPackBrowser: (String) -> Unit`.
       - Look up widget via `widgetRegistry.get(widgetTypeId)` to get `WidgetSpec`.
       - `HorizontalPager` with 3 pages + `TabRow` at top:
         - Tab 0: "Feature" -> `FeatureSettingsContent`
         - Tab 1: "Data Source" -> `DataProviderSettingsContent`
         - Tab 2: "Info" -> `WidgetInfoContent`
       - Title shows widget display name from `WidgetSpec.displayName`.
       - Uses `OverlayScaffold(overlayType = OverlayType.Preview)` per replication advisory section 1.
       - Dismissal: `onDismiss()` callback, NOT `popBackStack()` per advisory -- caller handles `navigate(Empty) { popUpTo<WidgetSettings> { inclusive = true } }`.

    2. **FeatureSettingsContent.kt**: Widget feature settings tab.
       - Loads current settings from `providerSettingsStore.getAllSettings(packId, providerId)` via `collectAsState()` (Layer 1 -- `collectAsStateWithLifecycle` since this is an overlay).
       - Renders `WidgetSpec.settingsSchema` items through `SettingRowDispatcher`.
       - Value changes write through to `providerSettingsStore.setSetting()` immediately.
       - Passes `onNavigate` for sub-pickers (timezone, date format, app, sound).

    3. **DataProviderSettingsContent.kt**: Data source selection tab.
       - Shows available providers for the widget's compatible data types via `dataProviderRegistry.getByDataType(dataType)`.
       - Current provider highlighted with accent color.
       - Provider cards show: name, data type, connection status indicator (green/red dot), priority badge (HARDWARE > DEVICE_SENSOR > NETWORK > SIMULATED).
       - Selecting a different provider fires callback to update widget binding.
       - Providers with setup requirements show "Setup Required" badge; tap navigates to setup via `onNavigateToSetup(providerId)`.

    4. **WidgetInfoContent.kt**: Widget info + issues tab.
       - Displays: widget type name, pack name (from typeId prefix), `WidgetSpec.description`, compatible data types list.
       - **NF-D1 speed disclaimer**: For widgets with `essentials:speedometer`, `essentials:speed-limit-circle`, `essentials:speed-limit-rect` typeIds, include disclaimer text from Android string resource: "Speed and speed limit data are approximate. Always refer to your vehicle speedometer and posted signs."
       - Issues section: if widget has status issues from `WidgetStatusCache`, show them with resolution actions (navigate to setup, navigate to settings).
       - "View Pack" button navigates to `PackBrowserContent` via `onNavigateToPackBrowser(packId)`.

    5. **WidgetSettingsSheetTest.kt**: Robolectric Compose test:
       - **Tab navigation**: Verify 3 tabs render (Feature, Data Source, Info), swipe between tabs, verify content changes.
       - **Schema rendering**: Create mock WidgetSpec with settingsSchema containing BooleanSetting + EnumSetting, verify FeatureSettingsContent renders them via semantics.
       - **Provider listing**: Mock DataProviderRegistry returning 2 providers for data type, verify DataProviderSettingsContent renders both.
       - **Speed disclaimer**: For speedometer typeId, verify disclaimer text renders in WidgetInfoContent.

       Mock WidgetRegistry, DataProviderRegistry, ProviderSettingsStore, EntitlementManager with MockK.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetSettingsSheetTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - WidgetSettingsSheet renders 3-tab pager with correct content per tab
    - FeatureSettingsContent renders settings schema via SettingRowDispatcher
    - DataProviderSettingsContent lists providers with status and priority
    - WidgetInfoContent shows description, disclaimer for speed widgets, issues
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: WidgetPicker + PackBrowserContent + tests</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/PackBrowserContent.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerTest.kt
  </files>
  <action>
    1. **WidgetPicker.kt**: Widget selection grid displayed from Add Widget button.
       - Parameters: `widgetRegistry: WidgetRegistry`, `entitlementManager: EntitlementManager`, `onSelectWidget: (String) -> Unit` (typeId), `onDismiss: () -> Unit`.
       - Group widgets by pack: `widgets.groupBy { it.typeId.substringBefore(':') }.toImmutableMap()`.
       - Per-pack section with pack name header.
       - Widget cards in staggered grid showing:
         - Widget display name from `WidgetSpec.displayName`
         - One-line description from `WidgetSpec.description`
         - Required data type icons (GPS/BLE/none derived from setup schema)
         - **Entitlement badge** (F8.7): Lock icon on gated widgets. All widgets shown regardless of entitlement (preview-regardless-of-entitlement). Adding a gated widget checks `Gated.isAccessible(entitlementManager)` -- if not accessible, show "Coming soon" toast instead of adding.
       - `StubEntitlementManager` treats all as free (F8.1), so no lock icons in V1 but UI structure must support them.
       - Uses `OverlayScaffold(overlayType = OverlayType.Hub)` (full-screen).
       - Minimum touch targets 76dp on widget cards (F10.4).

    2. **PackBrowserContent.kt**: Pack list accessible from Settings > Behavior or WidgetInfoContent.
       - Shows all packs with: name, widget count, entitlement status.
       - Each pack card navigable to filtered widget list.
       - Debug builds: entitlement toggle for testing (visible only in debug via `BuildConfig.DEBUG` check on app module -- for now, just leave the toggle composable conditionally visible, actual BuildConfig check deferred to overlay wiring since feature module doesn't have its own BuildConfig).
       - Uses `OverlayScaffold(overlayType = OverlayType.Hub)`.

    3. **WidgetPickerTest.kt**: Robolectric Compose test:
       - **Grouping**: Create 3 widgets from 2 packs, verify grouped under correct pack headers via semantics.
       - **Entitlement badge**: Create widget with `requiredAnyEntitlement = listOf("plus")`, mock EntitlementManager returning false, verify lock icon renders.
       - **Selection callback**: Tap a widget card, verify `onSelectWidget` fires with correct typeId.
       - **Accessible widget adds**: Mock EntitlementManager returning true, tap widget, verify callback fires.
       - **Gated widget blocks**: Mock EntitlementManager returning false, tap gated widget, verify `onSelectWidget` NOT called (gated at persistence per F8.7).

       Mock WidgetRegistry, EntitlementManager with MockK.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetPickerTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - WidgetPicker groups widgets by pack with correct headers
    - Entitlement badges render on gated widgets (lock icon)
    - Preview-regardless-of-entitlement: all widgets shown
    - Gate-at-persistence: gated widget selection blocked with feedback
    - PackBrowserContent shows pack list with widget counts
    - All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetSettingsSheetTest" --tests "*.WidgetPickerTest" --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- WidgetSettingsSheet renders 3 tabs with correct content
- FeatureSettingsContent renders widget settings schema through SettingRowDispatcher
- DataProviderSettingsContent shows available providers with status
- WidgetInfoContent includes NF-D1 speed disclaimer for speed/speed-limit widgets
- WidgetPicker groups widgets by pack, shows entitlement badges
- Gate-at-persistence: gated widgets previewable but not addable
- PackBrowserContent shows pack navigation
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-05-SUMMARY.md`
</output>
