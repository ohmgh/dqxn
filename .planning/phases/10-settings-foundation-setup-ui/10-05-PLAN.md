---
phase: 10-settings-foundation-setup-ui
plan: 05
type: execute
wave: 2
depends_on:
  - "10-02"
  - "10-04"
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/InstructionSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/AppPickerSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/DateFormatSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/TimezoneSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SoundPickerSettingRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/UriSettingRow.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcherTest.kt
autonomous: true
requirements:
  - F2.9
  - F10.4

must_haves:
  truths:
    - "All 12 SettingDefinition subtypes dispatch to correct row composables"
    - "InstructionSettingRow dual-executes action + navigation callback"
    - "TimezoneSettingRow handles null/SYSTEM/specific zone display"
    - "SettingRowDispatcherTest validates all 12 subtypes, visibility, entitlement, value change"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/InstructionSettingRow.kt"
      provides: "Step badge + action button + dual execution"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcherTest.kt"
      provides: "Parameterized test for 12 subtypes + visibility + entitlement"
  key_links:
    - from: "InstructionSettingRow.kt"
      to: "SettingNavigation.OnInstructionAction"
      via: "Dual execution callback"
      pattern: "OnInstructionAction"
---

<objective>
Complete the setting row system: remaining 6 row types + comprehensive SettingRowDispatcher test.

Purpose: Fills in the remaining when-branches of the dispatcher with Instruction, AppPicker, DateFormat, Timezone, SoundPicker, and Uri rows. The dispatcher test validates all 12 subtypes, visibility gating, entitlement gating, and value change propagation.
Output: All 12 row composables implemented, SettingRowDispatcherTest.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md

@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/settings/SettingDefinition.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/settings/SettingsEnums.kt

# Plan 02 provides SettingsNavigation, OverlayScaffold
@.planning/phases/10-settings-foundation-setup-ui/10-02-SUMMARY.md
# Plan 04 provides SettingRowDispatcher + first 6 rows
@.planning/phases/10-settings-foundation-setup-ui/10-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remaining 6 row types (Instruction, AppPicker, DateFormat, Timezone, SoundPicker, Uri)</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/InstructionSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/AppPickerSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/DateFormatSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/TimezoneSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/SoundPickerSettingRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/row/UriSettingRow.kt
  </files>
  <action>
    1. **InstructionSettingRow**: Step number badge + action button + description. `executeInstructionAction()` fires locally AND calls `onNavigate(SettingNavigation.OnInstructionAction(...))` per Pitfall 7 (dual execution -- row handles launch, callback handles verification tracking). Step badge renders with accent color circle + white number.

    2. **AppPickerSettingRow**: Shows current app name resolved from package name (or "None selected"). Taps fire `onNavigate(SettingNavigation.ToAppPicker(key, currentPackage))`. Package name -> app name resolution via `PackageManager.getApplicationLabel()` with fallback to package name. 76dp row height.

    3. **DateFormatSettingRow**: Shows live date preview formatted with current `DateFormatOption`. Taps fire `onNavigate(SettingNavigation.ToDateFormatPicker(key, currentValue))`. Display current date/time with selected format. Use `java.time` APIs.

    4. **TimezoneSettingRow**: Displays city name + GMT offset. Three display states:
       - `null` -> system timezone with "System Default" subtitle
       - `"SYSTEM"` -> system timezone display without subtitle (avoid duplicate per advisory)
       - else -> parse zone ID, extract city from last "/" segment, format GMT offset via `formatGmtOffset()`
       Taps fire `onNavigate(SettingNavigation.ToTimezonePicker(key, currentValue))`.

    5. **SoundPickerSettingRow**: Shows current ringtone name via `RingtoneManager.getRingtone(context, uri).getTitle(context)` with fallback to "Default". Button launches system `ACTION_RINGTONE_PICKER` via `ActivityResultLauncher` integration. Note: actual `ActivityResultLauncher` registration happens at the parent composable level; this row fires a callback that triggers the launcher.

    6. **UriSettingRow**: Generic URI display with "Select" action. SettingLabel showing current URI or "Not set". Taps fire `onNavigate` for the URI sub-picker. Minimal -- this is the catch-all type.

    7. **Update SettingRowDispatcher.kt**: Replace the `else` fallback for these 6 types with proper dispatch branches.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - All 12 SettingDefinition subtypes dispatch to dedicated row composables
    - InstructionSettingRow fires both local action AND navigation callback (dual execution)
    - TimezoneSettingRow handles null/SYSTEM/specific zone display correctly
    - SoundPickerSettingRow displays ringtone name from URI
  </done>
</task>

<task type="auto">
  <name>Task 2: SettingRowDispatcherTest -- parameterized dispatch + visibility + entitlement</name>
  <files>
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/row/SettingRowDispatcherTest.kt
  </files>
  <action>
    1. **SettingRowDispatcherTest.kt**: Robolectric test with `createComposeRule()`:
       - **Parameterized render test**: Create one instance of each 12 `SettingDefinition` subtype with defaults, render through `SettingRowDispatcher`, assert non-empty content via semantics (`onAllNodesWithText` or `onNodeWithTag`). Use test tags on each row type for identification.
       - **Visibility gating test**: Create a `BooleanSetting` with `hidden = true`, verify nothing renders. Create one with `visibleWhen = { it["other"] == true }`, verify hidden when `currentSettings = emptyMap()` (per Pitfall 1 -- `null != false` is `true`, so visible when map empty), then visible when `currentSettings = mapOf("other" to true)`.
       - **Entitlement gating test**: Create a setting with `requiredAnyEntitlement = listOf("plus")`, mock `EntitlementManager` returning false for "plus", verify setting not rendered. Return true -> verify rendered.
       - **Value change test**: Render a `BooleanSetting`, toggle the switch, verify `onValueChanged` callback fires with correct key and new value.

       Use `StandardTestDispatcher` (never Unconfined). Mock `EntitlementManager` and `DashboardThemeDefinition` with MockK.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SettingRowDispatcherTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - SettingRowDispatcherTest passes: 12-subtype render, visibility gating, entitlement gating, value change propagation
    - visibleWhen null-safety verified (empty map = visible)
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SettingRowDispatcherTest" --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- All 12 SettingDefinition subtypes dispatch to correct row composables
- InstructionSettingRow dual-executes action + nav callback (Pitfall 7)
- TimezoneSettingRow handles 3 display states correctly
- visibleWhen treats null map values as default-visible (Pitfall 1)
- EnumSetting compares with toString fallback (Pitfall 3)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-05-SUMMARY.md`
</output>
