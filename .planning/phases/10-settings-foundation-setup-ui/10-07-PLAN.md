---
phase: 10-settings-foundation-setup-ui
plan: 07
type: execute
wave: 3
depends_on:
  - "10-04"
  - "10-05"
  - "10-06"
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
  - android/feature/dashboard/build.gradle.kts
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostTest.kt
autonomous: true
requirements:
  - F2.7
  - F2.8
  - F8.9
  - F10.4

must_haves:
  truths:
    - "OverlayNavHost has 4 new routes: WidgetPicker, Settings, WidgetSettings, Setup"
    - "Type-safe @Serializable route classes replace string-based routing"
    - "DashboardScreen wires button bar clicks to overlay navigation"
    - "WidgetSettings uses ExitTransition.None / EnterTransition.None per advisory"
    - "Back navigation from each overlay returns to dashboard correctly"
    - "editingWidgetId derived from back-stack scan for WidgetSettings route"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt"
      provides: "@Serializable route classes for type-safe navigation"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt"
      provides: "NavHost with 4 populated routes + transition specs"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostTest.kt"
      provides: "Route rendering + back navigation tests"
  key_links:
    - from: "DashboardScreen.kt"
      to: "OverlayNavHost"
      via: "navController navigation calls"
      pattern: "navController\\.navigate"
    - from: "OverlayNavHost.kt"
      to: "OverlayRoutes.kt"
      via: "composable<RouteType> registration"
      pattern: "composable<"
    - from: "DashboardScreen.kt"
      to: "editingWidgetId back-stack scan"
      via: "navController.currentBackStack scanning for WidgetSettings"
      pattern: "hasRoute<.*WidgetSettings>"
---

<objective>
Wire all Phase 10 overlay surfaces into the OverlayNavHost and connect DashboardScreen button bar to navigation.

Purpose: This is the integration plan that connects all individual UI components (Plans 02-06) into the navigation graph. The OverlayNavHost gets its first real routes, DashboardScreen gets its button bar callbacks, and the editingWidgetId back-stack scan enables widget preview mode.
Output: Populated OverlayNavHost, type-safe routes, DashboardScreen navigation wiring, integration tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/migration/replication-advisory.md (section 1, 2, 4)

@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt
@android/feature/dashboard/build.gradle.kts

# Prior plan summaries
@.planning/phases/10-settings-foundation-setup-ui/10-01-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-04-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-05-SUMMARY.md
@.planning/phases/10-settings-foundation-setup-ui/10-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Type-safe routes + OverlayNavHost population</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
    android/feature/dashboard/build.gradle.kts
  </files>
  <action>
    1. **build.gradle.kts**: Add `:feature:settings` dependency to `:feature:dashboard`:
       ```kotlin
       implementation(project(":feature:settings"))
       ```
       This allows OverlayNavHost to compose settings module composables. Check if this creates any circular dependency issues -- `:feature:settings` does NOT depend on `:feature:dashboard`, so the dependency is unidirectional.

    2. **OverlayRoutes.kt**: Type-safe route classes using `@Serializable`:
       ```kotlin
       @Serializable data object EmptyRoute
       @Serializable data object WidgetPickerRoute
       @Serializable data object SettingsRoute
       @Serializable data class WidgetSettingsRoute(val widgetId: String)
       @Serializable data class SetupRoute(val providerId: String)
       ```
       These replace the string-based `ROUTE_EMPTY = "empty"`. Migration: keep `ROUTE_EMPTY` as deprecated alias during transition, but new code uses type-safe routes.

    3. **OverlayNavHost.kt**: Replace empty NavHost with populated routes.

       **Route registration using `composable<RouteType>` syntax:**

       - `composable<EmptyRoute>` -- empty (Layer 0 visible)

       - `composable<WidgetPickerRoute>` with enter: `DashboardMotion.hubEnter`, exit: `DashboardMotion.hubExit`:
         Wire to `WidgetPicker(widgetRegistry, entitlementManager, onSelectWidget, onDismiss)`.
         `onSelectWidget`: create `DashboardWidgetInstance` with optimal position from `GridPlacementEngine`, dispatch `AddWidget` command, navigate back to `EmptyRoute`.
         `onDismiss`: `navController.navigate(EmptyRoute) { popUpTo<WidgetPickerRoute> { inclusive = true } }`.

       - `composable<SettingsRoute>` with enter/exit: source-varying per advisory section 2 & 4:
         - Exit to preview overlays (WidgetSettings): `fadeOut(100ms)`
         - Exit to hubs (PackBrowser): `ExitTransition.None`
         - PopEnter from preview overlays: `DashboardMotion.previewEnter`
         - PopEnter from hubs: `EnterTransition.None`
         Wire to `MainSettings(viewModel, onDismiss, onNavigate)`.
         `onDismiss`: `navController.navigate(EmptyRoute) { popUpTo<SettingsRoute> { inclusive = true } }`.

       - `composable<WidgetSettingsRoute>` with `exitTransition = { ExitTransition.None }`, `popEnterTransition = { EnterTransition.None }` per advisory section 2 (widget settings stays in composition under hubs):
         Wire to `WidgetSettingsSheet(widgetId, registries, stores, onDismiss, onNavigate)`.
         `onDismiss`: `navController.navigate(EmptyRoute) { popUpTo<WidgetSettingsRoute> { inclusive = true } }` -- NOT `popBackStack()` per advisory section 1.

       - `composable<SetupRoute>` with `DashboardMotion.hubEnter/hubExit`:
         Wire to `SetupSheet(schema, providerId, stores, evaluator, onComplete, onDismiss)`.

       **Additional parameters on OverlayNavHost**: Add `widgetRegistry: WidgetRegistry`, `dataProviderRegistry: DataProviderRegistry`, `providerSettingsStore: ProviderSettingsStore`, `entitlementManager: EntitlementManager`, `setupEvaluator: SetupEvaluator`, `pairedDeviceStore: PairedDeviceStore`, `layoutCoordinator: LayoutCoordinator`. These are injected at the DashboardScreen level from the ViewModel and passed through.

       **ClearPreviewTheme on Settings enter**: Add `LaunchedEffect(Unit) { onCommand(DashboardCommand.PreviewTheme(null)) }` inside Settings route per advisory section 3 race condition fix.

    4. Remove `ROUTE_EMPTY` constant. Replace all references with `EmptyRoute`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - OverlayNavHost has 5 route registrations (Empty, WidgetPicker, Settings, WidgetSettings, Setup)
    - Type-safe @Serializable routes replace string-based routing
    - WidgetSettings uses ExitTransition.None / EnterTransition.None per advisory
    - Settings has source-varying transitions
    - ClearPreviewTheme fired on Settings entry (race condition fix)
  </done>
</task>

<task type="auto">
  <name>Task 2: DashboardScreen navigation wiring + editingWidgetId + tests</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostTest.kt
  </files>
  <action>
    1. **DashboardScreen.kt**: Wire button bar callbacks and add editingWidgetId derivation.

       **Button bar callbacks** (replace empty lambda placeholders):
       - `onSettingsClick`: `navController.navigate(SettingsRoute)`
       - `onAddWidgetClick`: `navController.navigate(WidgetPickerRoute)`

       **editingWidgetId back-stack scan** (per replication advisory section 1):
       ```kotlin
       val editingWidgetId by remember {
           derivedStateOf {
               navController.currentBackStack.value
                   .lastOrNull { it.destination.hasRoute<WidgetSettingsRoute>() }
                   ?.toRoute<WidgetSettingsRoute>()?.widgetId
           }
       }
       ```
       This is load-bearing: child routes (Setup, timezone picker, etc.) preserve the peek because WidgetSettings is still in the back stack. Only checking `currentEntry` would collapse the preview.

       **Pass editingWidgetId to DashboardLayer** for widget preview mode (existing parameter, currently null). When non-null, the focused widget stays visible and other widgets fade out per advisory section 1.

       **Overlay hasOverlay detection**: Migrate from string route check to type-safe:
       ```kotlin
       val hasOverlay = currentEntry?.destination?.hasRoute<EmptyRoute>() == false
       ```

       **Pass new dependencies to OverlayNavHost**: Thread through WidgetRegistry, DataProviderRegistry, ProviderSettingsStore, EntitlementManager, SetupEvaluator, PairedDeviceStore from ViewModel or DI. The ViewModel already exposes `widgetRegistry`. For others, either add them to ViewModel or inject via `hiltViewModel()` at the OverlayNavHost level. Preferred: add missing dependencies to ViewModel constructor as `val` parameters (public, same pattern as existing `widgetRegistry`).

    2. **DashboardViewModel.kt**: Add public val parameters needed by OverlayNavHost:
       - `val dataProviderRegistry: DataProviderRegistry`
       - `val providerSettingsStore: ProviderSettingsStore`
       - `val entitlementManager: EntitlementManager`
       - `val setupEvaluator: SetupEvaluator`
       - `val pairedDeviceStore: PairedDeviceStore`

       These are already available in the DI graph (registered in Phase 5-8 modules). The ViewModel just needs to expose them for composable access.

    3. **OverlayNavHostTest.kt**: Robolectric Compose test:
       - **Empty route renders**: Create NavHost with EmptyRoute, verify no overlay content.
       - **Settings route renders**: Navigate to SettingsRoute, verify MainSettings content appears (section headers via semantics).
       - **WidgetPicker route renders**: Navigate to WidgetPickerRoute, verify picker content appears.
       - **Back from Settings**: Navigate to Settings, navigate back, verify EmptyRoute (no overlay).
       - **WidgetSettings route preserves in back stack**: Navigate to WidgetSettingsRoute, then to SetupRoute, verify WidgetSettingsRoute still in back stack (back-stack scan finds it).

       This test operates at the NavHost level, mocking the composable dependencies. Use `createComposeRule()` + `TestNavHostController`.

       Mock WidgetRegistry, DataProviderRegistry, ProviderSettingsStore, EntitlementManager, SetupEvaluator with MockK. Create minimal fakes returning empty lists/maps.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.OverlayNavHostTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - DashboardScreen button bar navigates to Settings and WidgetPicker overlays
    - editingWidgetId derived from back-stack scan (not current entry)
    - hasOverlay uses type-safe route check
    - ViewModel exposes additional dependencies for overlay composables
    - OverlayNavHostTest passes: route rendering, back navigation, back-stack preservation
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest :feature:settings:testDebugUnitTest --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- OverlayNavHost has 5 routes (Empty, WidgetPicker, Settings, WidgetSettings, Setup)
- Type-safe @Serializable routes used throughout (no string routes)
- DashboardScreen button bar clicks navigate to correct overlays
- editingWidgetId derived from back-stack scan (preview mode persists across child routes)
- WidgetSettings uses ExitTransition.None / EnterTransition.None
- Settings has source-varying transitions per advisory
- ClearPreviewTheme race condition fix applied
- Back navigation returns to dashboard (EmptyRoute) correctly
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-07-SUMMARY.md`
</output>
