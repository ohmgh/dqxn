---
phase: 10-settings-foundation-setup-ui
plan: 07
type: execute
wave: 3
depends_on:
  - "10-05"
  - "10-06"
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupSheet.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupNavigationBar.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupSheetTest.kt
autonomous: true
requirements:
  - F3.3
  - F3.14

must_haves:
  truths:
    - "SetupSheet renders multi-page paginated flow with forward gating"
    - "evaluationTrigger pattern forces re-evaluation after async events"
    - "Two exclusive BackHandlers handle page back vs dismiss"
    - "Buttons are alpha-dimmed (not disabled) when gated"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupSheet.kt"
      provides: "Fullscreen paginated setup flow"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupSheetTest.kt"
      provides: "Multi-page navigation + gating + completion tests"
  key_links:
    - from: "SetupSheet.kt"
      to: "SetupDefinitionRenderer.kt"
      via: "Per-item rendering within page"
      pattern: "SetupDefinitionRenderer"
---

<objective>
SetupSheet paginated flow assembling the setup cards from Plan 06 into a multi-page wizard with navigation, forward gating, and lifecycle-aware evaluation.

Purpose: This is the complete provider setup experience. Users navigate through permission grants, service toggles, BLE pairing, and configuration before a provider is ready. The evaluationTrigger pattern handles async state changes (returning from system settings, completing BLE pairing).
Output: SetupSheet, SetupNavigationBar, SetupSheetTest.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/migration/replication-advisory.md (section 7)

@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/SetupPageDefinition.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/setup/SetupEvaluator.kt

# Plan 05 provides completed SettingRowDispatcher
@.planning/phases/10-settings-foundation-setup-ui/10-05-SUMMARY.md
# Plan 06 provides SetupDefinitionRenderer + cards + evaluator
@.planning/phases/10-settings-foundation-setup-ui/10-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SetupSheet + SetupNavigationBar</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupSheet.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/SetupNavigationBar.kt
  </files>
  <action>
    1. **SetupSheet.kt**: Fullscreen paginated setup flow (NOT a bottom sheet despite the name).
       - Parameters: `setupSchema: List<SetupPageDefinition>`, `providerId: String`, `providerSettingsStore: ProviderSettingsStore`, `pairedDeviceStore: PairedDeviceStore`, `evaluator: SetupEvaluator`, `entitlementManager: EntitlementManager`, `onComplete: () -> Unit`, `onDismiss: () -> Unit`.
       - `currentPage: Int` state with `AnimatedContent` directional transitions (`slideInHorizontally/slideOutHorizontally` based on `targetState > initialState`).
       - **Settings loading**: One-shot `produceState` from `providerSettingsStore.getAllSettings(packId, providerId)`. Local `currentSettings: MutableMap<String, Any?>` for in-memory mutations. Immediate write-through on change (no debounce).
       - **evaluationTrigger** counter pattern (Pitfall: without counter, LaunchedEffect won't re-run after permission grants):
         ```kotlin
         var evaluationTrigger by remember { mutableIntStateOf(0) }
         LifecycleResumeEffect(Unit) { evaluationTrigger++; onPauseOrDispose {} }
         LaunchedEffect(providerId, evaluationTrigger) {
             satisfiedDefinitions = evaluator.evaluateWithPersistence(...)
                 .filter { it.satisfied }.map { it.definitionId }.toSet()
         }
         ```
       - **Forward navigation gating**: `Setting` types always satisfied; only requirement types block. Done button on final page uses same check.
       - **Buttons alpha-dimmed (50%) when disabled but remain tappable** -- do NOT use `enabled = false` on buttons per Pitfall 6.
       - **Two exclusive BackHandlers** (Pitfall 5):
         - BackHandler(enabled = currentPage > 0) { currentPage-- }
         - BackHandler(enabled = currentPage == 0) { onDismiss() }
         Don't unify -- exclusivity is load-bearing.
       - Per-page: iterate `page.items`, render each through `SetupDefinitionRenderer`.
       - `onComplete` fires on Done tap, but settings are already persisted per-change (no transaction boundary).

    2. **SetupNavigationBar.kt**: Bottom bar with:
       - Page indicator dots
       - "Next" button (alpha 50% when page not satisfied, but tappable)
       - "Done" button on final page (same gating)
       - Back button (goes to previous page)
       - All buttons 76dp minimum touch target (F10.4).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - SetupSheet renders multi-page flow with AnimatedContent transitions
    - Forward gating blocks only on unsatisfied requirement types
    - evaluationTrigger counter re-evaluates on lifecycle resume
    - Two exclusive BackHandlers work correctly for page back vs dismiss
    - Buttons are alpha-dimmed (not disabled) when gated
  </done>
</task>

<task type="auto">
  <name>Task 2: SetupSheetTest</name>
  <files>
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/SetupSheetTest.kt
  </files>
  <action>
    1. **SetupSheetTest.kt**: Robolectric Compose test:
       - **Multi-page navigation**: Create 2-page schema, verify page 1 renders, tap Next, verify page 2 renders.
       - **Forward gating**: Page with unsatisfied RuntimePermission, verify Next button is alpha-dimmed (not disabled -- tappable but dimmed).
       - **Back navigation**: Navigate to page 2, tap Back, verify page 1 renders.
       - **Completion**: Satisfied final page, tap Done, verify `onComplete` callback fires.
       - **Dismissal**: On page 0, press Back, verify `onDismiss` fires.
       - **Setting type always satisfies**: Page with only Setting items, verify forward navigation ungated.

       Mock `SetupEvaluator`, `ProviderSettingsStore`, `EntitlementManager` with MockK.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SetupSheetTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>
    - SetupSheetTest passes: navigation, gating, completion, dismissal
    - Setting-only pages always ungated
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.SetupSheetTest" --console=plain 2>&1 | tail -30
```
</verification>

<success_criteria>
- SetupSheet renders multi-page paginated flow
- Two BackHandler instances maintain exclusivity (Pitfall 5)
- evaluationTrigger forces re-evaluation after async events
- Buttons alpha-dimmed not disabled (Pitfall 6)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-07-SUMMARY.md`
</output>
