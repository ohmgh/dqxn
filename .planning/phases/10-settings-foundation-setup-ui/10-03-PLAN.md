---
phase: 10-settings-foundation-setup-ui
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanStateMachine.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanStateMachineTest.kt
autonomous: true
requirements:
  - F3.14
  - NF29

must_haves:
  truths:
    - "DeviceScanStateMachine transitions through all 5 states correctly"
    - "Verification retries up to 3 times with 2000ms delay between attempts"
    - "Failed state auto-returns to PreCDM after 1500ms"
    - "User cancellation returns to PreCDM cleanly"
    - "Device limit enforcement prevents scanning when at max capacity"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanStateMachine.kt"
      provides: "5-state BLE scan state machine with CDM verification"
      contains: "sealed interface ScanState"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanStateMachineTest.kt"
      provides: "State transition tests, retry logic, timeout handling"
  key_links:
    - from: "DeviceScanStateMachine.kt"
      to: "ScanState sealed interface"
      via: "MutableStateFlow state transitions"
      pattern: "_state\\.value ="
---

<objective>
Pure-logic BLE device scan state machine extracted from UI. Highest-complexity component in Phase 10.

Purpose: The DeviceScanStateMachine encapsulates the 5-state CDM BLE pairing lifecycle as a testable non-UI class. Separating ~300 lines of pure logic from ~450 lines of UI enables thorough testing without Compose dependencies. This is a TDD candidate -- well-defined state transitions with clear I/O.
Output: DeviceScanStateMachine class + comprehensive unit tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-settings-foundation-setup-ui/10-RESEARCH.md
@.planning/migration/replication-advisory.md (section 7)
</context>

<feature>
  <name>DeviceScanStateMachine</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanStateMachine.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/setup/DeviceScanStateMachineTest.kt
  </files>
  <behavior>
    5-state machine for BLE device pairing via Companion Device Manager:

    States:
    - PreCDM: initial state, ready to scan
    - Waiting: CDM dialog shown, waiting for user selection
    - Verifying(device, attempt, maxAttempts=3): device selected, running onPaired callback
    - Success(device): verification passed, device paired
    - Failed(device?, error): verification failed after all retries or error occurred

    Transitions:
    - PreCDM -> Waiting: onScanStarted()
    - Waiting -> Verifying(attempt=1): onDeviceFound(device)
    - Verifying -> Success: onVerificationResult(success=true)
    - Verifying(attempt < 3) -> Verifying(attempt+1): onVerificationResult(success=false) after 2000ms delay
    - Verifying(attempt == 3) -> Failed: onVerificationResult(success=false)
    - Failed -> PreCDM: auto after 1500ms
    - Waiting -> PreCDM: onUserCancelled() (silent, no error)
    - Any -> PreCDM: reset()

    Additional behaviors:
    - isAtDeviceLimit(currentCount, maxDevices): returns true when currentCount >= maxDevices
    - onCdmError(error): transitions to Failed with error message
    - CDM cancel detection: "user_rejected"/"canceled" in error -> silent PreCDM return

    Test cases:
    - Happy path: PreCDM -> scan -> found -> verify success -> Success
    - Retry path: verify fail -> retry (x2) -> verify success on 3rd
    - Exhausted retries: verify fail x3 -> Failed
    - User cancel from Waiting: -> PreCDM (no error)
    - User cancel during Verifying: -> PreCDM + cancellation
    - CDM error (non-cancel): -> Failed with error message
    - CDM cancel error (user_rejected): -> PreCDM silently
    - Failed auto-return: Failed -> 1500ms -> PreCDM
    - Device limit: isAtDeviceLimit(3, 3) == true
    - Reset from any state: always returns to PreCDM
    - Retry delay: 2000ms between Verifying attempts
  </behavior>
  <implementation>
    Pure Kotlin class with:
    - `MutableStateFlow<ScanState>` for observable state
    - `CoroutineScope` parameter for delay-based transitions (retries, auto-return)
    - All transition methods are non-suspend (they launch coroutines internally for delays)
    - No Android/Compose dependencies -- pure logic only
    - No BluetoothDevice reference in state (use MAC address string + device name instead to avoid Android dependency in tests)

    Key design decisions:
    - Device represented as `ScanDevice(name: String, macAddress: String, associationId: Int?)` data class instead of BluetoothDevice
    - Retry delay (2000ms) and auto-return delay (1500ms) are constructor params for testability
    - Max attempts (3) configurable via constructor
    - Internal `verificationJob: Job?` cancelled on user cancel or reset
    - CDM cancel detection via string matching on error message ("user_rejected", "canceled")
  </implementation>
</feature>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.DeviceScanStateMachineTest" --console=plain 2>&1 | tail -20
```
</verification>

<success_criteria>
- All 5 states reachable and correctly typed
- Happy path completes PreCDM -> Waiting -> Verifying -> Success
- Retry logic correctly increments attempt count with 2000ms delay
- Exhausted retries (attempt == maxAttempts) transitions to Failed
- Failed auto-returns to PreCDM after 1500ms
- User cancellation from any state returns to PreCDM
- CDM error with "user_rejected"/"canceled" -> silent PreCDM (not Failed)
- Device limit check prevents scan when at capacity
- Reset() works from every state
- All tests use StandardTestDispatcher with virtual time
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-foundation-setup-ui/10-03-SUMMARY.md`
</output>
