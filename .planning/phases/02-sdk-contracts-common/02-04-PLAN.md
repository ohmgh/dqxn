---
phase: 02-sdk-contracts-common
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetDataTest.kt
  - android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetStyleTest.kt
  - android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetContextTest.kt
  - android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/entitlement/GatedTest.kt
  - android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/settings/SettingDefinitionTest.kt
  - android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/setup/SetupDefinitionTest.kt
  - android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/fault/ProviderFaultTest.kt
autonomous: true
requirements: [F2.4, F2.5]

must_haves:
  truths:
    - "WidgetData multi-slot tests pass: typed retrieval, null for missing, withSlot accumulation, Empty vs Unavailable distinction, jqwik properties"
    - "Gated.isAccessible() tests pass: null=free, empty=free, OR-logic, single match, no match"
    - "SettingDefinition construction tests pass for all 12 subtypes with constraint validation"
    - "ProviderFault transformation tests verify all 7 variants"
  artifacts:
    - path: "android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetDataTest.kt"
      provides: "WidgetData multi-slot unit tests + jqwik properties"
      contains: "class WidgetDataTest"
    - path: "android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/entitlement/GatedTest.kt"
      provides: "Gated.isAccessible() logic tests"
      contains: "class GatedTest"
    - path: "android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/settings/SettingDefinitionTest.kt"
      provides: "12-subtype construction and constraint validation"
      contains: "class SettingDefinitionTest"
    - path: "android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/fault/ProviderFaultTest.kt"
      provides: "ProviderFault variant tests"
      contains: "class ProviderFaultTest"
  key_links:
    - from: "WidgetDataTest.kt"
      to: "WidgetData.kt + DataSnapshot.kt"
      via: "tests snapshot/withSlot/hasData against real DataSnapshot subtypes"
      pattern: "WidgetData\\.Empty|withSlot|snapshot<"
---

<objective>
Write unit tests for all `:sdk:contracts` types — WidgetData, Gated, SettingDefinition, SetupDefinition, ProviderFault, WidgetStyle, WidgetContext. These validate the type surface before any runtime consumer exists.

Purpose: The test suite IS the primary validation for Phase 2. There is no UI or runtime to exercise these types yet. Tests catch contract violations (null data, wrong types, constraint violations) that would cascade to 13 downstream phases.
Output: Complete unit test suite for `:sdk:contracts` types with JUnit5 + jqwik.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sdk-contracts-common/02-RESEARCH.md
@.planning/migration/phase-02.md
@.planning/phases/02-sdk-contracts-common/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write WidgetData, Gated, WidgetStyle, and WidgetContext unit tests</name>
  <files>
    android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetDataTest.kt
    android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetStyleTest.kt
    android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetContextTest.kt
    android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/entitlement/GatedTest.kt
  </files>
  <action>
    **WidgetDataTest.kt (JUnit5 + jqwik, @Tag("fast")):**

    Create test DataSnapshot subtypes for testing:
    ```kotlin
    @Immutable data class TestSpeedSnapshot(override val timestamp: Long, val speedKmh: Float) : DataSnapshot
    @Immutable data class TestBatterySnapshot(override val timestamp: Long, val level: Int) : DataSnapshot
    @Immutable data class TestTimeSnapshot(override val timestamp: Long, val epochMs: Long) : DataSnapshot
    ```
    Define these as private inner types or companion object types within the test file.

    **Multi-slot tests (9 per phase-02.md):**
    1. `snapshot returns typed value for matching KClass` — add SpeedSnapshot, retrieve via `snapshot<TestSpeedSnapshot>()`, assert non-null with correct value
    2. `snapshot returns null for missing KClass` — `WidgetData.Empty.snapshot<TestSpeedSnapshot>()` is null
    3. `snapshot returns null for wrong KClass` — add SpeedSnapshot, retrieve `snapshot<TestBatterySnapshot>()` is null
    4. `withSlot adds new slot without removing existing` — add speed, then add battery via withSlot, both present
    5. `withSlot replaces existing slot of same KClass` — add speed, withSlot same type different value, verify replaced
    6. `hasData false for Empty, true with any slot` — `Empty.hasData() == false`, `withSlot(...).hasData() == true`
    7. `Empty and Unavailable are distinct` — `Empty.timestamp == 0L`, `Unavailable.timestamp == -1L`, `Empty != Unavailable`
    8. jqwik `@Property`: `withSlot accumulation is order-independent for distinct KClasses` — generate random orderings of (Speed, Battery, Time) snapshots, apply in any order, all 3 retrievable
    9. jqwik `@Property`: `withSlot is idempotent for same KClass` — last write wins, verify final snapshot matches last-applied

    For jqwik properties, use custom `@Provide` methods:
    ```kotlin
    @Provide
    fun timestamps(): Arbitrary<Long> = Arbitraries.longs().between(1, Long.MAX_VALUE)
    ```

    **GatedTest.kt (JUnit5, @Tag("fast")):**
    6 tests:
    1. `null entitlement list means free` — object with `requiredAnyEntitlement = null`, `isAccessible { false } == true`
    2. `empty set means free` — `requiredAnyEntitlement = emptySet()`, `isAccessible { false } == true`
    3. `single required, user has it` — `setOf("themes")`, `isAccessible { it == "themes" } == true`
    4. `single required, user lacks it` — `setOf("themes")`, `isAccessible { false } == false`
    5. `OR logic: user has one of two` — `setOf("themes", "plus")`, `isAccessible { it == "themes" } == true`
    6. `OR logic: user has neither` — `setOf("themes", "plus")`, `isAccessible { false } == false`

    Create a simple test implementation: `data class TestGated(override val requiredAnyEntitlement: Set<String>?) : Gated`

    **WidgetStyleTest.kt (JUnit5, @Tag("fast")):**
    1. `default values match documented` — verify `WidgetStyle.Default` is `BackgroundStyle.NONE, 1.0f, false, false, 25, 0, 0`
    2. `serialization round-trip` — serialize to JSON, deserialize, equals original

    **WidgetContextTest.kt (JUnit5, @Tag("fast")):**
    1. `DEFAULT is UTC, US locale, US region` — `WidgetContext.DEFAULT.timezone == ZoneId.of("UTC")`, locale == Locale.US, region == "US"
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :sdk:contracts:testDebugUnitTest --tests "*.WidgetDataTest" --tests "*.GatedTest" --tests "*.WidgetStyleTest" --tests "*.WidgetContextTest" --console=plain 2>&1 | tail -20</automated>
    <manual>Verify all tests pass including jqwik property tests</manual>
  </verify>
  <done>WidgetData tests (9 including 2 jqwik properties), GatedTest (6), WidgetStyleTest (2), WidgetContextTest (1) all pass. Multi-slot behavior validated: typed access, null safety, accumulation order independence, sentinel distinction.</done>
</task>

<task type="auto">
  <name>Task 2: Write SettingDefinition, SetupDefinition, and ProviderFault unit tests</name>
  <files>
    android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/settings/SettingDefinitionTest.kt
    android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/setup/SetupDefinitionTest.kt
    android/sdk/contracts/src/test/kotlin/app/dqxn/android/sdk/contracts/fault/ProviderFaultTest.kt
  </files>
  <action>
    **SettingDefinitionTest.kt (JUnit5, @Tag("fast"), @Nested classes):**

    **Construction tests (12 — one per subtype):**
    For each of the 12 subtypes, create with required fields and verify construction succeeds:
    - BooleanSetting, IntSetting, FloatSetting, StringSetting, EnumSetting, TimezoneSetting, DateFormatSetting, UriSetting, AppPickerSetting, SoundPickerSetting, InstructionSetting, InfoSetting

    **Constraint validation tests:**
    - `IntSetting default in min-max range` — `IntSetting(key="k", label="l", default=5, min=0, max=10)` — verify `default in min..max`
    - `IntSetting default outside range detected` — if validation exists in constructor, test it. If no validation, add assertion test that documents the constraint.
    - `FloatSetting step is positive` — if enforced, test. If not, document.
    - `EnumSetting options non-empty` — `EnumSetting(options = listOf(...))` works, `emptyList()` is an error state to document
    - `EnumSetting default in options` — default value must be a member of options list

    **Visibility tests:**
    - `visibleWhen null means always visible` — create setting with `visibleWhen = null`, assert `setting.visibleWhen?.invoke(emptyMap()) != false` is true (null-means-visible convention)
    - `visibleWhen predicate evaluates correctly` — `visibleWhen = { it["enabled"] == true }`, test with `mapOf("enabled" to true)` and `mapOf("enabled" to false)`
    - `hidden setting is always skipped` — `hidden = true` setting, verify `hidden == true`

    **Gated inheritance:**
    - Each subtype inherits `requiredAnyEntitlement` — test `isAccessible()` on a BooleanSetting with entitlement set

    **Key uniqueness utility:**
    - `keys are unique in list` — create list with unique keys, verify `map { it.key }.distinct().size == size`
    - `duplicate keys detected` — create list with duplicate keys, verify count differs

    **IntSetting.getEffectivePresets:**
    - `presetsWhen overrides static presets` — `presetsWhen = { listOf(1,2,3) }`, verify returns dynamic
    - `falls back to static presets when presetsWhen is null` — `presetsWhen = null, presets = listOf(5,10)`, verify returns static
    - `falls back to static when presetsWhen returns null` — `presetsWhen = { null }`, verify returns static presets

    **SetupDefinitionTest.kt (JUnit5, @Tag("fast"), @Nested classes):**

    **7 subtype construction tests:**
    - RuntimePermission, SystemServiceToggle, SystemService, DeviceScan, Instruction, Info, Setting

    **Category classification:**
    - `isRequirement true for RuntimePermission, SystemServiceToggle, SystemService, DeviceScan`
    - `isDisplay true for Instruction, Info`
    - `isInput true for Setting`

    **Setting wrapper delegation:**
    - `Setting wrapper delegates id from inner definition` — `Setting(BooleanSetting(key="k", ...))` → `id == "k"`
    - `Setting wrapper delegates label from inner definition`

    **asSetup() extension:**
    - `SettingDefinition.asSetup() wraps in SetupDefinition.Setting`

    **getDefaultValue():**
    - Returns correct default for each subtype (true for BooleanSetting, 0 for IntSetting, Unit for InstructionSetting, etc.)

    **ProviderFaultTest.kt (JUnit5, @Tag("fast")):**
    7 variant tests — verify each variant constructs correctly and holds expected data:
    1. `Kill is a singleton` — `ProviderFault.Kill` is `data object`
    2. `Delay holds delayMs` — `Delay(500L).delayMs == 500L`
    3. `Error holds exception` — `Error(RuntimeException("boom")).exception.message == "boom"`
    4. `ErrorOnNext holds exception`
    5. `Corrupt holds transform function` — verify lambda identity
    6. `Flap holds timing` — `Flap(100, 200).onMillis == 100 && offMillis == 200`
    7. `Stall is a singleton`

    All tests use `@Tag("fast")`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :sdk:contracts:testDebugUnitTest --console=plain 2>&1 | tail -20</automated>
    <manual>Verify test XML at build/test-results/ shows both JUnit5 and jqwik engines executed</manual>
  </verify>
  <done>All `:sdk:contracts` unit tests pass: SettingDefinition (12 construction + constraint + visibility + Gated + getEffectivePresets tests), SetupDefinition (7 construction + category + wrapper + extension tests), ProviderFault (7 variant tests). Complete unit test coverage for Phase 2 type surface.</done>
</task>

</tasks>

<verification>
1. `./gradlew :sdk:contracts:testDebugUnitTest --console=plain` — all tests pass
2. Verify `build/test-results/testDebugUnitTest/` XML present with JUnit5 and jqwik test entries
3. `./gradlew :sdk:common:testDebugUnitTest --console=plain` — common tests still pass (regression check)
4. `./gradlew spotlessCheck --console=plain` — formatting passes
</verification>

<success_criteria>
- WidgetData multi-slot tests: 9 (including 2 jqwik properties)
- Gated.isAccessible() tests: 6
- WidgetStyle/WidgetContext tests: 3
- SettingDefinition tests: ~20 (12 construction + constraint + visibility + Gated + presets)
- SetupDefinition tests: ~12 (7 construction + category + wrapper + extension)
- ProviderFault tests: 7
- Total: ~57 test methods across 7 test files
- JUnit5 + jqwik engines both execute (verified via XML)
- No test uses UnconfinedTestDispatcher
</success_criteria>

<output>
After completion, create `.planning/phases/02-sdk-contracts-common/02-04-SUMMARY.md`
</output>
