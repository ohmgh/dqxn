---
phase: 12-ci-gates-benchmarking
plan: 04
type: execute
wave: 2
depends_on: ["12-02"]
files_modified:
  - android/scripts/check-benchmark.sh
  - android/scripts/ci-gates.sh
  - android/feature/dashboard/build.gradle.kts
autonomous: true
requirements: [NF1, NF10, NF35]

must_haves:
  truths:
    - "Benchmark threshold script parses JSON and gates on P50/P95/P99/startup thresholds"
    - "CI gates orchestrator invokes all 9 gate scripts with aggregate pass/fail"
    - "Kover coverage configured on :feature:dashboard with >90% line coverage rule"
  artifacts:
    - path: "android/scripts/check-benchmark.sh"
      provides: "Benchmark result JSON parser with configurable thresholds"
      contains: "frameDurationCpuMs"
    - path: "android/scripts/ci-gates.sh"
      provides: "Orchestrator running all CI gate scripts in sequence"
      contains: "check-compose-stability"
    - path: "android/feature/dashboard/build.gradle.kts"
      provides: "Kover plugin configuration with coordinator coverage rule"
      contains: "kover"
  key_links:
    - from: "android/scripts/ci-gates.sh"
      to: "android/scripts/check-compose-stability.sh"
      via: "script invocation"
      pattern: "check-compose-stability"
    - from: "android/scripts/ci-gates.sh"
      to: "android/scripts/check-benchmark.sh"
      via: "script invocation"
      pattern: "check-benchmark"
    - from: "android/scripts/ci-gates.sh"
      to: "android/scripts/check-apk-size.sh"
      via: "script invocation"
      pattern: "check-apk-size"
---

<objective>
Create benchmark result parser, CI gate orchestrator, and Kover coverage configuration.

Purpose: Complete the CI gate infrastructure: (1) a script that parses macrobenchmark JSON output and compares against NF1/NF10 thresholds, (2) an orchestrator that runs all gate scripts in sequence with aggregate reporting, and (3) Kover coverage enforcement on `:feature:dashboard` coordinators (>90% line coverage).

Output: Two scripts in `android/scripts/`, Kover plugin applied to `:feature:dashboard`.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-gates-benchmarking/12-RESEARCH.md
@.planning/phases/12-ci-gates-benchmarking/12-02-SUMMARY.md
@android/feature/dashboard/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create benchmark result parser script</name>
  <files>android/scripts/check-benchmark.sh</files>
  <action>
Create `android/scripts/check-benchmark.sh` (executable).

The script:
1. Takes a required positional argument: path to `benchmarkData.json` (or directory containing it).
2. If argument is a directory, finds `*-benchmarkData.json` or `benchmarkData.json` within it.
3. Uses Python 3 (available on CI and macOS) to parse the JSON and check thresholds.
4. Thresholds from roadmap/architecture:
   - P50 frame time: < 8.0ms (hard gate)
   - P95 frame time: < 16.67ms (hard gate, matches NF1 60fps target). Print WARNING if > 12.0ms (aspirational target). **Do NOT use the research example P95 threshold (12.0ms) as a hard gate. P95 hard gate is 16.67ms; 12.0ms is the WARNING threshold only.**
   - P99 frame time: < 16.0ms (hard gate, matches NF10)
   - Cold startup median: < 1500.0ms (hard gate)
5. For each benchmark in `data["benchmarks"]`:
   - Check `metrics.timeToInitialDisplayMs.median` against startup threshold
   - Check `sampledMetrics.frameDurationCpuMs.P50/P95/P99` against frame thresholds
6. Collects all failures, prints each with `[benchmark] FAIL:` prefix.
7. Prints `[benchmark] All benchmark gates passed` on success.
8. Exits 1 if any failure, 0 otherwise.

Use `set -euo pipefail`. The Python block should be an inline script using `python3 -c`.

**Important note on JSON structure:** The exact key path for sampled metrics may vary between benchmark library versions. The script should handle:
- `sampledMetrics.frameDurationCpuMs` (newer format)
- `metrics.frameDurationCpuMs` (older format, fallback)

If the JSON file doesn't exist, exit 1 with a clear error message. This can happen if benchmarks weren't run or results weren't pulled from device (see `android.enableAdditionalTestOutput` in gradle.properties).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && test -x scripts/check-benchmark.sh && bash -n scripts/check-benchmark.sh && echo "PASS: script executable and syntactically valid" || echo "FAIL"</automated>
  </verify>
  <done>check-benchmark.sh parses benchmarkData.json, checks P50/P95/P99 frame thresholds and startup threshold, exits 1 on failure with descriptive messages.</done>
</task>

<task type="auto">
  <name>Task 2: Create CI gates orchestrator + Kover coverage config</name>
  <files>
    android/scripts/ci-gates.sh
    android/feature/dashboard/build.gradle.kts
  </files>
  <action>
**`android/scripts/ci-gates.sh`** (executable):

Orchestrator that runs all CI gates and reports aggregate results. Use `set -euo pipefail`.

Structure:
1. `SCRIPT_DIR` resolves to the directory containing the script.
2. `PROJECT_DIR` resolves to `$SCRIPT_DIR/..` (the `android/` directory).
3. Tracks `PASS_COUNT`, `FAIL_COUNT`, `SKIP_COUNT`.
4. Defines a `run_gate()` function that takes a gate name and command, runs it, captures exit code, increments counters.
5. Runs gates in order (each independent, failure of one doesn't skip the rest):

   **Gate 1: Unit tests** — `./gradlew test --console=plain`
   **Gate 2: Lint** — `./gradlew lintDebug --console=plain`
   **Gate 3: Compose stability** — `$SCRIPT_DIR/check-compose-stability.sh` (requires prior `assembleRelease`)
   **Gate 4: APK size** — `$SCRIPT_DIR/check-apk-size.sh`
   **Gate 5: Coordinator coverage** — `./gradlew :feature:dashboard:koverVerify --console=plain`
   **Gate 6: Clean build time** — `$SCRIPT_DIR/check-build-time.sh` (skipped in fast mode, gated by `--full` flag). Covers both clean < 120s and incremental < 15s.
   **Gate 7: Benchmarks** — `$SCRIPT_DIR/check-benchmark.sh $BENCHMARK_JSON` (skipped if no benchmark JSON found; requires prior device run)
   **Gate 8: Baseline profile in APK** — After `assembleRelease`, verify that `baseline-prof.txt` (or `baseline.prof`/`baseline.profm`) exists inside the release APK. Use `unzip -l app/build/outputs/apk/release/app-release.apk | grep -q 'baseline'`. This verifies SC1 end-to-end. Skipped if no release APK exists.
   **Gate 9: R8 mapping file** — Verify `app/build/outputs/mapping/release/mapping.txt` exists and is non-empty after `assembleRelease`. This ensures R8 obfuscation is active and mapping file is available for crash report deobfuscation.

6. Gates 6, 7, 8, and 9 are conditionally run:
   - Gate 6 only when `--full` is passed (it runs clean + incremental builds which is slow)
   - Gate 7 only when benchmark JSON exists at `benchmark/build/outputs/connected_android_test_additional_output/benchmarkAndroidTest/connected/*/benchmarkData.json`
   - Gates 8 and 9 only when release APK exists (requires prior `assembleRelease`)

7. Print summary table: gate name, result (PASS/FAIL/SKIP).
8. Exit 1 if any FAIL, exit 0 if all PASS.

**`:feature:dashboard/build.gradle.kts`** — add Kover plugin:

Add `alias(libs.plugins.kover)` to the plugins block.

Add Kover verification configuration:
```kotlin
kover {
    reports {
        verify {
            rule("coordinator-coverage") {
                minBound(90)
            }
        }
    }
}
```

This enforces >90% line coverage across all code in `:feature:dashboard`. The 6 coordinators are the bulk of this module's code, so module-level coverage effectively measures coordinator coverage.

Note: The Kover DSL may differ between versions. If `minBound(90)` is not the correct API for Kover 0.9.7, check `kover { reports { verify { rule { bound { minValue = 90 } } } } }` as an alternative. The executor should verify the API against the actual Kover version.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && test -x scripts/ci-gates.sh && bash -n scripts/ci-gates.sh && grep -q "kover" feature/dashboard/build.gradle.kts && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -5 && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>ci-gates.sh orchestrates all gate scripts with aggregate reporting. Kover plugin applied to :feature:dashboard with 90% line coverage verification rule.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android

# 1. All scripts exist and are executable
test -x scripts/check-benchmark.sh
test -x scripts/ci-gates.sh

# 2. Valid bash syntax
bash -n scripts/check-benchmark.sh
bash -n scripts/ci-gates.sh

# 3. Kover applied to dashboard
grep -q "kover" feature/dashboard/build.gradle.kts

# 4. Dashboard still compiles with Kover
./gradlew :feature:dashboard:compileDebugKotlin --console=plain
```
</verification>

<success_criteria>
- check-benchmark.sh parses benchmark JSON with P50 < 8ms, P95 < 16.67ms (warn at 12ms), P99 < 16ms, startup < 1500ms thresholds
- ci-gates.sh orchestrates 9 gates with aggregate summary and conditional skip for build-time, benchmark, baseline-profile, and R8 mapping gates
- Kover plugin applied to :feature:dashboard with >90% line coverage verification rule
- :feature:dashboard still compiles with Kover plugin
- All scripts have valid bash syntax and are executable
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-gates-benchmarking/12-04-SUMMARY.md`
</output>
