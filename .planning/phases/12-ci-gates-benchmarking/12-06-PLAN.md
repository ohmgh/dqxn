---
phase: 12-ci-gates-benchmarking
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - android/gradle/libs.versions.toml
  - android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
  - android/app/build.gradle.kts
  - android/baselineprofile/build.gradle.kts
  - android/benchmark/build.gradle.kts
  - android/scripts/ci-gates.sh
autonomous: true
requirements: [NF1, NF9, NF10]
gap_closure: true

must_haves:
  truths:
    - "Release Hilt DI graph is complete — assembleRelease succeeds without missing binding errors"
    - "Benchmarks measure release variant performance (matchingFallbacks = release), not debug"
    - "baselineprofile Gradle plugin 1.5.0-alpha03 applied to both :baselineprofile and :app — profile injection into release APK is automated"
    - "ci-gates.sh Gate 8 checks for baseline profile in release APK (functional gate, not deferred skip)"
  artifacts:
    - path: "android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt"
      provides: "Release-variant Hilt bindings for WidgetHealthMonitor, DiagnosticSnapshotCapture, DiagnosticFileWriter, RingBufferSink"
      contains: "WidgetHealthMonitor"
    - path: "android/benchmark/build.gradle.kts"
      provides: "Benchmark module targeting release variant via matchingFallbacks"
      contains: "matchingFallbacks.*release"
    - path: "android/gradle/libs.versions.toml"
      provides: "Benchmark + baselineprofile versions bumped to 1.5.0-alpha03, uiautomator to 2.4.0-beta01"
      contains: "1.5.0-alpha03"
    - path: "android/app/build.gradle.kts"
      provides: "baselineprofile plugin applied + baselineProfile(:baselineprofile) dependency active"
      contains: "baselineprofile"
    - path: "android/baselineprofile/build.gradle.kts"
      provides: "baselineprofile plugin applied (producer side)"
      contains: "androidx.baselineprofile"
  key_links:
    - from: "android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt"
      to: "android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticsViewModel.kt"
      via: "DiagnosticSnapshotCapture Hilt binding satisfies @Inject constructor parameter"
      pattern: "DiagnosticSnapshotCapture"
    - from: "android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt"
      to: "android/app/src/main/kotlin/app/dqxn/android/app/SessionLifecycleTracker.kt"
      via: "WidgetHealthMonitor Hilt binding satisfies @Inject constructor parameter"
      pattern: "WidgetHealthMonitor"
    - from: "android/benchmark/build.gradle.kts"
      to: "android/app/build.gradle.kts"
      via: "matchingFallbacks to release variant for production-representative benchmarks"
      pattern: "matchingFallbacks.*release"
    - from: "android/baselineprofile/build.gradle.kts"
      to: "android/app/build.gradle.kts"
      via: "baselineprofile plugin producer → app-target wiring for profile injection"
      pattern: "baselineprofile"
---

<objective>
Close two verification gaps from 12-VERIFICATION.md:

**Gap 1 (NF9 — baseline profile):** Bump `baselineprofile-plugin` from 1.4.1 to 1.5.0-alpha03 which adds AGP 9 DSL compatibility (`newDsl=false` no longer required). Re-enable the plugin on both `:baselineprofile` (producer) and `:app` (app-target). Also bump `benchmark` to 1.5.0-alpha03 and `uiautomator` to 2.4.0-beta01 (required by benchmark 1.5.x). This makes baseline profile generation AND injection into the release APK fully automated — closing NF9 for real.

**Gap 2 (NF1/NF10 — benchmark debug fallback):** Complete the release Hilt DI graph by adding 4 missing `@Provides` bindings to `ReleaseModule.kt`, then revert `matchingFallbacks` from `debug` to `release`. Benchmarks now measure production-representative performance.

**Fallback:** If `1.5.0-alpha03` fails to compile with AGP 9.0.1 (alpha instability), revert to 1.4.1 and apply the deferred skip strategy for Gate 8 instead. The release DI fix (Gap 2) is independent and proceeds regardless.

Output: Complete release DI graph, benchmarks targeting release variant, baseline profile plugin functional, Gate 8 as a real gate.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-gates-benchmarking/12-VERIFICATION.md
@.planning/phases/12-ci-gates-benchmarking/12-03-SUMMARY.md
@android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
@android/app/src/debug/kotlin/app/dqxn/android/debug/DebugModule.kt
@android/benchmark/build.gradle.kts
@android/baselineprofile/build.gradle.kts
@android/app/build.gradle.kts
@android/gradle/libs.versions.toml
@android/scripts/ci-gates.sh
@android/app/src/main/kotlin/app/dqxn/android/app/SessionLifecycleTracker.kt
@android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticsViewModel.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete release Hilt DI graph + revert matchingFallbacks to release</name>
  <files>
    android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
    android/benchmark/build.gradle.kts
  </files>
  <action>
**`ReleaseModule.kt`** — add release-appropriate `@Provides` bindings for the 4 types that are currently only in `DebugModule`. The release bindings should be lightweight since these types exist for observability that's less critical in production (crash evidence is handled separately in DqxnApplication.kt, not via Hilt).

Add the following `@Provides @Singleton` methods to `ReleaseModule`:

1. **`provideRingBufferSink()`** → `RingBufferSink(capacity = 128)` — smaller than debug's 512. Still needed for `DiagnosticSnapshotCapture` log inclusion. Import: `app.dqxn.android.sdk.observability.log.RingBufferSink`.

2. **`provideWidgetHealthMonitor(logger: DqxnLogger)`** → `WidgetHealthMonitor(logger = logger, scope = CoroutineScope(SupervisorJob() + Dispatchers.Default))` — same as debug, uses the NoOpLogger in release. Import: `app.dqxn.android.sdk.observability.health.WidgetHealthMonitor`, `kotlinx.coroutines.CoroutineScope`, `kotlinx.coroutines.SupervisorJob`, `kotlinx.coroutines.Dispatchers`.

3. **`provideDiagnosticFileWriter(@ApplicationContext context: Context, logger: DqxnLogger)`** → `DiagnosticFileWriter(baseDirectory = File(context.filesDir, "diagnostics"), logger = logger)` — same construction as debug. Import: `app.dqxn.android.sdk.observability.diagnostic.DiagnosticFileWriter`, `android.content.Context`, `dagger.hilt.android.qualifiers.ApplicationContext`, `java.io.File`.

4. **`provideDiagnosticSnapshotCapture(logger, metricsCollector, ringBufferSink, fileWriter)`** → `DiagnosticSnapshotCapture(logger = logger, metricsCollector = metricsCollector, tracer = DqxnTracer, logRingBuffer = ringBufferSink, fileWriter = fileWriter)` — same construction as debug. Import: `app.dqxn.android.sdk.observability.diagnostic.DiagnosticSnapshotCapture`, `app.dqxn.android.sdk.observability.trace.DqxnTracer`.

Change `ReleaseModule` from `internal object` to `internal abstract class` with a `companion object` for the `@Provides` methods. Pattern: `@Module @InstallIn(SingletonComponent::class) internal abstract class ReleaseModule { companion object { @Provides @Singleton fun provide...() } }`. Move existing `provideDqxnLogger()` and `provideMetricsCollector()` into the companion as well.

**`benchmark/build.gradle.kts`** — change `matchingFallbacks += listOf("debug")` to `matchingFallbacks += listOf("release")`. Remove the comment about Hilt DI being incomplete.

After both changes, verify with:
```bash
./gradlew assembleRelease --console=plain
./gradlew :benchmark:compileBenchmarkKotlin --console=plain
```

The `assembleRelease` must succeed without Hilt `MissingBinding` errors. The `:benchmark:compileBenchmarkKotlin` must succeed with the release fallback.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew assembleRelease --console=plain 2>&1 | tail -20 && ./gradlew :benchmark:compileBenchmarkKotlin --console=plain 2>&1 | tail -10 && grep -q 'WidgetHealthMonitor' app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt && grep -q 'DiagnosticSnapshotCapture' app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt && grep -q 'provideDqxnLogger' app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt && grep -q 'provideMetricsCollector' app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt && grep -q 'matchingFallbacks.*release' benchmark/build.gradle.kts && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Release Hilt DI graph complete (WidgetHealthMonitor, DiagnosticSnapshotCapture, DiagnosticFileWriter, RingBufferSink all bound + existing provideDqxnLogger/provideMetricsCollector preserved). Benchmark module targets release variant via matchingFallbacks. `assembleRelease` succeeds without missing bindings.</done>
</task>

<task type="auto">
  <name>Task 2: Bump baselineprofile plugin to 1.5.0-alpha03 + re-enable on :baselineprofile and :app</name>
  <files>
    android/gradle/libs.versions.toml
    android/baselineprofile/build.gradle.kts
    android/app/build.gradle.kts
  </files>
  <action>
**Why 1.5.0-alpha03:** The `androidx.baselineprofile` Gradle plugin 1.4.1 is incompatible with AGP 9.0.1 (both producer TestExtension mismatch and app-target unsupported module type). Version 1.5.0-alpha01 explicitly fixed this: "Baseline Profile Gradle Plugin no longer requires `newDsl=false` in AGP 9.0" (Iaaac7, b/443311090). Latest alpha is 1.5.0-alpha03 (Feb 11, 2026). The benchmark library is tightly coupled with the plugin — both must be bumped together. Benchmark 1.5.x requires UiAutomator 2.4.x.

**`libs.versions.toml`** — update 3 versions:
- `benchmark = "1.4.1"` → `benchmark = "1.5.0-alpha03"`
- `baselineprofile-plugin = "1.4.1"` → `baselineprofile-plugin = "1.5.0-alpha03"`
- `uiautomator = "2.3.0"` → `uiautomator = "2.4.0-beta01"`

**`baselineprofile/build.gradle.kts`** — re-enable the plugin:
```kotlin
plugins {
  id("com.android.test")
  alias(libs.plugins.baselineprofile)
}
```
Remove the deferred comments (lines 3-4).

**`app/build.gradle.kts`** — re-enable the plugin and dependency:
```kotlin
plugins {
  id("dqxn.android.application")
  id("dqxn.android.hilt")
  id("dqxn.android.test")
  alias(libs.plugins.kotlin.serialization)
  alias(libs.plugins.baselineprofile)
}
```
Remove the deferred comments (lines 6-7). Uncomment the `baselineProfile` dependency:
```kotlin
  // Baseline Profile
  implementation(libs.profileinstaller)
  baselineProfile(project(":baselineprofile"))
```

After changes, verify compilation:
```bash
./gradlew :app:assembleRelease --console=plain
./gradlew :baselineprofile:compileDebugKotlin --console=plain
```

Both must succeed. If either fails with plugin incompatibility errors (TestExtension, unsupported module type, or similar AGP 9 DSL issues), this is the alpha instability fallback trigger — revert all version bumps, revert plugin re-enablement, and apply the deferred skip strategy from the original plan instead.

**Fallback (only if 1.5.0-alpha03 fails):**
1. Revert `libs.versions.toml` to original versions (1.4.1, 1.4.1, 2.3.0)
2. Re-comment the plugins in `:baselineprofile` and `:app`
3. Re-comment `baselineProfile(project(":baselineprofile"))` in `:app`
4. Task 3 will use the deferred skip for Gate 8 instead
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :app:assembleRelease :baselineprofile:compileDebugKotlin --console=plain 2>&1 | tail -20 && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>PRIMARY: baselineprofile plugin 1.5.0-alpha03 active on both :baselineprofile (producer) and :app (app-target). Benchmark library bumped to 1.5.0-alpha03. UiAutomator bumped to 2.4.0-beta01. Profile injection into release APK is now automated. NF9 fully satisfied. OR FALLBACK: baselineprofile plugin reverted to 1.4.1, plugins re-commented in :baselineprofile and :app, baselineProfile() dependency re-commented — Task 3 will apply deferred skip to Gate 8.</done>
</task>

<task type="auto">
  <name>Task 3: Update ci-gates.sh Gate 8 for active baseline profile check</name>
  <files>android/scripts/ci-gates.sh</files>
  <action>
**If Task 2 succeeded (plugin 1.5.0-alpha03 works):**

Gate 8 in `ci-gates.sh` (lines 144-173) already has the correct logic — it checks for `baseline` inside the release APK via `unzip -l`. No structural change needed. However, update the gate comment at the top (line 14) to remove any deferred notation and confirm the gate is active:
```
#   8. Baseline profile in APK (only if release APK exists)
```
This is already the current text, so verify it's correct and move on.

The existing Gate 8 logic is:
- If release APK exists → check for `baseline` in `unzip -l` output → PASS/FAIL
- If no release APK → SKIP

This is the correct behavior when the plugin is functional. No changes needed to Gate 8 itself.

**If Task 2 failed (fallback — plugin reverted to 1.4.1):**

Replace the entire Gate 8 block (lines 144-173) with a deferred skip:
```bash
# ========================================
# Gate 8: Baseline profile in APK
# DEFERRED: androidx.baselineprofile Gradle plugin incompatible with AGP 9.0.1
# Profile generation works via BaselineProfileRule + connectedDebugAndroidTest
# Profile injection into APK requires the Gradle plugin -- re-enable when AndroidX ships stable AGP 9 support
# ========================================
skip_gate "Baseline profile in APK" "deferred -- baselineprofile Gradle plugin incompatible with AGP 9"
```

Also update the gate comment at line 14:
```
#   8. Baseline profile in APK    (DEFERRED -- baselineprofile plugin AGP 9 incompatible)
```

Verify script syntax after any edit:
```bash
bash -n scripts/ci-gates.sh
```
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && bash -n scripts/ci-gates.sh && if grep -q 'alias(libs.plugins.baselineprofile)' app/build.gradle.kts; then echo "PRIMARY PATH: plugin active" && grep -q 'baselineProfile(project(":baselineprofile"))' app/build.gradle.kts && grep -q 'alias(libs.plugins.baselineprofile)' baselineprofile/build.gradle.kts && ./gradlew :baselineprofile:compileDebugKotlin --console=plain 2>&1 | tail -5 && echo "PASS: plugin wired + compiles" || echo "FAIL: plugin wired but compile failed"; else echo "FALLBACK PATH: plugin deferred" && grep -q 'skip_gate.*deferred' scripts/ci-gates.sh && echo "PASS: deferred skip in place" || echo "FAIL: fallback but no skip_gate"; fi</automated>
  </verify>
  <done>PRIMARY: Gate 8 active — baselineprofile plugin wired in :app and :baselineprofile, :baselineprofile:compileDebugKotlin passes, Gate 8 will check for profile in release APK. OR FALLBACK: Gate 8 deferred — skip_gate with "deferred" message in ci-gates.sh, no false FAIL on release APKs without profile.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android

# 1. Release variant compiles with complete Hilt DI
./gradlew assembleRelease --console=plain

# 2. Benchmark module compiles targeting release variant
./gradlew :benchmark:compileBenchmarkKotlin --console=plain

# 3. ReleaseModule has all required bindings
grep -q "WidgetHealthMonitor" app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
grep -q "DiagnosticSnapshotCapture" app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
grep -q "DiagnosticFileWriter" app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
grep -q "RingBufferSink" app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt

# 4. Benchmark matchingFallbacks points to release
grep -q 'matchingFallbacks.*release' benchmark/build.gradle.kts

# 5. Version catalog has 1.5.0-alpha03 (or 1.4.1 if fallback)
grep -q '1.5.0-alpha03\|baselineprofile-plugin' gradle/libs.versions.toml

# 6. baselineprofile plugin in :app (or deferred comment if fallback)
grep -q 'baselineprofile' app/build.gradle.kts

# 7. ci-gates.sh syntax valid
bash -n scripts/ci-gates.sh

# 8. Baselineprofile module compiles
./gradlew :baselineprofile:compileDebugKotlin --console=plain
```
</verification>

<success_criteria>
- `assembleRelease` succeeds without Hilt MissingBinding errors (release DI graph complete)
- `ReleaseModule.kt` provides WidgetHealthMonitor, DiagnosticSnapshotCapture, DiagnosticFileWriter, RingBufferSink
- `:benchmark:compileBenchmarkKotlin` succeeds with matchingFallbacks = release
- baselineprofile plugin 1.5.0-alpha03 applied to :baselineprofile and :app (preferred) OR deferred skip (fallback)
- NF9 fully closed if plugin works; partially closed with clear deferral if fallback
- All existing tests still pass (no regression from release DI or version bump changes)
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-gates-benchmarking/12-06-SUMMARY.md`
</output>
