---
phase: 12-ci-gates-benchmarking
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
  - android/benchmark/build.gradle.kts
  - android/scripts/ci-gates.sh
autonomous: true
requirements: [NF1, NF9, NF10]
gap_closure: true

must_haves:
  truths:
    - "Release Hilt DI graph is complete — assembleRelease succeeds without missing binding errors"
    - "Benchmarks measure release variant performance (matchingFallbacks = release), not debug"
    - "ci-gates.sh Gate 8 skips gracefully with deferred message instead of failing when no baseline profile plugin is active"
  artifacts:
    - path: "android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt"
      provides: "Release-variant Hilt bindings for WidgetHealthMonitor, DiagnosticSnapshotCapture, DiagnosticFileWriter, RingBufferSink"
      contains: "WidgetHealthMonitor"
    - path: "android/benchmark/build.gradle.kts"
      provides: "Benchmark module targeting release variant via matchingFallbacks"
      contains: "matchingFallbacks.*release"
    - path: "android/scripts/ci-gates.sh"
      provides: "CI gate orchestrator with Gate 8 deferred skip for baseline profile"
      contains: "deferred"
  key_links:
    - from: "android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt"
      to: "android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticsViewModel.kt"
      via: "DiagnosticSnapshotCapture Hilt binding satisfies @Inject constructor parameter"
      pattern: "DiagnosticSnapshotCapture"
    - from: "android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt"
      to: "android/app/src/main/kotlin/app/dqxn/android/app/SessionLifecycleTracker.kt"
      via: "WidgetHealthMonitor Hilt binding satisfies @Inject constructor parameter"
      pattern: "WidgetHealthMonitor"
    - from: "android/benchmark/build.gradle.kts"
      to: "android/app/build.gradle.kts"
      via: "matchingFallbacks to release variant for production-representative benchmarks"
      pattern: "matchingFallbacks.*release"
---

<objective>
Close two verification gaps from 12-VERIFICATION.md: (1) complete the release Hilt DI graph so benchmarks can target the release variant instead of debug, and (2) fix ci-gates.sh Gate 8 to skip gracefully when baseline profile Gradle plugin is deferred.

Purpose: Gap 2 (benchmark matchingFallbacks debug) means performance measurements include LeakCanary and debug tooling overhead, making NF1/NF10 results unreliable. The root cause is an incomplete release Hilt DI graph — `WidgetHealthMonitor`, `DiagnosticSnapshotCapture`, `DiagnosticFileWriter`, and `RingBufferSink` are only bound in `DebugModule`. Adding release-appropriate bindings to `ReleaseModule` unblocks switching `matchingFallbacks` back to `release`. Gap 1 (baseline profile Gradle plugin) is an external dependency issue — the fix is to make Gate 8 skip explicitly rather than fail when no profile is in the APK.

Output: Complete release DI graph, benchmarks targeting release variant, Gate 8 skipping gracefully.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-gates-benchmarking/12-VERIFICATION.md
@.planning/phases/12-ci-gates-benchmarking/12-03-SUMMARY.md
@android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
@android/app/src/debug/kotlin/app/dqxn/android/debug/DebugModule.kt
@android/benchmark/build.gradle.kts
@android/scripts/ci-gates.sh
@android/app/src/main/kotlin/app/dqxn/android/app/SessionLifecycleTracker.kt
@android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticsViewModel.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete release Hilt DI graph + revert matchingFallbacks to release</name>
  <files>
    android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
    android/benchmark/build.gradle.kts
  </files>
  <action>
**`ReleaseModule.kt`** — add release-appropriate `@Provides` bindings for the 4 types that are currently only in `DebugModule`. The release bindings should be lightweight since these types exist for observability that's less critical in production (crash evidence is handled separately in DqxnApplication.kt, not via Hilt).

Add the following `@Provides @Singleton` methods to `ReleaseModule`:

1. **`provideRingBufferSink()`** → `RingBufferSink(capacity = 128)` — smaller than debug's 512. Still needed for `DiagnosticSnapshotCapture` log inclusion. Import: `app.dqxn.android.sdk.observability.log.RingBufferSink`.

2. **`provideWidgetHealthMonitor(logger: DqxnLogger)`** → `WidgetHealthMonitor(logger = logger, scope = CoroutineScope(SupervisorJob() + Dispatchers.Default))` — same as debug, uses the NoOpLogger in release. Import: `app.dqxn.android.sdk.observability.health.WidgetHealthMonitor`, `kotlinx.coroutines.CoroutineScope`, `kotlinx.coroutines.SupervisorJob`, `kotlinx.coroutines.Dispatchers`.

3. **`provideDiagnosticFileWriter(@ApplicationContext context: Context, logger: DqxnLogger)`** → `DiagnosticFileWriter(baseDirectory = File(context.filesDir, "diagnostics"), logger = logger)` — same construction as debug. Import: `app.dqxn.android.sdk.observability.diagnostic.DiagnosticFileWriter`, `android.content.Context`, `dagger.hilt.android.qualifiers.ApplicationContext`, `java.io.File`.

4. **`provideDiagnosticSnapshotCapture(logger, metricsCollector, ringBufferSink, fileWriter)`** → `DiagnosticSnapshotCapture(logger = logger, metricsCollector = metricsCollector, tracer = DqxnTracer, logRingBuffer = ringBufferSink, fileWriter = fileWriter)` — same construction as debug. Import: `app.dqxn.android.sdk.observability.diagnostic.DiagnosticSnapshotCapture`, `app.dqxn.android.sdk.observability.trace.DqxnTracer`.

Change `ReleaseModule` from `internal object` to `internal abstract class` with a `companion object` for the `@Provides` methods. The `abstract class` form is preferred here because `object` modules cannot have parameters in `@Provides` methods unless using `companion object` (and Dagger prefers that pattern for parameterized providers). Actually — Dagger `object` modules **can** have `@Provides` functions with parameters on the companion. However, since we already have 2 existing `@Provides` methods on the object itself, and new ones need parameters, convert all `@Provides` into a companion object. Keep `@Module @InstallIn(SingletonComponent::class)` on the outer type.

Pattern: `@Module @InstallIn(SingletonComponent::class) internal abstract class ReleaseModule { companion object { @Provides @Singleton fun provide...() } }`. Move existing `provideDqxnLogger()` and `provideMetricsCollector()` into the companion as well.

The `DqxnLoggerImpl` import can be dropped since NoOpLogger is an object reference, not a class instantiation. The existing `NoOpLogger` reference stays.

**`benchmark/build.gradle.kts`** — change `matchingFallbacks += listOf("debug")` to `matchingFallbacks += listOf("release")`. Remove the comment about Hilt DI being incomplete.

After both changes, verify with:
```bash
./gradlew assembleRelease --console=plain
./gradlew :benchmark:compileBenchmarkKotlin --console=plain
```

The `assembleRelease` must succeed without Hilt `MissingBinding` errors. The `:benchmark:compileBenchmarkKotlin` must succeed with the release fallback.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew assembleRelease --console=plain 2>&1 | tail -20 && ./gradlew :benchmark:compileBenchmarkKotlin --console=plain 2>&1 | tail -10 && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Release Hilt DI graph complete (WidgetHealthMonitor, DiagnosticSnapshotCapture, DiagnosticFileWriter, RingBufferSink all bound). Benchmark module targets release variant via matchingFallbacks. `assembleRelease` succeeds without missing bindings.</done>
</task>

<task type="auto">
  <name>Task 2: Fix ci-gates.sh Gate 8 to skip when baseline profile plugin is deferred</name>
  <files>android/scripts/ci-gates.sh</files>
  <action>
Update `ci-gates.sh` Gate 8 (baseline profile in APK) to always skip with a deferred message until the `androidx.baselineprofile` Gradle plugin is AGP 9-compatible.

Replace the current Gate 8 block (lines ~146-173) with:

```bash
# ========================================
# Gate 8: Baseline profile in APK
# DEFERRED: androidx.baselineprofile Gradle plugin incompatible with AGP 9.0.1
# Profile generation works via BaselineProfileRule + connectedDebugAndroidTest
# Profile injection into APK requires the Gradle plugin -- re-enable when AndroidX ships AGP 9 support
# ========================================
skip_gate "Baseline profile in APK" "deferred — baselineprofile Gradle plugin incompatible with AGP 9"
```

This replaces the conditional check that would FAIL on a valid release APK that simply doesn't have a profile (which is always the case right now). The gate can be re-enabled when the plugin becomes compatible.

Also add a comment at the top of the file in the gates list updating Gate 8's description:
```
#   8. Baseline profile in APK    (DEFERRED -- baselineprofile plugin AGP 9 incompatible)
```

Verify the script still has valid bash syntax after the edit.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && bash -n scripts/ci-gates.sh && grep -q "deferred" scripts/ci-gates.sh && echo "PASS: valid syntax + deferred gate" || echo "FAIL"</automated>
  </verify>
  <done>Gate 8 skips gracefully with "deferred — baselineprofile Gradle plugin incompatible with AGP 9" message. No false FAIL on release APKs without baseline profile. Script syntax valid.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android

# 1. Release variant compiles with complete Hilt DI
./gradlew assembleRelease --console=plain

# 2. Benchmark module compiles targeting release variant
./gradlew :benchmark:compileBenchmarkKotlin --console=plain

# 3. ReleaseModule has all required bindings
grep -q "WidgetHealthMonitor" app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
grep -q "DiagnosticSnapshotCapture" app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
grep -q "DiagnosticFileWriter" app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
grep -q "RingBufferSink" app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt

# 4. Benchmark matchingFallbacks points to release
grep -q 'release' benchmark/build.gradle.kts

# 5. ci-gates.sh Gate 8 skips with deferred message
grep -q "deferred" scripts/ci-gates.sh
bash -n scripts/ci-gates.sh
```
</verification>

<success_criteria>
- `assembleRelease` succeeds without Hilt MissingBinding errors (release DI graph complete)
- `ReleaseModule.kt` provides WidgetHealthMonitor, DiagnosticSnapshotCapture, DiagnosticFileWriter, RingBufferSink
- `:benchmark:compileBenchmarkKotlin` succeeds with matchingFallbacks = release
- ci-gates.sh Gate 8 skips with deferred message instead of failing on release APKs without profile
- All existing tests still pass (no regression from release DI changes)
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-gates-benchmarking/12-06-SUMMARY.md`
</output>
