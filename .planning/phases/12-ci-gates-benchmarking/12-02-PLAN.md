---
phase: 12-ci-gates-benchmarking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - android/scripts/check-compose-stability.sh
  - android/scripts/check-apk-size.sh
  - android/scripts/check-build-time.sh
autonomous: true
requirements: [NF34, NF35]

must_haves:
  truths:
    - "Zero unstable Compose classes enforced as CI gate on every release build"
    - "APK base size < 30MB verified on every release build"
    - "Clean build < 120s and incremental build < 15s enforced as CI gates"
  artifacts:
    - path: "android/scripts/check-compose-stability.sh"
      provides: "Compose compiler stability audit parsing *-classes.txt reports"
      contains: "unstable"
    - path: "android/scripts/check-apk-size.sh"
      provides: "APK size threshold gate checking release APK < 30MB"
      contains: "30"
    - path: "android/scripts/check-build-time.sh"
      provides: "Build time gate: clean < 120s + incremental < 15s"
      contains: "120"
  key_links:
    - from: "android/scripts/check-compose-stability.sh"
      to: "build/compose_compiler/*-classes.txt"
      via: "glob pattern matching Compose compiler report output"
      pattern: "compose_compiler.*classes.txt"
    - from: "android/scripts/check-apk-size.sh"
      to: "app/build/outputs/apk/release/*.apk"
      via: "stat file size check"
      pattern: "release.*apk"
---

<objective>
Create CI gate scripts for Compose stability audit, APK size enforcement, and build time verification.

Purpose: Automate the three non-device CI gates that can run on any machine: Compose compiler stability report parsing (zero unstable classes), APK size threshold (< 30MB base), and clean build time (< 120s). These scripts are invoked by the CI orchestrator (Plan 04) and can be run independently.

Output: Three executable shell scripts in `android/scripts/` that exit 0 on pass, exit 1 on fail with descriptive messages.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-gates-benchmarking/12-RESEARCH.md
@android/build-logic/convention/src/main/kotlin/AndroidComposeConventionPlugin.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Compose stability audit script</name>
  <files>android/scripts/check-compose-stability.sh</files>
  <action>
Create `android/scripts/check-compose-stability.sh` (executable).

The script:
1. Takes an optional `--project-dir` argument (defaults to the script's parent directory `..`).
2. Scans Compose compiler report files at `{module}/build/compose_compiler/*-classes.txt` for all app-owned modules:
   - `app`, `feature/dashboard`, `feature/settings`, `feature/diagnostics`, `feature/onboarding`
   - `sdk/ui`, `core/design`
   - `pack/essentials`, `pack/themes`, `pack/demo`
3. For each module, counts lines containing `unstable ` (note trailing space to avoid matching "unstableParams" column headers).
4. Separately counts non-skippable composables: lines matching `restartable ` but NOT matching `skippable ` in `:feature:dashboard` only. Threshold: max 5.
5. Prints per-module results.
6. Exits 1 if any unstable classes found OR if `:feature:dashboard` has > 5 non-skippable composables.
7. Exits 0 otherwise with "All Compose stability gates passed."

Use `set -euo pipefail`. Prefix output with `[compose-stability]`.

**Important:** The `reportsDestination` in `AndroidComposeConventionPlugin` is `layout.buildDirectory.dir("compose_compiler")`. The actual filename pattern is `{variant}-classes.txt` (e.g., `release-classes.txt`). Use glob `*-classes.txt`.

If no report files exist for a module, print a warning but don't fail â€” the module may not have been built yet or may not have Compose compiler enabled.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && test -x scripts/check-compose-stability.sh && bash -n scripts/check-compose-stability.sh && echo "PASS: script is executable and has valid syntax" || echo "FAIL"</automated>
  </verify>
  <done>check-compose-stability.sh is executable, has valid bash syntax, scans 10 app-owned modules for unstable classes and non-skippable composables, exits 1 on failure.</done>
</task>

<task type="auto">
  <name>Task 2: Create APK size gate + build time gate scripts</name>
  <files>
    android/scripts/check-apk-size.sh
    android/scripts/check-build-time.sh
  </files>
  <action>
**`android/scripts/check-apk-size.sh`** (executable):

1. Takes an optional `--apk-path` argument. Default: auto-discover `app/build/outputs/apk/release/app-release.apk` (or `app-release-unsigned.apk`).
2. Uses `stat` to get file size in bytes. Use `stat -f%z` on macOS, fall back to `stat --format=%s` on Linux (detect via `uname`).
3. Converts to MB (integer division by 1048576).
4. Thresholds: base APK < 30MB (hard fail), > 25MB (warning).
5. Prints `[apk-size] APK size: {X}MB ({bytes} bytes)`.
6. Exits 1 if >= 30MB, exits 0 otherwise.

Use `set -euo pipefail`.

**`android/scripts/check-build-time.sh`** (executable):

1. Takes an optional `--project-dir` argument (defaults to `..` relative to script).
2. **Clean build gate (NF35):** Runs `./gradlew clean` then `time ./gradlew assembleDebug --console=plain --no-build-cache` with `TIMEFORMAT='%R'`. Captures elapsed time in seconds. Threshold: < 120s. Prints `[build-time] Clean build: {X}s (threshold: 120s)`.
3. **Incremental build gate (NF35):** After clean build completes, makes a no-op change to a source file (e.g., append then remove a blank line from `app/src/main/kotlin/app/dqxn/android/DqxnApplication.kt` using `echo >> $FILE && head -n -1 $FILE > tmp && mv tmp $FILE`). Then runs `time ./gradlew assembleDebug --console=plain` (without `--no-build-cache` and without `clean`). Captures elapsed time. Threshold: < 15s. Prints `[build-time] Incremental build: {X}s (threshold: 15s)`.
4. Exits 1 if EITHER threshold exceeded. Exits 0 if both pass.

Note: This script actually runs builds, so it's a longer-running CI step. It should be called explicitly, not as part of every commit.

Use `set -euo pipefail`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && test -x scripts/check-apk-size.sh && bash -n scripts/check-apk-size.sh && test -x scripts/check-build-time.sh && bash -n scripts/check-build-time.sh && echo "PASS: both scripts executable and syntactically valid" || echo "FAIL"</automated>
  </verify>
  <done>check-apk-size.sh gates APK < 30MB with cross-platform stat support. check-build-time.sh runs clean build (< 120s) and incremental build (< 15s) and gates both. Both scripts are executable with valid bash syntax.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android

# 1. All three scripts exist and are executable
test -x scripts/check-compose-stability.sh
test -x scripts/check-apk-size.sh
test -x scripts/check-build-time.sh

# 2. All three have valid bash syntax
bash -n scripts/check-compose-stability.sh
bash -n scripts/check-apk-size.sh
bash -n scripts/check-build-time.sh

# 3. Scripts contain expected threshold values
grep -q "unstable" scripts/check-compose-stability.sh
grep -q "30" scripts/check-apk-size.sh
grep -q "120" scripts/check-build-time.sh
```
</verification>

<success_criteria>
- Three executable shell scripts in `android/scripts/`
- check-compose-stability.sh parses 10 app-owned module reports, fails on >0 unstable classes or >5 non-skippable in :feature:dashboard
- check-apk-size.sh measures APK size, fails on >= 30MB
- check-build-time.sh runs clean build (fails on >= 120s) and incremental build (fails on >= 15s)
- All scripts have valid bash syntax (bash -n passes)
- All scripts use set -euo pipefail
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-gates-benchmarking/12-02-SUMMARY.md`
</output>
