---
phase: 12-ci-gates-benchmarking
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - android/baselineprofile/src/main/kotlin/app/dqxn/android/baselineprofile/BaselineProfileGenerator.kt
  - android/benchmark/src/main/kotlin/app/dqxn/android/benchmark/StartupBenchmark.kt
  - android/benchmark/src/main/kotlin/app/dqxn/android/benchmark/DashboardFrameBenchmark.kt
autonomous: true
requirements: [NF1, NF9, NF10]

must_haves:
  truths:
    - "Baseline profile generator covers startup and dashboard interaction critical paths"
    - "Startup benchmark measures cold start with StartupTimingMetric"
    - "Frame timing benchmark measures 12-widget steady state with FrameTimingMetric"
    - "All benchmark classes compile (connectedAndroidTest execution deferred to device availability)"
  artifacts:
    - path: "android/baselineprofile/src/main/kotlin/app/dqxn/android/baselineprofile/BaselineProfileGenerator.kt"
      provides: "Baseline profile generation for startup, dashboard, edit mode, widget picker"
      contains: "BaselineProfileRule"
    - path: "android/benchmark/src/main/kotlin/app/dqxn/android/benchmark/StartupBenchmark.kt"
      provides: "Cold startup timing measurement"
      contains: "StartupTimingMetric"
    - path: "android/benchmark/src/main/kotlin/app/dqxn/android/benchmark/DashboardFrameBenchmark.kt"
      provides: "Frame timing measurement with 12 active widgets"
      contains: "FrameTimingMetric"
  key_links:
    - from: "android/benchmark/src/main/kotlin/app/dqxn/android/benchmark/DashboardFrameBenchmark.kt"
      to: "app.dqxn.android"
      via: "packageName targeting the app process"
      pattern: "packageName.*app.dqxn.android"
    - from: "android/baselineprofile/src/main/kotlin/app/dqxn/android/baselineprofile/BaselineProfileGenerator.kt"
      to: "app.dqxn.android"
      via: "packageName targeting the app process"
      pattern: "packageName.*app.dqxn.android"
---

<objective>
Implement baseline profile generator and macrobenchmark test classes for startup timing and frame measurement.

Purpose: Provide the actual test code that generates AOT baseline profiles (NF9) and measures app performance (NF1, NF10). The baseline profile generator covers critical user journeys (startup, dashboard interaction, edit mode, widget picker). Macrobenchmarks measure cold startup (< 1.5s gate) and 12-widget frame timing (P95 < 16.67ms gate).

Output: Three Kotlin test classes that compile against the `:app` target. Execution requires a connected device (automated instrumented test, not manual).
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-gates-benchmarking/12-RESEARCH.md
@.planning/phases/12-ci-gates-benchmarking/12-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BaselineProfileGenerator</name>
  <files>android/baselineprofile/src/main/kotlin/app/dqxn/android/baselineprofile/BaselineProfileGenerator.kt</files>
  <action>
Create `BaselineProfileGenerator.kt` in package `app.dqxn.android.baselineprofile`.

Uses `@RunWith(AndroidJUnit4::class)` and `@get:Rule val rule = BaselineProfileRule()`.

Four `@Test` methods, each calling `rule.collect(packageName = "app.dqxn.android")`:

1. **`startup()`** — `pressHome()` then `startActivityAndWait()`. This is the minimal critical path — ART compiles the startup trace.

2. **`dashboardInteraction()`** — `startActivityAndWait()`, then `device.waitForIdle()`, then `Thread.sleep(3_000)` for data binding to complete. This captures the steady-state rendering path with active widgets.

3. **`editMode()`** — `startActivityAndWait()`, wait for idle, then use `device.findObject(By.desc("Edit mode"))` to toggle edit mode on and off. This captures the edit mode enter/exit + gesture handling codepath. Wrap findObject in a null-safe check — if the button isn't found (e.g., UI changed), skip gracefully.

4. **`widgetPicker()`** — `startActivityAndWait()`, enter edit mode, then attempt to find and tap the "Add widget" button (`By.desc("Add widget")`). This captures the overlay navigation + widget picker rendering path. Null-safe, skip if not found.

Import: `androidx.benchmark.macro.junit4.BaselineProfileRule`, `androidx.test.ext.junit.runners.AndroidJUnit4`, `androidx.test.uiautomator.By`, `org.junit.Rule`, `org.junit.Test`, `org.junit.runner.RunWith`.

Note: The `src/main/kotlin` path is correct for `com.android.test` modules — they don't use `src/androidTest`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :baselineprofile:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>BaselineProfileGenerator.kt compiles with 4 profile collection methods covering startup, dashboard interaction, edit mode, and widget picker.</done>
</task>

<task type="auto">
  <name>Task 2: Implement StartupBenchmark + DashboardFrameBenchmark</name>
  <files>
    android/benchmark/src/main/kotlin/app/dqxn/android/benchmark/StartupBenchmark.kt
    android/benchmark/src/main/kotlin/app/dqxn/android/benchmark/DashboardFrameBenchmark.kt
  </files>
  <action>
**`StartupBenchmark.kt`** in package `app.dqxn.android.benchmark`:

`@RunWith(AndroidJUnit4::class)` class with `@get:Rule val rule = MacrobenchmarkRule()`.

Two `@Test` methods:

1. **`coldStartup()`** — `rule.measureRepeated()` with:
   - `packageName = "app.dqxn.android"`
   - `metrics = listOf(StartupTimingMetric())`
   - `iterations = 5`
   - `startupMode = StartupMode.COLD`
   - `setupBlock = { pressHome() }`
   - `measureBlock = { startActivityAndWait() }`

2. **`warmStartup()`** — same as cold but with `startupMode = StartupMode.WARM` and `iterations = 3`. Useful for P50 trend tracking.

**`DashboardFrameBenchmark.kt`** in package `app.dqxn.android.benchmark`:

`@RunWith(AndroidJUnit4::class)` class with `@get:Rule val rule = MacrobenchmarkRule()`.

Two `@Test` methods:

1. **`steadyState12Widgets()`** — `rule.measureRepeated()` with:
   - `packageName = "app.dqxn.android"`
   - `metrics = listOf(FrameTimingMetric())`
   - `iterations = 3`
   - `startupMode = StartupMode.WARM`
   - `setupBlock = { startActivityAndWait(); device.waitForIdle() }`
   - `measureBlock = { Thread.sleep(5_000) }` — 5-second steady-state soak with demo pack data flowing through 12 widgets. The demo pack provides deterministic data via DemoTimeProvider + DemoSpeedProvider.

2. **`editModeCycle()`** — `rule.measureRepeated()` with:
   - `packageName = "app.dqxn.android"`
   - `metrics = listOf(FrameTimingMetric())`
   - `iterations = 3`
   - `startupMode = StartupMode.WARM`
   - `setupBlock = { startActivityAndWait(); device.waitForIdle() }`
   - `measureBlock = { }` — find edit mode toggle via `device.findObject(By.desc("Edit mode"))`, click it, wait for idle, sleep 2s for wiggle animations, click again, wait for idle. Null-safe the findObject.

Imports: `androidx.benchmark.macro.*`, `androidx.test.ext.junit.runners.AndroidJUnit4`, `androidx.test.uiautomator.By`, `org.junit.*`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :benchmark:compileBenchmarkKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>StartupBenchmark (cold + warm) and DashboardFrameBenchmark (steady state + edit mode cycle) compile. Four benchmark methods total covering NF1, NF10 requirements.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android

# 1. All source files exist
test -f baselineprofile/src/main/kotlin/app/dqxn/android/baselineprofile/BaselineProfileGenerator.kt
test -f benchmark/src/main/kotlin/app/dqxn/android/benchmark/StartupBenchmark.kt
test -f benchmark/src/main/kotlin/app/dqxn/android/benchmark/DashboardFrameBenchmark.kt

# 2. Baseline profile module compiles
./gradlew :baselineprofile:compileDebugKotlin --console=plain

# 3. Benchmark module compiles (benchmark build type)
./gradlew :benchmark:compileBenchmarkKotlin --console=plain
```

Note: `connectedBenchmarkAndroidTest` and `generateBaselineProfile` require a connected device. These are automated instrumented tests — execution deferred to device availability. The CI pipeline or developer runs them on a physical device or Firebase Test Lab.
</verification>

<success_criteria>
- BaselineProfileGenerator has 4 collection methods (startup, dashboardInteraction, editMode, widgetPicker)
- StartupBenchmark has 2 methods (cold, warm) using StartupTimingMetric
- DashboardFrameBenchmark has 2 methods (steadyState12Widgets, editModeCycle) using FrameTimingMetric
- All 3 source files compile without errors
- Target package is "app.dqxn.android" in all test methods
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-gates-benchmarking/12-03-SUMMARY.md`
</output>
