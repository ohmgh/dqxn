---
phase: 12-ci-gates-benchmarking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/gradle/libs.versions.toml
  - android/gradle.properties
  - android/baselineprofile/build.gradle.kts
  - android/benchmark/build.gradle.kts
  - android/app/build.gradle.kts
autonomous: true
requirements: [NF9, NF10]

must_haves:
  truths:
    - "`:baselineprofile` module compiles as com.android.test targeting `:app`"
    - "`:benchmark` module compiles as com.android.test with benchmark build type"
    - "`:app` has profileinstaller dependency and baselineprofile plugin"
    - "Version catalog contains all benchmark/profile library entries"
  artifacts:
    - path: "android/gradle/libs.versions.toml"
      provides: "Benchmark, profileinstaller, uiautomator, baselineprofile plugin, kover plugin version catalog entries"
      contains: "benchmark-macro-junit4"
    - path: "android/baselineprofile/build.gradle.kts"
      provides: "Baseline profile generation module targeting :app"
      contains: "targetProjectPath"
    - path: "android/benchmark/build.gradle.kts"
      provides: "Macrobenchmark module with benchmark build type"
      contains: "matchingFallbacks"
    - path: "android/app/build.gradle.kts"
      provides: "App module with baselineprofile plugin and profileinstaller"
      contains: "profileinstaller"
  key_links:
    - from: "android/baselineprofile/build.gradle.kts"
      to: "android/app/build.gradle.kts"
      via: "targetProjectPath = \":app\""
      pattern: "targetProjectPath.*:app"
    - from: "android/benchmark/build.gradle.kts"
      to: "android/app/build.gradle.kts"
      via: "targetProjectPath = \":app\""
      pattern: "targetProjectPath.*:app"
---

<objective>
Configure build infrastructure for baseline profile generation and macrobenchmark measurement.

Purpose: Establish the two `com.android.test` modules (`:baselineprofile` and `:benchmark`) with correct build.gradle.kts configurations, add all required library/plugin entries to the version catalog, wire profileinstaller into `:app`, and enable benchmark output in gradle.properties.

Output: Both modules compile, `:app` has baseline profile plugin + profileinstaller dependency, version catalog has all benchmark entries.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ci-gates-benchmarking/12-RESEARCH.md
@android/gradle/libs.versions.toml
@android/baselineprofile/build.gradle.kts
@android/benchmark/build.gradle.kts
@android/app/build.gradle.kts
@android/gradle.properties
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add version catalog entries + gradle.properties flag</name>
  <files>
    android/gradle/libs.versions.toml
    android/gradle.properties
  </files>
  <action>
Add the following entries to `android/gradle/libs.versions.toml`:

**Versions section** — add after existing entries:
```
benchmark = "1.4.1"
profileinstaller = "1.4.1"
baselineprofile-plugin = "1.3.1"
uiautomator = "2.3.0"
kover = "0.9.7"
```

**Libraries section** — add after existing entries:
```
benchmark-macro-junit4 = { group = "androidx.benchmark", name = "benchmark-macro-junit4", version.ref = "benchmark" }
profileinstaller = { group = "androidx.profileinstaller", name = "profileinstaller", version.ref = "profileinstaller" }
uiautomator = { group = "androidx.test.uiautomator", name = "uiautomator", version.ref = "uiautomator" }
```

**Plugins section** — add after existing entries:
```
baselineprofile = { id = "androidx.baselineprofile", version.ref = "baselineprofile-plugin" }
kover = { id = "org.jetbrains.kotlinx.kover", version.ref = "kover" }
```

Add to `android/gradle.properties`:
```
android.enableAdditionalTestOutput=true
```

This flag ensures benchmark JSON output files are pulled from device to `build/outputs/`.

Do NOT add Pitest entries to the version catalog yet — Pitest compatibility with Kotlin 2.3 + JDK 25 is LOW confidence. It will be attempted in a later plan and version catalog entries added there if it works.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && grep -q "benchmark-macro-junit4" gradle/libs.versions.toml && grep -q "profileinstaller" gradle/libs.versions.toml && grep -q "uiautomator" gradle/libs.versions.toml && grep -q "baselineprofile" gradle/libs.versions.toml && grep -q "kover" gradle/libs.versions.toml && grep -q "enableAdditionalTestOutput" gradle.properties && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Version catalog contains benchmark, profileinstaller, uiautomator, baselineprofile plugin, kover plugin entries. gradle.properties has enableAdditionalTestOutput=true.</done>
</task>

<task type="auto">
  <name>Task 2: Configure baselineprofile + benchmark modules + wire app</name>
  <files>
    android/baselineprofile/build.gradle.kts
    android/benchmark/build.gradle.kts
    android/app/build.gradle.kts
  </files>
  <action>
**`:baselineprofile/build.gradle.kts`** — replace the current stub entirely:
```kotlin
plugins {
    id("com.android.test")
    alias(libs.plugins.baselineprofile)
}

android {
    namespace = "app.dqxn.android.baselineprofile"
    compileSdk = 36
    targetProjectPath = ":app"

    defaultConfig {
        minSdk = 31
        targetSdk = 36
        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }
}

baselineProfile {
    useConnectedDevices = true
}

dependencies {
    implementation(libs.benchmark.macro.junit4)
}
```

**`:benchmark/build.gradle.kts`** — replace the current stub entirely (changing from `dqxn.android.library` to `com.android.test` per Pitfall 1 in research):
```kotlin
plugins {
    id("com.android.test")
}

android {
    namespace = "app.dqxn.android.benchmark"
    compileSdk = 36
    targetProjectPath = ":app"

    defaultConfig {
        minSdk = 31
        targetSdk = 36
        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        create("benchmark") {
            isDebuggable = true
            signingConfig = signingConfigs.getByName("debug")
            matchingFallbacks += listOf("release")
        }
    }
}

dependencies {
    implementation(libs.benchmark.macro.junit4)
    implementation(libs.uiautomator)
}
```

**`:app/build.gradle.kts`** — add:
1. `alias(libs.plugins.baselineprofile)` to the plugins block
2. `implementation(libs.profileinstaller)` to the dependencies block
3. `baselineProfile(project(":baselineprofile"))` to the dependencies block

If the `baselineprofile` plugin raises an AGP 9 version warning, add a `baselineProfile { }` block at the top-level of the app build file with `warnings { maxAgpVersion = false }` to suppress it. Try without the suppression first.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :baselineprofile:assembleDebug :benchmark:assembleDebug --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>Both `:baselineprofile` and `:benchmark` compile as `com.android.test` modules. `:app` has `profileinstaller` dependency and `baselineprofile` plugin applied.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android

# 1. Version catalog entries present
grep -q "benchmark-macro-junit4" gradle/libs.versions.toml
grep -q "profileinstaller" gradle/libs.versions.toml
grep -q "baselineprofile" gradle/libs.versions.toml

# 2. Both test modules compile
./gradlew :baselineprofile:assembleDebug :benchmark:assembleDebug --console=plain

# 3. App module has profileinstaller
grep -q "profileinstaller" app/build.gradle.kts

# 4. gradle.properties has benchmark output flag
grep -q "enableAdditionalTestOutput" gradle.properties
```
</verification>

<success_criteria>
- Version catalog has all 5 new entries (benchmark, profileinstaller, uiautomator versions; baselineprofile + kover plugins)
- `:baselineprofile` compiles as `com.android.test` with `targetProjectPath = ":app"`
- `:benchmark` compiles as `com.android.test` with benchmark build type + matchingFallbacks to release
- `:app` has `profileinstaller` implementation dependency and `baselineprofile` plugin
- `gradle.properties` has `android.enableAdditionalTestOutput=true`
</success_criteria>

<output>
After completion, create `.planning/phases/12-ci-gates-benchmarking/12-01-SUMMARY.md`
</output>
