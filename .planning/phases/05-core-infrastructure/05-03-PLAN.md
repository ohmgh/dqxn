---
phase: 05-core-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - android/data/build.gradle.kts
  - android/data/consumer-proguard-rules.pro
  - android/data/src/main/kotlin/app/dqxn/android/data/layout/DashboardWidgetInstance.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/layout/GridTypes.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/serializer/DashboardStoreSerializer.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/serializer/PairedDeviceSerializer.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/serializer/CustomThemeSerializer.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/di/DataModule.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepository.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepositoryImpl.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutMigration.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/layout/FallbackLayout.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryImpl.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preferences/PreferenceKeys.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/layout/LayoutRepositoryTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/layout/LayoutMigrationTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/layout/FallbackLayoutTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/di/CorruptionHandlerTest.kt
autonomous: true
requirements: [F7.1, F7.2, F7.3, F7.8, F7.12, F4.3, NF43]

must_haves:
  truths:
    - "DataStore instances are all @Singleton with ReplaceFileCorruptionHandler"
    - "LayoutRepository supports profile CRUD: create, clone, switch, delete"
    - "Layout save is debounced at 500ms — rapid mutations batch into single write"
    - "LayoutMigration applies chained N->N+1 transformers with pre-migration backup and failure fallback"
    - "FallbackLayout provides hardcoded clock-widget constant not dependent on JSON/assets"
    - "UserPreferencesRepository persists dual-theme selections (lightThemeId, darkThemeId) and auto-switch mode"
    - "Corrupted DataStore falls back to defaults without crashing"
  artifacts:
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepository.kt"
      provides: "Interface for dashboard layout persistence with profile CRUD"
      contains: "interface LayoutRepository"
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepositoryImpl.kt"
      provides: "Proto DataStore-backed implementation with debounced save"
      contains: "class LayoutRepositoryImpl"
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutMigration.kt"
      provides: "Chained schema migration with backup and fallback"
      contains: "class LayoutMigration"
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/di/DataModule.kt"
      provides: "Hilt @Provides for all DataStore instances with corruption handlers"
      contains: "@Module"
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt"
      provides: "Interface for user preferences (theme mode, orientation, etc.)"
      contains: "interface UserPreferencesRepository"
  key_links:
    - from: "android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepositoryImpl.kt"
      to: "android/data/src/main/kotlin/app/dqxn/android/data/di/DataModule.kt"
      via: "DataStore<DashboardStore> injected via Hilt"
      pattern: "DataStore<DashboardStore>"
    - from: "android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepositoryImpl.kt"
      to: "android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutMigration.kt"
      via: "Migration applied on first read"
      pattern: "LayoutMigration"
    - from: "android/data/src/main/kotlin/app/dqxn/android/data/di/DataModule.kt"
      to: "android/data/src/main/kotlin/app/dqxn/android/data/serializer/DashboardStoreSerializer.kt"
      via: "Serializer passed to DataStoreFactory.create()"
      pattern: "DashboardStoreSerializer"
---

<objective>
Build the `:data` module infrastructure and primary repositories: LayoutRepository and UserPreferencesRepository.

Purpose: These are the two most fundamental data stores. LayoutRepository manages the entire widget canvas persistence with profile CRUD and debounced save. UserPreferencesRepository stores theme mode, orientation lock, and other global settings consumed by ThemeAutoSwitchEngine (Plan 06). DataModule provides all DataStore instances with mandatory corruption handlers (NF43).
Output: Complete `:data` build config, domain types, all 3 DataStore serializers, DataModule with all @Provides, LayoutRepository with migration/fallback, UserPreferencesRepository, and tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-core-infrastructure/05-RESEARCH.md
@.planning/phases/05-core-infrastructure/05-01-SUMMARY.md
@android/data/build.gradle.kts
@android/data/proto/build.gradle.kts
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetStyle.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/theme/AutoSwitchMode.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data module build config + domain types + DataStore serializers + DataModule</name>
  <files>
    android/data/build.gradle.kts
    android/data/consumer-proguard-rules.pro
    android/data/src/main/kotlin/app/dqxn/android/data/layout/DashboardWidgetInstance.kt
    android/data/src/main/kotlin/app/dqxn/android/data/layout/GridTypes.kt
    android/data/src/main/kotlin/app/dqxn/android/data/serializer/DashboardStoreSerializer.kt
    android/data/src/main/kotlin/app/dqxn/android/data/serializer/PairedDeviceSerializer.kt
    android/data/src/main/kotlin/app/dqxn/android/data/serializer/CustomThemeSerializer.kt
    android/data/src/main/kotlin/app/dqxn/android/data/di/DataModule.kt
  </files>
  <action>
    **build.gradle.kts:** Already has `dqxn.android.library`, `dqxn.android.hilt`, `dqxn.android.test`. Add:
    - `api(project(":data:proto"))` — proto-generated classes
    - `implementation(project(":sdk:contracts"))` — WidgetStyle, AutoSwitchMode
    - `implementation(project(":sdk:observability"))` — DqxnLogger, ErrorReporter
    - `implementation(project(":sdk:common"))` — dispatcher qualifiers
    - `implementation(libs.datastore.proto)` — Proto DataStore
    - `implementation(libs.datastore.preferences)` — Preferences DataStore
    - `implementation(libs.kotlinx.coroutines.core)`
    - `implementation(libs.kotlinx.collections.immutable)`
    - `implementation(libs.kotlinx.serialization.json)`
    - Add `alias(libs.plugins.kotlin.serialization)` plugin for `@Serializable`

    **consumer-proguard-rules.pro:** Keep rules for proto-generated classes:
    ```
    -keep class app.dqxn.android.data.proto.** { *; }
    -keepclassmembers class * extends com.google.protobuf.GeneratedMessageLite { *; }
    ```

    **DashboardWidgetInstance.kt:** Package `app.dqxn.android.data.layout`. Data class with fields: `instanceId: String`, `typeId: String`, `position: GridPosition`, `size: GridSize`, `style: WidgetStyle` (from `:sdk:contracts`), `settings: ImmutableMap<String, String>`, `dataSourceBindings: ImmutableMap<String, String>`, `zIndex: Int`. Use `@Immutable` annotation via `compileOnly(libs.compose.runtime)` if available, otherwise skip. Include `toProto(): SavedWidget` and companion `fromProto(SavedWidget): DashboardWidgetInstance` conversion functions.

    **GridTypes.kt:** Same package. `data class GridPosition(val col: Int, val row: Int)` and `data class GridSize(val widthUnits: Int, val heightUnits: Int)`.

    **DashboardStoreSerializer.kt:** Package `app.dqxn.android.data.serializer`. Implements `Serializer<DashboardStore>`. `defaultValue = DashboardStore.getDefaultInstance()`. `readFrom` wraps `DashboardStore.parseFrom(input)` in try/catch, throws `CorruptionException` on `InvalidProtocolBufferException`. `writeTo` calls `t.writeTo(output)`.

    **PairedDeviceSerializer.kt:** Same pattern for `PairedDeviceStoreProto`.

    **CustomThemeSerializer.kt:** Same pattern for `CustomThemeStoreProto`.

    **DataModule.kt:** `@Module @InstallIn(SingletonComponent::class) object DataModule`. 3 `@Provides @Singleton` methods for Proto DataStore instances + 2 for Preferences DataStore:
    1. `provideDashboardDataStore(context, logger, errorReporter): DataStore<DashboardStore>` — with `ReplaceFileCorruptionHandler` that logs corruption, reports via `errorReporter.reportNonFatal()`, returns `DashboardStore.getDefaultInstance()`. File: `dashboard_store.pb`.
    2. `providePairedDeviceDataStore(context, logger, errorReporter): DataStore<PairedDeviceStoreProto>` — same corruption pattern. File: `paired_devices.pb`.
    3. `provideCustomThemeDataStore(context, logger, errorReporter): DataStore<CustomThemeStoreProto>` — same pattern. File: `custom_themes.pb`.
    4. `provideUserPreferencesDataStore(context): DataStore<Preferences>` — using `PreferenceDataStoreFactory.create()`. File: `user_preferences.pb`. With `ReplaceFileCorruptionHandler { emptyPreferences() }`.
    5. `provideProviderSettingsDataStore(context): DataStore<Preferences>` — File: `provider_settings.pb`. With corruption handler.
    6. `provideWidgetStyleDataStore(context): DataStore<Preferences>` — File: `widget_styles.pb`. With corruption handler.

    Use `@Named("user_preferences")`, `@Named("provider_settings")`, `@Named("widget_styles")` qualifiers to distinguish the 3 Preferences DataStore instances. Alternatively, use custom qualifier annotations (cleaner).

    CRITICAL: All 6 DataStore instances MUST have `ReplaceFileCorruptionHandler`. This is NF43.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :data:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>`:data` module compiles with proto dependency, domain types, all 6 DataStore providers with corruption handlers, and serializers.</done>
</task>

<task type="auto">
  <name>Task 2: LayoutRepository + LayoutMigration + FallbackLayout + UserPreferencesRepository</name>
  <files>
    android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepository.kt
    android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepositoryImpl.kt
    android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutMigration.kt
    android/data/src/main/kotlin/app/dqxn/android/data/layout/FallbackLayout.kt
    android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
    android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryImpl.kt
    android/data/src/main/kotlin/app/dqxn/android/data/preferences/PreferenceKeys.kt
  </files>
  <action>
    **LayoutRepository.kt:** Interface in `app.dqxn.android.data.layout`:
    - `val profiles: Flow<ImmutableList<ProfileSummary>>` — lightweight profile list (id, name, sortOrder)
    - `val activeProfileId: Flow<String>` — currently active profile ID
    - `fun getActiveProfileWidgets(): Flow<ImmutableList<DashboardWidgetInstance>>` — widgets in active profile
    - `suspend fun createProfile(displayName: String): String` — returns new profile ID
    - `suspend fun cloneProfile(sourceId: String, displayName: String): String` — deep copies widgets with new UUIDs
    - `suspend fun switchProfile(targetId: String)`
    - `suspend fun deleteProfile(id: String)` — cannot delete last profile
    - `suspend fun addWidget(widget: DashboardWidgetInstance)`
    - `suspend fun removeWidget(instanceId: String)`
    - `suspend fun updateWidget(widget: DashboardWidgetInstance)`
    - `suspend fun updateWidgetPosition(instanceId: String, position: GridPosition)`
    - `suspend fun updateWidgetSize(instanceId: String, size: GridSize)`
    - Also define `data class ProfileSummary(val profileId: String, val displayName: String, val sortOrder: Int)`
    - `companion object { val FALLBACK_LAYOUT: ... }` — delegate to FallbackLayout

    **LayoutRepositoryImpl.kt:** `@Singleton class LayoutRepositoryImpl @Inject constructor(dashboardDataStore: DataStore<DashboardStore>, logger: DqxnLogger, @IoDispatcher ioDispatcher: CoroutineDispatcher, @ApplicationScope scope: CoroutineScope)`.
    - Uses `Channel<Unit>(Channel.CONFLATED)` + `receiveAsFlow().debounce(500L)` for debounced save (F7.3)
    - `init {}` block launches save collector on `scope`
    - All mutating methods update an in-memory `MutableStateFlow<DashboardStore>`, then `saveChannel.trySend(Unit)` to trigger debounced write
    - `persistCurrentState()` calls `dataStore.updateData { currentState.value }` on `ioDispatcher`
    - `cloneProfile()` generates new UUIDs for all widgets in the cloned profile (critical — Phase-05 research open question #2)
    - `deleteProfile()` throws `IllegalStateException` if only one profile remains
    - First read applies `LayoutMigration` if `schemaVersion < CURRENT_VERSION`. **Pre-migration backup (F7.2):** Before invoking `migration.migrate(store)`, copy the current proto bytes to `dashboard_store.pb.bak` (via `File.copyTo(backupFile, overwrite = true)` on `ioDispatcher`). On `MigrationResult.Success` → delete backup. On `MigrationResult.Failed` → restore from `.bak` file by writing `result.preBackupStore` back to the DataStore, log error via `errorReporter.reportNonFatal()`. On `MigrationResult.Reset` → delete backup (store is being reset to defaults anyway). On `MigrationResult.NoOp` → no backup created. This ensures a failing transformer never leaves data in an inconsistent state (RESEARCH Pitfall #5).

    **LayoutMigration.kt:** `class LayoutMigration`. Constants: `CURRENT_VERSION = 1`, `MAX_VERSION_GAP = 5`.
    - `sealed interface MigrationResult { data class NoOp(val store: DashboardStore), data class Success(val store: DashboardStore), data object Reset, data class Failed(val failedAtVersion: Int, val preBackupStore: DashboardStore) }`
    - `fun migrate(store: DashboardStore): MigrationResult` — if `schemaVersion >= CURRENT_VERSION` return NoOp. If gap > MAX_VERSION_GAP return Reset. Otherwise apply transformers sequentially. On transformer exception, return `Failed(failedAtVersion, originalStore)` — the `preBackupStore` is the snapshot taken before migration began, enabling the caller to restore.
    - V1 is the initial version — no actual transformers yet. The infrastructure is ready for Phase 7+ schema changes.

    **FallbackLayout.kt:** `object FallbackLayout`. Contains `val FALLBACK_WIDGET = DashboardWidgetInstance(instanceId = "fallback-clock", typeId = "essentials:clock", position = GridPosition(col = 10, row = 5), size = GridSize(widthUnits = 10, heightUnits = 9), style = WidgetStyle.Default, settings = persistentMapOf(), dataSourceBindings = persistentMapOf(), zIndex = 0)`. Also `fun createFallbackProfile(): ProfileCanvas` that wraps FALLBACK_WIDGET in a default profile proto.

    **UserPreferencesRepository.kt:** Interface:
    - `val autoSwitchMode: Flow<AutoSwitchMode>`
    - `val lightThemeId: Flow<String>`
    - `val darkThemeId: Flow<String>`
    - `val illuminanceThreshold: Flow<Float>`
    - `val keepScreenOn: Flow<Boolean>`
    - `val orientationLock: Flow<String>` — landscape, portrait, auto
    - `val showStatusBar: Flow<Boolean>`
    - `suspend fun setAutoSwitchMode(mode: AutoSwitchMode)`
    - `suspend fun setLightThemeId(id: String)`
    - `suspend fun setDarkThemeId(id: String)`
    - `suspend fun setIlluminanceThreshold(threshold: Float)`
    - `suspend fun setKeepScreenOn(enabled: Boolean)`
    - `suspend fun setOrientationLock(lock: String)`
    - `suspend fun setShowStatusBar(visible: Boolean)`

    **UserPreferencesRepositoryImpl.kt:** Backed by `@Named("user_preferences") DataStore<Preferences>`. Each property is a `dataStore.data.map { prefs -> prefs[key] ?: default }`. Setters call `dataStore.edit { prefs -> prefs[key] = value }`.

    **PreferenceKeys.kt:** Object with typed `Preferences.Key<T>` constants: `AUTO_SWITCH_MODE: stringPreferencesKey`, `LIGHT_THEME_ID: stringPreferencesKey`, `DARK_THEME_ID: stringPreferencesKey`, `ILLUMINANCE_THRESHOLD: floatPreferencesKey`, etc.

    Add `@Binds` in DataModule (or a new RepositoryBindingsModule) for `LayoutRepository` → `LayoutRepositoryImpl` and `UserPreferencesRepository` → `UserPreferencesRepositoryImpl`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :data:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>LayoutRepository with profile CRUD and debounced save, LayoutMigration with chained transformer infrastructure, FallbackLayout with hardcoded clock constant, UserPreferencesRepository with dual-theme and auto-switch mode all compile.</done>
</task>

<task type="auto">
  <name>Task 3: Unit tests — LayoutRepository, LayoutMigration, FallbackLayout, UserPreferencesRepository</name>
  <files>
    android/data/src/test/kotlin/app/dqxn/android/data/layout/LayoutRepositoryTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/layout/LayoutMigrationTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/layout/FallbackLayoutTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/di/CorruptionHandlerTest.kt
  </files>
  <action>
    All tests: JUnit5 + Turbine + Truth + StandardTestDispatcher (NOT UnconfinedTestDispatcher).

    **LayoutRepositoryTest.kt:**
    - Create a test-scoped `DataStoreFactory.create()` with `TemporaryFolder` rule (JUnit5 `@TempDir`) for isolated DataStore file
    - Test `createProfile()` → profile appears in `profiles` flow
    - Test `cloneProfile(sourceId)` → new profile has same widgets but different instanceIds
    - Test `switchProfile(targetId)` → `activeProfileId` flow emits new id
    - Test `deleteProfile(id)` → profile removed from list
    - Test `deleteProfile()` on last profile → throws `IllegalStateException`
    - Test debounced save: call `updateWidgetPosition()` 10 times rapidly, verify DataStore write happens once (use `advanceTimeBy(600)` with `StandardTestDispatcher`)
    - Test `addWidget()` → widget appears in `getActiveProfileWidgets()` flow
    - Test `removeWidget()` → widget removed

    **LayoutMigrationTest.kt:**
    - Test `migrate()` with `schemaVersion == CURRENT_VERSION` → returns `NoOp`
    - Test `migrate()` with version gap > MAX_VERSION_GAP → returns `Reset`
    - Test `migrate()` with `schemaVersion = 0` and `CURRENT_VERSION = 1` → returns `Success` (initial migration is a no-op passthrough since v1 is first)
    - Test chained migration infrastructure: set `CURRENT_VERSION = 3` in a test subclass, add v1→v2 and v2→v3 transformers, verify both applied in sequence
    - Test transformer that throws → returns `Failed(failedAtVersion, preBackupStore)` with original store preserved
    - Test failing transformer does NOT leave data in partially-migrated state: add v1→v2 (succeeds) and v2→v3 (throws) transformers, verify `Failed.preBackupStore` is the original v1 input, NOT the v2 intermediate result — the caller can restore cleanly

    **FallbackLayoutTest.kt:**
    - Test `FALLBACK_WIDGET.typeId == "essentials:clock"`
    - Test `FALLBACK_WIDGET.position` is centered (col=10, row=5)
    - Test `createFallbackProfile()` returns a profile with exactly one widget
    - Test fallback layout does NOT depend on any file I/O or asset loading (it's a code-level constant)

    **UserPreferencesRepositoryTest.kt:**
    - Test-scoped Preferences DataStore via `PreferenceDataStoreFactory.create()` with `@TempDir`
    - Test default values: `autoSwitchMode` emits `SYSTEM`, `lightThemeId` emits default (e.g., "minimalist"), `darkThemeId` emits default (e.g., "slate")
    - Test `setAutoSwitchMode(SOLAR_AUTO)` → `autoSwitchMode` flow emits `SOLAR_AUTO`
    - Test `setLightThemeId("custom1")` / `setDarkThemeId("custom2")` → respective flows emit new values
    - Test `setIlluminanceThreshold(200f)` → threshold flow emits 200f
    - Test round-trip: set then read all preference keys

    **CorruptionHandlerTest.kt:** Package `app.dqxn.android.data.di`. JUnit5 + Truth. Behavioral test for NF43 — verifies `ReplaceFileCorruptionHandler` actually works at runtime, not just compiles.
    - **Proto DataStore corruption test:** Use `@TempDir` to create a `dashboard_store.pb` file. Write garbage bytes (e.g., `"NOT_VALID_PROTO".toByteArray()`) to that file. Create a `DataStore<DashboardStore>` via `DataStoreFactory.create()` using `DashboardStoreSerializer` and a `ReplaceFileCorruptionHandler { DashboardStore.getDefaultInstance() }` pointing at the corrupted file. Read `.data.first()` and assert it returns `DashboardStore.getDefaultInstance()` without throwing. Assert the corrupted file is replaced (subsequent reads also succeed).
    - **Preferences DataStore corruption test:** Same pattern — write garbage bytes to a `user_preferences.pb` file in `@TempDir`. Create `DataStore<Preferences>` via `PreferenceDataStoreFactory.create()` with `ReplaceFileCorruptionHandler { emptyPreferences() }`. Read `.data.first()` and assert it returns `emptyPreferences()` without crash. Verify write-after-corruption works: `edit { it[stringPreferencesKey("test")] = "value" }` succeeds and persists.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :data:testDebugUnitTest --tests "*.LayoutRepositoryTest" --tests "*.LayoutMigrationTest" --tests "*.FallbackLayoutTest" --tests "*.UserPreferencesRepositoryTest" --tests "*.CorruptionHandlerTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>LayoutRepository CRUD + debounced save tests pass. LayoutMigration chained migration tests pass (NoOp, Reset, Success, Failed, and failing-transformer-preserves-backup). FallbackLayout hardcoded constant tests pass. UserPreferencesRepository read/write round-trip tests pass. CorruptionHandlerTest verifies both Proto and Preferences DataStore recover from garbage bytes to defaults without crash (NF43 behavioral proof).</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android
./gradlew :data:testDebugUnitTest --console=plain
```
All `:data` tests pass including layout, migration, fallback, and preferences tests.
</verification>

<success_criteria>
1. `./gradlew :data:compileDebugKotlin` succeeds — proto dependency resolves, all types compile
2. `./gradlew :data:testDebugUnitTest` passes — LayoutRepository CRUD, debounced save, migration, fallback, preferences all green
3. All 6 DataStore instances have `ReplaceFileCorruptionHandler` (NF43)
4. `cloneProfile()` generates new widget UUIDs
5. Debounced save verified: 10 rapid mutations → single DataStore write
</success_criteria>

<output>
After completion, create `.planning/phases/05-core-infrastructure/05-03-SUMMARY.md`
</output>
