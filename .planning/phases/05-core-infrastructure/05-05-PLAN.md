---
phase: 05-core-infrastructure
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - android/core/design/build.gradle.kts
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/DashboardSpacing.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/DashboardTypography.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/TextEmphasis.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/CardSize.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/motion/DashboardMotion.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeSchema.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeJsonParser.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/BuiltInThemes.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeAutoSwitchEngine.kt
  - android/core/design/src/main/kotlin/app/dqxn/android/core/design/di/DesignModule.kt
  - android/core/design/src/test/kotlin/app/dqxn/android/core/design/theme/ThemeJsonParserTest.kt
  - android/core/design/src/test/kotlin/app/dqxn/android/core/design/theme/ThemeAutoSwitchEngineTest.kt
  - android/core/design/src/test/kotlin/app/dqxn/android/core/design/token/DashboardSpacingTest.kt
autonomous: true
requirements: [F4.1, F4.2, F4.4, F4.5]

must_haves:
  truths:
    - "Design tokens (spacing, typography, emphasis, card radii) are ported verbatim from old codebase"
    - "DashboardMotion spring configs and named transitions are ported verbatim from old codebase"
    - "ThemeJsonParser converts JSON theme files to DashboardThemeDefinition instances"
    - "ThemeAutoSwitchEngine combines auto-switch mode with late-binding illuminance/solar/preference inputs — no :data dependency"
    - "ThemeAutoSwitchEngine falls back to SYSTEM when SOLAR_AUTO/ILLUMINANCE_AUTO have no bound inputs"
    - "ThemeAutoSwitchEngine uses SharingStarted.Eagerly — ready at cold start"
  artifacts:
    - path: "android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/DashboardSpacing.kt"
      provides: "SpaceXXS through SpaceXXL + 10 semantic aliases"
      contains: "object DashboardSpacing"
    - path: "android/core/design/src/main/kotlin/app/dqxn/android/core/design/motion/DashboardMotion.kt"
      provides: "Spring configs and named enter/exit transitions"
      contains: "object DashboardMotion"
    - path: "android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeAutoSwitchEngine.kt"
      provides: "5-mode theme switching with late-binding sensor inputs"
      contains: "class ThemeAutoSwitchEngine"
    - path: "android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeJsonParser.kt"
      provides: "JSON-to-DashboardThemeDefinition conversion"
      contains: "class ThemeJsonParser"
  key_links:
    - from: "android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeAutoSwitchEngine.kt"
      to: "android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/theme/AutoSwitchMode.kt"
      via: "Receives StateFlow<AutoSwitchMode> and other preference flows via constructor injection — :app DI assembly wires from UserPreferencesRepository"
      pattern: "StateFlow<AutoSwitchMode>"
    - from: "android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeJsonParser.kt"
      to: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt"
      via: "Produces DashboardThemeDefinition from parsed JSON"
      pattern: "DashboardThemeDefinition"
---

<objective>
Implement the `:core:design` module with design tokens, motion specs, theme JSON parsing, and the ThemeAutoSwitchEngine.

Purpose: `:core:design` is the visual foundation consumed by all feature modules and overlays. Design tokens ensure consistent spacing/typography across the app. The ThemeAutoSwitchEngine manages the 5 auto-switch modes with late-binding sensor inputs, avoiding the old codebase's pack isolation violation.
Output: Complete `:core:design` module with ported design tokens, motion specs, theme JSON parser, ThemeAutoSwitchEngine, and tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-core-infrastructure/05-RESEARCH.md
@.planning/migration/replication-advisory.md (sections 3, 4, 5)
@android/core/design/build.gradle.kts
@android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt
@android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/GradientSpec.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/theme/AutoSwitchMode.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Design tokens + motion specs + theme JSON parser + BuiltInThemes</name>
  <files>
    android/core/design/build.gradle.kts
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/DashboardSpacing.kt
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/DashboardTypography.kt
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/TextEmphasis.kt
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/token/CardSize.kt
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/motion/DashboardMotion.kt
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeSchema.kt
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeJsonParser.kt
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/BuiltInThemes.kt
  </files>
  <action>
    **build.gradle.kts:** Already has `dqxn.android.library`, `dqxn.android.compose`, `dqxn.android.test`. Add:
    - `implementation(project(":sdk:ui"))` — DashboardThemeDefinition, GradientSpec
    - `implementation(project(":sdk:contracts"))` — AutoSwitchMode, ThemeSpec
    - `implementation(project(":sdk:observability"))` — DqxnLogger
    - `implementation(project(":sdk:common"))` — dispatcher qualifiers, @ApplicationScope
    - `implementation(libs.kotlinx.serialization.json)` — theme JSON parsing
    - `implementation(libs.kotlinx.collections.immutable)`
    - Add `alias(libs.plugins.kotlin.serialization)` if needed for `@Serializable`
    - Add `id("dqxn.android.hilt")` for ThemeAutoSwitchEngine DI
    - **DO NOT** add `implementation(project(":data"))` — ARCHITECTURE.md restricts `:core:design` to `:sdk:common` and `:sdk:ui` only. Preference values are injected as StateFlow parameters (see Task 2).

    **DashboardSpacing.kt:** Port VERBATIM from old codebase `DashboardThemeExtensions.kt`. Object with Dp values:
    - `SpaceXXS = 4.dp`, `SpaceXS = 8.dp`, `SpaceS = 12.dp`, `SpaceM = 16.dp`, `SpaceL = 24.dp`, `SpaceXL = 32.dp`, `SpaceXXL = 48.dp`
    - 10 semantic aliases: `ScreenEdgePadding = 16.dp`, `SectionGap = 16.dp`, `ItemGap = 12.dp`, `InGroupGap = 8.dp`, `ButtonGap = 8.dp`, `IconTextGap = 8.dp`, `LabelInputGap = 8.dp`, `CardInternalPadding = 16.dp`, `NestedIndent = 16.dp`, `MinTouchTarget = 48.dp`

    Read old codebase file directly at `../dqxn.old/android/feature/dashboard/src/main/kotlin/.../DashboardThemeExtensions.kt` to verify exact values before porting.

    **DashboardTypography.kt:** Port from old codebase. Object with 8 named TextStyle getters:
    - `title`, `sectionHeader`, `itemTitle`, `label`, `description`, `buttonLabel`, `primaryButtonLabel`, `caption`
    - Include `getTightTextStyle(base: TextStyle, lineHeightMultiplier: Float)` helper
    - Verify against Material 3 type scale for consistency

    **TextEmphasis.kt:** Port VERBATIM. Object with 4 alpha constants:
    - `High = 1.0f`, `Medium = 0.7f`, `Disabled = 0.4f`, `Pressed = 0.12f`
    - Fix known inconsistency from replication advisory §5: old code uses 0.6 alpha in OverlayTitleBar, should be 0.7 (Medium)

    **CardSize.kt:** Port VERBATIM. Enum: `SMALL(8.dp)`, `MEDIUM(12.dp)`, `LARGE(16.dp)` corner radii.

    **DashboardMotion.kt:** Port VERBATIM from old `DashboardAnimations.kt`. Read old source at `../dqxn.old/android/feature/dashboard/src/main/kotlin/.../DashboardAnimations.kt`. Object with:
    - `standardSpring = spring<Float>(dampingRatio = 0.65f, stiffness = 300f)`
    - `standardSpringInt = spring<IntOffset>(dampingRatio = 0.65f, stiffness = 300f)`
    - `hubSpring = spring<Float>(dampingRatio = 0.5f, stiffness = 300f)`
    - `previewSpring = spring<IntOffset>(dampingRatio = 0.75f, stiffness = 380f)`
    - Named transitions: `sheetEnter`, `sheetExit`, `hubEnter`, `hubExit`, etc. with duration asymmetry (enter 200ms, exit 150ms per replication advisory §4)
    - Port ALL named transitions verbatim — do not re-guess tuned values

    **ThemeSchema.kt:** `@Serializable` data classes for JSON theme parsing:
    - `@Serializable data class ThemeColorSchema(val primary: String, val secondary: String, val accent: String, val background: String, val surface: String, val onSurface: String, val error: String? = null, val warning: String? = null, val success: String? = null)`
    - `@Serializable data class ThemeGradientSchema(val type: String, val stops: List<GradientStopSchema>)`
    - `@Serializable data class GradientStopSchema(val color: String, val position: Float)`
    - `@Serializable data class ThemeFileSchema(val id: String, val name: String, val isDark: Boolean, val colors: ThemeColorSchema, val backgroundGradient: ThemeGradientSchema? = null, val widgetBackgroundGradient: ThemeGradientSchema? = null)`

    **ThemeJsonParser.kt:** `@Singleton class ThemeJsonParser @Inject constructor(private val json: Json)`.
    - `fun parse(jsonString: String): DashboardThemeDefinition?` — parses `ThemeFileSchema`, converts to `DashboardThemeDefinition`. Color strings parsed via `Color(android.graphics.Color.parseColor(hex))`. Gradient schemas converted to `GradientSpec`.
    - `fun parseAll(jsonArrayString: String): List<DashboardThemeDefinition>` — parses array of themes
    - Handle malformed JSON gracefully (return null, log warning)

    **BuiltInThemes.kt:** Object that provides references to the two free themes (Slate, Minimalist) already defined in `:sdk:ui` `DefaultTheme.kt`. Also provides a method `fun loadBundledThemes(context: Context): ImmutableList<DashboardThemeDefinition>` that loads theme JSON files from `assets/themes/` directory. Phase 9 populates the 22 premium theme files; Phase 5 provides the loading infrastructure.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :core:design:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>Design tokens ported verbatim. DashboardMotion springs and transitions ported verbatim. ThemeJsonParser converts JSON to DashboardThemeDefinition. BuiltInThemes references free themes and provides bundled theme loading infrastructure.</done>
</task>

<task type="auto">
  <name>Task 2: ThemeAutoSwitchEngine + Hilt module + tests</name>
  <files>
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeAutoSwitchEngine.kt
    android/core/design/src/main/kotlin/app/dqxn/android/core/design/di/DesignModule.kt
    android/core/design/src/test/kotlin/app/dqxn/android/core/design/theme/ThemeJsonParserTest.kt
    android/core/design/src/test/kotlin/app/dqxn/android/core/design/theme/ThemeAutoSwitchEngineTest.kt
    android/core/design/src/test/kotlin/app/dqxn/android/core/design/token/DashboardSpacingTest.kt
  </files>
  <action>
    **ThemeAutoSwitchEngine.kt:** `:core:design` MUST NOT depend on `:data` (ARCHITECTURE.md: `:core:design` → `:sdk:common`, `:sdk:ui` only). Instead of injecting `UserPreferencesRepository`, inject individual `StateFlow` parameters that `:app` DI wires from the repository. This matches the existing late-binding pattern used for sensor inputs.

    Constructor: `@Singleton class ThemeAutoSwitchEngine @Inject constructor(@ApplicationContext context: Context, @ApplicationScope scope: CoroutineScope, logger: DqxnLogger)`.

    **Injected preference flows** (set by `:app` DI module after construction, same late-binding pattern as sensor inputs):
    - `private val _autoSwitchMode = MutableStateFlow(AutoSwitchMode.SYSTEM)`
    - `private val _lightThemeId = MutableStateFlow("minimalist")`
    - `private val _darkThemeId = MutableStateFlow("slate")`
    - `private val _illuminanceThreshold = MutableStateFlow(200f)`
    - `fun bindPreferences(autoSwitchMode: StateFlow<AutoSwitchMode>, lightThemeId: StateFlow<String>, darkThemeId: StateFlow<String>, illuminanceThreshold: StateFlow<Float>)` — launches collectors on `scope` that update internal MutableStateFlows. Call site: `:app` DI assembly module invokes this after constructing both `ThemeAutoSwitchEngine` and `UserPreferencesRepository`.

    Late-binding inputs for sensor data (providers register these in Phase 8):
    - `private val _illuminanceFlow = MutableStateFlow<Float?>(null)` — null means no illuminance provider bound
    - `private val _solarIsDaytimeFlow = MutableStateFlow<Boolean?>(null)` — null means no solar provider bound
    - `fun bindIlluminance(source: StateFlow<Float>)` — launches collector that updates `_illuminanceFlow`
    - `fun bindSolarDaytime(source: StateFlow<Boolean>)` — same pattern

    Core `isDarkActive: StateFlow<Boolean>`:
    ```
    combine(
        _autoSwitchMode,
        systemDarkModeFlow(),
        _solarIsDaytimeFlow,
        _illuminanceFlow,
        _illuminanceThreshold,
    ) { mode, systemDark, solarDaytime, lux, threshold ->
        when (mode) {
            LIGHT -> false
            DARK -> true
            SYSTEM -> systemDark
            SOLAR_AUTO -> solarDaytime?.not() ?: systemDark
            ILLUMINANCE_AUTO -> lux?.let { it < threshold } ?: systemDark
        }
    }.distinctUntilChanged()
     .stateIn(scope, SharingStarted.Eagerly, isSystemInDarkMode())
    ```

    The `systemDarkModeFlow()` should observe `Configuration.UI_MODE_NIGHT_MASK` changes reactively. Use `@ApplicationContext context: Context` and check `context.resources.configuration.uiMode and Configuration.UI_MODE_NIGHT_MASK == Configuration.UI_MODE_NIGHT_YES`. For reactivity, register `context.registerComponentCallbacks()` with `onConfigurationChanged()`. This fires when system dark mode toggles.

    The `activeTheme: StateFlow<DashboardThemeDefinition>` combines `isDarkActive` with `_lightThemeId` and `_darkThemeId`, then resolves the theme by ID from `BuiltInThemes`. Phase 9 adds premium theme resolution.

    **DesignModule.kt:** `@Module @InstallIn(SingletonComponent::class) object DesignModule`. Provide `ThemeJsonParser` with `Json { ignoreUnknownKeys = true }`. The `ThemeAutoSwitchEngine` has `@Inject constructor` so no explicit provides needed.

    **ThemeAutoSwitchEngineTest.kt:** JUnit5 + Turbine + StandardTestDispatcher.
    - Construct `ThemeAutoSwitchEngine` with mock `Context` (for system dark mode check) and `TestScope`
    - Create `MutableStateFlow` instances for `autoSwitchMode`, `lightThemeId`, `darkThemeId`, `illuminanceThreshold` and call `bindPreferences()` to wire them
    - Test LIGHT mode → `isDarkActive` emits false regardless of system mode
    - Test DARK mode → `isDarkActive` emits true regardless
    - Test SYSTEM mode → follows system dark mode value
    - Test SOLAR_AUTO with no bound solar provider → falls back to SYSTEM behavior
    - Test SOLAR_AUTO with bound daytime=true → isDarkActive=false, daytime=false → isDarkActive=true
    - Test ILLUMINANCE_AUTO with no bound provider → falls back to SYSTEM
    - Test ILLUMINANCE_AUTO with bound lux=100 and threshold=200 → dark, lux=300 → light
    - Test `SharingStarted.Eagerly` — isDarkActive has value immediately after construction (no suspend required)
    - Test mode switching: change autoSwitchMode MutableStateFlow from DARK to LIGHT → isDarkActive changes
    - Test unbound preferences (no `bindPreferences` call) → uses defaults (SYSTEM mode, minimalist light, slate dark)

    **ThemeJsonParserTest.kt:** JUnit5 + Truth.
    - Test valid JSON → produces DashboardThemeDefinition with correct colors
    - Test JSON with gradients → GradientSpec types parsed correctly (VERTICAL, RADIAL, etc.)
    - Test malformed JSON → returns null (no crash)
    - Test missing optional fields → defaults applied
    - Test color parsing: "#FF0000" → Color.Red, "#80FF0000" → semi-transparent red

    **DashboardSpacingTest.kt:** JUnit5 + Truth.
    - Test all 7 spacing values match expected Dp (SpaceXXS=4, SpaceXS=8, ..., SpaceXXL=48)
    - Test all 10 semantic aliases are non-zero
    - Test MinTouchTarget = 48.dp
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :core:design:testDebugUnitTest --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>ThemeAutoSwitchEngine handles all 5 modes with correct fallback behavior. Late-binding inputs work for SOLAR_AUTO and ILLUMINANCE_AUTO. Theme JSON parsing produces valid DashboardThemeDefinitions. Design token values verified against old codebase.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android
./gradlew :core:design:testDebugUnitTest --console=plain
```
All `:core:design` tests pass.
</verification>

<success_criteria>
1. `./gradlew :core:design:compileDebugKotlin` succeeds with Compose compiler
2. Design tokens match old codebase values exactly (port verified)
3. DashboardMotion spring configs match old codebase exactly (0.65/300, 0.50/300, 0.75/380)
4. ThemeAutoSwitchEngine: 5 modes working, SOLAR/ILLUMINANCE fall back to SYSTEM when unbound
5. ThemeAutoSwitchEngine uses `SharingStarted.Eagerly` — value available at cold start
6. ThemeJsonParser: valid JSON produces theme, malformed returns null
7. All `:core:design` tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-core-infrastructure/05-05-SUMMARY.md`
</output>
