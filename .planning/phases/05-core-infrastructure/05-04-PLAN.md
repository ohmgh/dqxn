---
phase: 05-core-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - android/data/src/main/kotlin/app/dqxn/android/data/provider/ProviderSettingsStore.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/provider/ProviderSettingsStoreImpl.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/provider/SettingsSerialization.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStore.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStoreImpl.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/device/ConnectionEventStore.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/device/ConnectionEventStoreImpl.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/style/WidgetStyleStore.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/style/WidgetStyleStoreImpl.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preset/PresetLoader.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preset/PresetModels.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preset/FallbackRegionDetector.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/di/StoreBindingsModule.kt
  - android/data/src/main/assets/presets/default.json
  - android/data/src/test/kotlin/app/dqxn/android/data/provider/ProviderSettingsStoreTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/device/PairedDeviceStoreTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/device/ConnectionEventStoreTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/style/WidgetStyleStoreTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/preset/PresetLoaderTest.kt
autonomous: true
requirements: [F7.4, F7.5, F7.7]

must_haves:
  truths:
    - "ProviderSettingsStore uses {packId}:{providerId}:{key} namespaced keys with type-prefixed serialization"
    - "Writing settings for one provider does not affect another provider's settings"
    - "PairedDeviceStore persists BLE device metadata across restarts"
    - "ConnectionEventStore maintains a rolling 50-event window"
    - "WidgetStyleStore persists per-widget container styles with defaults for missing widgets"
    - "PresetLoader selects region-aware presets using timezone-based heuristic"
    - "Preset loading failure falls back to FallbackLayout (hardcoded clock widget)"
  artifacts:
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/provider/ProviderSettingsStore.kt"
      provides: "Interface for pack-namespaced provider settings"
      contains: "interface ProviderSettingsStore"
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/provider/SettingsSerialization.kt"
      provides: "Type-prefixed serialization (s:, i:, b:, f:, d:, l:, j:)"
      contains: "fun serializeValue"
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStore.kt"
      provides: "CRUD interface for paired BLE device persistence"
      contains: "interface PairedDeviceStore"
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/preset/PresetLoader.kt"
      provides: "Region-aware preset loading with JSON parsing"
      contains: "class PresetLoader"
  key_links:
    - from: "android/data/src/main/kotlin/app/dqxn/android/data/provider/ProviderSettingsStoreImpl.kt"
      to: "android/data/src/main/kotlin/app/dqxn/android/data/provider/SettingsSerialization.kt"
      via: "Type-prefixed encode/decode for all setting values"
      pattern: "serializeValue|deserializeValue"
    - from: "android/data/src/main/kotlin/app/dqxn/android/data/preset/PresetLoader.kt"
      to: "android/data/src/main/kotlin/app/dqxn/android/data/layout/FallbackLayout.kt"
      via: "Fallback when preset JSON loading fails"
      pattern: "FallbackLayout"
---

<objective>
Implement the remaining `:data` stores and the preset loading system.

Purpose: These stores complete the persistence layer consumed by Phase 7 coordinators. ProviderSettingsStore enables per-widget data source configuration. PairedDeviceStore persists BLE device associations. PresetLoader provides the first-launch experience with region-aware default layouts.
Output: 5 store interface/impl pairs, type-prefixed serialization, preset JSON, timezone-based region detection, and comprehensive tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-core-infrastructure/05-RESEARCH.md
@.planning/phases/05-core-infrastructure/05-03-SUMMARY.md
@android/data/src/main/kotlin/app/dqxn/android/data/di/DataModule.kt
@android/data/src/main/kotlin/app/dqxn/android/data/layout/DashboardWidgetInstance.kt
@android/data/src/main/kotlin/app/dqxn/android/data/layout/GridTypes.kt
@android/data/src/main/kotlin/app/dqxn/android/data/layout/FallbackLayout.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: ProviderSettingsStore + SettingsSerialization + PairedDeviceStore + ConnectionEventStore + WidgetStyleStore</name>
  <files>
    android/data/src/main/kotlin/app/dqxn/android/data/provider/ProviderSettingsStore.kt
    android/data/src/main/kotlin/app/dqxn/android/data/provider/ProviderSettingsStoreImpl.kt
    android/data/src/main/kotlin/app/dqxn/android/data/provider/SettingsSerialization.kt
    android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStore.kt
    android/data/src/main/kotlin/app/dqxn/android/data/device/PairedDeviceStoreImpl.kt
    android/data/src/main/kotlin/app/dqxn/android/data/device/ConnectionEventStore.kt
    android/data/src/main/kotlin/app/dqxn/android/data/device/ConnectionEventStoreImpl.kt
    android/data/src/main/kotlin/app/dqxn/android/data/style/WidgetStyleStore.kt
    android/data/src/main/kotlin/app/dqxn/android/data/style/WidgetStyleStoreImpl.kt
    android/data/src/main/kotlin/app/dqxn/android/data/di/StoreBindingsModule.kt
  </files>
  <action>
    **ProviderSettingsStore.kt:** Interface in `app.dqxn.android.data.provider`:
    - `fun getSetting(packId: String, providerId: String, key: String): Flow<Any?>`
    - `suspend fun setSetting(packId: String, providerId: String, key: String, value: Any?)`
    - `fun getAllSettings(packId: String, providerId: String): Flow<ImmutableMap<String, Any?>>`
    - `suspend fun clearSettings(packId: String, providerId: String)`

    **ProviderSettingsStoreImpl.kt:** Backed by `@Named("provider_settings") DataStore<Preferences>`. Key format: `"$packId:$providerId:$key"` (F7.4). Values stored as type-prefixed strings via `SettingsSerialization`.

    **SettingsSerialization.kt:** Object with `serializeValue(value: Any?): String` and `deserializeValue(serialized: String?): Any?`. Type prefixes: `s:` String, `i:` Int, `b:` Boolean, `f:` Float, `d:` Double, `l:` Long, `j:` JSON fallback. `null` → `"null"`. Legacy fallback: unprefixed strings treated as raw String. Ported from old codebase pattern (verified in research).

    **PairedDeviceStore.kt:** Interface in `app.dqxn.android.data.device`:
    - `val devices: Flow<ImmutableList<PairedDevice>>`
    - `suspend fun addDevice(device: PairedDevice)` — rejects duplicate MAC
    - `suspend fun removeDevice(macAddress: String)`
    - `suspend fun updateLastConnected(macAddress: String, timestamp: Long)`
    - Define `data class PairedDevice(val definitionId: String, val displayName: String, val macAddress: String, val lastConnected: Long, val associationId: Int)`

    **PairedDeviceStoreImpl.kt:** Backed by `DataStore<PairedDeviceStoreProto>`. Converts between proto `PairedDeviceMetadata` and domain `PairedDevice`. `addDevice()` checks for duplicate MAC address and throws `IllegalArgumentException` if found.

    **ConnectionEventStore.kt:** Interface:
    - `val events: Flow<ImmutableList<ConnectionEvent>>`
    - `suspend fun recordEvent(event: ConnectionEvent)`
    - `suspend fun clear()`
    - Define `@Serializable data class ConnectionEvent(val timestamp: Long, val deviceMac: String, val eventType: String, val details: String = "")`

    **ConnectionEventStoreImpl.kt:** Backed by `@Named("provider_settings") DataStore<Preferences>` (or a separate Preferences DataStore — research says keep as Preferences). Stores serialized JSON list under a single key. Rolling 50-event window: when list exceeds 50, drop oldest. Use `kotlinx.serialization.json` for list serialization.

    Actually, ConnectionEventStore should use its own Preferences DataStore or share with provider settings? Research says "Preferences DataStore with a JSON-serialized list". To avoid coupling, add a 7th DataStore in DataModule for connection events, or store under a dedicated key in the provider_settings DataStore. A dedicated key in an existing DataStore is simpler and avoids the "too many DataStore files" anti-pattern. Use a dedicated key `"__connection_events__"` in the provider_settings DataStore (prefix with `__` to avoid collision with `{packId}:{providerId}:{key}` namespace).

    **WidgetStyleStore.kt:** Interface in `app.dqxn.android.data.style`:
    - `fun getStyle(instanceId: String): Flow<WidgetStyle>`
    - `suspend fun setStyle(instanceId: String, style: WidgetStyle)`
    - `suspend fun removeStyle(instanceId: String)`

    **WidgetStyleStoreImpl.kt:** Backed by `@Named("widget_styles") DataStore<Preferences>`. Stores `WidgetStyle` as JSON-serialized string per widget instance ID. Returns `WidgetStyle.Default` for missing widgets.

    **StoreBindingsModule.kt:** `@Module @InstallIn(SingletonComponent::class) abstract class StoreBindingsModule`. `@Binds` for:
    - `ProviderSettingsStore` → `ProviderSettingsStoreImpl`
    - `PairedDeviceStore` → `PairedDeviceStoreImpl`
    - `ConnectionEventStore` → `ConnectionEventStoreImpl`
    - `WidgetStyleStore` → `WidgetStyleStoreImpl`
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :data:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>All 5 store implementations compile with correct Hilt bindings. Type-prefixed serialization handles all 7 type variants.</done>
</task>

<task type="auto">
  <name>Task 2: PresetLoader + preset JSON + region detection</name>
  <files>
    android/data/src/main/kotlin/app/dqxn/android/data/preset/PresetLoader.kt
    android/data/src/main/kotlin/app/dqxn/android/data/preset/PresetModels.kt
    android/data/src/main/kotlin/app/dqxn/android/data/preset/FallbackRegionDetector.kt
    android/data/src/main/assets/presets/default.json
  </files>
  <action>
    **PresetModels.kt:** Package `app.dqxn.android.data.preset`.
    - `@Serializable data class PresetManifest(val name: String, val description: String, val schemaVersion: Int, val widgets: List<PresetWidget>)`
    - `@Serializable data class PresetWidget(val typeId: String, val gridX: Int, val gridY: Int, val widthUnits: Int, val heightUnits: Int, val style: PresetWidgetStyle = PresetWidgetStyle(), val settings: Map<String, String> = emptyMap())`
    - `@Serializable data class PresetWidgetStyle(val backgroundStyle: String = "SOLID", val opacity: Float = 1.0f, val showBorder: Boolean = false, val hasGlowEffect: Boolean = false, val cornerRadiusPercent: Int = 0, val rimSizePercent: Int = 0)`

    **FallbackRegionDetector.kt:** `internal object FallbackRegionDetector`. `fun detectRegion(): String` using `TimeZone.getDefault().id`. Map timezone prefixes: `America/` → "US", `Europe/London|Europe/Dublin` → "GB", `Asia/Singapore` → "SG", `Asia/Tokyo` → "JP", `Europe/` → "EU", default → "DEFAULT". This is the simple timezone-based heuristic — Phase 8's `RegionDetector` can enhance with locale/SIM.

    **PresetLoader.kt:** `@Singleton class PresetLoader @Inject constructor(@ApplicationContext context: Context, logger: DqxnLogger)`.
    - `fun loadPreset(region: String = FallbackRegionDetector.detectRegion()): List<DashboardWidgetInstance>` — attempts to load `presets/{region}.json` from assets. If not found, falls back to `presets/default.json`. If that also fails (APK corruption), returns `listOf(FallbackLayout.FALLBACK_WIDGET)`.
    - Parses JSON via `kotlinx.serialization.json`. Converts `PresetWidget` to `DashboardWidgetInstance` with generated UUID for `instanceId`.
    - Remaps `free:*` typeIds to `essentials:*` for legacy preset compatibility (research pitfall #6).
    - Filters out GPS-dependent widgets (typeIds containing "speedometer", "compass", "gforce", "altimeter", "solar") per F11.5 — first launch preset must not include GPS widgets.

    **default.json:** Create the default preset JSON file at `android/data/src/main/assets/presets/default.json`:
    ```json
    {
      "name": "Default",
      "description": "Default dashboard layout",
      "schemaVersion": 1,
      "widgets": [
        { "typeId": "essentials:clock", "gridX": 10, "gridY": 3, "widthUnits": 10, "heightUnits": 9 },
        { "typeId": "essentials:battery", "gridX": 22, "gridY": 3, "widthUnits": 6, "heightUnits": 6 },
        { "typeId": "essentials:date-simple", "gridX": 10, "gridY": 13, "widthUnits": 10, "heightUnits": 4 }
      ]
    }
    ```
    Only clock, battery, date — no GPS widgets per F11.5.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :data:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>PresetLoader loads region-aware JSON presets with `essentials:*` typeIds. Timezone-based region detection covers US/GB/SG/JP/EU regions. FallbackLayout kicks in when preset loading fails.</done>
</task>

<task type="auto">
  <name>Task 3: Tests for remaining stores and PresetLoader</name>
  <files>
    android/data/src/test/kotlin/app/dqxn/android/data/provider/ProviderSettingsStoreTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/device/PairedDeviceStoreTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/device/ConnectionEventStoreTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/style/WidgetStyleStoreTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/preset/PresetLoaderTest.kt
  </files>
  <action>
    All tests: JUnit5 + Turbine + Truth + StandardTestDispatcher.

    **ProviderSettingsStoreTest.kt:**
    - Test `setSetting("essentials", "gps-speed", "unit", "mph")` → `getSetting()` returns "mph"
    - Test type-prefixed round-trip: Int, Float, Boolean, Long, Double, String, null
    - Test namespace isolation: writing `essentials:gps-speed:unit` does NOT affect `essentials:compass:style`
    - Test `clearSettings("essentials", "gps-speed")` removes only that provider's settings
    - Test `getAllSettings()` returns all keys for a specific provider
    - Test deserialization of legacy unprefixed values (raw string fallback)

    **PairedDeviceStoreTest.kt:**
    - Test `addDevice()` → appears in `devices` flow
    - Test duplicate MAC rejection → throws `IllegalArgumentException`
    - Test `removeDevice(mac)` → device removed
    - Test `updateLastConnected()` → timestamp updated
    - Test persistence: create DataStore, add device, create new impl with same file → device still present

    **ConnectionEventStoreTest.kt:**
    - Test `recordEvent()` → appears in `events` flow
    - Test rolling 50-event window: add 51 events, verify oldest evicted, newest present
    - Test event ordering preserved (newest last)
    - Test `clear()` removes all events

    **WidgetStyleStoreTest.kt:**
    - Test `setStyle(instanceId, style)` → `getStyle()` returns it
    - Test `getStyle()` for missing widget → returns `WidgetStyle.Default`
    - Test `removeStyle()` → subsequent `getStyle()` returns default
    - Test JSON round-trip of all `WidgetStyle` fields (opacity, border, glow, cornerRadius, etc.)

    **PresetLoaderTest.kt:**
    - Test region detection: "America/New_York" → "US", "Asia/Singapore" → "SG", "Asia/Tokyo" → "JP"
    - Test default preset loads 3 widgets (clock, battery, date)
    - Test no GPS-dependent widgets in default preset (F11.5)
    - Test `free:*` → `essentials:*` typeId remapping
    - Test preset loading failure → returns FallbackLayout (single clock widget)
    - Test each widget gets a unique UUID instanceId

    For PresetLoader tests requiring asset loading, either mock `Context.assets` or use a test resource. If mocking is complex, test the JSON parsing + conversion logic separately (pass JSON string to a `parsePreset()` method).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :data:testDebugUnitTest --tests "*.ProviderSettingsStoreTest" --tests "*.PairedDeviceStoreTest" --tests "*.ConnectionEventStoreTest" --tests "*.WidgetStyleStoreTest" --tests "*.PresetLoaderTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>All store tests pass: namespace isolation verified, rolling window enforced, type-prefixed serialization round-trips correctly, preset loading with region detection and fallback chain works.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android
./gradlew :data:testDebugUnitTest --console=plain
```
All `:data` tests pass (Plans 03 + 04 combined).
</verification>

<success_criteria>
1. ProviderSettingsStore namespace isolation: writing to `essentials:gps-speed:unit` does not affect `essentials:compass:style`
2. Type-prefixed serialization round-trips all 7 types correctly (s:, i:, b:, f:, d:, l:, j:)
3. ConnectionEventStore rolling 50-event window enforced — 51st event evicts oldest
4. PresetLoader region heuristic returns correct regions for known timezones
5. Default preset contains only permission-safe widgets (no GPS)
6. All store tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-core-infrastructure/05-04-SUMMARY.md`
</output>
