---
phase: 05-core-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - android/core/firebase/build.gradle.kts
  - android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseCrashReporter.kt
  - android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTracker.kt
  - android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebasePerformanceTracer.kt
  - android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/di/FirebaseModule.kt
  - android/core/firebase/src/test/kotlin/app/dqxn/android/core/firebase/FirebaseCrashReporterTest.kt
  - android/core/firebase/src/test/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTrackerTest.kt
autonomous: true
requirements: []

must_haves:
  truths:
    - "FirebaseCrashReporter delegates recordException/log/setCustomKey to Crashlytics"
    - "FirebaseAnalyticsTracker delegates logEvent/setUserProperty to Firebase Analytics with consent gating"
    - "Firebase SDKs are isolated to this single module — no other module has Firebase dependencies"
    - "Hilt binds FirebaseCrashReporter to CrashReporter and FirebaseAnalyticsTracker to AnalyticsTracker"
  artifacts:
    - path: "android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseCrashReporter.kt"
      provides: "CrashReporter implementation wrapping Crashlytics"
      contains: "class FirebaseCrashReporter"
    - path: "android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTracker.kt"
      provides: "AnalyticsTracker implementation wrapping Firebase Analytics"
      contains: "class FirebaseAnalyticsTracker"
    - path: "android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/di/FirebaseModule.kt"
      provides: "Hilt bindings for Firebase implementations to SDK interfaces"
      contains: "@Module"
  key_links:
    - from: "android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseCrashReporter.kt"
      to: "android/sdk/observability/src/main/kotlin/app/dqxn/android/sdk/observability/crash/CrashReporter.kt"
      via: "implements CrashReporter interface"
      pattern: "CrashReporter"
    - from: "android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTracker.kt"
      to: "android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsTracker.kt"
      via: "implements AnalyticsTracker interface"
      pattern: "AnalyticsTracker"
---

<objective>
Implement the Firebase isolation module wrapping Crashlytics, Analytics, and Performance behind SDK interfaces.

Purpose: `:core:firebase` is the only module with Firebase SDK dependencies. All other modules interact with crash reporting and analytics via the interfaces defined in `:sdk:observability` and `:sdk:analytics`. This isolation ensures Firebase doesn't leak into the dependency graph.
Output: Complete `:core:firebase` module with 3 implementation classes, Hilt module, and mock-based tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-core-infrastructure/05-RESEARCH.md
@android/core/firebase/build.gradle.kts
@android/sdk/observability/src/main/kotlin/app/dqxn/android/sdk/observability/crash/CrashReporter.kt
@android/sdk/observability/src/main/kotlin/app/dqxn/android/sdk/observability/crash/ErrorReporter.kt
@android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsTracker.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Firebase wrapper implementations — CrashReporter, AnalyticsTracker, PerformanceTracer</name>
  <files>
    android/core/firebase/build.gradle.kts
    android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseCrashReporter.kt
    android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTracker.kt
    android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebasePerformanceTracer.kt
    android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/di/FirebaseModule.kt
  </files>
  <action>
    **build.gradle.kts:** Add plugins: `id("dqxn.android.hilt")`. Add dependencies:
    - `implementation(project(":sdk:observability"))` — for CrashReporter, ErrorReporter
    - `implementation(project(":sdk:analytics"))` — for AnalyticsTracker
    - `implementation(project(":sdk:common"))` — for dispatcher qualifiers
    - `implementation(platform(libs.firebase.bom))` — Firebase BOM
    - `implementation(libs.firebase.crashlytics)` — Crashlytics
    - `implementation(libs.firebase.analytics)` — Analytics
    - `implementation(libs.firebase.perf)` — Performance

    **FirebaseCrashReporter.kt:** Package `app.dqxn.android.core.firebase`. `@Singleton class FirebaseCrashReporter @Inject constructor() : CrashReporter`. Implement all CrashReporter interface methods by delegating to `Firebase.crashlytics`:
    - `recordException(throwable, context)` → `crashlytics.recordException(throwable)` with custom keys from ErrorContext
    - `log(message)` → `crashlytics.log(message)`
    - `setCustomKey(key, value)` → `crashlytics.setCustomKey(key, value)`
    - `setUserId(id)` → `crashlytics.setUserId(id)`
    - `setCrashlyticsCollectionEnabled(enabled)` for consent gating

    Read the actual CrashReporter interface first to match its exact API surface. Do NOT invent methods that don't exist on the interface.

    **FirebaseAnalyticsTracker.kt:** `@Singleton class FirebaseAnalyticsTracker @Inject constructor(@ApplicationContext context: Context) : AnalyticsTracker`. Read the actual AnalyticsTracker interface to implement its exact methods. Typical API:
    - `logEvent(event)` → `firebaseAnalytics.logEvent(event.name, bundle)`
    - `setUserProperty(name, value)` → `firebaseAnalytics.setUserProperty(name, value)`
    - `setAnalyticsCollectionEnabled(enabled)` → `firebaseAnalytics.setAnalyticsCollectionEnabled(enabled)` for consent gating
    - Convert `AnalyticsEvent` sealed types to Firebase Bundle parameters

    **FirebasePerformanceTracer.kt:** Lightweight wrapper around Firebase Performance for custom trace spans. `@Singleton class FirebasePerformanceTracer @Inject constructor()`. Methods:
    - `startTrace(name): Trace` → `Firebase.performance.newTrace(name).also { it.start() }`
    - `stopTrace(trace)` → `trace.stop()`
    - `setEnabled(enabled)` → `Firebase.performance.isPerformanceCollectionEnabled = enabled`

    **FirebaseModule.kt:** `@Module @InstallIn(SingletonComponent::class) abstract class FirebaseModule`. Use `@Binds` to bind:
    - `FirebaseCrashReporter` → `CrashReporter`
    - `FirebaseAnalyticsTracker` → `AnalyticsTracker`
    Do NOT bind ErrorReporter here — DeduplicatingErrorReporter from `:sdk:observability` wraps CrashReporter. That binding happens in `:app` (Phase 6).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :core:firebase:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>`:core:firebase` compiles with all 3 Firebase wrapper classes and Hilt module. Firebase SDKs confined to this module only.</done>
</task>

<task type="auto">
  <name>Task 2: Firebase wrapper unit tests — mock-based, no real Firebase</name>
  <files>
    android/core/firebase/src/test/kotlin/app/dqxn/android/core/firebase/FirebaseCrashReporterTest.kt
    android/core/firebase/src/test/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTrackerTest.kt
  </files>
  <action>
    Unit tests using MockK to mock Firebase SDK classes. No real Firebase calls — this is mock-based verification that the wrapper delegates correctly.

    **FirebaseCrashReporterTest.kt:** JUnit5 + MockK + Truth.
    - Mock `FirebaseCrashlytics` instance. Inject into reporter via `mockkStatic(Firebase::class)` + `every { Firebase.crashlytics } returns mockCrashlytics`.
    - Test `recordException()` delegates to `crashlytics.recordException()` with verify
    - Test `log()` delegates to `crashlytics.log()`
    - Test `setCustomKey()` delegates correctly
    - Test `setCrashlyticsCollectionEnabled(false)` disables collection
    - Match test structure to exact CrashReporter interface methods

    **FirebaseAnalyticsTrackerTest.kt:** JUnit5 + MockK + Truth.
    - Mock `FirebaseAnalytics` instance via `mockkStatic` or constructor injection
    - Test `logEvent()` converts event to Bundle and delegates
    - Test `setUserProperty()` delegates correctly
    - Test `setAnalyticsCollectionEnabled(false)` suppresses events
    - Test at least one AnalyticsEvent type converts to correct Bundle params

    Note: MockK static mocking of Firebase singletons can be tricky. If `mockkStatic` fails on JDK 25, use an alternative approach: inject `FirebaseCrashlytics` and `FirebaseAnalytics` instances via constructor (provided by FirebaseModule `@Provides` methods) rather than using static `Firebase.*` accessors. This makes testing trivial — just pass mocks to the constructor.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :core:firebase:testDebugUnitTest --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>All Firebase wrapper tests pass. Mock-based verification confirms delegation correctness without requiring real Firebase initialization or google-services.json.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/ohm/Workspace/dqxn/android
./gradlew :core:firebase:testDebugUnitTest --console=plain
```
All tests pass. No Firebase SDK leakage into test classpath beyond this module.
</verification>

<success_criteria>
1. `./gradlew :core:firebase:compileDebugKotlin` succeeds
2. `./gradlew :core:firebase:testDebugUnitTest` passes — mock-based delegation tests green
3. Only `:core:firebase` has `firebase-*` dependencies in its classpath
4. Hilt binds `CrashReporter` and `AnalyticsTracker` to Firebase implementations
</success_criteria>

<output>
After completion, create `.planning/phases/05-core-infrastructure/05-02-SUMMARY.md`
</output>
