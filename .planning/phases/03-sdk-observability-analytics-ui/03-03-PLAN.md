---
phase: 03-sdk-observability-analytics-ui
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - android/sdk/ui/build.gradle.kts
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/GradientSpec.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DefaultTheme.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/LocalDashboardTheme.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/WidgetContainer.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/LocalWidgetData.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/LocalWidgetScope.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/GridConstants.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/layout/InfoCardLayout.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/layout/InfoCardSettings.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/settings/EnumPreviewRegistry.kt
  - android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/icon/IconResolver.kt
  - android/sdk/ui/src/test/kotlin/app/dqxn/android/sdk/ui/widget/WidgetContainerTest.kt
  - android/sdk/ui/src/test/kotlin/app/dqxn/android/sdk/ui/layout/InfoCardLayoutTest.kt
  - android/sdk/ui/src/test/kotlin/app/dqxn/android/sdk/ui/settings/EnumPreviewRegistryTest.kt
  - android/sdk/ui/src/test/kotlin/app/dqxn/android/sdk/ui/icon/IconResolverTest.kt
autonomous: true
requirements:
  - F12.1
  - F13.5
  - F13.6

must_haves:
  truths:
    - "DashboardThemeDefinition provides 6 core color tokens + 3 semantic tokens + gradient specs"
    - "WidgetContainer renders with graphicsLayer, border, rim padding, and background style"
    - "InfoCardLayout distributes space via weighted normalization with 80% safety target across STACK/COMPACT/GRID modes"
    - "LocalWidgetData and LocalWidgetScope CompositionLocals are defined for widget state injection"
    - "EnumPreviewRegistry allows packs to register preview composables for enum settings"
  artifacts:
    - path: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt"
      provides: "Full runtime theme type with 6+3 color tokens, gradients, metadata"
      contains: "data class DashboardThemeDefinition"
    - path: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/WidgetContainer.kt"
      provides: "Widget rendering container with graphicsLayer, border, background, rim"
      contains: "fun WidgetContainer"
    - path: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/layout/InfoCardLayout.kt"
      provides: "Deterministic layout algorithm ported from old codebase"
      contains: "fun InfoCardLayout"
    - path: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/LocalWidgetData.kt"
      provides: "CompositionLocal for per-widget data injection"
      contains: "val LocalWidgetData"
    - path: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/settings/EnumPreviewRegistry.kt"
      provides: "Registry for pack-contributed enum option preview composables"
      contains: "class EnumPreviewRegistry"
    - path: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/icon/IconResolver.kt"
      provides: "String icon name to ImageVector resolution"
      contains: "object IconResolver"
  key_links:
    - from: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt"
      to: ":sdk:contracts ThemeSpec"
      via: "DashboardThemeDefinition implements ThemeSpec interface from contracts"
      pattern: "ThemeSpec"
    - from: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/WidgetContainer.kt"
      to: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/LocalDashboardTheme.kt"
      via: "WidgetContainer reads theme from LocalDashboardTheme.current"
      pattern: "LocalDashboardTheme\\.current"
    - from: "android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/layout/InfoCardLayout.kt"
      to: ":sdk:contracts InfoCardLayoutMode, SizeOption"
      via: "InfoCardLayout uses layout mode and size option enums from contracts"
      pattern: "InfoCardLayoutMode|SizeOption"
---

<objective>
Build the `:sdk:ui` module with Compose types: DashboardThemeDefinition (6-token color model + semantic tokens), WidgetContainer skeleton, InfoCardLayout (536-line port from old codebase), CompositionLocals, EnumPreviewRegistry, and IconResolver.

Purpose: This module provides the Compose-enabled UI contracts that packs and features import. `DashboardThemeDefinition` lives here (not `:core:design`) because packs implement `ThemeProvider` returning this type, and packs depend only on `:sdk:*`. `InfoCardLayout` is used by 5+ widgets in Phase 8. Building it now with tests prevents a two-concern pile-up later.

Output: Compilable `:sdk:ui` module with all planned types and unit tests passing.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sdk-observability-analytics-ui/03-RESEARCH.md
@.planning/migration/phase-03.md
@.planning/migration/replication-advisory.md (section 5 — color model, emphasis, typography)
@.planning/oldcodebase/core-libraries.md (InfoCardLayout, WidgetContainer old implementations)
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: DashboardThemeDefinition + WidgetContainer + CompositionLocals + GridConstants + IconResolver</name>
  <files>
    android/sdk/ui/build.gradle.kts
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/GradientSpec.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DefaultTheme.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/LocalDashboardTheme.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/WidgetContainer.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/LocalWidgetData.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/LocalWidgetScope.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/widget/GridConstants.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/icon/IconResolver.kt
  </files>
  <action>
    **Build config:** Update `build.gradle.kts`. The module already has `dqxn.android.compose` plugin (Compose compiler enabled). Add:
    - `implementation(project(":sdk:contracts"))` — provides `ThemeSpec`, `WidgetStyle`, `BackgroundStyle` (enum: `NONE`/`SOLID`), `InfoCardLayoutMode`, `SizeOption`, `WidgetData`, `DataSnapshot`. All are Phase 2 deliverables — import, do not redefine.
    - `implementation(project(":sdk:common"))` — for dispatcher qualifiers
    - `implementation(libs.kotlinx.collections.immutable)`
    - Compose dependencies are auto-wired by `dqxn.android.compose` (BOM, foundation, material3, ui-tooling)
    - `testImplementation(libs.compose.ui.test.junit4)` — for composition testing (if not already from convention plugin)

    **BackgroundStyle:** Already defined in `:sdk:contracts` (Phase 2 deliverable) at `app.dqxn.android.sdk.contracts.widget.BackgroundStyle` with values `NONE` and `SOLID`. Import from `:sdk:contracts` — do NOT redefine. Note: the enum uses `NONE` (not `TRANSPARENT`).

    **GradientSpec.kt:** Defined here in `:sdk:ui` (not in `:sdk:contracts`) because it requires Compose `Brush` and `Size` types which need the Compose compiler.
    - `@Immutable data class GradientSpec(val type: GradientType, val stops: ImmutableList<GradientStop>)`
    - `enum class GradientType { VERTICAL, HORIZONTAL, LINEAR, RADIAL, SWEEP }`
    - `@Immutable data class GradientStop(val color: Long, val position: Float)` — Long for ARGB color representation
    - `fun toBrush(size: Size): Brush` — converts spec to Compose Brush based on type

    **DashboardThemeDefinition.kt:** `@Immutable` data class implementing `ThemeSpec` (from `:sdk:contracts`):
    - 6 core tokens (from replication-advisory §5): `primaryTextColor: Color`, `secondaryTextColor: Color`, `accentColor: Color`, `highlightColor: Color` (defaults to accentColor), `widgetBorderColor: Color`, `backgroundBrush: Brush`, `widgetBackgroundBrush: Brush`
    - 3 new semantic tokens: `errorColor: Color`, `warningColor: Color`, `successColor: Color`
    - Metadata: `id: String`, `name: String`, `isDark: Boolean = true`, `defaultBackgroundStyle: BackgroundStyle = BackgroundStyle.SOLID`, `defaultHasGlowEffect: Boolean = false`
    - Entitlement: `requiredAnyEntitlement: ImmutableSet<String>? = null`
    - Serialization support: `backgroundGradientSpec: GradientSpec? = null`, `widgetBackgroundGradientSpec: GradientSpec? = null`
    - Emphasis levels from §5: companion object with `const val EMPHASIS_HIGH = 1.0f`, `const val EMPHASIS_MEDIUM = 0.7f`, `const val EMPHASIS_LOW = 0.4f`, `const val EMPHASIS_DISABLED = 0.12f`

    **DefaultTheme.kt:** Fallback theme (Slate dark theme):
    - `val SlateTheme = DashboardThemeDefinition(id = "slate", name = "Slate", primaryTextColor = Color.White, secondaryTextColor = Color(0xFFB0B0B0), accentColor = Color(0xFF4FC3F7), ...)` — use dark slate colors
    - `val MinimalistTheme = DashboardThemeDefinition(id = "minimalist", name = "Minimalist", isDark = false, ...)` — light theme

    **LocalDashboardTheme.kt:** `val LocalDashboardTheme = staticCompositionLocalOf<DashboardThemeDefinition> { SlateTheme }`. Static because theme changes are infrequent — forces full recomposition on theme switch (correct behavior).

    **WidgetContainer.kt:** `@Composable fun WidgetContainer(style: WidgetStyle, modifier: Modifier = Modifier, contentDescription: String? = null, content: @Composable BoxWithConstraintsScope.() -> Unit)`.
    Implementation per research code example:
    - Read theme from `LocalDashboardTheme.current`
    - `graphicsLayer { alpha = style.opacity }` — isolated RenderNode
    - `semantics { contentDescription?.let { this.contentDescription = it } }` — accessibility
    - `clip(RoundedCornerShape(cornerRadius))` where cornerRadius = `style.cornerRadiusPercent / 2f` mapped to percent
    - Conditional border: `if (style.showBorder) Modifier.border(2.dp, theme.widgetBorderColor, shape)`
    - Background based on `style.backgroundStyle`: `SOLID` uses `theme.widgetBackgroundBrush`, `NONE` uses transparent brush (no background drawn)
    - Inner `Box` with rim padding: `rimPx = (minOf(maxWidth, maxHeight) * (style.rimSizePercent / 100f))`
    - NOTE: Glow rendering (`RenderEffect.createBlurEffect()`) deferred to Phase 7. Error boundary deferred to Phase 7 (`WidgetSlot`).
    - `WidgetStyle` is a Phase 2 deliverable in `:sdk:contracts` (`app.dqxn.android.sdk.contracts.widget.WidgetStyle`). Import it — do NOT redefine. Fields: `backgroundStyle: BackgroundStyle`, `opacity: Float`, `showBorder: Boolean`, `hasGlowEffect: Boolean`, `cornerRadiusPercent: Int`, `rimSizePercent: Int`, `zLayer: Int`.

    **LocalWidgetData.kt:** `val LocalWidgetData = compositionLocalOf<WidgetData> { error("No WidgetData provided") }`. `WidgetData` comes from `:sdk:contracts` (Phase 2, KClass-keyed multi-slot).

    **LocalWidgetScope.kt:** `val LocalWidgetScope = staticCompositionLocalOf<CoroutineScope> { error("No WidgetScope provided") }`. This provides the supervised `WidgetCoroutineScope` for per-widget coroutine isolation.

    **GridConstants.kt:** Object: `val GRID_UNIT_SIZE = 16.dp`.

    **IconResolver.kt:** Object with `fun resolve(iconName: String): ImageVector?`. Uses reflection on `androidx.compose.material.icons.Icons.Default` and `Icons.Rounded` to find icons by name. Cache results in `ConcurrentHashMap<String, ImageVector?>`. Handles camelCase to PascalCase conversion. Returns null for unknown names (caller provides fallback). This maps string icon names from Phase 2 `SetupDefinition.iconName` to actual `ImageVector` instances.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :sdk:ui:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
    <manual>Verify DashboardThemeDefinition has all 9 color tokens (6 core + 3 semantic). Verify WidgetContainer uses graphicsLayer.</manual>
  </verify>
  <done>DashboardThemeDefinition with 6+3 color tokens, DefaultTheme, LocalDashboardTheme, WidgetContainer with graphicsLayer/border/rim/background, LocalWidgetData, LocalWidgetScope, GridConstants, and IconResolver all compile with Compose compiler.</done>
</task>

<task type="auto">
  <name>Task 2: InfoCardLayout + EnumPreviewRegistry + unit tests</name>
  <files>
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/layout/InfoCardLayout.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/layout/InfoCardSettings.kt
    android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/settings/EnumPreviewRegistry.kt
    android/sdk/ui/src/test/kotlin/app/dqxn/android/sdk/ui/widget/WidgetContainerTest.kt
    android/sdk/ui/src/test/kotlin/app/dqxn/android/sdk/ui/layout/InfoCardLayoutTest.kt
    android/sdk/ui/src/test/kotlin/app/dqxn/android/sdk/ui/settings/EnumPreviewRegistryTest.kt
    android/sdk/ui/src/test/kotlin/app/dqxn/android/sdk/ui/icon/IconResolverTest.kt
  </files>
  <action>
    **InfoCardLayout.kt:** Port from old codebase `core:widget-primitives` (~536 lines). This is a `@Composable` function implementing a deterministic weighted layout algorithm.

    Three layout modes (from `:sdk:contracts` `InfoCardLayoutMode`):
    - **STACK:** Vertical stack — icon on top, title below, body at bottom
    - **GRID:** Icon left column, text right column (2-column)
    - **COMPACT:** Icon + title inline on one row, body text below

    Core algorithm:
    1. Measure available height after subtracting fixed spacers
    2. Read `SizeOption` for icon, top text, bottom text from widget settings
    3. Convert via `SizeOption.toMultiplier()`: `NONE=0.0, SMALL=0.3, MEDIUM=0.5, LARGE=0.7, XL=1.0`
    4. Normalize weights to sum = 0.8 (80% of available height — 20% safety buffer for font leading/descenders)
    5. Distribute space proportionally
    6. Apply `getTightTextStyle()` — eliminates font padding via `PlatformTextStyle(includeFontPadding = false)` + `LineHeightStyle(trim = Trim.Both, alignment = Alignment.Center)`

    Consult old codebase at `../dqxn.old/android/core/widget-primitives/` for the actual implementation. Reference `.planning/oldcodebase/core-libraries.md` for the API surface. The port should adapt to the new architecture (use `LocalDashboardTheme`, use Phase 2 types like `InfoCardLayoutMode` and `SizeOption`).

    Parameters: `modifier: Modifier = Modifier`, `layoutMode: InfoCardLayoutMode`, `iconSize: SizeOption`, `topTextSize: SizeOption`, `bottomTextSize: SizeOption`, `icon: (@Composable () -> Unit)?`, `topText: (@Composable (TextStyle) -> Unit)?`, `bottomText: (@Composable (TextStyle) -> Unit)?`.

    The composable provides calculated `TextStyle` to each text slot (via slot API pattern) so consumers don't need to compute sizes themselves.

    **InfoCardSettings.kt:** Helper utilities:
    - `fun parseLayoutMode(value: String): InfoCardLayoutMode` — safe parsing with fallback to STACK
    - `fun parseSizeOption(value: String): SizeOption` — safe parsing with fallback to MEDIUM

    **EnumPreviewRegistry.kt:** Registry for pack-contributed enum option preview composables.
    - `class EnumPreviewRegistry @Inject constructor(private val previews: Map<KClass<out Enum<*>>, @JvmSuppressWildcards @Composable (Any) -> Unit>)`
    - Packs contribute via Hilt `@IntoMap` binding with `@EnumPreviewKey(SomeEnum::class)`
    - `@MapKey annotation class EnumPreviewKey(val value: KClass<out Enum<*>>)`
    - `fun hasPreviews(enumClass: KClass<out Enum<*>>): Boolean`
    - `@Composable fun Preview(enumClass: KClass<out Enum<*>>, value: Enum<*>)` — renders preview if available, fallback to text label
    - If map is empty for a given enum, fall back to text-only rendering (graceful degradation)

    **WidgetContainerTest.kt:** Compose UI tests (uses `createComposeRule()`):
    - `renders with solid background` — set `backgroundStyle = SOLID`, verify background drawn (use semantics or snapshot testing)
    - `renders with NONE background` — set `backgroundStyle = NONE`, verify no background drawn
    - `applies border when showBorder true` — verify border composable present
    - `no border when showBorder false` — verify no border
    - `rim padding creates inner space` — set `rimSizePercent = 20`, verify content has padding
    - `graphicsLayer applied for opacity` — set opacity 0.5, verify graphicsLayer exists on node
    - `accessibility contentDescription set` — set `contentDescription = "Speed: 65 km/h"`, verify semantics node has it
    Use `ComposeContentTestRule` with `setContent { WidgetContainer(...) { Text("test") } }`.

    **InfoCardLayoutTest.kt:** Unit tests for the normalization algorithm (not Compose tests — test the math):
    - `SizeOption toMultiplier mapping` — verify NONE=0.0, SMALL=0.3, MEDIUM=0.5, LARGE=0.7, XL=1.0
    - `normalization with all MEDIUM` — 3 elements each MEDIUM(0.5), total raw = 1.5, normalized to 0.8 → each gets 0.267 of available
    - `normalization with NONE element` — icon=NONE, top=LARGE, bottom=SMALL → icon gets 0, remaining 80% split proportionally between top and bottom
    - `normalization with all XL` — stress test: all 1.0, normalized to 0.8/3 each
    - `normalization with single non-NONE element` — only top text = MEDIUM, others NONE → top gets full 80%
    - `getTightTextStyle eliminates font padding` — verify `includeFontPadding = false` on returned TextStyle
    - For STACK/COMPACT/GRID mode tests: verify the layout algorithm produces correct proportions per mode. These may need Compose test infrastructure if testing actual layout, or can test the calculation functions directly if extracted.

    **EnumPreviewRegistryTest.kt:**
    - `hasPreviews returns true for registered enum` — register preview for test enum, verify true
    - `hasPreviews returns false for unregistered enum` — verify false
    - `Preview renders registered composable` — register preview, call Preview in composition, verify content rendered (Compose test)
    - `Preview falls back to text for unregistered enum` — verify text label rendered

    **IconResolverTest.kt:**
    - `resolves known icon name` — `IconResolver.resolve("Settings")` returns non-null
    - `returns null for unknown icon` — `IconResolver.resolve("NonExistentIcon123")` returns null
    - `caches resolved icons` — resolve same icon twice, verify same instance returned
    - `handles camelCase input` — `IconResolver.resolve("arrowBack")` resolves correctly
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :sdk:ui:testDebugUnitTest --console=plain 2>&1 | tail -20</automated>
    <manual>Verify InfoCardLayout SizeOption.toMultiplier() values match spec (NONE=0.0, SMALL=0.3, MEDIUM=0.5, LARGE=0.7, XL=1.0). Verify 80% normalization target.</manual>
  </verify>
  <done>InfoCardLayout ported with weighted normalization algorithm, STACK/COMPACT/GRID modes, getTightTextStyle. EnumPreviewRegistry with Hilt @IntoMap pattern. WidgetContainer composition tests pass (background, border, rim, opacity, accessibility). InfoCardLayout SizeOption mapping and normalization math verified. IconResolver resolves Material icon names. All unit tests pass.</done>
</task>

</tasks>

<verification>
1. `./gradlew :sdk:ui:compileDebugKotlin --console=plain` succeeds
2. `./gradlew :sdk:ui:testDebugUnitTest --console=plain` — all tests pass
3. DashboardThemeDefinition has 9 color tokens (6 core + 3 semantic)
4. WidgetContainer uses `graphicsLayer` (not direct `alpha` modifier)
5. InfoCardLayout `SizeOption.toMultiplier()` returns NONE=0.0, SMALL=0.3, MEDIUM=0.5, LARGE=0.7, XL=1.0
6. InfoCardLayout normalization targets 80% of available height
7. Test XML files exist in `sdk/ui/build/test-results/testDebugUnitTest/`
</verification>

<success_criteria>
- DashboardThemeDefinition implements ThemeSpec with full color model
- WidgetContainer renders with graphicsLayer isolation, border, rim, background
- InfoCardLayout weighted normalization works across all 3 modes
- LocalWidgetData and LocalWidgetScope CompositionLocals defined
- EnumPreviewRegistry supports Hilt multibinding for pack previews
- IconResolver maps string names to ImageVector
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-sdk-observability-analytics-ui/03-03-SUMMARY.md`
</output>
