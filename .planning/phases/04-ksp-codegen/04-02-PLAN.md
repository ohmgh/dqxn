---
phase: 04-ksp-codegen
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorTest.kt
  - android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/ContractStubs.kt
  - android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/SnapshotValidationTest.kt
  - android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/TypeIdValidationTest.kt
autonomous: true
requirements:
  - F2.12
  - F3.8

must_haves:
  truths:
    - "Valid @DashboardWidget class generates a Hilt module file containing @Binds @IntoSet for WidgetRenderer"
    - "Valid @DashboardDataProvider class generates a Hilt module file containing @Binds @IntoSet for DataProvider"
    - "Valid @DashboardSnapshot class generates a compose_stability_config.txt containing its FQN"
    - "Invalid typeId (uppercase, missing colon, wrong format) produces a compilation error with descriptive message"
    - "@DashboardSnapshot on a non-data class produces a compilation error"
    - "@DashboardSnapshot on a class without @Immutable produces a compilation error"
    - "@DashboardSnapshot on a class with var properties produces a compilation error"
    - "@DashboardSnapshot on a class not implementing DataSnapshot produces a compilation error"
    - "Duplicate dataType within the same module produces a compilation error"
    - "PackManifest object is generated with correct PackWidgetRef and PackDataProviderRef entries"
  artifacts:
    - path: "android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorTest.kt"
      provides: "Positive path compile-testing for widget, provider, snapshot generation"
      contains: "class PluginProcessorTest"
    - path: "android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/ContractStubs.kt"
      provides: "Reusable annotation and interface stubs for compile-testing"
      contains: "fun contractStubs"
    - path: "android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/SnapshotValidationTest.kt"
      provides: "Negative path tests for @DashboardSnapshot validation"
      contains: "class SnapshotValidationTest"
    - path: "android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/TypeIdValidationTest.kt"
      provides: "Negative path tests for typeId format validation"
      contains: "class TypeIdValidationTest"
  key_links:
    - from: "android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorTest.kt"
      to: "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorProvider.kt"
      via: "symbolProcessorProviders = listOf(PluginProcessorProvider())"
      pattern: "PluginProcessorProvider"
    - from: "android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/ContractStubs.kt"
      to: "android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/"
      via: "Stub mirrors of real annotation shapes (same FQN, same params)"
      pattern: "app.dqxn.android.sdk.contracts.annotation"
---

<objective>
Validate the `:codegen:plugin` processor with compile-testing covering all positive and negative paths.

Purpose: KSP processors are notoriously hard to debug after integration — errors surface in consumer modules with cryptic messages. Compile-testing catches generation and validation bugs before the processor runs in any real pack module. This is the only way to verify the processor works correctly before Phase 8.

Output: Complete test suite using kctfork compile-testing for all three annotation handlers, both validators, and all three generators.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ksp-codegen/04-RESEARCH.md
@.planning/phases/04-ksp-codegen/04-01-SUMMARY.md
@android/codegen/plugin/build.gradle.kts
@android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorProvider.kt
@android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessor.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/DashboardWidget.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/DashboardDataProvider.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/DashboardSnapshot.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Contract stubs + positive path compile-testing for widget, provider, and snapshot processing</name>
  <files>
    android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/ContractStubs.kt
    android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorTest.kt
  </files>
  <action>
    **IMPORTANT — kctfork compatibility:** The project uses Kotlin 2.3.10. kctfork 0.8.0 may not be compatible. If test compilation fails with `IncompatibleClassChangeError`, `NoSuchMethodError`, or `AbstractMethodError`, check Maven Central for a newer kctfork version. Try `0.8.0` first. If it fails:
    1. Search for `dev.zacsweers.kctfork` on Maven Central for the latest release
    2. Update the version in `libs.versions.toml`
    3. If no compatible version exists, use `kctfork-core` at 0.12.1 (may have separate versioning)
    4. As a last resort, write Gradle TestKit integration tests instead (slower but always compatible)

    **ContractStubs.kt** — Provide stub source files for annotations and interfaces that the processor reads. The processor doesn't depend on `:sdk:contracts` at compile time, so tests must provide these on the compilation classpath.

    Create a top-level function `contractStubs(): Array<SourceFile>` returning `SourceFile.kotlin` entries for:

    - `DashboardWidget.kt` — annotation with `typeId: String`, `displayName: String`, `icon: String = ""`. Package: `app.dqxn.android.sdk.contracts.annotation`. Retention: SOURCE.
    - `DashboardDataProvider.kt` — annotation with `localId: String`, `displayName: String`, `description: String = ""`. Same package. Retention: SOURCE.
    - `DashboardSnapshot.kt` — annotation with `dataType: String`. Same package. Retention: SOURCE.
    - `DataSnapshot.kt` — interface with `val timestamp: Long`. Package: `app.dqxn.android.sdk.contracts.provider`. Add `@Immutable` from `androidx.compose.runtime` (since real `DataSnapshot` has it).
    - `Immutable.kt` — annotation stub. Package: `androidx.compose.runtime`. Retention: BINARY. Target: CLASS.
    - `WidgetRenderer.kt` — minimal interface (empty body is fine). Package: `app.dqxn.android.sdk.contracts.widget`.
    - `DataProvider.kt` — interface with generic `T : DataSnapshot`. Package: `app.dqxn.android.sdk.contracts.provider`.
    - `DataProviderSpec.kt` — interface with `val sourceId: String`, `val displayName: String`, `val description: String`, `val dataType: String`. Same package.
    - `Gated.kt` — interface with `val requiredAnyEntitlement: Set<String>?`. Package: `app.dqxn.android.sdk.contracts.entitlement`.
    - `WidgetSpec.kt` — interface with `val typeId: String`, `val displayName: String`. Package: `app.dqxn.android.sdk.contracts.widget`.

    These stubs must match the FQNs the processor uses for `resolver.getSymbolsWithAnnotation()` and supertype checks.

    **PluginProcessorTest.kt** — Positive path tests using kctfork `KotlinCompilation`:

    Common setup:
    - Each test creates a `KotlinCompilation()`, sets `sources`, adds `contractStubs()` spread, sets `symbolProcessorProviders = listOf(PluginProcessorProvider())`, and passes `kspArgs = mapOf("packId" to "essentials")`.

    Tests (JUnit5):

    1. `valid DashboardWidget generates Hilt module` — provide a source file with a valid `@DashboardWidget(typeId = "essentials:speedometer", displayName = "Speedometer") class SpeedometerRenderer : WidgetRenderer { ... }`. Assert: `exitCode == OK`. Find generated file `EssentialsHiltModule.kt` in `kspSourcesDir`. Assert it contains `@Module`, `@InstallIn`, `@Binds`, `@IntoSet`, `bindSpeedometerRenderer`, `WidgetRenderer`.

    2. `valid DashboardDataProvider generates Hilt module` — provide `@DashboardDataProvider(localId = "gps-speed", displayName = "GPS Speed") class GpsSpeedProvider : DataProvider<SpeedSnapshot> { ... }` (with a minimal `SpeedSnapshot` data class annotated `@DashboardSnapshot`). Assert: generated Hilt module has `bindGpsSpeedProvider` returning `DataProvider<*>`.

    3. `valid DashboardSnapshot generates stability config` — provide `@DashboardSnapshot(dataType = "SPEED") @Immutable data class SpeedSnapshot(override val timestamp: Long, val speed: Float) : DataSnapshot`. Assert: file `compose_stability_config.txt` exists in KSP output. Assert it contains the fully qualified class name.

    4. `PackManifest object is generated with widget and provider refs` — combine widget + provider in one compilation. Assert: generated `EssentialsGeneratedManifest.kt` exists and contains `PackWidgetRef`, `PackDataProviderRef`, `typeId = "essentials:speedometer"`.

    5. `multiple widgets and providers in same module` — provide 2 widgets and 2 providers. Assert: Hilt module has 4 `@Binds` methods. Manifest has all refs.

    6. `module with no annotations produces no output` — compile with no annotated classes. Assert: `exitCode == OK`. No generated files.

    **Note on generated code assertions:** Do NOT try to compile the generated Hilt modules within the compile-test — they reference Dagger types not on the test classpath. Assert on generated SOURCE CODE content (read generated files as strings). Use `assertThat(generatedSource).contains(...)` checks.

    **Note on KSP options:** kctfork's `KotlinCompilation` has a `kspArgs` property (or pass via `symbolProcessorProviders` with options). Check the kctfork API — it may differ from older compile-testing. The key is passing `packId` so the processor reads it.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :codegen:plugin:test --console=plain 2>&1 | tail -20</automated>
    <manual>Check test output for 6 passing positive-path tests</manual>
  </verify>
  <done>6 positive-path compile-testing tests pass: valid widget generates Hilt module, valid provider generates Hilt module, valid snapshot generates stability config, manifest generated with refs, multiple annotations handled, empty module produces no output.</done>
</task>

<task type="auto">
  <name>Task 2: Negative path compile-testing for validation errors (typeId, snapshot constraints)</name>
  <files>
    android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/TypeIdValidationTest.kt
    android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/SnapshotValidationTest.kt
  </files>
  <action>
    **TypeIdValidationTest.kt** — Tests for typeId format validation. Each test provides a `@DashboardWidget` with an invalid typeId and asserts `exitCode == COMPILATION_ERROR` and `messages` contains the expected error string.

    Tests (JUnit5):

    1. `uppercase typeId produces error` — `typeId = "Essentials:Speedometer"`. Assert error message about format.
    2. `missing colon produces error` — `typeId = "speedometer"`. Assert error.
    3. `empty typeId produces error` — `typeId = ""`. Assert error.
    4. `special characters produce error` — `typeId = "ess_entials:speed meter"`. Assert error. (underscores and spaces not allowed)
    5. `valid typeId with hyphens compiles` — `typeId = "essentials:gps-speed"`. Assert `exitCode == OK`. (positive control)
    6. `typeId starting with number produces error` — `typeId = "1pack:widget"`. Assert error.
    7. `widget not implementing WidgetRenderer produces error` — valid typeId, but class doesn't extend WidgetRenderer. Assert error about missing interface.

    **SnapshotValidationTest.kt** — Tests for @DashboardSnapshot validation rules. Each test provides an invalid snapshot class and asserts compilation error with descriptive message.

    Tests (JUnit5):

    1. `non-data class produces error` — `@DashboardSnapshot(dataType = "SPEED") @Immutable class SpeedSnapshot(override val timestamp: Long) : DataSnapshot`. Assert error about "must be applied to a data class".
    2. `missing @Immutable produces error` — data class implementing DataSnapshot but without `@Immutable`. Assert error about "must be annotated with @Immutable".
    3. `not implementing DataSnapshot produces error` — `@DashboardSnapshot(dataType = "SPEED") @Immutable data class SpeedSnapshot(val speed: Float)`. Assert error about "must implement DataSnapshot".
    4. `mutable property produces error` — `@DashboardSnapshot @Immutable data class SpeedSnapshot(override val timestamp: Long, var speed: Float) : DataSnapshot`. Assert error about "must be val, not var" with the property name.
    5. `duplicate dataType in same module produces error` — two snapshot classes both with `dataType = "SPEED"`. Assert error about duplicate.
    6. `valid snapshot compiles successfully` — correct data class with all requirements. Assert `exitCode == OK`. (positive control)
    7. `multiple valid snapshots with different dataTypes compile` — two correct snapshots with `SPEED` and `BATTERY`. Assert `exitCode == OK` and stability config contains both FQNs.

    **For all negative tests:** Use `contractStubs()` from ContractStubs.kt. Pass `kspArgs = mapOf("packId" to "test")`. Assert that `result.exitCode == ExitCode.COMPILATION_ERROR` (or `KotlinCompilation.ExitCode.COMPILATION_ERROR`). Assert `result.messages.contains(expectedSubstring)` for error message verification.

    **Total test count across Plan 02:** 6 (Task 1) + 7 (TypeId) + 7 (Snapshot) = 20 compile-testing tests.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :codegen:plugin:test --console=plain 2>&1 | tail -20</automated>
    <manual>Check for 20 total passing tests (6 positive + 14 negative)</manual>
  </verify>
  <done>14 negative-path compile-testing tests pass: 7 typeId validation tests (uppercase, missing colon, empty, special chars, number prefix, valid control, missing interface) and 7 snapshot validation tests (non-data class, missing @Immutable, not DataSnapshot, var property, duplicate dataType, valid control, multiple valid). All 20 tests in the :codegen:plugin test suite pass.</done>
</task>

</tasks>

<verification>
1. `./gradlew :codegen:plugin:test --console=plain` — all 20 tests pass
2. Test output XML present in `codegen/plugin/build/test-results/test/`
3. Positive tests verify generated Hilt module content (not just compilation success)
4. Negative tests verify specific error messages (not just compilation failure)
5. No test depends on Dagger/Hilt being on the test classpath — assertions are on source code strings
</verification>

<success_criteria>
20 compile-testing tests validate the `:codegen:plugin` processor: 6 positive-path tests confirming correct Hilt module, manifest, and stability config generation for valid annotations; 7 typeId format validation tests; 7 snapshot constraint validation tests. Tests use kctfork for in-process compilation. Contract stubs provide annotation/interface definitions without importing `:sdk:contracts`.
</success_criteria>

<output>
After completion, create `.planning/phases/04-ksp-codegen/04-02-SUMMARY.md`
</output>
