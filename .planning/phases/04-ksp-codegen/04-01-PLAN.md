---
phase: 04-ksp-codegen
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/gradle/libs.versions.toml
  - android/codegen/plugin/build.gradle.kts
  - android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorProvider.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessor.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/model/WidgetInfo.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/model/ProviderInfo.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/model/SnapshotInfo.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/handlers/WidgetHandler.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/handlers/DataProviderHandler.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/handlers/SnapshotHandler.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/HiltModuleGenerator.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/ManifestGenerator.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/StabilityConfigGenerator.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/validation/TypeIdValidator.kt
  - android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/validation/SnapshotValidator.kt
  - android/codegen/plugin/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider
autonomous: true
requirements:
  - F2.12
  - F3.8

must_haves:
  truths:
    - "@DashboardWidget-annotated classes produce a Hilt @Module with @Binds @IntoSet for WidgetRenderer"
    - "@DashboardDataProvider-annotated classes produce a Hilt @Module with @Binds @IntoSet for DataProvider<*>"
    - "@DashboardSnapshot-annotated classes produce a compose_stability_config.txt listing all snapshot FQNs"
    - "Invalid typeId format causes a KSP compilation error, not a warning"
    - "@DashboardSnapshot missing @Immutable causes a KSP compilation error"
    - "PackManifest implementation is generated with PackWidgetRef and PackDataProviderRef entries"
    - "PackConventionPlugin passes packId as a KSP argument and wires stability config path"
  artifacts:
    - path: "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessor.kt"
      provides: "Hub processor delegating to handlers"
      contains: "class PluginProcessor"
    - path: "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorProvider.kt"
      provides: "KSP service entry point"
      contains: "class PluginProcessorProvider"
    - path: "android/codegen/plugin/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider"
      provides: "Service loader registration"
      contains: "app.dqxn.android.codegen.plugin.PluginProcessorProvider"
    - path: "android/codegen/plugin/build.gradle.kts"
      provides: "Dependencies on ksp-api, kotlinpoet, kotlinpoet-ksp, kctfork"
      contains: "libs.ksp.api"
    - path: "android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt"
      provides: "packId KSP arg + stability config file wiring"
      contains: "packId"
  key_links:
    - from: "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessor.kt"
      to: "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/handlers/WidgetHandler.kt"
      via: "Handler delegation in process()"
      pattern: "WidgetHandler.*process"
    - from: "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/HiltModuleGenerator.kt"
      to: "app.dqxn.android.sdk.contracts.widget.WidgetRenderer"
      via: "Generated @Binds return type (FQN string, no compile dep)"
      pattern: "WidgetRenderer"
    - from: "android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt"
      to: "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessor.kt"
      via: "KSP arg 'packId' consumed by processor"
      pattern: "arg.*packId"
---

<objective>
Build the `:codegen:plugin` KSP processor and wire it into the build infrastructure.

Purpose: Packs need zero-boilerplate registration. The KSP processor auto-generates Hilt multibinding modules, pack manifests, and Compose stability configs from `@DashboardWidget`, `@DashboardDataProvider`, and `@DashboardSnapshot` annotations. This eliminates manual `@Module` classes and manifest construction in every pack module.

Output: Compiling `:codegen:plugin` processor with hub-and-spoke architecture, three handlers, three generators, two validators, and convention plugin wiring for `packId` arg + stability config path.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ksp-codegen/04-RESEARCH.md
@.planning/oldcodebase/ksp-processors.md
@android/gradle/libs.versions.toml
@android/codegen/plugin/build.gradle.kts
@android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt
@android/build-logic/convention/src/main/kotlin/AndroidComposeConventionPlugin.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/DashboardWidget.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/DashboardDataProvider.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/DashboardSnapshot.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/pack/DashboardPackManifest.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetRenderer.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/provider/DataProvider.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/provider/DataProviderSpec.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/provider/DataSnapshot.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build infrastructure — version catalog + codegen:plugin deps + PackConventionPlugin wiring</name>
  <files>
    android/gradle/libs.versions.toml
    android/codegen/plugin/build.gradle.kts
    android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt
  </files>
  <action>
    **1. Add kctfork to version catalog** (`android/gradle/libs.versions.toml`):

    In `[versions]` section add:
    ```
    kctfork = "0.8.0"
    ```

    In `[libraries]` section add:
    ```
    kctfork-core = { group = "dev.zacsweers.kctfork", name = "core", version.ref = "kctfork" }
    kctfork-ksp = { group = "dev.zacsweers.kctfork", name = "ksp", version.ref = "kctfork" }
    ```

    **IMPORTANT:** kctfork 0.8.0 may not be compatible with Kotlin 2.3.10. If resolution fails at test time (Plan 02), check Maven Central for newer releases. The `core` artifact may be at a different version (0.12.1 per research). At this point, just add the catalog entries — compatibility is verified when tests actually compile.

    **2. Update `:codegen:plugin` build.gradle.kts** — replace the one-liner with full dependencies:

    ```kotlin
    plugins { id("dqxn.kotlin.jvm") }

    dependencies {
        implementation(libs.ksp.api)
        implementation(libs.kotlinpoet)
        implementation(libs.kotlinpoet.ksp)

        testImplementation(platform(libs.junit.bom))
        testImplementation(libs.junit.jupiter.api)
        testRuntimeOnly(libs.junit.jupiter.engine)
        testImplementation(libs.truth)
        testImplementation(libs.kctfork.core)
        testImplementation(libs.kctfork.ksp)
    }
    ```

    **3. Update `PackConventionPlugin.kt`** — add `packId` KSP argument and stability config file path wiring:

    In the `KspExtension` configure block, add:
    ```kotlin
    arg("packId", project.name)  // project.name gives the Gradle module name (e.g., "essentials")
    ```

    After the KSP config block, add stability config wiring to the Compose compiler:
    ```kotlin
    extensions.configure<ComposeCompilerGradlePluginExtension> {
        stabilityConfigurationFiles.add(
            layout.buildDirectory.file("generated/ksp/debugKotlin/resources/compose_stability_config.txt")
        )
    }
    ```
    This requires importing `org.jetbrains.kotlin.compose.compiler.gradle.ComposeCompilerGradlePluginExtension`.

    The `debugKotlin` variant path is what KSP uses for debug Android builds. The processor writes to this path using `codeGenerator.createNewFile()` with `Dependencies.ALL_FILES`.

    **Key constraint:** The Compose compiler DSL accepts the file at configuration time even if it doesn't exist yet — it's evaluated at compile time when KSP has already run. The `stabilityConfigurationFiles` API (plural, from Phase 1 decision) is additive — this adds the generated config alongside the base config already added by `AndroidComposeConventionPlugin`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :codegen:plugin:compileKotlin --console=plain 2>&1 | tail -5</automated>
    <manual>Verify libs.versions.toml has kctfork entries, codegen:plugin has all deps, PackConventionPlugin has packId arg</manual>
  </verify>
  <done>`:codegen:plugin` compiles with ksp-api + kotlinpoet + kotlinpoet-ksp. Version catalog has kctfork entries. PackConventionPlugin passes packId KSP arg and wires stability config path into Compose compiler.</done>
</task>

<task type="auto">
  <name>Task 2: Implement `:codegen:plugin` processor — hub, handlers, generators, validators, service file</name>
  <files>
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorProvider.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessor.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/model/WidgetInfo.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/model/ProviderInfo.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/model/SnapshotInfo.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/handlers/WidgetHandler.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/handlers/DataProviderHandler.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/handlers/SnapshotHandler.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/HiltModuleGenerator.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/ManifestGenerator.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/StabilityConfigGenerator.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/validation/TypeIdValidator.kt
    android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/validation/SnapshotValidator.kt
    android/codegen/plugin/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider
  </files>
  <action>
    All source files go under `android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/`.

    **Model classes** (in `model/` package):

    `WidgetInfo`: data class with `className: String`, `packageName: String`, `typeId: String`, `displayName: String`, `icon: String`, `typeName: ClassName` (KotlinPoet), `originatingFile: KSFile`.

    `ProviderInfo`: data class with `className: String`, `packageName: String`, `localId: String`, `displayName: String`, `description: String`, `dataType: String`, `typeName: ClassName`, `originatingFile: KSFile`. The `dataType` is extracted from the class's `DataProviderSpec.dataType` property (the processor reads the supertype's property declaration). Actually, the processor can't reliably resolve runtime property values via KSP. Instead: the `dataType` for the manifest's `PackDataProviderRef` should be derived from the `@DashboardDataProvider` annotation. **BUT** the current annotation doesn't have a `dataType` param. Resolution: the `PackDataProviderRef.dataType` field in the generated manifest will be populated from the provider class's `snapshotType` generic parameter's `@DashboardSnapshot.dataType` annotation, if resolvable. If NOT resolvable at KSP time (cross-module snapshot), use the provider's `localId` as a fallback. Document this limitation in the generator. Alternatively, use a simpler approach: leave `dataType` as empty string in the manifest for now — the runtime `DataProviderRegistry` has the actual `dataType` from the provider instance. The manifest is primarily for pack introspection, not data binding.

    `SnapshotInfo`: data class with `className: String`, `packageName: String`, `qualifiedName: String`, `dataType: String`, `originatingFile: KSFile`.

    **PluginProcessorProvider**: Implements `SymbolProcessorProvider`. `create()` returns `PluginProcessor(environment.codeGenerator, environment.logger, environment.options)`.

    **PluginProcessor**: Single-pass hub processor.
    - `private var invoked = false`
    - `process(resolver: Resolver): List<KSAnnotated>` — if `invoked`, return `emptyList()`. Set `invoked = true`.
    - Read `packId` from `options["packId"]` (passed by PackConventionPlugin). If missing, `logger.error("Missing required KSP option: packId")` and return.
    - Delegate to `WidgetHandler(resolver, logger).process()` → `List<WidgetInfo>`
    - Delegate to `DataProviderHandler(resolver, logger).process()` → `List<ProviderInfo>`
    - Delegate to `SnapshotHandler(resolver, logger).process()` → `List<SnapshotInfo>`
    - If any handler reported errors (via KSPLogger.error), skip generation (KSP will fail compilation).
    - Otherwise, generate outputs:
      - `HiltModuleGenerator(codeGenerator).generate(packId, widgetInfos, providerInfos)`
      - `ManifestGenerator(codeGenerator).generate(packId, widgetInfos, providerInfos)`
      - `StabilityConfigGenerator(codeGenerator).generate(snapshotInfos)`

    **WidgetHandler** (in `handlers/`):
    - `process(): List<WidgetInfo>`
    - `resolver.getSymbolsWithAnnotation("app.dqxn.android.sdk.contracts.annotation.DashboardWidget")`
    - Filter to `KSClassDeclaration` instances
    - For each: extract `typeId`, `displayName`, `icon` from annotation arguments
    - Validate `typeId` via `TypeIdValidator.validate(typeId, logger, classDecl)` — must match `^[a-z][a-z0-9]*:[a-z][a-z0-9-]*$`
    - Validate class implements `WidgetRenderer` by checking supertypes for FQN `app.dqxn.android.sdk.contracts.widget.WidgetRenderer`
    - Build `WidgetInfo` using `classDecl.toClassName()` from kotlinpoet-ksp
    - Return list

    **DataProviderHandler** (in `handlers/`):
    - `process(): List<ProviderInfo>`
    - `resolver.getSymbolsWithAnnotation("app.dqxn.android.sdk.contracts.annotation.DashboardDataProvider")`
    - Extract `localId`, `displayName`, `description`
    - Validate class implements `DataProvider<*>` by checking supertypes
    - Try to resolve `DataProvider`'s type argument `T` to get the snapshot class, then check if it has `@DashboardSnapshot` and extract `dataType`. If resolution fails, use empty string for `dataType` (documented limitation — cross-module snapshots).
    - Build `ProviderInfo`

    **SnapshotHandler** (in `handlers/`):
    - `process(): List<SnapshotInfo>`
    - `resolver.getSymbolsWithAnnotation("app.dqxn.android.sdk.contracts.annotation.DashboardSnapshot")`
    - For each: validate via `SnapshotValidator` (must be data class, must implement `DataSnapshot`, must have `@Immutable`, all properties must be `val`)
    - Extract `dataType` from annotation
    - Check for duplicate `dataType` within the module (same round) — `logger.error` on duplicate
    - Build `SnapshotInfo` with fully qualified class name

    **TypeIdValidator** (in `validation/`):
    - `fun validate(typeId: String, logger: KSPLogger, node: KSNode): Boolean`
    - Pattern: `^[a-z][a-z0-9]*:[a-z][a-z0-9-]*$`
    - On failure: `logger.error("@DashboardWidget typeId must match '{packId}:{widget-name}' format (lowercase letters, digits, hyphens after colon), got: $typeId", node)`

    **SnapshotValidator** (in `validation/`):
    - `fun validate(classDecl: KSClassDeclaration, logger: KSPLogger): Boolean`
    - Check: `classKind == ClassKind.CLASS && Modifier.DATA in modifiers` — error: "must be applied to a data class"
    - Check: implements `DataSnapshot` (FQN check on supertypes) — error: "must implement DataSnapshot"
    - Check: has `@Immutable` annotation (FQN: `androidx.compose.runtime.Immutable`) — error: "must be annotated with @Immutable"
    - Check: all properties are `val` (iterate `getAllProperties()`, check `!isMutable`) — error: "properties must be val, not var: {name}"

    **HiltModuleGenerator** (in `generation/`):
    - `fun generate(packId: String, widgets: List<WidgetInfo>, providers: List<ProviderInfo>)`
    - If both lists empty, skip.
    - Module name: `${packId.replaceFirstChar { it.uppercase() }}HiltModule`
    - Package: `app.dqxn.android.pack.${packId}.generated`
    - Generate an `@Module @InstallIn(SingletonComponent::class)` **interface** (not abstract class — interfaces are preferred for `@Binds`)
    - For each widget: `@Binds @IntoSet` abstract fun `bind{ClassName}(impl: ClassName): WidgetRenderer`
    - For each provider: `@Binds @IntoSet` abstract fun `bind{ClassName}(impl: ClassName): DataProvider<*>` (use `STAR` from KotlinPoet)
    - Use KotlinPoet `FileSpec.builder` → `TypeSpec.interfaceBuilder` → `FunSpec.builder` with `KModifier.ABSTRACT`
    - Call `addOriginatingKSFile()` on the TypeSpec builder for each widget/provider's originating file
    - Write via `fileSpec.writeTo(codeGenerator, aggregating = false)` — per-class isolation for incremental
    - FQN references: `dagger.Module`, `dagger.Binds`, `dagger.multibindings.IntoSet`, `dagger.hilt.InstallIn`, `dagger.hilt.components.SingletonComponent`

    **ManifestGenerator** (in `generation/`):
    - `fun generate(packId: String, widgets: List<WidgetInfo>, providers: List<ProviderInfo>)`
    - Generate a Kotlin `object` (not data class) that provides a `DashboardPackManifest` instance via a `val manifest` property
    - Object name: `${packId.replaceFirstChar { it.uppercase() }}GeneratedManifest`
    - Package: `app.dqxn.android.pack.${packId}.generated`
    - The manifest construction: `DashboardPackManifest(packId = ..., displayName = packId, description = "", version = 1, widgets = persistentListOf(...PackWidgetRef entries...), themes = persistentListOf(), dataProviders = persistentListOf(...PackDataProviderRef entries...), category = PackCategory.ESSENTIALS, entitlementId = null)`
    - Note: `displayName`, `description`, `version`, `category`, `entitlementId` are placeholders — the actual pack module overrides the generated manifest in its Hilt module. The generated manifest provides the widget/provider refs from KSP scanning.
    - Use `addOriginatingKSFile()` for all widget and provider originating files
    - Write via `fileSpec.writeTo(codeGenerator, aggregating = true)` — manifest aggregates all annotated symbols

    **StabilityConfigGenerator** (in `generation/`):
    - `fun generate(snapshots: List<SnapshotInfo>)`
    - If empty, skip.
    - Write a plain text file listing FQNs of all snapshot classes, one per line
    - Use `codeGenerator.createNewFile(Dependencies.ALL_FILES, "", "compose_stability_config", "txt")`
    - This writes to `build/generated/ksp/{variant}Kotlin/resources/compose_stability_config.txt`
    - Content: each snapshot's `qualifiedName` on its own line (e.g., `app.dqxn.android.pack.essentials.snapshots.SpeedSnapshot`)

    **Service file**: Create `android/codegen/plugin/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider` containing:
    ```
    app.dqxn.android.codegen.plugin.PluginProcessorProvider
    ```

    **Anti-patterns to avoid (from research):**
    - Do NOT add `:sdk:contracts` as a dependency of `:codegen:plugin` — read annotation FQNs as strings
    - Do NOT use source-file regex parsing (old codebase pattern) — use KSP Resolver API
    - Do NOT use `logger.warn()` for validation failures — use `logger.error()` to fail compilation
    - Do NOT generate no-arg constructor instantiation — generate `@Binds` interfaces for Hilt
    - Single-pass only (`invoked` flag) — no multi-round processing needed
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :codegen:plugin:compileKotlin --console=plain 2>&1 | tail -5</automated>
    <manual>Verify all source files created in expected directory structure, service file exists, no compile errors</manual>
  </verify>
  <done>`:codegen:plugin` compiles with full processor implementation: PluginProcessorProvider + PluginProcessor hub + 3 handlers (Widget, DataProvider, Snapshot) + 3 generators (HiltModule, Manifest, StabilityConfig) + 2 validators (TypeId, Snapshot) + META-INF service file. No compile dependency on :sdk:contracts.</done>
</task>

</tasks>

<verification>
1. `./gradlew :codegen:plugin:compileKotlin --console=plain` succeeds (zero errors)
2. Service file at `codegen/plugin/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider` contains correct FQN
3. `PackConventionPlugin` passes `packId` KSP arg and wires stability config into Compose compiler
4. No import of `:sdk:contracts` in `:codegen:plugin` build.gradle.kts
5. `libs.versions.toml` has `kctfork-core` and `kctfork-ksp` entries
</verification>

<success_criteria>
`:codegen:plugin` compiles as a pure JVM module with the complete hub-and-spoke processor architecture. Handlers extract annotation metadata via KSP Resolver (no regex, no compile dependency on contracts). Generators produce Hilt modules, pack manifests, and Compose stability configs using KotlinPoet. PackConventionPlugin passes packId and wires stability config path. Version catalog has kctfork entries for Plan 02 tests.
</success_criteria>

<output>
After completion, create `.planning/phases/04-ksp-codegen/04-01-SUMMARY.md`
</output>
