---
phase: 04-ksp-codegen
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - android/codegen/agentic/build.gradle.kts
  - android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessorProvider.kt
  - android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessor.kt
  - android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/model/CommandInfo.kt
  - android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/generation/CommandRouterGenerator.kt
  - android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/generation/SchemaGenerator.kt
  - android/codegen/agentic/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider
  - android/codegen/agentic/src/test/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessorTest.kt
  - android/codegen/agentic/src/test/kotlin/app/dqxn/android/codegen/agentic/AgenticStubs.kt
autonomous: true
requirements:
  - F2.12
  - F3.8

must_haves:
  truths:
    - "@AgenticCommand-annotated classes generate an AgenticCommandRouter with Hilt-injected dispatch"
    - "Generated list-commands schema includes command name, description, category, and parameter schema"
    - "Missing handler implementation (annotated class not implementing CommandHandler) produces a compilation error"
    - "Processor compiles and runs against synthetic annotation shapes (real @AgenticCommand created in Phase 6)"
  artifacts:
    - path: "android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessor.kt"
      provides: "KSP processor for @AgenticCommand annotations"
      contains: "class AgenticProcessor"
    - path: "android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessorProvider.kt"
      provides: "KSP service entry point"
      contains: "class AgenticProcessorProvider"
    - path: "android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/generation/CommandRouterGenerator.kt"
      provides: "Generates Hilt-compatible command router (not no-arg constructors)"
      contains: "class CommandRouterGenerator"
    - path: "android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/generation/SchemaGenerator.kt"
      provides: "Generates list-commands schema output for self-describing command registry"
      contains: "class SchemaGenerator"
    - path: "android/codegen/agentic/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider"
      provides: "Service loader registration"
      contains: "app.dqxn.android.codegen.agentic.AgenticProcessorProvider"
    - path: "android/codegen/agentic/src/test/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessorTest.kt"
      provides: "Compile-testing for agentic processor"
      contains: "class AgenticProcessorTest"
  key_links:
    - from: "android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessor.kt"
      to: "android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/generation/CommandRouterGenerator.kt"
      via: "Processor delegates generation"
      pattern: "CommandRouterGenerator"
    - from: "android/codegen/agentic/src/test/kotlin/app/dqxn/android/codegen/agentic/AgenticStubs.kt"
      to: "core:agentic (Phase 6)"
      via: "Synthetic annotation stubs matching expected @AgenticCommand shape"
      pattern: "AgenticCommand"
---

<objective>
Build the `:codegen:agentic` KSP processor for agentic command auto-registration and validate with compile-testing.

Purpose: The agentic debug framework (Phase 6) needs auto-discovery of command handlers. The old codebase's `GeneratedCommandRegistry` used no-arg constructors that broke with Hilt injection. The new processor generates a Hilt-compatible command router with `@Binds @IntoSet` multibinding + a self-describing `list-commands` schema. Built now against expected annotation shapes — becomes functional when Phase 6 provides the real `@AgenticCommand` annotation.

Output: Compiling `:codegen:agentic` processor with compile-testing tests using synthetic annotation stubs.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ksp-codegen/04-RESEARCH.md
@.planning/oldcodebase/ksp-processors.md
@android/codegen/agentic/build.gradle.kts
@android/gradle/libs.versions.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement `:codegen:agentic` processor — build config, processor, generators, service file</name>
  <files>
    android/codegen/agentic/build.gradle.kts
    android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessorProvider.kt
    android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessor.kt
    android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/model/CommandInfo.kt
    android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/generation/CommandRouterGenerator.kt
    android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/generation/SchemaGenerator.kt
    android/codegen/agentic/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider
  </files>
  <action>
    **1. Update build.gradle.kts** — replace stub with dependencies:

    ```kotlin
    plugins { id("dqxn.kotlin.jvm") }

    dependencies {
        implementation(libs.ksp.api)
        implementation(libs.kotlinpoet)
        implementation(libs.kotlinpoet.ksp)

        testImplementation(platform(libs.junit.bom))
        testImplementation(libs.junit.jupiter.api)
        testRuntimeOnly(libs.junit.jupiter.engine)
        testImplementation(libs.truth)
        testImplementation(libs.kctfork.core)
        testImplementation(libs.kctfork.ksp)
    }
    ```

    Same dependency set as `:codegen:plugin`. No dependency on `:core:agentic` (annotation read via KSP from consumer classpath).

    **2. Model class** (`model/CommandInfo.kt`):

    `CommandInfo` data class: `name: String`, `description: String`, `category: String`, `className: String`, `packageName: String`, `typeName: ClassName`, `originatingFile: KSFile`.

    **3. AgenticProcessorProvider** — standard `SymbolProcessorProvider` creating `AgenticProcessor`.

    **4. AgenticProcessor** — single-pass processor:
    - `private var invoked = false`
    - Scans for annotation FQN `app.dqxn.android.core.agentic.AgenticCommand` (expected shape from Phase 6)
    - For each `KSClassDeclaration` annotated:
      - Extract `name`, `description`, `category` from annotation arguments
      - Validate: class must implement `CommandHandler` (FQN: `app.dqxn.android.core.agentic.CommandHandler`). If not, `logger.error("@AgenticCommand class must implement CommandHandler", classDecl)`.
      - Build `CommandInfo`
    - Generate outputs:
      - `CommandRouterGenerator(codeGenerator).generate(commandInfos)` — Hilt module
      - `SchemaGenerator(codeGenerator).generate(commandInfos)` — schema object

    **5. CommandRouterGenerator** (`generation/CommandRouterGenerator.kt`):

    Generates a Hilt `@Module @InstallIn(SingletonComponent::class)` **interface** with `@Binds @IntoSet` for each command handler, binding into `Set<CommandHandler>`.

    Module name: `AgenticHiltModule`
    Package: `app.dqxn.android.core.agentic.generated`

    For each command: `@Binds @IntoSet abstract fun bind{ClassName}(impl: ClassName): CommandHandler`

    **Critical difference from old codebase:** The old processor generated `FooHandler()` no-arg constructors. The new processor generates `@Binds` interfaces — Hilt handles injection. Each `CommandHandler` implementation class needs its own `@Inject constructor` (written in Phase 6, not generated here). The generated module just binds the concrete class into the `Set<CommandHandler>`.

    Use KotlinPoet. `addOriginatingKSFile()` for each command's originating file. `writeTo(codeGenerator, aggregating = false)`.

    **6. SchemaGenerator** (`generation/SchemaGenerator.kt`):

    Generates a Kotlin `object` with a function that returns the command schema as a list of data objects.

    Object name: `GeneratedCommandSchema`
    Package: `app.dqxn.android.core.agentic.generated`

    Generated structure:
    ```kotlin
    object GeneratedCommandSchema {
        data class CommandSchemaEntry(
            val name: String,
            val description: String,
            val category: String,
        )

        val commands: List<CommandSchemaEntry> = listOf(
            CommandSchemaEntry(name = "ping", description = "Health check", category = "diagnostics"),
            // ... one per @AgenticCommand
        )
    }
    ```

    This provides the `list-commands` self-describing registry. The `AgenticEngine` in Phase 6 reads `GeneratedCommandSchema.commands` to build the schema response.

    Use `aggregating = true` for the schema (depends on all annotated symbols).

    **7. Service file**: `android/codegen/agentic/src/main/resources/META-INF/services/com.google.devtools.ksp.processing.SymbolProcessorProvider` containing:
    ```
    app.dqxn.android.codegen.agentic.AgenticProcessorProvider
    ```

    **Note:** No `@DashboardWidget` / `@DashboardDataProvider` processing here — that's all in `:codegen:plugin`. The agentic processor is a separate concern (debug framework), separate module, separate service provider.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :codegen:agentic:compileKotlin --console=plain 2>&1 | tail -5</automated>
    <manual>Verify processor, generators, model, and service file all created</manual>
  </verify>
  <done>`:codegen:agentic` compiles with AgenticProcessor + AgenticProcessorProvider + CommandRouterGenerator (Hilt @Binds @IntoSet) + SchemaGenerator (list-commands schema) + CommandInfo model + META-INF service file. No dependency on :core:agentic.</done>
</task>

<task type="auto">
  <name>Task 2: Compile-testing for agentic processor — positive and negative paths</name>
  <files>
    android/codegen/agentic/src/test/kotlin/app/dqxn/android/codegen/agentic/AgenticStubs.kt
    android/codegen/agentic/src/test/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessorTest.kt
  </files>
  <action>
    **AgenticStubs.kt** — Synthetic annotation and interface stubs matching the expected `@AgenticCommand` and `CommandHandler` shapes from Phase 6.

    `fun agenticStubs(): Array<SourceFile>` returning:

    - `AgenticCommand.kt` — annotation with `name: String`, `description: String`, `category: String = ""`. Package: `app.dqxn.android.core.agentic`. Retention: SOURCE.
    - `CommandHandler.kt` — interface with `val name: String`, `val description: String`, `val category: String`, `val aliases: List<String>`, `suspend fun execute(params: Any, commandId: String): Any`, `fun paramsSchema(): Any`. Package: `app.dqxn.android.core.agentic`. (Simplified from real interface — don't need JsonObject/CommandResult types for KSP validation, just the FQN match.)

    **AgenticProcessorTest.kt** — Compile-testing with kctfork:

    Common setup: `KotlinCompilation()` with `agenticStubs()`, `symbolProcessorProviders = listOf(AgenticProcessorProvider())`.

    Positive tests:

    1. `valid AgenticCommand generates Hilt module` — provide:
    ```kotlin
    @AgenticCommand(name = "ping", description = "Health check", category = "diagnostics")
    class PingHandler : CommandHandler { ... minimal stubs ... }
    ```
    Assert: `exitCode == OK`. Generated `AgenticHiltModule.kt` contains `@Module`, `@Binds`, `@IntoSet`, `bindPingHandler`, `CommandHandler`.

    2. `valid AgenticCommand generates schema` — same input. Assert: generated `GeneratedCommandSchema.kt` contains `name = "ping"`, `description = "Health check"`, `category = "diagnostics"`.

    3. `multiple commands generate combined module and schema` — two commands: `ping` and `navigate`. Assert: Hilt module has 2 `@Binds` methods. Schema has 2 entries.

    4. `no annotated classes produces no output` — empty compilation. Assert: `exitCode == OK`. No generated files.

    Negative tests:

    5. `class not implementing CommandHandler produces error` — `@AgenticCommand` on a plain class not implementing `CommandHandler`. Assert: `exitCode == COMPILATION_ERROR`. Message contains "must implement CommandHandler".

    6. `duplicate command names produce error` — two classes with `@AgenticCommand(name = "ping", ...)`. This isn't explicitly validated in the processor spec, but it's good practice. If the processor doesn't check this, skip this test. Alternatively, add duplicate name detection to the processor: if two `CommandInfo` entries have the same `name`, `logger.error("Duplicate @AgenticCommand name: $name")`.

    **Total: 5-6 tests** for the agentic processor.

    **Same kctfork compatibility note as Plan 02:** If kctfork doesn't work with Kotlin 2.3.10, this plan needs the same version resolution. Since Plan 03 runs in Wave 1 parallel with Plan 01, if kctfork fails here, the fix propagates to Plan 02 as well. Document any version change needed.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :codegen:agentic:test --console=plain 2>&1 | tail -20</automated>
    <manual>Check for 5-6 passing tests covering positive and negative paths</manual>
  </verify>
  <done>5-6 compile-testing tests pass for the agentic processor: valid command generates Hilt module, valid command generates schema, multiple commands combined, empty module no output, missing CommandHandler produces error, (optionally) duplicate name detection. Tests use synthetic @AgenticCommand stubs matching the Phase 6 expected annotation shape.</done>
</task>

</tasks>

<verification>
1. `./gradlew :codegen:agentic:compileKotlin --console=plain` succeeds
2. `./gradlew :codegen:agentic:test --console=plain` — all tests pass
3. Service file registered at correct path
4. Generated Hilt module uses `@Binds @IntoSet` (NOT no-arg constructor instantiation)
5. Generated schema includes command name, description, and category from annotation arguments
6. No compile dependency on `:core:agentic` in build.gradle.kts
</verification>

<success_criteria>
`:codegen:agentic` compiles and passes all compile-testing tests. The processor generates Hilt-compatible `@Binds @IntoSet` modules (fixing the old codebase's no-arg constructor anti-pattern) and a self-describing command schema object. Tests use synthetic annotation stubs since real `@AgenticCommand` is created in Phase 6. The processor is ready to become functional when the annotation lands on the consumer's classpath.
</success_criteria>

<output>
After completion, create `.planning/phases/04-ksp-codegen/04-03-SUMMARY.md`
</output>
