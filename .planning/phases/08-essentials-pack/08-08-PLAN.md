---
phase: 08-essentials-pack
plan: 08
type: execute
wave: 3
depends_on: ["08-02", "08-03", "08-04", "08-05", "08-06", "08-07"]
files_modified:
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/integration/PackCompileVerificationTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/integration/MultiSlotBindingTest.kt
  - android/app/src/debug/kotlin/app/dqxn/android/debug/handlers/AddWidgetHandler.kt
  - android/app/src/test/kotlin/app/dqxn/android/debug/handlers/AddWidgetHandlerTest.kt
autonomous: true
requirements:
  - F5.1
  - F5.2
  - F5.3
  - F5.4
  - F5.5
  - F5.6
  - F5.7
  - F5.8
  - F5.9
  - F5.10
  - F5.11
  - NF14
  - NF40
  - NF-I2
  - NF-P1

must_haves:
  truths:
    - "13 widget renderers all pass WidgetRendererContractTest (14 assertions each)"
    - "9 data providers all pass DataProviderContractTest (12 assertions each)"
    - "KSP generates Hilt module and pack manifest without errors"
    - "Full project test suite passes with :pack:essentials in dependency graph"
    - "App assembles with pack included — no Hilt binding conflicts or R8 errors"
    - "SpeedometerRenderer receives speed data independently via merge()+scan() — does not block on acceleration or speed limit providers"
  artifacts:
    - path: "android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/integration/PackCompileVerificationTest.kt"
      provides: "Integration verification test"
      contains: "widget count"
    - path: "android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/integration/MultiSlotBindingTest.kt"
      provides: "merge()+scan() multi-slot proof"
      contains: "SpeedSnapshot"
    - path: "android/app/src/debug/kotlin/app/dqxn/android/debug/handlers/AddWidgetHandler.kt"
      provides: "Agentic add-widget command handler"
      contains: "AddWidgetHandler"
  key_links:
    - from: "android/app/build.gradle.kts"
      to: ":pack:essentials"
      via: "implementation dependency"
      pattern: "pack:essentials"
    - from: "KSP generated EssentialsModule"
      to: "Set<WidgetRenderer>, Set<DataProvider<*>>"
      via: "Hilt multibinding"
      pattern: "@IntoSet"
    - from: "android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/integration/MultiSlotBindingTest.kt"
      to: "WidgetDataBinder"
      via: "merge()+scan() accumulation validates independent slot arrival"
      pattern: "merge.*scan|WidgetDataBinder"
    - from: "android/app/src/debug/kotlin/app/dqxn/android/debug/handlers/AddWidgetHandler.kt"
      to: "DashboardCommand.AddWidget"
      via: "Agentic bridge dispatches add-widget to LayoutCoordinator"
      pattern: "DashboardCommand.AddWidget"
---

<objective>
Verify end-to-end integration: all contract tests green, KSP generation works, full project builds with the pack, regression suite passes, multi-slot merge()+scan() proven, on-device wiring verified, and 60-second stability soak passes.

Purpose: This is the Phase 8 gate — all seven success criteria from the roadmap must pass before Phase 9 can start. This plan runs the full verification pipeline: unit/contract tests, integration proof of multi-slot binding, KSP manifest verification, on-device wiring via agentic commands, and a stability soak to confirm safe mode is not triggered.

Output: All tests green, full build successful, MultiSlotBindingTest, PackCompileVerificationTest, on-device verification, stability soak pass.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-essentials-pack/08-RESEARCH.md
@.planning/phases/08-essentials-pack/08-01-SUMMARY.md
@.planning/phases/08-essentials-pack/08-02-SUMMARY.md
@.planning/phases/08-essentials-pack/08-03-SUMMARY.md
@.planning/phases/08-essentials-pack/08-04-SUMMARY.md
@.planning/phases/08-essentials-pack/08-05-SUMMARY.md
@.planning/phases/08-essentials-pack/08-06-SUMMARY.md
@.planning/phases/08-essentials-pack/08-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix any compilation or test failures across all pack code</name>
  <files>
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/integration/PackCompileVerificationTest.kt
  </files>
  <action>
    **Step 1: Full pack compilation check.**
    Run `./gradlew :pack:essentials:compileDebugKotlin --console=plain`. This triggers KSP annotation processing which generates:
    - `EssentialsModule` (Hilt `@Module @InstallIn(SingletonComponent)` with `@Binds @IntoSet` for all 13 renderers and 10 providers)
    - `EssentialsPackManifest` (serializable manifest with widget/provider inventory)
    - Compose stability configuration for all snapshot types

    If KSP fails, the most likely causes are:
    - Duplicate `typeId` across widgets → fix the typeId string
    - Missing `@DashboardSnapshot` on a snapshot used in `compatibleSnapshots` → add annotation
    - `@DashboardDataProvider` `localId` format error → lowercase, hyphens for multi-word
    - Annotation field mismatch (check if KSP expects full `essentials:speedometer` or just `speedometer` for typeId — read `:codegen:plugin` PluginProcessor to determine)

    **Step 2: Full pack test suite.**
    Run `./gradlew :pack:essentials:testDebugUnitTest --console=plain`. Fix any failures. Common failure modes:
    - Test runner framework mismatch (JUnit4 for widget contract tests, JUnit5 for provider contract tests)
    - MockK issues with final classes on JDK 25 — make classes open if needed
    - Missing `isReturnDefaultValues=true` for Android stubs in unit tests

    **Step 3: Create integration verification test.**
    Create `PackCompileVerificationTest.kt` (JUnit5) that verifies:
    - KSP-generated `EssentialsPackManifest` contains 13 widget entries
    - Manifest widget typeIds match expected: `essentials:speedometer`, `essentials:clock`, `essentials:clock-analog`, `essentials:date-simple`, `essentials:date-stack`, `essentials:date-grid`, `essentials:compass`, `essentials:battery`, `essentials:speedlimit-circle`, `essentials:speedlimit-rect`, `essentials:shortcuts`, `essentials:solar`, `essentials:ambient-light`
    - Provider count: 10 providers (9 typed + 1 action)
    - Theme count: 2 themes
    - All typeIds follow `packId:widget-name` format

    **Step 4: Full project build.**
    Run `./gradlew assembleDebug --console=plain`. This verifies:
    - Hilt multibinding sets resolve (no `MissingBinding` errors)
    - KSP processing doesn't conflict with other modules
    - R8/D8 dexing succeeds with all pack classes

    **Step 5: Regression gate.**
    Run `./gradlew test --console=plain`. This runs ALL project tests (Phases 2-7 + Phase 8). Fix any regression. Common regression causes:
    - Empty multibinding sets in Phase 6 tests now have real entries — may change test expectations
    - Hilt component graph changes — new bindings might conflict with test fakes
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:testDebugUnitTest --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>Pack compiles with KSP generation. All 13 widget contract tests pass (14 assertions each = 182 total). All 9 typed provider contract tests pass (12 assertions each = 108 total). Integration test verifies manifest inventory. Full assembleDebug succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Full project regression verification</name>
  <files><!-- No new files — this task runs existing tests and fixes regressions in-place --></files>
  <action>
    **Run the complete project test suite:**
    ```
    ./gradlew test --console=plain
    ```

    This is the regression gate — ALL previous phase tests must still pass with `:pack:essentials` in the dependency graph.

    **Expected test counts (approximate):**
    - `:sdk:common` — ~30 tests (AppResult, ConnectionStateMachine, FlowExtensions)
    - `:sdk:contracts` — ~72 tests (WidgetData, Gated, SettingDefinition, SetupDefinition, ProviderFault)
    - `:sdk:observability` — ~40 tests (logging, metrics, health, crash evidence, ANR)
    - `:sdk:analytics` — ~10 tests (PackAnalytics, events)
    - `:sdk:ui` — ~15 tests (InfoCardLayout, theme definition, container)
    - `:codegen:plugin` — ~20 tests (KSP compile-testing)
    - `:codegen:agentic` — ~10 tests (agentic processor)
    - `:core:thermal` — ~10 tests
    - `:core:firebase` — ~15 tests
    - `:core:design` — ~20 tests (tokens, ThemeJsonParser, ThemeAutoSwitchEngine)
    - `:core:agentic` — ~20 tests (router, handlers)
    - `:data` — ~30 tests (repositories, stores, migration)
    - `:lint-rules` — ~35 tests (5 detectors + WidgetScopeBypass)
    - `:pack:essentials` — ~80+ tests (13 widget + 9 provider contract + specific + integration)
    - `:app` — ~15 tests (DI, crash recovery, agentic)
    - Total: ~400+ tests

    **If any test fails:**
    1. Read the failure output carefully
    2. Determine if it's a genuine regression (existing test broke due to pack addition) or a pre-existing flaky test
    3. For genuine regressions: fix in the affected module. Common fixes:
       - Hilt test modules need `@UninstallModules` for pack modules
       - Empty set expectations need updating (set now has entries)
       - R8 rules may need `@Keep` on KSP-generated classes
    4. For pack test failures: fix the pack code
    5. Re-run until green

    **Also verify:**
    ```
    ./gradlew assembleRelease --console=plain
    ```
    Release build with R8 must succeed. KSP-generated classes and `@Serializable` manifest must survive R8 processing. If R8 strips needed classes, add ProGuard rules to pack's `proguard-rules.pro`.

    **Final verification:**
    ```
    ./gradlew lintDebug --console=plain
    ```
    Lint should pass with no new errors. WidgetScopeBypass rule should NOT fire on any widget (they all use LocalWidgetData, not rememberCoroutineScope).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew test assembleRelease lintDebug --console=plain 2>&1 | tail -30</automated>
  </verify>
  <done>Full project test suite passes (400+ tests). assembleRelease succeeds with R8 processing. lintDebug passes with no new errors. Phase 8 gate criteria met: (1) contract tests green, (2) KSP generation works, (3) regression suite passes, (4) release build succeeds.</done>
</task>

<task type="auto">
  <name>Task 3: Create AddWidgetHandler and MultiSlotBindingTest</name>
  <files>
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/integration/MultiSlotBindingTest.kt
    android/app/src/debug/kotlin/app/dqxn/android/debug/handlers/AddWidgetHandler.kt
    android/app/src/test/kotlin/app/dqxn/android/debug/handlers/AddWidgetHandlerTest.kt
  </files>
  <action>
    **Part A: Create AddWidgetHandler agentic command**

    The `add-widget` agentic command does not exist yet. Create it following the pattern of existing handlers in `app/src/debug/kotlin/.../handlers/` (e.g., `DumpHealthHandler`, `ListWidgetsHandler`).

    Create `AddWidgetHandler.kt`:
    - Package: `app.dqxn.android.debug.handlers`
    - Implements `AgenticCommandHandler` (check `AgenticCommand.kt` in `:core:agentic` for the interface)
    - `name = "add-widget"`
    - Reads `typeId` from `params.raw["typeId"]` (caller passes JSON object arg: `{"typeId":"essentials:clock"}`)
    - Dispatches `DashboardCommand.AddWidget(typeId)` through the dashboard command channel
    - Returns JSON: `{"status":"ok","typeId":"essentials:clock","widgetId":"<generated>"}` on success
    - Returns JSON: `{"status":"error","message":"Unknown typeId: foo","code":"UNKNOWN_TYPE"}` on failure
    - Inject via Hilt `@IntoSet` multibinding into `Set<AgenticCommandHandler>`, same as other handlers
    - Read existing handlers (e.g., `DumpHealthHandler.kt`, `ListWidgetsHandler.kt`) for the exact interface contract and Hilt registration pattern

    Create `AddWidgetHandlerTest.kt`:
    - Verify handler name is `"add-widget"`
    - Verify successful add returns `"ok"` status with typeId echoed
    - Verify unknown typeId returns error with `UNKNOWN_TYPE` code
    - Mock the dashboard command channel (same pattern as other handler tests)

    **Part B: merge()+scan() multi-slot integration test**

    Create `MultiSlotBindingTest.kt` (JUnit5) in the integration test package. This test proves that the multi-slot `WidgetData` accumulation model works correctly for merge()+scan() — each slot update preserves existing slots.

    Test setup:
    - Create a `SpeedometerRenderer` instance
    - Build `WidgetData` progressively via slot population:
      ```
      val data0 = WidgetData.Empty
      val data1 = data0.withSlot(SpeedSnapshot::class, speedSnapshot)
      val data2 = data1.withSlot(AccelerationSnapshot::class, accelSnapshot)
      val data3 = data2.withSlot(SpeedLimitSnapshot::class, limitSnapshot)
      ```

    Assertions:
    1. `data1.snapshot<SpeedSnapshot>()` is non-null — speed present
    2. `data1.snapshot<AccelerationSnapshot>()` is null — acceleration not yet added
    3. SpeedometerRenderer's `accessibilityDescription(data1)` includes speed value — renders with partial data, no crash
    4. `data2.snapshot<SpeedSnapshot>()` is still non-null — speed preserved after acceleration slot added
    5. `data2.snapshot<AccelerationSnapshot>()` is non-null — acceleration now present
    6. `data3` has all 3 slots populated, `accessibilityDescription(data3)` includes "Over limit" (speed > limit)

    If `DashboardTestHarness` supports `WidgetDataBinder` wiring, optionally add a flow-based variant using `StandardTestDispatcher` + `advanceTimeBy()` + Turbine with staggered-delay fake providers to prove merge()+scan() timing independence. This flow-based variant FAILS if combine() is used — combine() blocks until all 3 emit, so speed data would not arrive before acceleration.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:testDebugUnitTest --tests "*.MultiSlotBindingTest" :app:testDebugUnitTest --tests "*.AddWidgetHandlerTest" --console=plain 2>&1 | tail -15</automated>
  </verify>
  <done>AddWidgetHandler created and tested. MultiSlotBindingTest proves independent slot arrival — speed data available before acceleration/speed limit. Slot accumulation preserves existing data on each update. Speedometer renders with partial data without crash.</done>
</task>

</tasks>

<verification>
1. `./gradlew :pack:essentials:testDebugUnitTest --console=plain` — all pack tests pass
2. `./gradlew test --console=plain` — full project regression green
3. `./gradlew assembleDebug --console=plain` — debug build with pack succeeds
4. `./gradlew assembleRelease --console=plain` — release build with R8 succeeds
5. `./gradlew lintDebug --console=plain` — no new lint errors
6. KSP-generated EssentialsModule resolves in Hilt graph
7. 13 widgets × 14 contract assertions = 182 contract test passes
8. 9 providers × 12 contract assertions = 108 contract test passes
9. MultiSlotBindingTest: speed data arrives before acceleration/speed limit — merge()+scan() confirmed
</verification>

<success_criteria>
- Phase 8 gate criteria (off-device):
  1. Contract tests green (13 widgets + 9 providers)
  2. Multi-snapshot wiring: SpeedometerRenderer receives data from 3 providers via merge()+scan() — proven by MultiSlotBindingTest
  3. Regression gate: full project tests pass with pack in dependency graph
  4. KSP generation produces valid Hilt module + manifest
  5. Release build succeeds
- Integration verification test confirms 13 widgets, 10 providers, 2 themes in manifest
- No new lint errors from WidgetScopeBypass or other rules
- On-device gate criteria (end-to-end wiring + stability soak) verified in 08-09
</success_criteria>

<output>
After completion, create `.planning/phases/08-essentials-pack/08-08-SUMMARY.md`
</output>
