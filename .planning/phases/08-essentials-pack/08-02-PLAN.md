---
phase: 08-essentials-pack
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/TimeDataProvider.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/OrientationDataProvider.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/AmbientLightDataProvider.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/BatteryProvider.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/RegionDetector.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/TimezoneCountryMap.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/TimeDataProviderTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/OrientationDataProviderTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/AmbientLightDataProviderTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/BatteryProviderTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/RegionDetectorTest.kt
autonomous: true
requirements:
  - F5.2
  - F5.3
  - F5.4
  - F5.5
  - F5.6
  - F5.10
  - NF14

must_haves:
  truths:
    - "TimeDataProvider emits TimeSnapshot every 1 second with correct epoch and zone"
    - "OrientationDataProvider emits bearing/pitch/roll with sensor batching (200ms)"
    - "AmbientLightDataProvider emits lux with category classification and sensor batching (500ms)"
    - "BatteryProvider emits level/charging/temperature from sticky broadcast immediately"
    - "RegionDetector correctly identifies MPH countries via timezone fallback chain"
  artifacts:
    - path: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/TimeDataProvider.kt"
      provides: "System clock data provider"
      contains: "@DashboardDataProvider"
    - path: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/BatteryProvider.kt"
      provides: "Greenfield battery data provider"
      contains: "callbackFlow"
    - path: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/RegionDetector.kt"
      provides: "Timezone-first MPH detection"
      contains: "MPH_COUNTRIES"
  key_links:
    - from: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/TimeDataProvider.kt"
      to: "app.dqxn.android.pack.essentials.snapshots.TimeSnapshot"
      via: "emits typed snapshot"
      pattern: "TimeSnapshot"
    - from: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/OrientationDataProvider.kt"
      to: "SensorManager.registerListener"
      via: "callbackFlow with awaitClose"
      pattern: "awaitClose"
---

<objective>
Implement simple data providers (Time, Orientation, AmbientLight, Battery) and the RegionDetector utility.

Purpose: These 4 providers cover 6 of the 8 data types used by Essentials widgets. Battery is greenfield (no old codebase equivalent). RegionDetector determines speed unit display for 3 widgets.

Output: 4 data providers with contract tests + provider-specific tests. RegionDetector utility with fallback chain tests. TimezoneCountryMap data table.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-essentials-pack/08-RESEARCH.md
@.planning/phases/08-essentials-pack/08-01-SUMMARY.md
@android/sdk/contracts/src/testFixtures/kotlin/app/dqxn/android/sdk/contracts/testing/DataProviderContractTest.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/provider/DataProvider.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/provider/DataProviderSpec.kt
@.planning/oldcodebase/packs.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Time, Orientation, AmbientLight, and Battery providers</name>
  <files>
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/TimeDataProvider.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/OrientationDataProvider.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/AmbientLightDataProvider.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/BatteryProvider.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/RegionDetector.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/TimezoneCountryMap.kt
  </files>
  <action>
    All providers: package `app.dqxn.android.pack.essentials.providers`. Annotate with `@DashboardDataProvider(localId, displayName, description)`. `@Singleton`. `@Inject constructor`. Implement `DataProvider<T>` with `snapshotType`, `sourceId` (format: `essentials:{name}`), `dataType`, `priority`, `subscriberTimeout`, `firstEmissionTimeout`, `provideState(): Flow<T>`, `connectionState: StateFlow<Boolean>`, `connectionErrorDescription: StateFlow<String?>`, `setupSchema`, `schema: DataSchema`.

    **TimeDataProvider** — port pattern from old codebase:
    - `localId = "time"`, priority `DEVICE_SENSOR`, subscriberTimeout 1s
    - `provideState()`: `flow { while(true) { emit(TimeSnapshot(System.currentTimeMillis(), TimeZone.getDefault().id, elapsedRealtimeNanos())); delay(1000) } }`
    - connectionState always true, no setup needed, empty setupSchema
    - Register `BroadcastReceiver` for `ACTION_TIMEZONE_CHANGED` to update zone ID reactively

    **OrientationDataProvider** — port from old, `callbackFlow` pattern:
    - `localId = "orientation"`, priority `DEVICE_SENSOR`, subscriberTimeout 5s
    - `provideState()`: `callbackFlow` with `SensorManager.registerListener()` for `TYPE_ROTATION_VECTOR`
    - **NF14 sensor batching:** `maxReportLatencyUs = 200_000` (200ms batch for orientation)
    - Warm-up: skip first 10 sensor events (calibration noise)
    - Bearing normalized to 0-360: `(Math.toDegrees(orientation[0].toDouble()).toFloat() + 360f) % 360f`
    - `.conflate()` on the flow — latest value wins for display
    - `awaitClose { sensorManager.unregisterListener(listener) }` — MANDATORY
    - connectionState based on sensor availability

    **AmbientLightDataProvider** — port from old, `callbackFlow` pattern:
    - `localId = "ambient-light"`, priority `DEVICE_SENSOR`, subscriberTimeout 5s
    - `provideState()`: `callbackFlow` with `SensorManager.registerListener()` for `TYPE_LIGHT`
    - **NF14 sensor batching:** `maxReportLatencyUs = 500_000` (500ms batch for ambient light)
    - Category classification: DARK (<50 lux), DIM (<200), NORMAL (<500), BRIGHT (>=500)
    - `.conflate()` on flow
    - `awaitClose` for cleanup

    **BatteryProvider** — GREENFIELD:
    - `localId = "battery"`, priority `DEVICE_SENSOR`, subscriberTimeout 30s, firstEmissionTimeout 5s
    - `provideState()`: `callbackFlow` with `BroadcastReceiver` for `ACTION_BATTERY_CHANGED`
    - Battery is sticky broadcast — first emission is immediate upon registration
    - Extract: level = `EXTRA_LEVEL * 100 / EXTRA_SCALE`, isCharging = `EXTRA_STATUS == CHARGING || FULL`, temperature = `EXTRA_TEMPERATURE / 10f` (null if <=0)
    - `awaitClose { context.unregisterReceiver(receiver) }` — MANDATORY
    - connectionState always true (battery is always available), empty setupSchema

    **RegionDetector** — port from old codebase:
    - Object with `fun detectSpeedUnit(): SpeedUnit` enum (KPH, MPH)
    - 3-step fallback: (1) timezone → country via `TimezoneCountryMap`, (2) `Locale.getDefault().country`, (3) fallback "US"
    - `MPH_COUNTRIES` set: US, GB, MM, LR, AS, VI, GU, MP, PR, WS, BS, BZ, KY, FK, AG, DM, GD, KN, LC, VC, MS, TC, VG, AI
    - `fun isMetric(): Boolean` convenience

    **TimezoneCountryMap** — data table port:
    - Object with `fun getCountryCode(timezoneId: String): String?`
    - Map of IANA timezone ID to ISO 3166-1 alpha-2 country code
    - Must handle alias resolution via `android.icu.util.TimeZone.getCanonicalID()` before lookup
    - Include common aliases: "US/Eastern" → "America/New_York", "Asia/Saigon" → "Asia/Ho_Chi_Minh"
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>All 4 providers compile with correct annotations, callbackFlow patterns, sensor batching parameters. RegionDetector and TimezoneCountryMap compile. Each provider has awaitClose for resource cleanup.</done>
</task>

<task type="auto">
  <name>Task 2: Provider contract tests and provider-specific unit tests</name>
  <files>
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/TimeDataProviderTest.kt
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/OrientationDataProviderTest.kt
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/AmbientLightDataProviderTest.kt
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/BatteryProviderTest.kt
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/RegionDetectorTest.kt
  </files>
  <action>
    **Contract test classes** — each extends `DataProviderContractTest` (JUnit5, 12 inherited assertions):
    - Override `createProvider()` returning a configured instance with mocked Android dependencies
    - TimeDataProviderTest: mock is minimal (no Android deps needed for time)
    - OrientationDataProviderTest: mock `SensorManager` + `Sensor`, simulate sensor events in test
    - AmbientLightDataProviderTest: mock `SensorManager` + `Sensor`, simulate light events
    - BatteryProviderTest: mock `Context.registerReceiver()` with sticky broadcast behavior

    **For mocking sensor providers:** Since `callbackFlow` captures a `SensorEventListener`, tests need to:
    1. Capture the listener registered with `SensorManager.registerListener()`
    2. Fire events through the captured listener
    3. Use `StandardTestDispatcher` (never Unconfined)
    4. Use Turbine for flow assertions

    **Provider-specific tests beyond contract base:**

    BatteryProviderTest (greenfield-specific):
    - Battery level calculation: `EXTRA_LEVEL=75, EXTRA_SCALE=100` → level=75
    - Charging state: `EXTRA_STATUS=CHARGING` → isCharging=true
    - Temperature conversion: `EXTRA_TEMPERATURE=285` → temperature=28.5f
    - Temperature null: `EXTRA_TEMPERATURE=-1` → temperature=null
    - Sticky broadcast: first emission is immediate (no delay)

    OrientationDataProviderTest:
    - Bearing normalization: negative bearing wraps to 0-360
    - Warm-up skip: first 10 events not emitted
    - Sensor batching: verify `registerListener` called with `maxReportLatencyUs = 200_000`

    AmbientLightDataProviderTest:
    - Category classification: 10 lux → DARK, 100 lux → DIM, 300 lux → NORMAL, 1000 lux → BRIGHT

    **RegionDetectorTest:**
    - Timezone "America/New_York" → MPH (US)
    - Timezone "Europe/London" → MPH (GB)
    - Timezone "Asia/Singapore" → KPH
    - Timezone "Asia/Tokyo" → KPH
    - Fallback when timezone lookup fails: uses locale country
    - Default fallback: US (MPH) when both timezone and locale fail
    - `MPH_COUNTRIES` set includes all 24 known countries
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:testDebugUnitTest --console=plain 2>&1 | tail -15</automated>
  </verify>
  <done>All 4 provider contract test classes pass 12 inherited assertions each. Battery greenfield tests verify level calculation, charging state, temperature conversion. Orientation tests verify bearing normalization, warm-up, and batching. AmbientLight tests verify category classification. RegionDetector tests verify 3-step fallback chain and MPH_COUNTRIES completeness.</done>
</task>

</tasks>

<verification>
1. `./gradlew :pack:essentials:testDebugUnitTest --console=plain` — all provider + RegionDetector tests pass
2. Each provider has `@DashboardDataProvider` annotation
3. Sensor providers have `awaitClose` blocks
4. Sensor batching parameters: orientation 200ms, ambient light 500ms (NF14)
5. Battery uses sticky broadcast pattern for immediate first emission
</verification>

<success_criteria>
- 4 providers pass DataProviderContractTest (12 assertions each)
- Battery-specific: level, charging, temperature, immediate emission tests pass
- Orientation-specific: bearing normalization, warm-up, batching tests pass
- AmbientLight-specific: lux category classification tests pass
- RegionDetector: 3-step fallback chain verified with 7+ test cases
</success_criteria>

<output>
After completion, create `.planning/phases/08-essentials-pack/08-02-SUMMARY.md`
</output>
