---
phase: 08-essentials-pack
plan: 07
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/widgets/speedometer/SpeedometerRenderer.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/theme/EssentialsThemeProvider.kt
  - android/pack/essentials/src/main/resources/themes/slate.theme.json
  - android/pack/essentials/src/main/resources/themes/minimalist.theme.json
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/widgets/SpeedometerRendererTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/theme/EssentialsThemeProviderTest.kt
autonomous: true
requirements:
  - F5.1
  - NF40
  - NF-I2

must_haves:
  truths:
    - "SpeedometerRenderer consumes 3 slots (Speed, Acceleration, SpeedLimit) independently via multi-slot WidgetData"
    - "Speed limit warning uses color + pulsing border + warning icon (not color alone) for color-blind safety"
    - "Auto-scaling gauge max adjusts to stepped thresholds based on current speed"
    - "12-segment acceleration arc renders with drawWithCache"
    - "Two free themes (Slate, Minimalist) load from JSON"
  artifacts:
    - path: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/widgets/speedometer/SpeedometerRenderer.kt"
      provides: "Multi-slot speedometer widget"
      contains: "SpeedSnapshot::class, AccelerationSnapshot::class, SpeedLimitSnapshot::class"
    - path: "android/pack/essentials/src/main/resources/themes/slate.theme.json"
      provides: "Dark free theme"
      contains: "slate"
    - path: "android/pack/essentials/src/main/resources/themes/minimalist.theme.json"
      provides: "Light free theme"
      contains: "minimalist"
  key_links:
    - from: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/widgets/speedometer/SpeedometerRenderer.kt"
      to: "WidgetData.snapshot<SpeedSnapshot>()"
      via: "multi-slot derivedStateOf reads"
      pattern: "derivedStateOf.*snapshot<Speed"
    - from: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/theme/EssentialsThemeProvider.kt"
      to: "themes/slate.theme.json"
      via: "JSON theme loading"
      pattern: "slate.theme.json"
---

<objective>
Implement the Speedometer widget (multi-slot, most complex) and the two free theme JSON files with EssentialsThemeProvider.

Purpose: Speedometer is the architecture validation centerpiece — it proves multi-slot WidgetData works with 3 independent providers. The 12-segment acceleration arc, auto-scaling gauge max, and speed limit warning with NF40 color-blind safety are the most complex rendering in the pack. Themes complete the pack's deliverables.

Output: SpeedometerRenderer with multi-slot wiring, contract test + arc/gauge/warning tests. EssentialsThemeProvider with 2 free themes.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-essentials-pack/08-RESEARCH.md
@.planning/phases/08-essentials-pack/08-01-SUMMARY.md
@android/sdk/contracts/src/testFixtures/kotlin/app/dqxn/android/sdk/contracts/testing/WidgetRendererContractTest.kt
@android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt
@.planning/oldcodebase/packs.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SpeedometerRenderer with multi-slot wiring</name>
  <files>
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/widgets/speedometer/SpeedometerRenderer.kt
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/widgets/SpeedometerRendererTest.kt
  </files>
  <action>
    **SpeedometerRenderer** — port from old codebase, adapted to new architecture:
    - typeId: `essentials:speedometer`, displayName: "Speedometer", defaultSize: 12x12, aspectRatio: 1f
    - `compatibleSnapshots = setOf(SpeedSnapshot::class, AccelerationSnapshot::class, SpeedLimitSnapshot::class)`
    - This is the KEY multi-slot validation — each snapshot read via separate `derivedStateOf`

    **Render() implementation:**
    ```
    val widgetData = LocalWidgetData.current
    val speed by remember { derivedStateOf { widgetData.snapshot<SpeedSnapshot>() } }
    val acceleration by remember { derivedStateOf { widgetData.snapshot<AccelerationSnapshot>() } }
    val speedLimit by remember { derivedStateOf { widgetData.snapshot<SpeedLimitSnapshot>() } }
    ```
    - Each slot read is independent — speed renders immediately even if acceleration/speedLimit haven't emitted
    - Null snapshot = feature not shown (no acceleration arc, no speed limit overlay)

    **Canvas rendering (all via `drawWithCache`):**
    - Main arc: 270-degree sweep arc showing speed. Angle = `(currentSpeed / gaugeMax) * 270f`
    - Auto-scaling gauge max via `computeGaugeMax(speedKph)`: stepped thresholds — 30→60, 60→120, 120→200, 200→300, 300→400. Hysteresis: don't scale down until speed drops 20% below threshold.
    - 12-segment acceleration arc: inner arc divided into 12 segments. Fill count = `(acceleration / maxAcceleration) * 12`. Positive = green segments, negative = red.
    - Speed limit warning overlay: when `currentSpeed > speedLimit + offset`:
      - Amber zone: speed > limit + `speedLimitOffsetKph` (default 5)
      - Red zone: speed > limit + `speedLimitOffsetKph * 2` (default 10)
      - **NF40 color-blind safety:** Amber/red background PLUS pulsing border animation PLUS warning icon (triangle exclamation). Not color alone. Pulsing via `animateFloat` infinite transition (0.6f to 1.0f alpha, 500ms).
    - Tick marks: remembered `Path` objects, drawn at gauge intervals
    - Speed unit conversion: `RegionDetector.detectSpeedUnit()` for AUTO. `speedMps * 3.6f` for kph, `speedMps * 2.23694f` for mph.
    - NF-I2: speed value displayed with locale `NumberFormat`, unit label from string resources

    **Settings schema (9 settings):**
    - `showSpeedArc` (Boolean, default true)
    - `showAccelerationArc` (Boolean, default true)
    - `arcStrokeDp` (IntSetting, min 2, max 12, default 6)
    - `showTickMarks` (Boolean, default true)
    - `speedUnit` (EnumSetting: AUTO/KPH/MPH, default AUTO)
    - `speedLimitOffsetKph` (IntSetting, min 0, max 30, default 5) — amber trigger offset
    - `speedLimitOffsetMph` (IntSetting, min 0, max 20, default 3) — mph equivalent
    - `showWarningBackground` (Boolean, default true)
    - `alertType` (EnumSetting: VISUAL/HAPTIC/BOTH/NONE, default VISUAL)

    **accessibilityDescription:** "Speed: 65 km/h" (with speed limit: "Speed: 65 km/h, Limit: 60 km/h, Over limit")

    **Expose static computation functions for testing:**
    - `computeGaugeMax(speedKph: Float): Float`
    - `computeArcAngle(speedKph: Float, gaugeMax: Float): Float`
    - `computeAccelerationSegments(acceleration: Float, maxAcceleration: Float): Int`

    **SpeedometerRendererTest** — extends `WidgetRendererContractTest` (JUnit4):
    - `createTestWidgetData()`: `WidgetData.Empty.withSlot(SpeedSnapshot::class, ...).withSlot(AccelerationSnapshot::class, ...).withSlot(SpeedLimitSnapshot::class, ...)`
    - Widget-specific tests:
      - `computeGaugeMax(0f)` returns 60f (minimum gauge)
      - `computeGaugeMax(60f)` returns 120f
      - `computeGaugeMax(140f)` returns 200f
      - `computeGaugeMax(250f)` returns 300f
      - `computeArcAngle(0f, 120f)` returns 0f
      - `computeArcAngle(60f, 120f)` returns 135f (half of 270-degree arc)
      - `computeArcAngle(120f, 120f)` returns 270f (full arc)
      - `computeAccelerationSegments(0f, 10f)` returns 0
      - `computeAccelerationSegments(5f, 10f)` returns 6 (half of 12)
      - `computeAccelerationSegments(10f, 10f)` returns 12 (full)
      - accessibilityDescription with SpeedSnapshot(speedMps=16.67f) includes "60" (60 kph)
      - accessibilityDescription with speed over limit includes "Over limit"
      - Multi-slot independence: `WidgetData` with only SpeedSnapshot → accessibilityDescription still works (no crash from null acceleration/speedLimit)
      - aspectRatio is 1f
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:testDebugUnitTest --tests "*.SpeedometerRendererTest" --console=plain 2>&1 | tail -15</automated>
  </verify>
  <done>SpeedometerRenderer passes 14 contract assertions + 13 widget-specific tests. Multi-slot wiring validated: renders with speed-only data without crashing on null acceleration/speedLimit. Gauge max auto-scaling verified at 4 thresholds. Arc angle computation verified. NF40 warning uses color + icon + pulsing border.</done>
</task>

<task type="auto">
  <name>Task 2: EssentialsThemeProvider and free theme JSON files</name>
  <files>
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/theme/EssentialsThemeProvider.kt
    android/pack/essentials/src/main/resources/themes/slate.theme.json
    android/pack/essentials/src/main/resources/themes/minimalist.theme.json
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/theme/EssentialsThemeProviderTest.kt
  </files>
  <action>
    **EssentialsThemeProvider** — provides 2 free bundled themes:
    - Package: `app.dqxn.android.pack.essentials.theme`
    - `@Singleton class EssentialsThemeProvider @Inject constructor()` implementing `ThemeProvider` from `app.dqxn.android.sdk.contracts.theme.ThemeProvider`
    - Interface contract: `val packId: String` (return `"essentials"`), `fun getThemes(): List<ThemeSpec>` (return 2 theme specs)
    - Each theme spec implements `ThemeSpec` (extends `Gated`): `themeId`, `displayName`, `isDark`, `packId`, and `requiredAnyEntitlement` (null = free)
    - Loads theme color/gradient data from `themes/slate.theme.json` and `themes/minimalist.theme.json` in resources
    - Uses `kotlinx.serialization` for JSON parsing
    - Both themes: `requiredAnyEntitlement = null` (free)

    **slate.theme.json** — Dark theme (port from old codebase):
    - Read old theme JSON from `../dqxn.old/android/` if available, otherwise create based on REQUIREMENTS.md theme inventory
    - Dark background, muted foreground, minimal contrast design
    - JSON structure must match `ThemeJsonParser` schema from `:core:design` (Phase 5)
    - Fields: `id`, `name`, `mode` (DARK), `colors` object with 6 color tokens (primary, secondary, background, surface, onBackground, onSurface), `gradients` (background + widget background with type + color stops)

    **minimalist.theme.json** — Light theme:
    - Light background, clean lines, high readability
    - mode: LIGHT
    - Same JSON structure as slate

    **EssentialsThemeProviderTest** (JUnit5):
    - Provider loads exactly 2 themes
    - Slate theme has id "slate", mode DARK
    - Minimalist theme has id "minimalist", mode LIGHT
    - Both themes have null requiredAnyEntitlement (free)
    - Theme JSON files are valid (parse without exception)
    - Both themes have non-null color values for all 6 required tokens
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:testDebugUnitTest --tests "*.EssentialsThemeProviderTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>EssentialsThemeProvider loads 2 themes from JSON resources. Slate (dark) and Minimalist (light) parse correctly with all 6 color tokens and gradient definitions. Both themes are free (null entitlement). Theme JSON files are valid kotlinx.serialization JSON.</done>
</task>

</tasks>

<verification>
1. `./gradlew :pack:essentials:testDebugUnitTest --console=plain` — all Speedometer + theme tests pass
2. Speedometer multi-slot: renders with speed-only data, no crash on null acceleration/speedLimit
3. Gauge max auto-scaling: 4 threshold steps verified
4. NF40: speed limit warning includes icon + pulsing border alongside color
5. Theme JSON files parse correctly, both free, correct modes
</verification>

<success_criteria>
- SpeedometerRenderer passes 14 contract + 13 specific tests
- Multi-slot independence: speed-only WidgetData → no crash, correct accessibility
- computeGaugeMax: 4 thresholds correct
- computeArcAngle: 0 at 0 speed, 135 at half, 270 at full
- NF40: warning visual includes pulsing border + warning icon
- 2 theme JSON files parse, Slate=DARK, Minimalist=LIGHT, both free
</success_criteria>

<output>
After completion, create `.planning/phases/08-essentials-pack/08-07-SUMMARY.md`
</output>
