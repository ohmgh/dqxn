---
phase: 08-essentials-pack
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/pack/essentials/build.gradle.kts
  - android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SpeedSnapshot.kt
  - android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/AccelerationSnapshot.kt
  - android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/BatterySnapshot.kt
  - android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/TimeSnapshot.kt
  - android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/OrientationSnapshot.kt
  - android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/AmbientLightSnapshot.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SolarSnapshot.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SpeedLimitSnapshot.kt
  - android/lint-rules/src/main/kotlin/app/dqxn/android/lint/WidgetScopeBypassDetector.kt
  - android/lint-rules/src/test/kotlin/app/dqxn/android/lint/WidgetScopeBypassDetectorTest.kt
  - android/lint-rules/src/main/kotlin/app/dqxn/android/lint/DqxnIssueRegistry.kt
autonomous: true
requirements:
  - F5.1
  - F5.2
  - F5.3
  - F5.4
  - F5.5
  - F5.6
  - F5.7
  - F5.8
  - F5.9
  - F5.10
  - F5.11

must_haves:
  truths:
    - "All 8 snapshot types compile in their respective modules"
    - "Pack module has play-services-location dependency for solar providers"
    - "WidgetScopeBypass lint rule detects rememberCoroutineScope in widget Render()"
  artifacts:
    - path: "android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SpeedSnapshot.kt"
      provides: "Cross-boundary speed data snapshot"
      contains: "@DashboardSnapshot"
    - path: "android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/TimeSnapshot.kt"
      provides: "Cross-boundary time data snapshot"
      contains: "@DashboardSnapshot"
    - path: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SolarSnapshot.kt"
      provides: "Pack-local solar data snapshot"
      contains: "@DashboardSnapshot"
    - path: "android/lint-rules/src/main/kotlin/app/dqxn/android/lint/WidgetScopeBypassDetector.kt"
      provides: "Lint rule enforcing LocalWidgetScope usage"
      contains: "WidgetScopeBypassDetector"
  key_links:
    - from: "android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SpeedSnapshot.kt"
      to: "app.dqxn.android.sdk.contracts.provider.DataSnapshot"
      via: "implements DataSnapshot interface"
      pattern: ": DataSnapshot"
    - from: "android/lint-rules/src/main/kotlin/app/dqxn/android/lint/DqxnIssueRegistry.kt"
      to: "WidgetScopeBypassDetector"
      via: "registered in issue registry"
      pattern: "WidgetScopeBypassDetector"
---

<objective>
Create all snapshot types and foundation infrastructure for the Essentials pack.

Purpose: Snapshot types are the compile-time dependency for every provider and widget in the pack. The WidgetScopeBypass lint rule enforces widget coroutine isolation from the first renderer onward. This plan unblocks all other Phase 8 plans.

Output: 6 cross-boundary snapshots in `:pack:essentials:snapshots`, 2 pack-local snapshots in `:pack:essentials`, `play-services-location` dependency, and WidgetScopeBypass lint rule with tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-essentials-pack/08-RESEARCH.md
@android/pack/essentials/build.gradle.kts
@android/pack/essentials/snapshots/build.gradle.kts
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/provider/DataSnapshot.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/DashboardSnapshot.kt
@android/lint-rules/src/main/kotlin/app/dqxn/android/lint/DqxnIssueRegistry.kt
@android/lint-rules/src/main/kotlin/app/dqxn/android/lint/ComposeInNonUiModuleDetector.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create all snapshot types and update build config</name>
  <files>
    android/pack/essentials/build.gradle.kts
    android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SpeedSnapshot.kt
    android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/AccelerationSnapshot.kt
    android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/BatterySnapshot.kt
    android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/TimeSnapshot.kt
    android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/OrientationSnapshot.kt
    android/pack/essentials/snapshots/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/AmbientLightSnapshot.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SolarSnapshot.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/snapshots/SpeedLimitSnapshot.kt
  </files>
  <action>
    **Cross-boundary snapshots** in `:pack:essentials:snapshots` (package `app.dqxn.android.pack.essentials.snapshots`). Each has `@DashboardSnapshot(dataType = "...")`, `@Immutable`, implements `DataSnapshot`, all `val` properties, `override val timestamp: Long`:

    1. `SpeedSnapshot(speedMps: Float, accuracy: Float?, timestamp: Long)` — dataType="speed". Speed in m/s, widget handles unit conversion.
    2. `AccelerationSnapshot(acceleration: Float, lateralAcceleration: Float?, timestamp: Long)` — dataType="acceleration". Gravity-removed longitudinal + optional lateral.
    3. `BatterySnapshot(level: Int, isCharging: Boolean, temperature: Float?, timestamp: Long)` — dataType="battery". Level 0-100, temp in Celsius (null if unavailable).
    4. `TimeSnapshot(epochMillis: Long, zoneId: String, timestamp: Long)` — dataType="time". Epoch + IANA zone ID. Widgets extract time/date via java.time.
    5. `OrientationSnapshot(bearing: Float, pitch: Float, roll: Float, timestamp: Long)` — dataType="orientation". Bearing 0-360 degrees, pitch/roll in degrees.
    6. `AmbientLightSnapshot(lux: Float, category: String, timestamp: Long)` — dataType="ambient_light". Category: DARK/DIM/NORMAL/BRIGHT.

    **Pack-local snapshots** in `:pack:essentials` (package `app.dqxn.android.pack.essentials.snapshots`):

    7. `SolarSnapshot(sunriseEpochMillis: Long, sunsetEpochMillis: Long, solarNoonEpochMillis: Long, isDaytime: Boolean, sourceMode: String, timestamp: Long)` — dataType="solar". sourceMode: "location" or "timezone".
    8. `SpeedLimitSnapshot(speedLimitKph: Float, source: String, timestamp: Long)` — dataType="speed_limit". Source: "user" (static user-configured value).

    **Build config** — Update `android/pack/essentials/build.gradle.kts`:
    - Add `implementation(libs.play.services.location)` for SolarLocationDataProvider.
    - Verify `play.services.location` alias exists in `libs.versions.toml`. If missing, add `play-services-location = { group = "com.google.android.gms", name = "play-services-location", version = "21.3.0" }`.

    **Import pattern:** `@Immutable` from `androidx.compose.runtime.Immutable`, `@DashboardSnapshot` from `app.dqxn.android.sdk.contracts.annotation.DashboardSnapshot`, `DataSnapshot` from `app.dqxn.android.sdk.contracts.provider.DataSnapshot`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:snapshots:compileDebugKotlin :pack:essentials:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>All 8 snapshot types compile. SpeedSnapshot, AccelerationSnapshot, BatterySnapshot, TimeSnapshot, OrientationSnapshot, AmbientLightSnapshot in :pack:essentials:snapshots. SolarSnapshot, SpeedLimitSnapshot in :pack:essentials. play-services-location dependency added.</done>
</task>

<task type="auto">
  <name>Task 2: Implement WidgetScopeBypass lint rule with tests</name>
  <files>
    android/lint-rules/src/main/kotlin/app/dqxn/android/lint/WidgetScopeBypassDetector.kt
    android/lint-rules/src/test/kotlin/app/dqxn/android/lint/WidgetScopeBypassDetectorTest.kt
    android/lint-rules/src/main/kotlin/app/dqxn/android/lint/DqxnIssueRegistry.kt
  </files>
  <action>
    Create `WidgetScopeBypassDetector` following the existing lint detector pattern (see `ComposeInNonUiModuleDetector` for reference).

    **Detection targets** — flag coroutine launches inside `@Composable` functions in files under `pack/*/widgets/` that do NOT use `LocalWidgetScope.current`:
    - `rememberCoroutineScope()` usage — fires
    - `GlobalScope.launch {}` — fires
    - Direct `CoroutineScope()` construction — fires
    - `LaunchedEffect` with captured non-widget scope — fires

    **Exemptions:**
    - `LocalWidgetScope.current.launch {}` — does NOT fire
    - `derivedStateOf {}` — does NOT fire (synchronous, no coroutine)
    - Test source sets — does NOT fire
    - `remember {}` without coroutine scope — does NOT fire

    **Implementation approach:**
    - Extend `Detector`, implement `SourceCodeScanner`
    - Override `getApplicableMethodNames()` returning `listOf("rememberCoroutineScope", "launch", "async")`
    - In `visitMethodCall()`, check if call is inside a file path containing `pack/` and `widgets/`
    - For `launch`/`async`, check receiver — if it's `GlobalScope` or constructed `CoroutineScope`, flag. If receiver is from `LocalWidgetScope.current`, allow.
    - For `rememberCoroutineScope`, always flag in widget render context.
    - Issue severity: ERROR, category: CORRECTNESS

    **Register** in `DqxnIssueRegistry` — add `WidgetScopeBypassDetector.ISSUE` to the `issues` list.

    **Tests** in `WidgetScopeBypassDetectorTest` (follow existing test pattern with `TestLintTask.lint()`):
    1. Positive: `rememberCoroutineScope().launch {}` in widget Render() → 1 error
    2. Positive: `GlobalScope.launch {}` in widget Render() → 1 error
    3. Negative: `LocalWidgetScope.current.launch {}` in widget Render() → clean
    4. Negative: `derivedStateOf {}` in widget Render() → clean
    5. Negative: `rememberCoroutineScope()` in non-widget file (feature module) → clean
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :lint-rules:test --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>WidgetScopeBypassDetector fires on rememberCoroutineScope/GlobalScope/CoroutineScope() in widget Render functions. Does NOT fire on LocalWidgetScope.current or test sources. All existing lint tests still pass. Registered in DqxnIssueRegistry.</done>
</task>

</tasks>

<verification>
1. `./gradlew :pack:essentials:snapshots:compileDebugKotlin --console=plain` — all 6 cross-boundary snapshots compile
2. `./gradlew :pack:essentials:compileDebugKotlin --console=plain` — pack-local snapshots + build config compile
3. `./gradlew :lint-rules:test --console=plain` — all lint tests pass including new WidgetScopeBypass tests
4. Each snapshot has `@DashboardSnapshot`, `@Immutable`, implements `DataSnapshot`, only `val` properties
</verification>

<success_criteria>
- 6 cross-boundary snapshot types in `:pack:essentials:snapshots` compile
- 2 pack-local snapshot types in `:pack:essentials` compile
- `play-services-location` dependency added to essentials build.gradle.kts
- WidgetScopeBypass lint rule detects 2 positive cases and passes 3 negative cases
- All existing lint tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-essentials-pack/08-01-SUMMARY.md`
</output>
