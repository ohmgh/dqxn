---
phase: 08-essentials-pack
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/GpsSpeedProvider.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/AccelerometerProvider.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/SpeedLimitProvider.kt
  - android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/CallActionProvider.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/GpsSpeedProviderTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/AccelerometerProviderTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/SpeedLimitProviderTest.kt
  - android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/CallActionProviderTest.kt
autonomous: true
requirements:
  - F5.1
  - F5.7
  - F5.8
  - F5.11
  - NF14
  - NF-P1

must_haves:
  truths:
    - "GpsSpeedProvider emits speed in m/s from GPS LocationManager without storing coordinates"
    - "AccelerometerProvider emits gravity-removed acceleration data"
    - "SpeedLimitProvider emits user-configured static speed limit from ProviderSettingsStore"
    - "CallActionProvider implements ActionableProvider for Shortcuts widget tap action"
  artifacts:
    - path: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/GpsSpeedProvider.kt"
      provides: "Greenfield GPS speed provider"
      contains: "LocationManager.GPS_PROVIDER"
    - path: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/SpeedLimitProvider.kt"
      provides: "Greenfield user-configured speed limit provider"
      contains: "ProviderSettingsStore"
    - path: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/CallActionProvider.kt"
      provides: "Action handler for Shortcuts widget"
      contains: "ActionableProvider"
  key_links:
    - from: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/GpsSpeedProvider.kt"
      to: "SpeedSnapshot"
      via: "emits speed without retaining Location reference"
      pattern: "SpeedSnapshot"
    - from: "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/SpeedLimitProvider.kt"
      to: "ProviderSettingsStore"
      via: "reads settings with namespaced key"
      pattern: "essentials.*speed-limit"
---

<objective>
Implement greenfield data providers (GpsSpeed, Accelerometer, SpeedLimit) and the CallActionProvider.

Purpose: All 4 are greenfield — no old codebase equivalents. GpsSpeedProvider is the primary speed source for the dashboard. SpeedLimitProvider reads user-configured values. AccelerometerProvider feeds the Speedometer acceleration arc. CallActionProvider enables Shortcuts widget tap-to-launch. NF-P1 compliance: no GPS coordinates stored.

Output: 4 providers with contract tests + provider-specific greenfield tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-essentials-pack/08-RESEARCH.md
@.planning/phases/08-essentials-pack/08-01-SUMMARY.md
@android/sdk/contracts/src/testFixtures/kotlin/app/dqxn/android/sdk/contracts/testing/DataProviderContractTest.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/provider/ActionableProvider.kt
@android/data/src/main/kotlin/app/dqxn/android/data/settings/ProviderSettingsStore.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GpsSpeed, Accelerometer, SpeedLimit, and CallAction providers</name>
  <files>
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/GpsSpeedProvider.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/AccelerometerProvider.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/SpeedLimitProvider.kt
    android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/CallActionProvider.kt
  </files>
  <action>
    All providers: package `app.dqxn.android.pack.essentials.providers`. `@Singleton`, `@Inject constructor`.

    **GpsSpeedProvider** — GREENFIELD, requires `ACCESS_FINE_LOCATION`:
    - `@DashboardDataProvider(localId = "gps-speed", displayName = "GPS Speed", description = "...")
    - Implements `DataProvider<SpeedSnapshot>`, priority `HARDWARE`
    - `provideState()`: `callbackFlow` with `LocationManager.requestLocationUpdates(GPS_PROVIDER, 1000L, 0f, listener, Looper.getMainLooper())`
    - Speed extraction: prefer `location.speed` when `location.hasSpeed()` is true. Fallback: compute from consecutive locations (`distance / timeDelta`). Set `accuracy = null` for computed speed.
    - **NF-P1 CRITICAL:** Do NOT retain `Location` references. Extract speed immediately, let Location GC. No coordinate storage. `lastLocation` only held transiently for fallback speed computation, overwritten on each update.
    - `awaitClose { locationManager.removeUpdates(listener) }`
    - `.conflate()` on the flow
    - Handle `SecurityException` in `requestLocationUpdates` — `close(e)` the channel
    - `setupSchema`: one `SetupPageDefinition` with `RuntimePermission(permissions = listOf(Manifest.permission.ACCESS_FINE_LOCATION))`
    - `connectionState`: `MutableStateFlow(false)`, set true on first location, false on provider error
    - subscriberTimeout 5s, firstEmissionTimeout 10s (GPS can be slow to acquire)

    **AccelerometerProvider** — GREENFIELD:
    - `@DashboardDataProvider(localId = "accelerometer", displayName = "Accelerometer", description = "...")`
    - Implements `DataProvider<AccelerationSnapshot>`, priority `DEVICE_SENSOR`
    - Strategy: try `TYPE_LINEAR_ACCELERATION` first (gravity pre-removed by Android). If sensor unavailable, fall back to `TYPE_ACCELEROMETER` with low-pass gravity filter.
    - Low-pass filter: `gravity[i] = alpha * gravity[i] + (1 - alpha) * event.values[i]`, then `linear[i] = event.values[i] - gravity[i]`. Alpha default 0.8.
    - Emit `AccelerationSnapshot(acceleration = linearZ, lateralAcceleration = linearX, timestamp = ...)`
    - **NF14 sensor batching:** `maxReportLatencyUs = 100_000` (100ms for accelerometer — needs responsiveness for speedometer arc)
    - `awaitClose { sensorManager.unregisterListener(listener) }`
    - `.conflate()` on flow

    **SpeedLimitProvider** — GREENFIELD (user-configured static value):
    - `@DashboardDataProvider(localId = "speed-limit", displayName = "Speed Limit", description = "...")`
    - Implements `DataProvider<SpeedLimitSnapshot>`, priority `SIMULATED`
    - `@Inject constructor(private val settingsStore: ProviderSettingsStore)`
    - `provideState()`: `settingsStore.getSetting("essentials", "speed-limit", "value")` mapped to `SpeedLimitSnapshot(speedLimitKph = value?.toFloat() ?: 0f, source = "user", timestamp = ...)`
    - When value is 0 or unset, still emit (let widget decide display behavior)
    - `connectionState` always true, empty `setupSchema`
    - settingsSchema for the provider: `NumberSetting(key = "value", label = "Speed Limit", description = "Set the speed limit in km/h", default = 0f, min = 0f, max = 300f)`

    **CallActionProvider** — port from old, implements `ActionableProvider`:
    - `@DashboardDataProvider(localId = "call-action", displayName = "App Launcher", description = "...")`
    - Implements `ActionableProvider` (which extends `DataProvider<UnitSnapshot>`)
    - `@Inject constructor(@param:ApplicationContext private val context: Context)`
    - `provideState()`: `flowOf(UnitSnapshot(timestamp = SystemClock.elapsedRealtimeNanos()))` — emits once, no data flow
    - `execute(action: WidgetAction, settings: ImmutableMap<String, Any>)`: extract `packageName` from settings, create launch intent via `context.packageManager.getLaunchIntentForPackage()`, start activity with `FLAG_ACTIVITY_NEW_TASK`
    - connectionState always true, no setupSchema
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>All 4 greenfield providers compile. GpsSpeedProvider uses LocationManager.GPS_PROVIDER without storing Location references. AccelerometerProvider has LINEAR_ACCELERATION fallback. SpeedLimitProvider reads from ProviderSettingsStore. CallActionProvider implements ActionableProvider with intent launch.</done>
</task>

<task type="auto">
  <name>Task 2: Greenfield provider contract tests and specific unit tests</name>
  <files>
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/GpsSpeedProviderTest.kt
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/AccelerometerProviderTest.kt
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/SpeedLimitProviderTest.kt
    android/pack/essentials/src/test/kotlin/app/dqxn/android/pack/essentials/providers/CallActionProviderTest.kt
  </files>
  <action>
    **Contract tests** — each extends `DataProviderContractTest` (JUnit5):
    - GpsSpeedProviderTest: mock `LocationManager`, simulate `onLocationChanged` with speed-bearing Location
    - AccelerometerProviderTest: mock `SensorManager`, simulate sensor events
    - SpeedLimitProviderTest: mock `ProviderSettingsStore` with test flow emission
    - CallActionProviderTest: mock `Context` — NOTE: CallActionProvider implements `ActionableProvider` which extends `DataProvider`. Still passes contract tests via `UnitSnapshot` emission.

    **GpsSpeedProvider-specific tests (NF-P1 verification):**
    - Location with `hasSpeed()=true` → emits `speedMps = location.speed`, `accuracy = speedAccuracyMetersPerSecond`
    - Location with `hasSpeed()=false` → computes speed from consecutive locations, `accuracy = null`
    - Verify no `Location` field stored as class member (code review assertion: only transient `lastLocation` for fallback computation, overwritten each update)
    - SecurityException on `requestLocationUpdates` → flow closes, does not crash
    - setupSchema contains RuntimePermission for ACCESS_FINE_LOCATION

    **AccelerometerProvider-specific tests:**
    - TYPE_LINEAR_ACCELERATION available → uses directly (no gravity filter)
    - TYPE_LINEAR_ACCELERATION unavailable → falls back to TYPE_ACCELEROMETER + low-pass
    - Low-pass filter: stationary device (gravity-only) → acceleration near 0.0 after convergence
    - Sensor batching: verify `registerListener` called with `maxReportLatencyUs = 100_000`

    **SpeedLimitProvider-specific tests:**
    - Setting present with value 60 → emits `SpeedLimitSnapshot(speedLimitKph = 60f)`
    - Setting absent → emits `SpeedLimitSnapshot(speedLimitKph = 0f)` (default)
    - Setting changes → new emission with updated value
    - Key format verification: reads from "essentials", "speed-limit", "value" path

    **CallActionProvider-specific tests:**
    - `execute()` with valid package → launches intent with FLAG_ACTIVITY_NEW_TASK
    - `execute()` with unknown package → does not crash (null intent handled)
    - `provideState()` emits UnitSnapshot (single emission)
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :pack:essentials:testDebugUnitTest --tests "*.GpsSpeed*" --tests "*.Accelerometer*" --tests "*.SpeedLimit*" --tests "*.CallAction*" --console=plain 2>&1 | tail -15</automated>
  </verify>
  <done>All 4 greenfield provider contract tests pass. GpsSpeed: speed extraction, fallback computation, no Location retention, SecurityException handling. Accelerometer: sensor fallback, gravity filter, batching. SpeedLimit: settings round-trip, default value. CallAction: intent launch, null package safety.</done>
</task>

</tasks>

<verification>
1. `./gradlew :pack:essentials:testDebugUnitTest --console=plain` — all provider tests pass
2. GpsSpeedProvider: no `Location` retained as a class field (NF-P1)
3. AccelerometerProvider: LINEAR_ACCELERATION preference with fallback
4. SpeedLimitProvider: reads from ProviderSettingsStore with correct key format
5. All providers have `awaitClose` where applicable
</verification>

<success_criteria>
- 4 greenfield providers pass DataProviderContractTest (12 assertions each)
- GpsSpeed: NF-P1 compliance verified — no coordinate storage
- Accelerometer: gravity removal works, sensor batching at 100ms
- SpeedLimit: settings-driven emission, default behavior when unconfigured
- CallAction: ActionableProvider contract met, intent launch works
</success_criteria>

<output>
After completion, create `.planning/phases/08-essentials-pack/08-03-SUMMARY.md`
</output>
