---
phase: 08-essentials-pack
plan: 09
type: execute
wave: 4
depends_on: ["08-08"]
files_modified: []
autonomous: true
requirements:
  - F5.1
  - F5.2
  - F5.3
  - F5.4
  - F5.5
  - F5.6
  - F5.7
  - F5.8
  - F5.9
  - F5.10
  - F5.11

must_haves:
  truths:
    - "On-device add-widget + dump-health shows ACTIVE for all 13 widget types"
    - "60-second stability soak with all 13 widgets does not trigger safe mode"
  artifacts: []
  key_links:
    - from: "adb shell content call --method add-widget"
      to: "AddWidgetHandler"
      via: "Agentic ContentProvider routes to handler"
      pattern: "add-widget"
    - from: "adb shell content call --method dump-health"
      to: "DumpHealthHandler"
      via: "Agentic ContentProvider routes to handler"
      pattern: "dump-health"
---

<objective>
On-device end-to-end wiring verification and stability soak for the Essentials pack.

Purpose: This is the device-dependent half of the Phase 8 gate. 08-08 proved correctness via unit/integration tests. This plan proves the full stack works on a real device: Hilt DI resolves, KSP-generated modules bind, providers emit, widgets render, and the system stays stable under sustained load.

Output: All 13 widgets added via agentic commands, dump-health ACTIVE for each, 60-second soak without safe mode trigger.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-essentials-pack/08-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install debug APK and verify all 13 widgets via agentic commands</name>
  <files><!-- No files modified — on-device verification only --></files>
  <action>
    Build and install the debug APK, then add all 13 widget types and verify wiring via the agentic ContentProvider.

    **Important:** The `AgenticContentProvider` uses a response-file protocol — responses are written to a temp file in cacheDir. The returned Bundle contains `filePath=<path>`. All adb commands must extract the file path and `cat` it to read the actual JSON response.

    Helper function for reading agentic responses. `AgenticContentProvider.parseParams` expects a JSON object string — bare strings are not parsed. The helper passes `arg` through without extra quoting so callers must provide valid JSON when args are needed.
    ```bash
    agentic_call() {
      local method="$1"
      local arg="$2"
      local raw
      if [ -n "$arg" ]; then
        raw=$(adb shell content call --uri content://app.dqxn.android.agentic --method "$method" --arg "$arg")
      else
        raw=$(adb shell content call --uri content://app.dqxn.android.agentic --method "$method")
      fi
      local fpath
      fpath=$(echo "$raw" | sed 's/.*filePath=//;s/[}].*//')
      adb shell cat "$fpath"
    }
    ```

    Steps:
    ```bash
    cd /Users/ohm/Workspace/dqxn/android
    ./gradlew installDebug --console=plain
    adb shell am start -n app.dqxn.android/.MainActivity
    sleep 5

    for typeId in essentials:speedometer essentials:clock essentials:clock-analog essentials:date-simple essentials:date-stack essentials:date-grid essentials:compass essentials:battery essentials:speedlimit-circle essentials:speedlimit-rect essentials:shortcuts essentials:solar essentials:ambient-light; do
      echo "Adding $typeId..."
      agentic_call add-widget "{\"typeId\":\"$typeId\"}"
      sleep 1
    done
    ```

    Parse each response — all 13 must return `"status":"ok"`. No `UNKNOWN_TYPE` errors.

    Verify wiring:
    ```bash
    echo "=== HEALTH CHECK ==="
    agentic_call dump-health

    echo "=== SEMANTICS CHECK ==="
    agentic_call query-semantics '{"testTag":"dashboard_grid"}'
    ```

    Assert:
    - All 13 widgets added successfully (no `"status":"error"` responses, no `UNKNOWN_TYPE` codes)
    - `dump-health` shows ACTIVE for each widget (not ERRORED, not STALE)
    - `query-semantics` returns nodes with `widget_{typeId}` test tags and non-empty `contentDescription`
  </action>
  <verify>
    <automated>adb shell content call --uri content://app.dqxn.android.agentic --method dump-health | sed 's/.*filePath=//;s/[}].*//' | xargs adb shell cat | python3 -c "import sys,json; d=json.load(sys.stdin); widgets=d.get('widgets',[]); active=[w for w in widgets if w.get('status')=='ACTIVE']; print(f'{len(active)}/13 ACTIVE'); sys.exit(0 if len(active)>=13 else 1)"</automated>
  </verify>
  <done>Debug APK installed. All 13 widgets added via add-widget agentic command — no UNKNOWN_TYPE errors. dump-health shows ACTIVE for all 13. query-semantics confirms visible nodes with contentDescription.</done>
</task>

<task type="auto">
  <name>Task 2: 60-second stability soak</name>
  <files><!-- No files modified — on-device verification only --></files>
  <action>
    With all 13 widgets placed from Task 1, run a 60-second stability soak to verify no widget crashes trigger safe mode.

    ```bash
    echo "Starting 60-second stability soak..."
    sleep 60

    echo "=== POST-SOAK HEALTH CHECK ==="
    agentic_call dump-health
    ```

    Assert:
    - Safe mode is NOT active after 60 seconds (no `"safe_mode":true` in health output)
    - No widget shows ERRORED status
    - Widget crash count < 3 for every widget (safe mode threshold is >3 in 60s)
    - GPS-dependent providers (GpsSpeed, SolarLocation) may show DISCONNECTED if no GPS signal — acceptable, not a failure
  </action>
  <verify>
    <automated>adb shell content call --uri content://app.dqxn.android.agentic --method dump-health | sed 's/.*filePath=//;s/[}].*//' | xargs adb shell cat | python3 -c "import sys,json; d=json.load(sys.stdin); safe=d.get('safe_mode',False); errored=[w for w in d.get('widgets',[]) if w.get('status')=='ERRORED']; print(f'safe_mode={safe}, errored={len(errored)}'); sys.exit(0 if not safe and len(errored)==0 else 1)"</automated>
  </verify>
  <done>60-second stability soak complete. Safe mode NOT triggered. No widgets in ERRORED state. Phase 8 on-device gate criteria met.</done>
</task>

</tasks>

<verification>
1. All 13 widgets added via add-widget — no UNKNOWN_TYPE errors
2. dump-health shows ACTIVE for all 13 widget types
3. query-semantics confirms visible nodes with non-empty contentDescription
4. 60-second soak: safe mode NOT active
5. 60-second soak: no ERRORED widgets
</verification>

<success_criteria>
- On-device gate criteria from ROADMAP:
  1. End-to-end wiring: add-widget for all 13 types → dump-health ACTIVE for each → query-semantics non-empty contentDescription
  2. Stability soak: 60-second soak with all 13 widgets — safe mode not triggered, no ERRORED widgets
</success_criteria>

<output>
After completion, create `.planning/phases/08-essentials-pack/08-09-SUMMARY.md`
</output>
