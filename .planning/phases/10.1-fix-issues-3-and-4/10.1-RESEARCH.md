# Phase 10.1 Research: Fix KSP ManifestGenerator + ThemeProvider Hilt Asymmetry

## Issue 3: ManifestGenerator Hardcodes PackCategory.ESSENTIALS

### Root Cause

`ManifestGenerator.kt` line 106: `category = %T.ESSENTIALS` — unconditional for all packs.

**Scope is wider than initially reported.** Five values are hardcoded, not just category:

| Field | Hardcoded Value | Should Be |
|---|---|---|
| `category` (line 106) | `PackCategory.ESSENTIALS` | Derived from pack identity |
| `displayName` (line 61) | Raw packId string | Human-readable name |
| `description` (line 62) | `""` (empty) | Pack description |
| `version` (line 63) | `1` | Pack version |
| `entitlementId` (line 107) | `null` | Entitlement tier |

**Additional findings:**

1. **Test stubs out of sync.** `ContractStubs.kt` defines `PackCategory { ESSENTIALS, PLUS, THEMES, DEMO }` but real enum is `{ ESSENTIALS, PREMIUM, REGIONAL, DEBUG }`.

2. **Generated manifest never injected.** `HiltModuleGenerator` produces `@Binds @IntoSet` for widgets and providers but NOT for the manifest. The manifest is a static `val` on the generated object — never enters the `Set<DashboardPackManifest>` multibinding in `AppModule.kt`. **Dead code at runtime.**

3. **`themes` field always empty.** `ManifestGenerator` line 84: `themes = persistentListOf()` — theme refs never populated even for theme-providing packs.

### Existing Infrastructure

- `dqxn.pack` convention plugin already passes `packId` via `arg("packId", project.name)` at `PackConventionPlugin.kt` line 44
- No `packCategory` KSP arg exists
- `PackCategory` enum: `ESSENTIALS`, `PREMIUM`, `REGIONAL`, `DEBUG`
- `DashboardPackManifest` in `:sdk:contracts` — data class with packId, displayName, description, version, widgets, themes, dataProviders, category, entitlementId

### Fix Design

**Add `packCategory` KSP arg** from convention plugin. Pack identity → category mapping:

| packId | category | entitlementId |
|---|---|---|
| `essentials` | ESSENTIALS | null (free tier) |
| `plus` | PREMIUM | "plus" |
| `themes` | PREMIUM | "themes" |
| `demo` | DEBUG | null |

Convention plugin derives category from a DSL extension or from packId with a default mapping. Processor reads the arg and passes to ManifestGenerator.

**Wire manifest into Hilt.** HiltModuleGenerator should add a `@Provides @IntoSet` method returning the generated manifest object.

**Fix test stubs** to match real `PackCategory` enum values.

---

## Issue 4: ThemeProvider Requires Manual Hilt Module

### Root Cause

KSP handles three annotations:

| Annotation | Handler | Auto Hilt Binding | Multibind Target |
|---|---|---|---|
| `@DashboardWidget` | `WidgetHandler` | Yes — `@Binds @IntoSet` | `Set<WidgetRenderer>` |
| `@DashboardDataProvider` | `DataProviderHandler` | Yes — `@Binds @IntoSet` | `Set<DataProvider<*>>` |
| `@DashboardSnapshot` | `SnapshotHandler` | No (stability config only) | N/A |

**No `@DashboardThemeProvider` annotation exists.** ThemeProvider uses the same `Set<ThemeProvider>` multibinding pattern but requires manual Hilt modules:

- `pack/essentials/.../EssentialsThemeModule.kt` — binds `EssentialsThemeProvider`
- `pack/themes/.../ThemesThemeModule.kt` — binds `ThemesPackThemeProvider`

Both have the comment: `/** Manual Hilt module for theme provider binding. KSP only generates widget/provider bindings. */`

### Why Themes Are Structurally Different

- Widgets: 1 class = 1 widget. `@DashboardWidget` on class → `@Binds @IntoSet WidgetRenderer`.
- Providers: 1 class = 1 provider. `@DashboardDataProvider` on class → `@Binds @IntoSet DataProvider<*>`.
- Themes: 1 class = N themes. `EssentialsThemeProvider.getThemes()` returns 2 themes. `ThemesPackThemeProvider.getThemes()` returns 22. The annotation goes on the **provider class** (factory), not individual theme definitions.

This doesn't block the approach — it just means the annotation describes the provider class, not individual themes. Same as widgets/providers.

### Fix Design

**New `@DashboardThemeProvider` annotation** in `:sdk:contracts`:

```kotlin
@Retention(AnnotationRetention.SOURCE)
@Target(AnnotationTarget.CLASS)
annotation class DashboardThemeProvider
```

No parameters needed — packId already comes from KSP arg. Display name is a runtime concern (`ThemeProvider.packId` field).

**New `ThemeProviderHandler`** in `:codegen:plugin`:
- Scans for `@DashboardThemeProvider`
- Validates class implements `ThemeProvider`
- Produces `ThemeProviderInfo(className, packageName, typeName, originatingFile)`

**Modified `HiltModuleGenerator`:**
- Accept `List<ThemeProviderInfo>` parameter
- Emit `@Binds @IntoSet fun bind{ClassName}(impl: Type): ThemeProvider`

**Modified `ManifestGenerator`:**
- Accept theme provider info
- Populate `themes` field (at minimum flag "has themes") instead of hardcoding `persistentListOf()`

**Delete manual modules:**
- `EssentialsThemeModule.kt` → replaced by generated code
- `ThemesThemeModule.kt` → replaced by generated code

**Add annotation to existing providers:**
- `@DashboardThemeProvider` on `EssentialsThemeProvider`
- `@DashboardThemeProvider` on `ThemesPackThemeProvider`

---

## Dependency Between Issues

Issue 4's ThemeProviderHandler feeds theme provider info into both HiltModuleGenerator (Hilt binding) and ManifestGenerator (theme refs). Issue 3's ManifestGenerator fixes (category, wiring) should be done in the same pass. **Both issues should be in a single plan** — they modify the same KSP files.

## Files to Modify

### Codegen (`:codegen:plugin`)
- `PluginProcessor.kt` — add ThemeProviderHandler invocation, pass theme info to generators
- `HiltModuleGenerator.kt` — accept theme providers, add manifest `@Provides @IntoSet`
- `ManifestGenerator.kt` — accept category arg, populate themes field, remove hardcoded values
- New: `handlers/ThemeProviderHandler.kt`
- New: `model/ThemeProviderInfo.kt`
- `ContractStubs.kt` (test) — fix PackCategory enum, add ThemeProvider/DashboardThemeProvider stubs
- `PluginProcessorTest.kt` — add theme provider tests, update manifest tests

### SDK Contracts (`:sdk:contracts`)
- New: `annotation/DashboardThemeProvider.kt`

### Convention Plugin
- `PackConventionPlugin.kt` — add `packCategory` KSP arg

### Pack Modules
- `pack/essentials/.../EssentialsThemeProvider.kt` — add `@DashboardThemeProvider`
- `pack/essentials/.../EssentialsThemeModule.kt` — DELETE
- `pack/themes/.../ThemesPackThemeProvider.kt` — add `@DashboardThemeProvider`
- `pack/themes/.../ThemesThemeModule.kt` — DELETE

## Test Strategy

All verifiable via compile-testing (kctfork) — no Android runtime needed:
1. `@DashboardThemeProvider` on valid ThemeProvider class → generates Hilt `@Binds @IntoSet` method
2. `@DashboardThemeProvider` on non-ThemeProvider class → KSP error
3. Generated manifest uses correct PackCategory from KSP arg (not hardcoded ESSENTIALS)
4. Generated manifest includes `@Provides @IntoSet` method for Hilt injection
5. Existing widget/provider tests still pass (no regression)
6. Pack module compiles with `@DashboardThemeProvider` annotation and without manual module
