---
phase: 10.1-fix-issues-3-and-4
plan: 01
subsystem: codegen
tags: [ksp, hilt, dagger, kotlinpoet, compile-testing, theme-provider, pack-manifest]

# Dependency graph
requires:
  - phase: 04-ksp-codegen
    provides: KSP processor infrastructure, WidgetHandler/DataProviderHandler patterns, ManifestGenerator/HiltModuleGenerator
provides:
  - "@DashboardThemeProvider annotation for auto-generated ThemeProvider Hilt bindings"
  - "PackCategory KSP arg for per-pack manifest category derivation"
  - "Manifest Hilt injection via @Provides @IntoSet in generated HiltModule"
  - "ThemeProviderHandler in :codegen:plugin for scanning @DashboardThemeProvider"
affects: [11-theme-ui-diagnostics-onboarding, pack-modules]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Companion object @Provides in interface @Module for mixing @Binds and @Provides"
    - "KSP arg-driven code generation (packCategory from convention plugin)"

key-files:
  created:
    - "android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/annotation/DashboardThemeProvider.kt"
    - "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/model/ThemeProviderInfo.kt"
    - "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/handlers/ThemeProviderHandler.kt"
  modified:
    - "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/PluginProcessor.kt"
    - "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/ManifestGenerator.kt"
    - "android/codegen/plugin/src/main/kotlin/app/dqxn/android/codegen/plugin/generation/HiltModuleGenerator.kt"
    - "android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt"
    - "android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/ContractStubs.kt"
    - "android/codegen/plugin/src/test/kotlin/app/dqxn/android/codegen/plugin/PluginProcessorTest.kt"
    - "android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/theme/EssentialsThemeProvider.kt"
    - "android/pack/themes/src/main/kotlin/app/dqxn/android/pack/themes/ThemesPackThemeProvider.kt"

key-decisions:
  - "Companion object with @Provides @IntoSet @JvmStatic inside interface @Module for DashboardPackManifest injection -- Dagger 2.26+ supports companion @Provides in interface modules"
  - "HiltModuleGenerator always runs (even with no widgets/providers/themes) because manifest @Provides is always needed"
  - "HiltModuleGenerator changed from aggregating=false to aggregating=true because it references the aggregated manifest object"
  - "themes = persistentListOf() at codegen time -- individual theme IDs are runtime data from ThemeProvider.getThemes(), served by Set<ThemeProvider> multibinding not manifest"

patterns-established:
  - "KSP arg-driven PackCategory: convention plugin derives category from packId and passes via arg('packCategory', value)"
  - "ThemeProviderHandler follows WidgetHandler/DataProviderHandler pattern for @DashboardThemeProvider scanning"

requirements-completed: []

# Metrics
duration: 6min
completed: 2026-02-25
---

# Phase 10.1 Plan 01: KSP Codegen Fixes Summary

**Fix per-pack PackCategory derivation from KSP arg, wire generated manifest into Hilt multibinding via @Provides @IntoSet, add @DashboardThemeProvider annotation with auto-generated Hilt bindings, delete manual theme modules**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-25T07:48:12Z
- **Completed:** 2026-02-25T07:54:20Z
- **Tasks:** 2
- **Files modified:** 12 (3 created, 7 modified, 2 deleted)

## Accomplishments
- ManifestGenerator reads packCategory from KSP arg instead of hardcoded ESSENTIALS -- convention plugin passes ESSENTIALS/PREMIUM/DEBUG per packId
- Generated DashboardPackManifest injected into Hilt's Set<DashboardPackManifest> via @Provides @IntoSet in the generated HiltModule companion object
- New @DashboardThemeProvider annotation + ThemeProviderHandler produces @Binds @IntoSet ThemeProvider bindings automatically
- Manual EssentialsThemeModule.kt and ThemesThemeModule.kt deleted -- replaced by KSP-generated code
- Test stub PackCategory enum fixed (PREMIUM/REGIONAL/DEBUG not PLUS/THEMES/DEMO)
- 5 new compile-testing tests covering: theme provider Hilt binding, non-ThemeProvider error, packCategory PREMIUM, manifest Hilt injection, packCategory default

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix ManifestGenerator + HiltModuleGenerator + add ThemeProvider codegen + update test infrastructure** - `76577e9` (feat)
2. **Task 2: Add new codegen tests + annotate pack providers + delete manual theme modules** - `98f0db7` (feat)

## Files Created/Modified
- `android/sdk/contracts/.../annotation/DashboardThemeProvider.kt` - New @DashboardThemeProvider annotation (SOURCE retention, CLASS target)
- `android/codegen/plugin/.../model/ThemeProviderInfo.kt` - Data model for scanned theme provider info
- `android/codegen/plugin/.../handlers/ThemeProviderHandler.kt` - KSP handler scanning @DashboardThemeProvider, validates ThemeProvider supertype
- `android/codegen/plugin/.../PluginProcessor.kt` - Added ThemeProviderHandler invocation, packCategory option reading, manifest ClassName computation
- `android/codegen/plugin/.../generation/ManifestGenerator.kt` - Accepts packCategory arg, uses PackCategory.${packCategory} instead of hardcoded ESSENTIALS
- `android/codegen/plugin/.../generation/HiltModuleGenerator.kt` - Added @Binds @IntoSet for ThemeProvider, @Provides @IntoSet for DashboardPackManifest via companion object, changed to aggregating=true
- `android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt` - Added packCategory KSP arg derived from packId (essentials->ESSENTIALS, plus/themes->PREMIUM, demo->DEBUG)
- `android/codegen/plugin/.../ContractStubs.kt` - Fixed PackCategory enum, added ThemeProvider/DashboardThemeProvider/@Provides/PackThemeRef stubs
- `android/codegen/plugin/.../PluginProcessorTest.kt` - Updated compile() helper, fixed existing test assertions, added 5 new tests
- `android/pack/essentials/.../EssentialsThemeProvider.kt` - Added @DashboardThemeProvider annotation
- `android/pack/themes/.../ThemesPackThemeProvider.kt` - Added @DashboardThemeProvider annotation
- `android/pack/essentials/.../EssentialsThemeModule.kt` - DELETED (replaced by generated code)
- `android/pack/themes/.../ThemesThemeModule.kt` - DELETED (replaced by generated code)

## Decisions Made
- Companion object with @Provides @IntoSet @JvmStatic inside interface @Module for DashboardPackManifest injection -- cleanest Dagger pattern for mixing @Binds (abstract) and @Provides (concrete) in same module
- HiltModuleGenerator always runs even with no annotated classes -- manifest @Provides is always needed
- HiltModuleGenerator switched to aggregating=true because it now references the aggregated manifest object
- themes field stays persistentListOf() at codegen time -- theme IDs are runtime data served by Set<ThemeProvider> multibinding

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- KSP codegen infrastructure now complete for all three annotation types: @DashboardWidget, @DashboardDataProvider, @DashboardThemeProvider
- All packs get correct PackCategory in their generated manifests
- Generated manifests are Hilt-injected and available at runtime via Set<DashboardPackManifest>
- Ready for Phase 11 (Theme UI + Diagnostics + Onboarding)

## Self-Check: PASSED

- DashboardThemeProvider.kt: FOUND
- ThemeProviderInfo.kt: FOUND
- ThemeProviderHandler.kt: FOUND
- EssentialsThemeModule.kt: CONFIRMED DELETED
- ThemesThemeModule.kt: CONFIRMED DELETED
- Commit 76577e9: FOUND
- Commit 98f0db7: FOUND

---
*Phase: 10.1-fix-issues-3-and-4*
*Completed: 2026-02-25*
