---
phase: 13-e2e-integration-launch-polish
plan: 07
type: execute
wave: 2
depends_on: [13-05]
files_modified:
  - android/app/src/androidTest/kotlin/app/dqxn/android/e2e/BatterySoakTest.kt
  - android/app/src/androidTest/kotlin/app/dqxn/android/e2e/BackgroundBatterySoakTest.kt
  - android/app/src/test/kotlin/app/dqxn/android/app/performance/SensorUnregistrationTest.kt
autonomous: true
requirements:
  - NF11
  - NF37

must_haves:
  truths:
    - "Screen-on soak with 12 widgets measures battery drain under threshold"
    - "Background soak verifies near-zero drain when app is backgrounded"
    - "All sensor callbackFlow providers properly awaitClose and unregister"
  artifacts:
    - path: "android/app/src/androidTest/kotlin/app/dqxn/android/e2e/BatterySoakTest.kt"
      provides: "Screen-on battery soak measurement"
    - path: "android/app/src/androidTest/kotlin/app/dqxn/android/e2e/BackgroundBatterySoakTest.kt"
      provides: "Background battery drain measurement"
    - path: "android/app/src/test/kotlin/app/dqxn/android/app/performance/SensorUnregistrationTest.kt"
      provides: "Sensor unregistration verification for all callbackFlow providers"
  key_links:
    - from: "BatterySoakTest"
      to: "dumpsys batterystats"
      via: "Shell command delta measurement"
      pattern: "dumpsys batterystats|battery_level"
    - from: "SensorUnregistrationTest"
      to: "callbackFlow providers"
      via: "awaitClose verification"
      pattern: "awaitClose|unregisterListener|removeUpdates"
---

<objective>
Battery drain measurement infrastructure and sensor lifecycle verification.

Purpose: NF11 requires < 5% per hour screen-on battery drain with 12 widgets. NF37 requires near-zero background drain. This plan creates the automated measurement infrastructure using `dumpsys batterystats` delta calculation (soak tests on device) and verifies proper sensor unregistration in callbackFlow providers (unit test).

Output: BatterySoakTest (instrumented, 30-minute soak), BackgroundBatterySoakTest (instrumented), SensorUnregistrationTest (unit test verifying awaitClose patterns).
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-e2e-integration-launch-polish/13-RESEARCH.md
@android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/GpsSpeedProvider.kt
@android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/AccelerometerProvider.kt
@android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/AmbientLightProvider.kt
@android/pack/essentials/src/main/kotlin/app/dqxn/android/pack/essentials/providers/OrientationProvider.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: SensorUnregistrationTest â€” verify callbackFlow awaitClose in all providers</name>
  <files>
    android/app/src/test/kotlin/app/dqxn/android/app/performance/SensorUnregistrationTest.kt
  </files>
  <action>
    1. **SensorUnregistrationTest** (JUnit5):
       - This is a source-code analysis test verifying correct sensor lifecycle management.
       - Parse provider source files and verify every `callbackFlow` block has a matching `awaitClose` that unregisters the sensor/listener.
       - Target files (all providers using callbackFlow):
         - `pack/essentials/src/main/kotlin/.../providers/GpsSpeedProvider.kt`
         - `pack/essentials/src/main/kotlin/.../providers/AccelerometerProvider.kt`
         - `pack/essentials/src/main/kotlin/.../providers/AmbientLightProvider.kt`
         - `pack/essentials/src/main/kotlin/.../providers/OrientationProvider.kt`
         - `pack/essentials/src/main/kotlin/.../providers/BatteryProvider.kt`
       - For each file:
         - Read source as text
         - Count `callbackFlow` occurrences
         - Count `awaitClose` occurrences
         - Assert counts match: every `callbackFlow` must have exactly one `awaitClose`
         - Verify `awaitClose` body contains an unregister call: `unregisterListener`, `removeUpdates`, `removeCallbacks`, or `unregisterReceiver`
       - This ensures no sensor leak on coroutine cancellation (critical for NF37 background drain).
       - Also verify no bare `launch { }` inside `callbackFlow` that could escape cancellation. Pattern: `callbackFlow` body should only use `trySend` and `awaitClose`, not `launch`.
       - NOTE: Use `File("pack/essentials/src/main/kotlin/...")` for path resolution, or iterate over provider source directories.
  </action>
  <verify>
    <automated>cd android && ./gradlew :app:testDebugUnitTest --tests "*.SensorUnregistrationTest" --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>SensorUnregistrationTest verifies all callbackFlow providers have matching awaitClose with sensor unregistration. No sensor leaks possible on coroutine cancellation.</done>
</task>

<task type="auto">
  <name>Task 2: BatterySoakTest + BackgroundBatterySoakTest (instrumented)</name>
  <files>
    android/app/src/androidTest/kotlin/app/dqxn/android/e2e/BatterySoakTest.kt
    android/app/src/androidTest/kotlin/app/dqxn/android/e2e/BackgroundBatterySoakTest.kt
  </files>
  <action>
    1. **BatterySoakTest** (JUnit4 instrumented test, long-running):
       - Uses `AgenticTestClient` from Plan 13-05.
       - `@Test fun screenOnBatterySoak()`:
         - Launch app, wait for ready via `client.send("ping")`
         - Add 12 widgets via `client.send("add-widget", ...)` using a mix of essentials widget types:
           - 2x `essentials:clock-digital`, 2x `essentials:speedometer`, 2x `essentials:battery-info`
           - 2x `essentials:compass`, 2x `essentials:date-simple`, 2x `essentials:ambient-light`
         - Wait for all widgets to be ACTIVE via `dump-health`
         - Record initial battery level: `device.executeShellCommand("dumpsys battery | grep level").trim()` -> extract integer
         - Reset batterystats: `device.executeShellCommand("dumpsys batterystats --reset")`
         - Soak for 30 minutes: `Thread.sleep(30 * 60 * 1000L)` (yes, actual sleep here is intentional for soak)
         - Record final battery level
         - Calculate drain percentage: `(initial - final)`
         - Extrapolate to 1 hour: `drain * 2` (30 min -> 1 hour)
         - Assert `hourlyDrain < 5` (NF11 threshold)
         - NOTE: `@LargeTest` annotation. Battery measurement on emulator is unreliable (virtual battery). This test is designed for real device CI. On emulator, it validates the test infrastructure compiles and runs without crash.
       - Alternative measurement: use `dumpsys batterystats` to get estimated discharge rate rather than level delta if available.

    2. **BackgroundBatterySoakTest** (JUnit4 instrumented test, long-running):
       - `@Test fun backgroundBatterySoak()`:
         - Launch app, wait for ready
         - Press HOME to background the app: `device.pressHome()`
         - Record initial battery level
         - Reset batterystats
         - Soak for 15 minutes: `Thread.sleep(15 * 60 * 1000L)`
         - Record final battery level
         - Calculate drain: should be < 1%/hour with BLE (NF37) or near-zero without
         - Assert `hourlyDrain < 1`
       - `@Test fun sensorUnregistrationOnBackground()`:
         - Launch app with widgets
         - Press HOME to background
         - Wait 5 seconds
         - Check `dumpsys sensorservice` to verify no active sensor registrations from the app PID
         - `device.executeShellCommand("dumpsys sensorservice | grep $packageName")` should show no active connections
         - This validates that `callbackFlow` `awaitClose` properly unregisters sensors when the app is backgrounded

    Both tests: `@LargeTest` annotation only. Do NOT add `@Ignore` -- these are automated tests that run on device/emulator, not manual tests. Per project policy, connected device tests are automated tests.
    PITFALL: Emulator battery is virtual -- on emulator, battery level won't change, so assertion may trivially pass. Meaningful drain numbers require physical device. CI should run these on a physical device when available.
  </action>
  <verify>
    <automated>cd android && ./gradlew :app:compileDebugAndroidTestKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>BatterySoakTest measures 30-min screen-on drain with 12 widgets, extrapolates to hourly rate, asserts < 5%. BackgroundBatterySoakTest measures backgrounded drain and verifies sensor unregistration. Both compile and run on device (no @Ignore). Meaningful battery delta requires physical device in CI.</done>
</task>

</tasks>

<verification>
- `cd android && ./gradlew :app:testDebugUnitTest --tests "*.SensorUnregistrationTest" --console=plain` -- callbackFlow lifecycle test passes
- `cd android && ./gradlew :app:compileDebugAndroidTestKotlin --console=plain` -- soak tests compile
- On physical device (when available): `cd android && ./gradlew :app:connectedDebugAndroidTest --tests "*.BatterySoakTest" --tests "*.BackgroundBatterySoakTest" --console=plain`
</verification>

<success_criteria>
- SensorUnregistrationTest verifies every callbackFlow provider has matching awaitClose with unregistration
- BatterySoakTest infrastructure compiles with 12-widget soak, battery level delta measurement, and < 5%/hr assertion
- BackgroundBatterySoakTest infrastructure compiles with background soak and sensor check
- Unit test passes; instrumented tests compile (device execution deferred to CI)
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-integration-launch-polish/13-07-SUMMARY.md`
</output>
