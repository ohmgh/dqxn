---
phase: 13-e2e-integration-launch-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/gradle/libs.versions.toml
  - android/app/build.gradle.kts
  - android/app/src/main/kotlin/app/dqxn/android/app/lifecycle/AppUpdateCoordinator.kt
  - android/app/src/main/kotlin/app/dqxn/android/app/lifecycle/AppReviewCoordinator.kt
  - android/app/src/main/kotlin/app/dqxn/android/app/di/AppModule.kt
  - android/app/src/main/kotlin/app/dqxn/android/app/MainActivity.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryImpl.kt
  - android/app/src/test/kotlin/app/dqxn/android/app/lifecycle/AppUpdateCoordinatorTest.kt
  - android/app/src/test/kotlin/app/dqxn/android/app/lifecycle/AppReviewCoordinatorTest.kt
autonomous: true
requirements:
  - NF-L2
  - NF-L3

must_haves:
  truths:
    - "AppUpdateCoordinator triggers IMMEDIATE flow for critical updates (priority >= 4)"
    - "AppUpdateCoordinator triggers FLEXIBLE flow for non-critical updates"
    - "AppReviewCoordinator prompts only after 3+ sessions AND customized layout AND no crash"
    - "AppReviewCoordinator enforces 90-day frequency cap"
  artifacts:
    - path: "android/app/src/main/kotlin/app/dqxn/android/app/lifecycle/AppUpdateCoordinator.kt"
      provides: "In-app update trigger logic"
    - path: "android/app/src/main/kotlin/app/dqxn/android/app/lifecycle/AppReviewCoordinator.kt"
      provides: "In-app review trigger logic with gating conditions"
    - path: "android/app/src/test/kotlin/app/dqxn/android/app/lifecycle/AppUpdateCoordinatorTest.kt"
      provides: "FakeAppUpdateManager-based tests"
    - path: "android/app/src/test/kotlin/app/dqxn/android/app/lifecycle/AppReviewCoordinatorTest.kt"
      provides: "FakeReviewManager-based tests"
  key_links:
    - from: "AppUpdateCoordinator"
      to: "AppUpdateManager"
      via: "FakeAppUpdateManager in tests"
      pattern: "FakeAppUpdateManager.*setUpdateAvailable"
    - from: "AppReviewCoordinator"
      to: "UserPreferencesRepository"
      via: "sessionCount + lastReviewPromptTimestamp flows"
      pattern: "sessionCount|lastReviewPrompt"
---

<objective>
Add Google Play In-App Update and In-App Review APIs with full unit test coverage.

Purpose: NF-L2 requires IMMEDIATE updates for critical bugs and FLEXIBLE for features. NF-L3 requires review prompts gated by session count, customization, crash history, and 90-day frequency cap. Both APIs ship with test doubles (FakeAppUpdateManager, FakeReviewManager) making unit testing trivial.

Output: Two coordinator classes in `:app`, version catalog entries for play-app-update-ktx and play-review-ktx, UserPreferencesRepository extensions for review tracking, tests using official fake managers.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-e2e-integration-launch-polish/13-RESEARCH.md
@android/app/build.gradle.kts
@android/gradle/libs.versions.toml
@android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
@android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryImpl.kt
@android/app/src/main/kotlin/app/dqxn/android/app/di/AppModule.kt
@android/app/src/main/kotlin/app/dqxn/android/app/MainActivity.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Version catalog + UserPreferencesRepository extensions + AppUpdateCoordinator + AppReviewCoordinator</name>
  <files>
    android/gradle/libs.versions.toml
    android/app/build.gradle.kts
    android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
    android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryImpl.kt
    android/app/src/main/kotlin/app/dqxn/android/app/lifecycle/AppUpdateCoordinator.kt
    android/app/src/main/kotlin/app/dqxn/android/app/lifecycle/AppReviewCoordinator.kt
    android/app/src/main/kotlin/app/dqxn/android/app/di/AppModule.kt
    android/app/src/main/kotlin/app/dqxn/android/app/MainActivity.kt
  </files>
  <action>
    1. **Version catalog** (`libs.versions.toml`):
       - Add `play-app-update = "2.1.0"` and `play-review = "2.0.1"` to `[versions]`
       - Add `play-app-update-ktx = { group = "com.google.android.play", name = "app-update-ktx", version.ref = "play-app-update" }` to `[libraries]`
       - Add `play-review-ktx = { group = "com.google.android.play", name = "review-ktx", version.ref = "play-review" }` to `[libraries]`

    2. **`:app` build.gradle.kts**: Add `implementation(libs.play.app.update.ktx)` and `implementation(libs.play.review.ktx)`

    3. **UserPreferencesRepository interface**: Add 4 new members:
       - `val sessionCount: Flow<Int>` (defaults to 0)
       - `suspend fun incrementSessionCount()`
       - `val lastReviewPromptTimestamp: Flow<Long>` (defaults to 0L)
       - `suspend fun setLastReviewPromptTimestamp(timestamp: Long)`

    4. **UserPreferencesRepositoryImpl**: Implement the 4 new members using Preferences DataStore keys (`SESSION_COUNT`, `LAST_REVIEW_PROMPT_TIMESTAMP`).

    5. **AppUpdateCoordinator** (`app/lifecycle/`):
       - Constructor: `@Inject constructor(private val appUpdateManager: AppUpdateManager)`
       - `fun checkForUpdate(activity: Activity)`: call `appUpdateManager.appUpdateInfo`, on success check `updateAvailability() == UPDATE_AVAILABLE`. If `updatePriority() >= 4` -> IMMEDIATE, else FLEXIBLE. Start update flow via `startUpdateFlowForResult()`.
       - Handle `InstallStatus.DOWNLOADED` for FLEXIBLE: call `appUpdateManager.completeUpdate()`.
       - No `@Singleton` -- created per Activity lifecycle.

    6. **AppReviewCoordinator** (`app/lifecycle/`):
       - Constructor: `@Inject constructor(private val reviewManager: ReviewManager, private val prefs: UserPreferencesRepository)`
       - `suspend fun maybeRequestReview(activity: Activity)`: Check gating conditions:
         - `prefs.sessionCount.first() >= 3`
         - Layout has been customized (derive from `LayoutRepository` widget count > default preset count, or pass as boolean param `hasCustomizedLayout`)
         - No crash in current session (pass as boolean param `hasCrashedThisSession`)
         - `System.currentTimeMillis() - prefs.lastReviewPromptTimestamp.first() > 90 * 24 * 3600 * 1000L` (or lastTimestamp == 0L for first time)
       - If all conditions met: `reviewManager.requestReviewFlow().await()` then `reviewManager.launchReviewFlow(activity, reviewInfo).await()` then `prefs.setLastReviewPromptTimestamp(System.currentTimeMillis())`
       - Make `timeProvider: () -> Long = System::currentTimeMillis` a constructor param for testability.

    7. **AppModule**: Add `@Provides` for `AppUpdateManager` (via `AppUpdateManagerFactory.create(context)`) and `ReviewManager` (via `ReviewManagerFactory.create(context)`) in `SingletonComponent`.

    8. **MainActivity**: In `onResume()`, call `appUpdateCoordinator.checkForUpdate(this)`. After `setContent` block's LaunchedEffect, call `appReviewCoordinator.maybeRequestReview(this)` passing derived `hasCustomizedLayout` and `hasCrashedThisSession` booleans.

    PITFALL: `FakeAppUpdateManager` requires specific method call ordering (set availability -> check -> start flow -> user action). Structure coordinator to follow this sequence.
    PITFALL: `FakeAppUpdateManager` does NOT trigger `onActivityResult`. Tests check `isImmediateFlowVisible`/`isFlexibleUpdateVisible` instead.
  </action>
  <verify>
    <automated>cd android && ./gradlew :app:compileDebugKotlin :data:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>Version catalog has play-app-update-ktx and play-review-ktx. AppUpdateCoordinator and AppReviewCoordinator compile. UserPreferencesRepository has sessionCount and lastReviewPromptTimestamp flows.</done>
</task>

<task type="auto">
  <name>Task 2: AppUpdateCoordinator and AppReviewCoordinator unit tests</name>
  <files>
    android/app/src/test/kotlin/app/dqxn/android/app/lifecycle/AppUpdateCoordinatorTest.kt
    android/app/src/test/kotlin/app/dqxn/android/app/lifecycle/AppReviewCoordinatorTest.kt
  </files>
  <action>
    1. **AppUpdateCoordinatorTest** (JUnit5 + MockK):
       - Use `FakeAppUpdateManager` from `com.google.android.play.core.appupdate.testing` package.
       - Test: `setUpdateAvailable(2)` with priority >= 4 -> `isImmediateFlowVisible` is true after `checkForUpdate()`
       - Test: `setUpdateAvailable(2)` with priority < 4 -> check FLEXIBLE flow triggered
       - Test: no update available -> neither flow visible
       - Test: `DOWNLOADED` install status -> `completeUpdate()` called
       - NOTE: `FakeAppUpdateManager` constructor takes `Context`. Use `mockk<Context>(relaxed = true)` or ApplicationProvider if using Robolectric. Since this is JUnit5, use `mockk<Context>(relaxed = true)` and verify that `FakeAppUpdateManager` accepts it.
       - If `FakeAppUpdateManager` requires real Context, fall back to MockK-based approach: mock `AppUpdateManager`, mock `Task<AppUpdateInfo>`, use `addOnSuccessListener` capture pattern.

    2. **AppReviewCoordinatorTest** (JUnit5 + MockK):
       - Use `FakeReviewManager` from `com.google.android.play.core.review.testing`.
       - If `FakeReviewManager` requires real Context, mock `ReviewManager` interface instead.
       - Test: 3+ sessions AND customized AND no crash AND no recent review -> review flow triggered, `lastReviewPromptTimestamp` updated
       - Test: < 3 sessions -> review NOT triggered
       - Test: not customized -> review NOT triggered
       - Test: crashed this session -> review NOT triggered
       - Test: last review within 90 days -> review NOT triggered (use injectable `timeProvider` to control current time)
       - Test: first time (lastTimestamp == 0L) + all conditions met -> review triggered

    All tests use `StandardTestDispatcher` + `runTest`. Mock `UserPreferencesRepository` flows with `MutableStateFlow`.
  </action>
  <verify>
    <automated>cd android && ./gradlew :app:testDebugUnitTest --tests "*.AppUpdateCoordinatorTest" --tests "*.AppReviewCoordinatorTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>AppUpdateCoordinator tests cover IMMEDIATE/FLEXIBLE/no-update/complete-download paths. AppReviewCoordinator tests cover all 5 gating conditions plus 90-day cap. All tests pass.</done>
</task>

</tasks>

<verification>
- `cd android && ./gradlew :app:testDebugUnitTest --tests "*.AppUpdateCoordinatorTest" --tests "*.AppReviewCoordinatorTest" --console=plain` -- all tests pass
- `cd android && ./gradlew :data:testDebugUnitTest --console=plain` -- existing UserPreferencesRepository tests still pass
- Version catalog entries resolve: `./gradlew :app:dependencies --configuration debugCompileClasspath --console=plain | grep "play"` shows app-update-ktx and review-ktx
</verification>

<success_criteria>
- play-app-update-ktx 2.1.0 and play-review-ktx 2.0.1 in version catalog and app deps
- AppUpdateCoordinator triggers IMMEDIATE for priority >= 4, FLEXIBLE otherwise
- AppReviewCoordinator enforces all 5 trigger conditions + 90-day cap
- UserPreferencesRepository has sessionCount and lastReviewPromptTimestamp
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-integration-launch-polish/13-01-SUMMARY.md`
</output>
