---
phase: 13-e2e-integration-launch-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/src/test/kotlin/app/dqxn/android/app/accessibility/WcagContrastChecker.kt
  - android/app/src/test/kotlin/app/dqxn/android/app/accessibility/ThemeContrastAuditTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/accessibility/TalkBackAccessibilityTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/accessibility/FontScaleTest.kt
autonomous: true
requirements:
  - NF30
  - NF32
  - NF33

must_haves:
  truths:
    - "All 24 themes (2 free + 22 premium) pass WCAG AA 4.5:1 contrast for primary text against all background gradient stops"
    - "Settings interactive elements have contentDescription for TalkBack"
    - "Settings UI renders without overflow or clipping at system font scale 2.0x"
  artifacts:
    - path: "android/app/src/test/kotlin/app/dqxn/android/app/accessibility/WcagContrastChecker.kt"
      provides: "WCAG 2.1 relative luminance and contrast ratio calculation"
    - path: "android/app/src/test/kotlin/app/dqxn/android/app/accessibility/ThemeContrastAuditTest.kt"
      provides: "Programmatic contrast audit for all 24 themes"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/accessibility/TalkBackAccessibilityTest.kt"
      provides: "Semantics traversal test for settings elements"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/accessibility/FontScaleTest.kt"
      provides: "Font scale rendering verification"
  key_links:
    - from: "ThemeContrastAuditTest"
      to: "DashboardThemeDefinition + theme JSON files"
      via: "Parse all 24 themes and extract color tokens"
      pattern: "contrastRatio.*primaryTextColor"
    - from: "TalkBackAccessibilityTest"
      to: "MainSettings composable"
      via: "Semantics node assertions"
      pattern: "contentDescription|hasClickAction"
---

<objective>
Programmatic WCAG AA contrast audit across all 24 themes, TalkBack semantics verification for settings, and font scale rendering test.

Purpose: NF30 requires WCAG 2.1 AA contrast ratios for critical text. NF32 requires TalkBack support in settings/setup flows. NF33 requires system font scale respected in settings UI. All tests are pure-programmatic with zero manual verification.

Output: WcagContrastChecker utility, contrast audit test covering all 24 themes against all gradient stops, TalkBack semantics test, font scale test.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-e2e-integration-launch-polish/13-RESEARCH.md
@android/sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/theme/DashboardThemeDefinition.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/BuiltInThemes.kt
@android/core/design/src/main/kotlin/app/dqxn/android/core/design/theme/ThemeJsonParser.kt
@android/pack/themes/src/main/resources/themes/arctic.theme.json
@android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettings.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: WcagContrastChecker utility + ThemeContrastAuditTest for all 24 themes</name>
  <files>
    android/app/src/test/kotlin/app/dqxn/android/app/accessibility/WcagContrastChecker.kt
    android/app/src/test/kotlin/app/dqxn/android/app/accessibility/ThemeContrastAuditTest.kt
  </files>
  <action>
    1. **WcagContrastChecker** (test utility object, lives in test source set):
       - `fun Color.relativeLuminance(): Double` -- per WCAG 2.1 spec: linearize each RGB channel, apply 0.2126*R + 0.7152*G + 0.0722*B
       - `fun linearize(channel: Float): Double` -- if c <= 0.04045 then c/12.92 else ((c+0.055)/1.055)^2.4
       - `fun contrastRatio(foreground: Color, background: Color): Double` -- (lighter + 0.05) / (darker + 0.05), range 1.0 to 21.0
       - `fun meetsAA(foreground: Color, background: Color, isLargeText: Boolean = false): Boolean` -- large text >= 3.0, normal text >= 4.5
       - `fun parseHexColor(hex: String): Color` -- parse #RRGGBB and #AARRGGBB format hex strings to Compose Color. Handle both 6 and 8 character hex values.

    2. **ThemeContrastAuditTest** (JUnit5):
       - Load all 24 themes:
         - 2 free themes: `SlateTheme` and `MinimalistTheme` (from `sdk/ui`)
         - 22 premium themes: read JSON files from `pack/themes/src/main/resources/themes/*.theme.json` using `ThemeJsonParser` or by directly parsing the JSON and extracting color values via `parseHexColor()`
       - For each theme, extract: `primaryTextColor`, `secondaryTextColor`, `accentColor`, `errorColor`, `warningColor`, `successColor`
       - For background colors: parse the `backgroundGradient.stops[].color` values (ALL stops, not just first). Also parse `widgetBackgroundGradient.stops[].color`.
       - **Critical contrast pairs to check** (normal text, 4.5:1 threshold):
         - `primaryTextColor` vs each background gradient stop color
         - `primaryTextColor` vs each widget background gradient stop color (alpha-composited over background if semi-transparent)
       - **Large text pairs** (3:1 threshold):
         - `accentColor` vs background gradient stop colors (accent is used for large display values like speed)
       - Use `assertWithMessage("Theme '${theme.themeId}': primaryText vs background stop $i contrast ${ratio}")` for clear failure messages including theme ID, color pair, and actual ratio.
       - PITFALL: Gradient backgrounds have MULTIPLE stops. Check contrast against EVERY stop. The minimum contrast across all stops must meet the threshold.
       - PITFALL: Widget background may be semi-transparent (e.g., `#CCFFFFFF`). Alpha-composite over the darkest/lightest background gradient stop before checking contrast.
       - For alpha compositing: `resultColor = fg * fg.alpha + bg * (1 - fg.alpha)` per channel.
  </action>
  <verify>
    <automated>cd android && ./gradlew :app:testDebugUnitTest --tests "*.ThemeContrastAuditTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>WcagContrastChecker implements WCAG 2.1 relative luminance and contrast ratio. ThemeContrastAuditTest checks all 24 themes against all gradient stops with 4.5:1 for normal text and 3:1 for large text. Any failing theme/color pair produces a specific error message with theme ID and actual ratio.</done>
</task>

<task type="auto">
  <name>Task 2: TalkBack semantics test + font scale rendering test for settings UI</name>
  <files>
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/accessibility/TalkBackAccessibilityTest.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/accessibility/FontScaleTest.kt
  </files>
  <action>
    1. **TalkBackAccessibilityTest** (JUnit4 + `createAndroidComposeRule<ComponentActivity>`):
       - Render `MainSettings` composable with mock callbacks and state.
       - Verify all clickable settings rows have either `contentDescription` or text content (using `onAllNodesWithTag()` + `assertIsDisplayed()` + `assert(hasClickAction())`).
       - Verify no focus traps: all interactive elements are traversable (use `onAllNodes(hasClickAction())` and assert count matches expected number of interactive rows).
       - Verify section headers have text content (not just decorative).
       - Check the "Delete All Data" button has click action and content.
       - Check settings row toggles have `toggleableState` semantics (for TalkBack to announce on/off).

    2. **FontScaleTest** (JUnit4 + `createAndroidComposeRule<ComponentActivity>`):
       - Render `MainSettings` composable at font scale 1.0x -- verify it renders (baseline).
       - Render `MainSettings` composable at font scale 1.5x -- verify all sections still render by checking test tags or text nodes are still displayed.
       - Render `MainSettings` composable at font scale 2.0x -- verify no layout crash and all sections still display. Use `LocalDensity` override: `CompositionLocalProvider(LocalDensity provides Density(density = LocalDensity.current.density, fontScale = 2.0f))`.
       - Assert that at various font scales, key text nodes (`assertIsDisplayed()`) are still rendered. We are checking for no clipping or invisible overflow -- if text nodes still assert as displayed, Compose layout is handling the scaling.
       - NOTE: Dashboard widgets use fixed sizes (NF33 explicitly exempts them). Only test settings UI.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.TalkBackAccessibilityTest" --tests "*.FontScaleTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>TalkBack test verifies all interactive settings elements have semantics content and click actions. Font scale test verifies settings renders without crashes or invisible elements at 1.0x, 1.5x, and 2.0x. All tests pass.</done>
</task>

</tasks>

<verification>
- `cd android && ./gradlew :app:testDebugUnitTest --tests "*.ThemeContrastAuditTest" --console=plain` -- all 24 themes pass
- `cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.TalkBackAccessibilityTest" --tests "*.FontScaleTest" --console=plain` -- accessibility tests pass
</verification>

<success_criteria>
- WcagContrastChecker correctly computes relative luminance and contrast ratio per WCAG 2.1
- All 24 themes pass 4.5:1 contrast for normal text and 3:1 for large text against all gradient stops
- Settings interactive elements verified to have TalkBack semantics
- Settings UI renders without layout issues at 2.0x font scale
- All tests pass with zero manual verification
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-integration-launch-polish/13-03-SUMMARY.md`
</output>
