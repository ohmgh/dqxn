---
phase: 13-e2e-integration-launch-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsTracker.kt
  - android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTracker.kt
  - android/core/firebase/src/test/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTrackerTest.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModelTest.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/privacy/DataExporter.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/privacy/DataExporterTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/privacy/AnalyticsConsentFlowTest.kt
  - android/app/src/main/res/values/strings.xml
autonomous: true
requirements:
  - NF-P3
  - NF-P4
  - NF-P5

must_haves:
  truths:
    - "Analytics consent is required before any tracking event fires"
    - "User can delete all data and the Firebase analytics ID is reset"
    - "DataExporter produces valid JSON containing layout, preferences, paired devices, provider settings, widget styles"
    - "Export JSON is round-trip parseable (export then parse back)"
    - "Privacy policy URL string resource exists"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/privacy/DataExporter.kt"
      provides: "JSON export of all user data"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/privacy/DataExporterTest.kt"
      provides: "Round-trip export test"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/privacy/AnalyticsConsentFlowTest.kt"
      provides: "Consent gate verification — events suppressed before consent, enabled after"
  key_links:
    - from: "MainSettingsViewModel.deleteAllData()"
      to: "AnalyticsTracker.resetAnalyticsData()"
      via: "Invocation after store clears"
      pattern: "resetAnalyticsData"
    - from: "DataExporter"
      to: "All 5 DataStore repositories"
      via: "Constructor injection + .first() collection"
      pattern: "layoutRepository|userPreferencesRepository|providerSettingsStore|pairedDeviceStore|widgetStyleStore"
    - from: "AnalyticsConsentFlowTest"
      to: "AnalyticsTracker.track()"
      via: "Consent state toggle verification"
      pattern: "analyticsConsent|track\\("
---

<objective>
Implement Export My Data (NF-P5), Firebase analytics ID reset (NF-P4), and verify PDPA consent flow (NF-P3).

Purpose: GDPR Article 15 requires user data export. NF-P4 requires Firebase analytics ID reset on data deletion. NF-P3 requires verifying the consent-before-analytics flow and privacy policy URL.

Output: DataExporter class in `:feature:settings`, resetAnalyticsData() interface addition, privacy policy URL string resource, round-trip export test.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-e2e-integration-launch-polish/13-RESEARCH.md
@android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsTracker.kt
@android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTracker.kt
@android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt
@android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
@android/data/src/main/kotlin/app/dqxn/android/data/layout/LayoutRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: AnalyticsTracker.resetAnalyticsData() + DataExporter class + privacy strings</name>
  <files>
    android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsTracker.kt
    android/core/firebase/src/main/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTracker.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModel.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/privacy/DataExporter.kt
    android/app/src/main/res/values/strings.xml
  </files>
  <action>
    1. **AnalyticsTracker interface** (`sdk/analytics`): Add `fun resetAnalyticsData()` method. No-op default in `NoOpAnalyticsTracker`.

    2. **FirebaseAnalyticsTracker** (`core/firebase`): Implement `resetAnalyticsData()` by calling `firebaseAnalytics.resetAnalyticsData()`. This resets the Firebase Analytics ID.

    3. **MainSettingsViewModel.deleteAllData()**: After clearing all stores and disabling analytics, call `analyticsTracker.resetAnalyticsData()`. Order: disable tracker -> clear stores -> reset analytics data.

    4. **DataExporter** (`feature/settings/privacy/`):
       - `@Inject constructor(layoutRepository, userPreferencesRepository, providerSettingsStore, pairedDeviceStore, widgetStyleStore)`
       - `suspend fun exportToJson(): String` -- collects `.first()` from each repository flow, maps to serializable data classes, serializes via `Json.encodeToString()`.
       - Define `@Serializable` data classes:
         - `DataExport(exportTimestamp: Long, appVersion: String, layout: LayoutExport, preferences: PreferencesExport, providerSettings: Map<String, Map<String, String>>, pairedDevices: List<PairedDeviceExport>, widgetStyles: Map<String, Map<String, String>>)`
         - `LayoutExport(profiles: List<ProfileExport>, activeProfileId: String)`
         - `ProfileExport(profileId: String, displayName: String, widgets: List<WidgetExport>)`
         - `WidgetExport(instanceId: String, typeId: String, positionX: Int, positionY: Int, width: Int, height: Int)`
         - `PreferencesExport(autoSwitchMode: String, lightThemeId: String, darkThemeId: String, illuminanceThreshold: Float, keepScreenOn: Boolean, orientationLock: String, showStatusBar: Boolean, analyticsConsent: Boolean)`
         - `PairedDeviceExport(name: String, macAddress: String)`
       - PITFALL: Proto DataStore is binary -- do NOT try to read .proto files directly. Collect via repository interfaces.
       - Use `Json { prettyPrint = true }` for human-readable output.

    5. **strings.xml** (`app/src/main/res/values/`): Add `<string name="privacy_policy_url">https://dqxn.app/privacy</string>` and `<string name="tos_url">https://dqxn.app/terms</string>`. These are placeholder URLs that will be updated before launch.
  </action>
  <verify>
    <automated>cd android && ./gradlew :sdk:analytics:compileDebugKotlin :core:firebase:compileDebugKotlin :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>AnalyticsTracker has resetAnalyticsData(). DataExporter compiles with all 5 repository injections. Privacy/ToS URL string resources exist.</done>
</task>

<task type="auto">
  <name>Task 2: DataExporter round-trip test + Firebase reset test + deleteAllData update test</name>
  <files>
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/privacy/DataExporterTest.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/privacy/AnalyticsConsentFlowTest.kt
    android/core/firebase/src/test/kotlin/app/dqxn/android/core/firebase/FirebaseAnalyticsTrackerTest.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/main/MainSettingsViewModelTest.kt
  </files>
  <action>
    1. **DataExporterTest** (JUnit5 + MockK):
       - Mock all 5 repositories. Configure each mock to return fake data via MutableStateFlow.
       - Test `exportToJson()` produces valid JSON: parse result with `Json.decodeFromString<DataExport>()`.
       - Verify exported JSON contains: at least 1 profile, activeProfileId, widget entries with position/size, preferences with all fields, paired devices, provider settings.
       - Test empty state: no widgets, no paired devices, no provider settings -> still produces valid JSON with empty lists/maps.
       - Test round-trip: export -> parse -> verify all keys present and values match mocked data.

    2. **FirebaseAnalyticsTrackerTest** (existing file): Add test for `resetAnalyticsData()` -- verify it calls `firebaseAnalytics.resetAnalyticsData()`. Follow existing test patterns in this file (MockK verify on firebase instance).

    3. **MainSettingsViewModelTest** (existing file): Update `deleteAllData clears all 6 stores and disables analytics` test to also verify `analyticsTracker.resetAnalyticsData()` is called. The call order should be: disable analytics -> clear stores -> reset analytics data.

    4. **AnalyticsConsentFlowTest** (`feature/settings/src/test/.../privacy/AnalyticsConsentFlowTest.kt`, JUnit5 + MockK):
       - Inject `MockK<AnalyticsTracker>` and `FakeUserPreferencesRepository` (or mock).
       - **Test: events suppressed before consent** — Set `analyticsConsent = false` in preferences. Call the code path that triggers `analyticsTracker.track(...)` (e.g., through `MainSettingsViewModel` or whatever wires consent to tracker). Verify `analyticsTracker.track()` is never called (`verify(exactly = 0) { analyticsTracker.track(any()) }`).
       - **Test: events fire after consent** — Set `analyticsConsent = true`. Trigger same code path. Verify `analyticsTracker.track()` IS called (`verify(atLeast = 1) { analyticsTracker.track(any()) }`).
       - **Test: consent toggle stops events** — Start with consent=true, fire events, toggle to false, verify subsequent track() calls are suppressed.
       - This directly covers NF-P3's behavioral requirement: "consent before analytics."
       - Also verify privacy policy URL string resource exists by checking `R.string.privacy_policy_url` is defined (compile-time verification is sufficient since it's a string resource).
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.DataExporterTest" --tests "*.AnalyticsConsentFlowTest" --tests "*.MainSettingsViewModelTest" :core:firebase:testDebugUnitTest --tests "*.FirebaseAnalyticsTrackerTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>DataExporter round-trip test passes (export -> parse -> values match). Firebase resetAnalyticsData() verified. deleteAllData() now includes analytics reset. AnalyticsConsentFlowTest verifies events are suppressed before consent and fire after.</done>
</task>

</tasks>

<verification>
- `cd android && ./gradlew :feature:settings:testDebugUnitTest --console=plain` -- all settings tests pass (including AnalyticsConsentFlowTest)
- `cd android && ./gradlew :core:firebase:testDebugUnitTest --console=plain` -- firebase tests pass including reset
- `cd android && ./gradlew :sdk:analytics:testDebugUnitTest --console=plain` -- analytics tests pass
</verification>

<success_criteria>
- Analytics events are suppressed before consent and enabled after (AnalyticsConsentFlowTest green)
- AnalyticsTracker.resetAnalyticsData() exists on interface with Firebase and NoOp implementations
- DataExporter.exportToJson() returns valid JSON with all 5 data store contents
- Export JSON survives round-trip (export -> parse -> values intact)
- MainSettingsViewModel.deleteAllData() calls resetAnalyticsData()
- Privacy policy and ToS URL string resources exist
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-integration-launch-polish/13-02-SUMMARY.md`
</output>
