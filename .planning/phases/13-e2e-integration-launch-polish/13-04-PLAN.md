---
phase: 13-e2e-integration-launch-polish
plan: 04
type: execute
wave: 2
depends_on: [13-01, 13-02, 13-05]
files_modified:
  - android/app/src/androidTest/kotlin/app/dqxn/android/e2e/FullJourneyE2ETest.kt
  - android/app/src/test/kotlin/app/dqxn/android/app/legal/ToSDisclaimerTest.kt
  - android/app/src/main/res/values/strings.xml
autonomous: true
requirements:
  - NF-D2

must_haves:
  truths:
    - "Full E2E journey test exercises launch -> bind -> render -> edit -> add/remove -> theme switch -> settings"
    - "ToS string resource contains speed accuracy disclaimer"
  artifacts:
    - path: "android/app/src/androidTest/kotlin/app/dqxn/android/e2e/FullJourneyE2ETest.kt"
      provides: "Full user journey E2E test with semantics verification"
    - path: "android/app/src/test/kotlin/app/dqxn/android/app/legal/ToSDisclaimerTest.kt"
      provides: "ToS speed accuracy disclaimer verification"
  key_links:
    - from: "FullJourneyE2ETest"
      to: "AgenticTestClient (from Plan 13-05)"
      via: "send() + assertion helpers"
      pattern: "client\\.send|assertWidgetRendered"
---

<objective>
Full user journey E2E integration test plus NF-D2 ToS speed accuracy disclaimer.

Purpose: The convergence test -- verifies the entire system works end-to-end: launch, load layout, bind data, render widgets, edit mode, add/remove/resize, theme switch, settings navigation. Uses AgenticTestClient created in Plan 13-05. NF-D2 verifies the ToS contains required speed accuracy disclaimer language.

Output: FullJourneyE2ETest instrumented test, ToS disclaimer unit test, speed disclaimer string resource.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-e2e-integration-launch-polish/13-RESEARCH.md
@.planning/phases/13-e2e-integration-launch-polish/13-05-SUMMARY.md
@.planning/arch/testing.md (AgenticTestClient specification)
@android/app/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: FullJourneyE2ETest using AgenticTestClient from Plan 13-05</name>
  <files>
    android/app/src/androidTest/kotlin/app/dqxn/android/e2e/FullJourneyE2ETest.kt
  </files>
  <action>
    1. **FullJourneyE2ETest** (JUnit4 instrumented test):
       - Import `AgenticTestClient` from `app.dqxn.android.e2e` package (created in Plan 13-05)
       - `@Before`: get `UiDevice` via `UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())`, create `AgenticTestClient(device)`, launch app
       - **Test: full user journey** (`@Test fun fullJourneyE2E()`):
         - **Step 1 - Launch**: Wait for app via `client.send("ping")` -> status ok
         - **Step 2 - Dashboard loads**: `client.send("dump-layout")` -> verify response has profiles, default profile exists
         - **Step 3 - Widgets render**: `client.send("dump-health")` -> verify response (may be empty on fresh install)
         - **Step 4 - Enter edit mode**: `client.send("toggle-edit-mode")` -> verify edit mode active via response
         - **Step 5 - Add widget**: `client.send("add-widget", mapOf("typeId" to "essentials:clock-digital"))` -> get instanceId from response
         - **Step 6 - Widget health**: `client.awaitCondition("dump-health", "data", /* check widget is ACTIVE */, timeoutMs = 5000)`
         - **Step 7 - Verify semantics**: `client.assertWidgetRendered(instanceId)` -- widget has semantics node
         - **Step 8 - Remove widget**: `client.send("remove-widget", mapOf("widgetId" to instanceId))` -> `client.assertWidgetNotRendered(instanceId)`
         - **Step 9 - Exit edit mode**: `client.send("toggle-edit-mode")`
         - **Step 10 - Theme state**: `client.send("dump-state")` -> verify theme info present in response
         - **Step 11 - Settings**: Use UiDevice to find and tap settings button by test tag `settings_button`, verify settings overlay appears
       - PITFALL: E2E tests MUST use debug build variant (AgenticContentProvider only exists in debug).
       - PITFALL: Use `client.awaitCondition()` with poll+timeout, NEVER bare `Thread.sleep`.
       - NOTE: Instrumented test -- compiles for verification, execution requires device/emulator.
  </action>
  <verify>
    <automated>cd android && ./gradlew :app:compileDebugAndroidTestKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>FullJourneyE2ETest compiles with 11-step journey covering launch -> dashboard -> edit mode -> add/remove widget -> theme -> settings. Uses AgenticTestClient from Plan 13-05.</done>
</task>

<task type="auto">
  <name>Task 2: NF-D2 Terms of Service speed accuracy disclaimer</name>
  <files>
    android/app/src/main/res/values/strings.xml
    android/app/src/test/kotlin/app/dqxn/android/app/legal/ToSDisclaimerTest.kt
  </files>
  <action>
    1. **strings.xml** (`app/src/main/res/values/`): Add Terms of Service speed accuracy disclaimer string resource:
       ```xml
       <string name="tos_speed_disclaimer">Speed data displayed by DQXN is derived from GPS and device sensors and is approximate. DQXN is not a certified speedometer. Do not rely on displayed speed for regulatory compliance or safety-critical decisions. The developer disclaims all liability for the accuracy of speed data.</string>
       ```
       If strings.xml was already modified by Plan 13-02 (privacy/ToS URLs), append to existing file.

    2. **ToSDisclaimerTest** (JUnit5, pure unit test -- no Robolectric):
       - Parse `app/src/main/res/values/strings.xml` directly as XML using `javax.xml.parsers.DocumentBuilderFactory`.
       - Find the `<string name="tos_speed_disclaimer">` element.
       - Assert element exists (not null).
       - Assert text content contains key phrases:
         - "approximate"
         - "not a certified speedometer" (or "not.*certified.*speedometer")
         - "disclaims" or "disclaimer"
         - "liability"
         - "speed"
       - This ensures the disclaimer text cannot be accidentally emptied or stripped without breaking the build.
       - Path resolution: use `File("src/main/res/values/strings.xml")` relative to project dir, or `System.getProperty("user.dir")` + path.
  </action>
  <verify>
    <automated>cd android && ./gradlew :app:testDebugUnitTest --tests "*.ToSDisclaimerTest" --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>ToS speed accuracy disclaimer string resource exists with required legal language. Unit test verifies the string contains key phrases (approximate, not certified, disclaims, liability, speed).</done>
</task>

</tasks>

<verification>
- `cd android && ./gradlew :app:compileDebugAndroidTestKotlin --console=plain` -- E2E test compiles
- `cd android && ./gradlew :app:testDebugUnitTest --tests "*.ToSDisclaimerTest" --console=plain` -- disclaimer test passes
- On device (when available): `cd android && ./gradlew :app:connectedDebugAndroidTest --tests "*.FullJourneyE2ETest" --console=plain`
</verification>

<success_criteria>
- FullJourneyE2ETest exercises launch -> bind -> render -> edit -> add/remove -> theme -> settings using AgenticTestClient
- ToS string resource contains speed accuracy disclaimer with key legal phrases
- All compilable tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-integration-launch-polish/13-04-SUMMARY.md`
</output>
