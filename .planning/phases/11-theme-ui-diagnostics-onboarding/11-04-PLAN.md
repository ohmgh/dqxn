---
phase: 11-theme-ui-diagnostics-onboarding
plan: 04
type: execute
wave: 2
depends_on: ["11-02"]
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinator.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/di/DashboardModule.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/ProviderStatusBridgeTest.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/NavigationCoordinator.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/session/SessionEventEmissionTest.kt
autonomous: true
requirements:
  - F3.13
  - F13.3

must_haves:
  truths:
    - "ProviderStatusProvider is implemented and installed in Hilt graph"
    - "Provider statuses include providerId, displayName, isConnected, lastUpdateTimestamp"
    - "Diagnostics module can inject ProviderStatusProvider without depending on :feature:dashboard"
    - "Dashboard grid emits TAP, MOVE, RESIZE events to SessionEventEmitter"
    - "NavigationCoordinator emits NAVIGATE events to SessionEventEmitter"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinator.kt"
      provides: "ProviderStatusProvider implementation via WidgetBindingCoordinator"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/di/DashboardModule.kt"
      provides: "Hilt binding for ProviderStatusProvider"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/session/SessionEventEmissionTest.kt"
      provides: "Tests verifying session event emission from dashboard interactions"
  key_links:
    - from: "DashboardModule.kt"
      to: "ProviderStatusProvider interface"
      via: "@Binds Hilt binding"
      pattern: "@Binds.*ProviderStatusProvider"
    - from: "DashboardGrid.kt"
      to: "SessionEventEmitter"
      via: "record() calls on tap/move/resize"
      pattern: "sessionEventEmitter\\.record"
    - from: "NavigationCoordinator.kt"
      to: "SessionEventEmitter"
      via: "record() calls on route navigation"
      pattern: "sessionEventEmitter\\.record"
---

<objective>
Implement ProviderStatusProvider in `:feature:dashboard`, bind it in the Hilt graph, and wire SessionEventEmitter call sites so dashboard interactions (tap, move, resize, navigate) are recorded for F13.3.

Purpose: ProviderStatusProvider bridges diagnostics to dashboard provider health. SessionEventEmitter (from `:sdk:observability`, created in Plan 11-02) lets dashboard record user interactions without depending on `:feature:diagnostics`. Both follow the same interface-in-sdk, impl-in-feature pattern.

Output: ProviderStatusProvider bound in Hilt, SessionEventEmitter wired at 4+ interaction points, both tested.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-02-SUMMARY.md
@android/sdk/observability/src/main/kotlin/app/dqxn/android/sdk/observability/health/ProviderStatusProvider.kt
@android/sdk/observability/src/main/kotlin/app/dqxn/android/sdk/observability/session/SessionEventEmitter.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinator.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: ProviderStatusProvider implementation + Hilt binding + test</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/WidgetBindingCoordinator.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/di/DashboardModule.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/ProviderStatusBridgeTest.kt
  </files>
  <action>
    1. Make `WidgetBindingCoordinator` implement `ProviderStatusProvider`:
       - Add `: ProviderStatusProvider` to class declaration
       - Implement `providerStatuses(): Flow<Map<String, ProviderStatus>>` that maps the coordinator's internal provider tracking state to `ProviderStatus` objects
       - The coordinator already tracks provider states (connection, errors, timestamps) internally. Map those to the ProviderStatus data class from `:sdk:observability`
       - If the coordinator doesn't have a suitable internal flow, create a `_providerStatuses: MutableStateFlow<Map<String, ProviderStatus>>` and update it when provider states change (on bind, on error, on data emission)
       - Each ProviderStatus should include: providerId (from DataProvider.providerId), displayName (from DataProviderSpec), isConnected (from binding state), lastUpdateTimestamp (from last emission), errorDescription (from last error if any)

    2. Add Hilt binding in `DashboardModule.kt`:
       ```kotlin
       @Binds
       abstract fun bindProviderStatusProvider(
           impl: WidgetBindingCoordinator
       ): ProviderStatusProvider
       ```

       Note: WidgetBindingCoordinator's scoping must match. If it's `@ViewModelScoped` or not scoped, you may need to adjust. If it's already `@Inject` constructor, verify the binding is compatible. If WidgetBindingCoordinator isn't directly bindable (e.g., it's created by another coordinator), create a thin `ProviderStatusBridge` class that delegates to the coordinator and is `@Singleton` or `@ViewModelScoped`.

    3. Create `ProviderStatusBridgeTest.kt` with JUnit5 + MockK + Turbine:
       - `providerStatuses emits empty map initially` — no providers bound → empty map
       - `providerStatuses reflects bound provider` — after binding a provider, map contains its status with correct providerId and displayName
       - `provider error updates status description` — after a provider error, the errorDescription field is populated
       - `disconnected provider shows isConnected false` — provider that stops emitting shows isConnected=false in status

    Read the actual WidgetBindingCoordinator source carefully to understand its internal state tracking before implementing. The implementation must derive statuses from existing data flows, not duplicate tracking.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.ProviderStatusBridgeTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>WidgetBindingCoordinator implements ProviderStatusProvider, Hilt binding resolves, 4 status tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Wire SessionEventEmitter call sites in :feature:dashboard</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/NavigationCoordinator.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/session/SessionEventEmissionTest.kt
  </files>
  <action>
    Wire `SessionEventEmitter.record()` calls at dashboard interaction points. The `SessionEventEmitter` interface is in `:sdk:observability` (created in Plan 11-02), so `:feature:dashboard` can inject it without any new module dependency.

    1. **DashboardGrid.kt** — inject or pass `SessionEventEmitter` and add recording calls:
       - On widget tap (existing gesture handler): `sessionEventEmitter.record(SessionEvent(System.currentTimeMillis(), EventType.TAP, "widgetId=$widgetId"))`
       - On widget move completion (drag end): `sessionEventEmitter.record(SessionEvent(System.currentTimeMillis(), EventType.MOVE, "widgetId=$widgetId, from=($fromX,$fromY), to=($toX,$toY)"))`
       - On widget resize completion: `sessionEventEmitter.record(SessionEvent(System.currentTimeMillis(), EventType.RESIZE, "widgetId=$widgetId, newSize=${w}x${h}"))`

       The emitter should be injected into the ViewModel or coordinator that handles these gestures, NOT into the composable directly. Pass it through the existing gesture callback lambdas or inject into the coordinator/ViewModel that DashboardGrid already uses.

    2. **NavigationCoordinator.kt** — inject `SessionEventEmitter` and add:
       - On overlay navigation: `sessionEventEmitter.record(SessionEvent(System.currentTimeMillis(), EventType.NAVIGATE, "route=$routeName"))`
       - On edit mode toggle: `sessionEventEmitter.record(SessionEvent(System.currentTimeMillis(), EventType.EDIT_MODE_ENTER/EXIT, ""))`

       Read the actual NavigationCoordinator source to identify the correct injection point and existing navigation callbacks. If NavigationCoordinator doesn't exist as a separate class, wire into whatever coordinator manages overlay navigation (likely DashboardViewModel or a similar orchestrator).

    3. **SessionEventEmissionTest.kt** — verify the wiring:
       - `widget tap emits TAP event` — mock SessionEventEmitter, simulate tap, verify record() called with EventType.TAP and widgetId in details
       - `widget move emits MOVE event` — simulate drag completion, verify MOVE event with coordinates
       - `widget resize emits RESIZE event` — simulate resize, verify RESIZE event with dimensions
       - `navigation emits NAVIGATE event` — simulate route navigation, verify NAVIGATE event with route name

       Use MockK to mock `SessionEventEmitter`. Test at the coordinator/ViewModel level, not the composable level, to avoid compose test overhead.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.SessionEventEmissionTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>SessionEventEmitter wired at 4+ interaction points in :feature:dashboard, all 4 emission tests pass</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.ProviderStatusBridgeTest" --tests "*.SessionEventEmissionTest" --console=plain
</verification>

<success_criteria>
- ProviderStatusProvider implemented in `:feature:dashboard` without cross-module dependency violations
- Hilt binding compiles (no MissingBinding at DI assembly)
- SessionEventEmitter.record() called on widget tap, move, resize, and navigation
- No `:feature:dashboard` → `:feature:diagnostics` dependency (only `:sdk:observability` used)
- 8+ tests pass (4 provider status + 4 session event emission)
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-04-SUMMARY.md`
</output>
