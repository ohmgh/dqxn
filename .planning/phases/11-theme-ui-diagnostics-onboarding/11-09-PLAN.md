---
phase: 11-theme-ui-diagnostics-onboarding
plan: 09
type: execute
wave: 4
depends_on: ["11-05", "11-06", "11-07", "11-08"]
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/NfD1Disclaimer.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostRouteTest.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/preset/PresetLoaderTest.kt
autonomous: true
requirements:
  - F4.6
  - F4.10
  - F11.5
  - F11.7
  - NF-D1

must_haves:
  truths:
    - "All 7 OverlayNavHost routes are populated and navigate correctly"
    - "ThemeSelector route uses Preview overlay type with caller-managed preview"
    - "Diagnostics route uses Hub overlay type"
    - "Onboarding route uses Hub overlay type"
    - "Speed disclaimer string resource exists on widget info page (NF-D1)"
    - "Source-varying transitions: ThemeSelector popEnter uses fadeIn(150ms) not previewEnter"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt"
      provides: "All 7 routes populated with correct transitions"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostRouteTest.kt"
      provides: "Route navigation integration tests"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/NfD1Disclaimer.kt"
      provides: "Speed disclaimer for widget info page (NF-D1)"
  key_links:
    - from: "OverlayNavHost.kt"
      to: "ThemeSelector (Plan 11-05)"
      via: "composable route with previewEnter/previewExit transitions"
      pattern: "composable.*theme_selector"
    - from: "OverlayNavHost.kt"
      to: "Diagnostics (Plan 11-07)"
      via: "composable route with hubEnter/hubExit transitions"
      pattern: "composable.*diagnostics"
    - from: "OverlayNavHost.kt"
      to: "FirstRunFlow (Plan 11-08)"
      via: "composable route with hubEnter/hubExit transitions"
      pattern: "composable.*onboarding"
    - from: "DashboardScreen.kt"
      to: "OnboardingViewModel"
      via: "first-run check on launch"
      pattern: "hasCompletedOnboarding"
---

<objective>
Wire all 7 OverlayNavHost routes, add source-varying transitions per replication advisory, integrate first-run onboarding check into DashboardScreen, and add NF-D1 speed disclaimer.

Purpose: This is the integration plan that connects all three feature clusters to the dashboard shell. Source-varying transitions are critical for visual polish (replication advisory section 4). The first-run check ensures onboarding appears exactly once.

Output: Complete OverlayNavHost with all 7 routes + integration tests + NF-D1 disclaimer.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@.planning/migration/replication-advisory.md
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-05-SUMMARY.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-07-SUMMARY.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: OverlayNavHost 7-route wiring + source-varying transitions</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/NfD1Disclaimer.kt
  </files>
  <action>
    1. **OverlayNavHost route wiring** — add 3 new routes to existing OverlayNavHost:

    Route table (all 7):
    | Route | Type | Enter | Exit | popEnter | popExit |
    |-------|------|-------|------|----------|---------|
    | empty | N/A | None | None | None | None |
    | widget_picker | Hub | hubEnter | hubExit | hubEnter | hubExit |
    | settings | Preview* | previewEnter | *source-varying | *source-varying | previewExit |
    | widget_settings/{id} | Preview | previewEnter | None | None | previewExit |
    | setup/{id} | Hub | hubEnter | hubExit | hubEnter | hubExit |
    | **theme_selector** | Preview | previewEnter | previewExit | **fadeIn(150ms)** | previewExit |
    | **diagnostics** | Hub | hubEnter | hubExit | hubEnter | hubExit |
    | **onboarding** | Hub | hubEnter | hubExit | hubEnter | hubExit |

    **CRITICAL from replication advisory section 4:** ThemeSelector popEnter MUST use `fadeIn(150ms)` — NOT previewEnter. This prevents double-slide when returning from a theme sub-screen.

    **Settings source-varying transitions:**
    - Exit to theme_selector: `fadeOut(100ms)` (not full previewExit)
    - popEnter from theme_selector: `fadeIn(150ms)` (not previewEnter)
    - Exit to diagnostics/onboarding (hub routes): `ExitTransition.None`
    - popEnter from diagnostics/onboarding: `EnterTransition.None`

    Implementation: Use `targetState.destination.hasRoute<Route>()` in transition lambdas per research pattern.

    2. **Route class definitions**: Add sealed route classes for the 3 new routes:
    ```kotlin
    @Serializable object ThemeSelectorRoute
    @Serializable object DiagnosticsRoute
    @Serializable object OnboardingRoute
    ```

    3. **NfD1Disclaimer** — speed disclaimer string resource and composable:
    - Add string resource `speed_disclaimer` to `feature/settings/src/main/res/values/strings.xml`:
      "Speed and speed limit data are approximate. Always refer to your vehicle speedometer and posted signs."
    - Create small composable `NfD1Disclaimer` that renders this text in Info style (reusable from WidgetInfoContent)
    - This composable is used by WidgetInfoContent for speed-related widgets

    4. **Caller-managed preview for ThemeSelector route:**
    The Settings composable MUST set preview theme BEFORE navigating to ThemeSelector:
    ```kotlin
    onNavigateToThemeSelector = {
        themeState.darkTheme?.let { viewModel.handlePreviewTheme(it) }
        navController.navigate(ThemeSelectorRoute)
    }
    ```
    And clear preview in Settings `LaunchedEffect(Unit)`:
    ```kotlin
    LaunchedEffect(Unit) { viewModel.handlePreviewTheme(null) }
    ```
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>All 7 OverlayNavHost routes populated with correct transitions, NF-D1 disclaimer composable created, caller-managed preview wired for ThemeSelector</done>
</task>

<task type="auto">
  <name>Task 2: DashboardScreen first-run integration + route tests</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostRouteTest.kt
    android/data/src/test/kotlin/app/dqxn/android/data/preset/PresetLoaderTest.kt
  </files>
  <action>
    1. **DashboardScreen first-run integration:**
    - Add `hasCompletedOnboarding: Boolean` to DashboardScreen parameters (from DashboardViewModel which observes UserPreferencesRepository)
    - In a `LaunchedEffect(hasCompletedOnboarding)`:
      ```kotlin
      if (!hasCompletedOnboarding) {
          navController.navigate(OnboardingRoute) {
              launchSingleTop = true
          }
      }
      ```
    - This navigates to onboarding on first launch only. After completion, the flag prevents re-navigation.

    2. **F11.5 default preset validation:**
    - Read `PresetLoaderTest` in `:data` and UNCONDITIONALLY add an assertion verifying the default preset excludes GPS-dependent widgets. Steps: (1) read PresetLoaderTest source, (2) add test `default preset excludes GPS-dependent widgets` asserting typeIds do NOT contain "essentials:speedometer", "essentials:speed-limit-circle", "essentials:speed-limit-rect" — only non-GPS widgets like "essentials:clock-digital", "essentials:battery", "essentials:date-simple", (3) run the test. Do NOT skip this step regardless of what already exists in the test file.

    3. **OverlayNavHostRouteTest** (integration test):
    - `all 7 routes compile and have distinct paths` — verify route constants are unique
    - `theme_selector route uses preview transitions` — verify enter transition is previewEnter
    - `diagnostics route uses hub transitions` — verify enter transition is hubEnter
    - `onboarding route uses hub transitions` — verify enter transition is hubEnter
    - `settings exit to theme_selector uses fadeOut` — test source-varying transition
    - `theme_selector popEnter uses fadeIn not previewEnter` — verify the CRITICAL transition override

    For transition testing: create a test composable that navigates between routes and verifies that the animated visibility state changes correctly. Alternatively, test the route configuration programmatically if Navigation Compose exposes transition specs.

    If programmatic transition inspection isn't feasible, verify at minimum:
    - Route definitions exist (no crash on navigate)
    - Back navigation works for all routes
    - First-run flow triggers on hasCompletedOnboarding=false
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.OverlayNavHostRouteTest" :data:testDebugUnitTest --tests "*.PresetLoaderTest" --console=plain 2>&1 | tail -30</automated>
  </verify>
  <done>DashboardScreen navigates to onboarding on first run, all 7 routes verified via integration test, source-varying transitions configured, PresetLoaderTest GPS-exclusion assertion passes</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.OverlayNavHostRouteTest" --console=plain
</verification>

<success_criteria>
- All 7 OverlayNavHost routes populated and navigable
- Source-varying transitions per replication advisory (ThemeSelector popEnter = fadeIn(150ms))
- First-run check navigates to onboarding exactly once
- NF-D1 speed disclaimer composable exists
- 6+ route tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-09-SUMMARY.md`
</output>
