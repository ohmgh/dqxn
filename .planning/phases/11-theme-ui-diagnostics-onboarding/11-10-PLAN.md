---
phase: 11-theme-ui-diagnostics-onboarding
plan: 10
type: execute
wave: 5
depends_on: ["11-05", "11-06", "11-07", "11-08", "11-09"]
files_modified:
  - android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsEventCallSites.kt
  - android/sdk/analytics/src/test/kotlin/app/dqxn/android/sdk/analytics/AnalyticsEventCallSiteTest.kt
  - android/app/src/main/kotlin/app/dqxn/android/app/SessionLifecycleTracker.kt
  - android/app/src/test/kotlin/app/dqxn/android/app/SessionLifecycleTrackerTest.kt
autonomous: true
requirements:
  - F12.2
  - F12.3
  - F12.4
  - F12.6
  - F12.7

must_haves:
  truths:
    - "widget_add, theme_change, upsell_impression events fire with correct parameters"
    - "upsell_impression includes trigger_source parameter (F12.6)"
    - "session_end includes jank%, thermal, failures, errors (F12.7)"
    - "All events suppressed when analytics consent is false"
    - "No PII in any analytics event (F12.4)"
  artifacts:
    - path: "android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsEventCallSites.kt"
      provides: "Helper functions for firing analytics events at interaction points"
    - path: "android/sdk/analytics/src/test/kotlin/app/dqxn/android/sdk/analytics/AnalyticsEventCallSiteTest.kt"
      provides: "Tests verifying event parameter completeness and consent gating"
    - path: "android/app/src/main/kotlin/app/dqxn/android/app/SessionLifecycleTracker.kt"
      provides: "Session start/end event firing with quality metrics"
    - path: "android/app/src/test/kotlin/app/dqxn/android/app/SessionLifecycleTrackerTest.kt"
      provides: "Session lifecycle event tests"
  key_links:
    - from: "AnalyticsEventCallSites.kt"
      to: "AnalyticsTracker"
      via: "track() calls gated on internal consent check"
      pattern: "analyticsTracker\\.track"
    - from: "SessionLifecycleTracker.kt"
      to: "MetricsCollector"
      via: "snapshot for session quality metrics"
      pattern: "metricsCollector"
---

<objective>
Wire analytics event call sites at overlay interaction points and implement session lifecycle tracking with quality metrics.

Purpose: F12.2-F12.7 require specific analytics events at specific interaction points. All gated on consent (F12.5 from Plan 11-08). Session quality metrics (F12.7) capture jank%, thermal, failures, errors at session end. No PII (F12.4).

Output: Analytics helper functions + session tracker with comprehensive tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsTracker.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analytics event call site helpers + tests</name>
  <files>
    android/sdk/analytics/src/main/kotlin/app/dqxn/android/sdk/analytics/AnalyticsEventCallSites.kt
    android/sdk/analytics/src/test/kotlin/app/dqxn/android/sdk/analytics/AnalyticsEventCallSiteTest.kt
  </files>
  <action>
    Create `AnalyticsEventCallSites.kt` — helper extension functions on `AnalyticsTracker`:

    ```kotlin
    // F12.2: Key funnel events
    fun AnalyticsTracker.trackWidgetAdd(typeId: String, packId: String) {
        track(AnalyticsEvent.WidgetAdded(typeId = typeId, packId = packId))
    }

    fun AnalyticsTracker.trackThemeChange(themeId: String, isDark: Boolean) {
        track(AnalyticsEvent.ThemeChanged(themeId = themeId, isDark = isDark))
    }

    // F12.6: Upsell with trigger_source
    fun AnalyticsTracker.trackUpsellImpression(trigger: String) {
        track(AnalyticsEvent.UpsellImpression(trigger = trigger))
    }

    // Trigger sources: "theme_preview", "widget_picker", "settings"
    object UpsellTrigger {
        const val THEME_PREVIEW = "theme_preview"
        const val WIDGET_PICKER = "widget_picker"
        const val SETTINGS = "settings"
    }
    ```

    All calls go through `AnalyticsTracker.track()` which already gates on consent internally via `isEnabled()`. No additional consent checks needed at call sites.

    Create `AnalyticsEventCallSiteTest.kt` with JUnit5 + MockK:
    1. `trackWidgetAdd fires WidgetAdded event` — verify tracker.track called with correct event type + params
    2. `trackThemeChange fires ThemeChanged event` — verify themeId and isDark params
    3. `trackUpsellImpression includes trigger source` — verify trigger param matches input
    4. `events suppressed when consent is false` — create an AnalyticsTracker instance (or use the real implementation, not NoOp) with consent disabled. Call the helper extension functions (trackWidgetAdd, trackThemeChange, trackUpsellImpression). Verify NO events are dispatched to the underlying sink. This tests the actual consent gating behavior, not just mock interaction. If the real AnalyticsTracker isn't directly testable, mock `isEnabled()` to return false and verify `track()` is never called on the underlying dispatcher.
    5. `no PII in event parameters` — verify event constructors don't accept email, name, phone, etc. (structural test — ensure event data classes only contain non-PII fields)
    6. `UpsellTrigger constants are distinct` — verify THEME_PREVIEW, WIDGET_PICKER, SETTINGS are unique strings
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :sdk:analytics:testDebugUnitTest --tests "*.AnalyticsEventCallSiteTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>Analytics helper functions fire correct events with correct parameters, consent gating verified, 6 tests pass</done>
</task>

<task type="auto">
  <name>Task 2: SessionLifecycleTracker + tests</name>
  <files>
    android/app/src/main/kotlin/app/dqxn/android/app/SessionLifecycleTracker.kt
    android/app/src/test/kotlin/app/dqxn/android/app/SessionLifecycleTrackerTest.kt
  </files>
  <action>
    Implement `SessionLifecycleTracker` (`@Singleton`):
    - Inject: `AnalyticsTracker`, `MetricsCollector`, `WidgetHealthMonitor` (from `:sdk:observability`)
    - Tracks session start time via `System.currentTimeMillis()` (or injectable clock for testing)

    Methods:
    - `onSessionStart(widgetCount: Int)` — records start time, fires `AnalyticsEvent.SessionStart(widgetCount = widgetCount)`
    - `onSessionEnd(editCount: Int)` — fires `AnalyticsEvent.SessionEnd(...)` with:
      - `durationMs` = current time - start time
      - `widgetCount` from last known count
      - `editCount` from parameter
      - `jankPercent` from `metricsCollector.snapshot().jankPercent` (F12.7)
      - `peakThermalLevel` from metricsCollector (F12.7)
      - `widgetRenderFailures` from healthMonitor (F12.7)
      - `providerErrors` from healthMonitor (F12.7)

    Make clock injectable (constructor parameter `clock: () -> Long = System::currentTimeMillis`) for deterministic testing.

    Create `SessionLifecycleTrackerTest.kt` with JUnit5 + MockK:
    1. `onSessionStart fires SessionStart event` — verify event with widgetCount
    2. `onSessionEnd calculates duration correctly` — inject fake clock, verify durationMs
    3. `onSessionEnd includes jank percent from metrics` — mock metricsCollector, verify jankPercent in event
    4. `onSessionEnd includes thermal level` — mock metricsCollector, verify peakThermalLevel
    5. `onSessionEnd includes render failures and provider errors` — verify widgetRenderFailures and providerErrors from healthMonitor
    6. `session without start records zero duration` — call onSessionEnd without onSessionStart, verify durationMs = 0 (or graceful fallback)

    Use `@Tag("fast")` on test class.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :app:testDebugUnitTest --tests "*.SessionLifecycleTrackerTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>SessionLifecycleTracker fires SessionStart/SessionEnd with all F12.7 quality metrics, 6 tests pass</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :sdk:analytics:testDebugUnitTest --tests "*.AnalyticsEventCallSiteTest" :app:testDebugUnitTest --tests "*.SessionLifecycleTrackerTest" --console=plain
</verification>

<success_criteria>
- F12.2 events (widget_add, theme_change, upsell_impression) fire with correct params
- F12.6 trigger_source parameter present on upsell events
- F12.7 session_end includes jank%, thermal, failures, errors
- F12.4 no PII in event parameters
- All events gated on consent via AnalyticsTracker internal check
- 12 tests pass (6 + 6)
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-10-SUMMARY.md`
</output>
