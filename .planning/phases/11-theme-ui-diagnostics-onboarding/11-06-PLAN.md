---
phase: 11-theme-ui-diagnostics-onboarding
plan: 06
type: execute
wave: 3
depends_on: ["11-01", "11-05"]
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudio.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/InlineColorPicker.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/GradientStopRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/GradientTypeSelector.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSwatchRow.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/AutoSwitchModeContent.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/IlluminanceThresholdControl.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/GradientStopRowTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioTest.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/AutoSwitchModeContentTest.kt
autonomous: true
requirements:
  - F4.7
  - F4.8

must_haves:
  truths:
    - "ThemeStudio renders color pickers for all 8 theme properties"
    - "InlineColorPicker converts between HSL and hex bidirectionally"
    - "GradientStopRow enforces min 2, max 5 stop count"
    - "AutoSwitchModeContent shows premium gating on SOLAR_AUTO and ILLUMINANCE_AUTO"
    - "ThemeStudio enforces max-12 custom themes with visible banner and disabled action"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudio.kt"
      provides: "Custom theme CRUD composable with auto-save"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/InlineColorPicker.kt"
      provides: "HSL slider + hex editor color picker"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/GradientStopRow.kt"
      provides: "2-5 stop gradient editor"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/GradientStopRowTest.kt"
      provides: "Gradient stop boundary tests"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioTest.kt"
      provides: "ThemeStudio UI tests: max-12 banner enforcement, 8-property accessibility"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/AutoSwitchModeContentTest.kt"
      provides: "AutoSwitchModeContent UI tests: lock icon gating, illuminance control visibility"
  key_links:
    - from: "ThemeStudio.kt"
      to: "ThemeStudioStateHolder.kt"
      via: "remember { ThemeStudioStateHolder(initialTheme) }"
      pattern: "ThemeStudioStateHolder"
    - from: "InlineColorPicker.kt"
      to: "ColorConversion.kt"
      via: "import colorToHsl/hslToColor/colorToHex/parseHexToColor"
      pattern: "colorToHsl|parseHexToColor"
---

<objective>
Build the theme editing composable suite: ThemeStudio, InlineColorPicker, GradientStopRow, GradientTypeSelector, ThemeSwatchRow, AutoSwitchModeContent, and IlluminanceThresholdControl.

Purpose: These composables form the complete theme customization UI (F4.7, F4.8). ThemeStudio uses the state holder from Plan 11-05 and color conversion from Plan 11-01. Auto-save via LaunchedEffect + live preview.

Output: 7 composable files + GradientStopRow boundary tests + ThemeStudio behavioral tests + AutoSwitchModeContent gating tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@.planning/migration/replication-advisory.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-01-SUMMARY.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: InlineColorPicker + GradientStopRow + GradientTypeSelector + ThemeSwatchRow</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/InlineColorPicker.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/GradientStopRow.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/GradientTypeSelector.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSwatchRow.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/GradientStopRowTest.kt
  </files>
  <action>
    1. **InlineColorPicker** — HSL sliders + hex editor:
       - 4 sliders: H (0-360), S (0-1), L (0-1), A (0-1)
       - Hex text field with live sync (bidirectional: slider → hex, hex → slider)
       - Use `colorToHsl`/`hslToColor` from ColorConversion.kt for conversion
       - Color preview swatch showing current selection
       - API: `@Composable fun InlineColorPicker(color: Color, onColorChanged: (Color) -> Unit, modifier: Modifier)`

    2. **GradientStopRow** — 2-5 stop gradient editor:
       - Each stop: position slider (0.0-1.0) + InlineColorPicker
       - Add button (disabled at 5 stops)
       - Remove button per stop (disabled at 2 stops — minimum)
       - Position clamped to [0.0, 1.0]
       - API: `@Composable fun GradientStopRow(stops: ImmutableList<GradientStop>, onStopsChanged: (ImmutableList<GradientStop>) -> Unit, modifier: Modifier)`

    3. **GradientTypeSelector** — 5 gradient types:
       - `FilterChip` row for VERTICAL, HORIZONTAL, LINEAR, RADIAL, SWEEP
       - Simple selection, maps to `GradientType` enum from `:sdk:ui`
       - API: `@Composable fun GradientTypeSelector(selected: GradientType, onSelected: (GradientType) -> Unit, modifier: Modifier)`

    4. **ThemeSwatchRow** — 7-value SwatchType enum selector:
       - Color swatch circles for each SwatchType (primaryText, secondaryText, accent, highlight, widgetBorder, background, widgetBackground)
       - Selected swatch has accent border
       - API: `@Composable fun ThemeSwatchRow(selected: SwatchType, onSelected: (SwatchType) -> Unit, theme: DashboardThemeDefinition, modifier: Modifier)`

    5. **GradientStopRowTest** (Compose UI test):
       - `add button disabled at 5 stops` — provide 5 stops, verify add button has disabled semantics
       - `remove button disabled at 2 stops` — provide 2 stops, verify remove button has disabled semantics
       - `position clamped to valid range` — verify stops render with positions in [0, 1]
       - `add stop inserts at midpoint` — tap add, verify new stop appears

    Use test tags: `gradient_stop_add`, `gradient_stop_remove_{index}`, `gradient_stop_position_{index}`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.GradientStopRowTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>InlineColorPicker, GradientStopRow, GradientTypeSelector, ThemeSwatchRow composables compile. GradientStopRow: 4 boundary tests pass (min 2, max 5, position clamping, add midpoint)</done>
</task>

<task type="auto">
  <name>Task 2: ThemeStudio + AutoSwitchModeContent + IlluminanceThresholdControl + behavioral tests</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudio.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/AutoSwitchModeContent.kt
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/IlluminanceThresholdControl.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioTest.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/AutoSwitchModeContentTest.kt
  </files>
  <action>
    1. **ThemeStudio** — custom theme CRUD:
       - Uses `remember { ThemeStudioStateHolder(existingTheme) }`
       - Theme ID stability: `remember { existingId ?: "custom_${System.currentTimeMillis()}" }`
       - ThemeSwatchRow to select which property to edit
       - InlineColorPicker for the selected swatch
       - GradientTypeSelector + GradientStopRow for background/widget background
       - isDark toggle
       - Auto-save via `LaunchedEffect` on all state vars: `if (stateHolder.isDirty) { onAutoSave(stateHolder.buildCustomTheme(stableThemeId)) }`
       - Max 12 check: if `customThemeCount >= 12`, show info banner and disable "New Theme" action
       - Delete-while-previewing: if deleting the previewed theme, `onClearPreview()` BEFORE `onDelete(themeId)`
       - Wrap in OverlayScaffold(overlayType = OverlayType.Preview)
       - API: `@Composable fun ThemeStudio(existingTheme: DashboardThemeDefinition?, customThemeCount: Int, onAutoSave: (DashboardThemeDefinition) -> Unit, onDelete: (String) -> Unit, onClearPreview: () -> Unit, onClose: () -> Unit, modifier: Modifier)`
       - Test tags: `theme_studio`, `theme_studio_swatch_row`, `max_themes_banner`, `new_theme_action`

    2. **AutoSwitchModeContent** — 5 auto-switch modes:
       - LIGHT, DARK, SYSTEM, SOLAR_AUTO, ILLUMINANCE_AUTO
       - Each mode as selectable row with radio button
       - SOLAR_AUTO and ILLUMINANCE_AUTO show lock icon if `Gated.isAccessible(entitlements)` returns false
       - When ILLUMINANCE_AUTO selected, show IlluminanceThresholdControl below
       - API: `@Composable fun AutoSwitchModeContent(selectedMode: AutoSwitchMode, illuminanceThreshold: Float, entitlementManager: EntitlementManager, onModeSelected: (AutoSwitchMode) -> Unit, onIlluminanceThresholdChanged: (Float) -> Unit, modifier: Modifier)`
       - Test tags: `auto_switch_mode_{MODE}`, `lock_icon_{MODE}`, `illuminance_control`

    3. **IlluminanceThresholdControl** — Canvas logarithmic lux meter:
       - Custom `Canvas` composable with tap+drag gesture
       - Uses `luxToPosition`/`positionToLux` from LuxMapping.kt
       - Draws logarithmic scale with dashed lines at key lux values (1, 10, 100, 1000, 10000)
       - Thumb indicator at current threshold position
       - Display current lux value as text above thumb
       - API: `@Composable fun IlluminanceThresholdControl(threshold: Float, onThresholdChanged: (Float) -> Unit, theme: DashboardThemeDefinition, modifier: Modifier)`

    4. **ThemeStudioTest** (Compose UI test):
       - `max 12 banner shown at count equals 12` — set customThemeCount=12, verify `max_themes_banner` test tag is visible
       - `max 12 banner hidden at count below 12` — set customThemeCount=5, verify `max_themes_banner` NOT visible
       - `new theme action disabled at count equals 12` — set customThemeCount=12, verify `new_theme_action` is disabled
       - `all 8 theme properties accessible via swatch row` — render with existingTheme, verify ThemeSwatchRow shows 7 swatches + isDark toggle (8 total editable properties). Verify by checking for 7 swatch test tags + isDark toggle tag
       - Use `createAndroidComposeRule<ComponentActivity>`. Provide mock callbacks.

    5. **AutoSwitchModeContentTest** (Compose UI test):
       - `SOLAR_AUTO shows lock icon when ungated` — mock EntitlementManager with no premium entitlement, verify `lock_icon_SOLAR_AUTO` test tag visible
       - `ILLUMINANCE_AUTO shows lock icon when ungated` — mock EntitlementManager with no premium entitlement, verify `lock_icon_ILLUMINANCE_AUTO` test tag visible
       - `lock icons hidden when entitled` — mock EntitlementManager with premium entitlement, verify no lock icon test tags
       - `illuminance control shown when ILLUMINANCE_AUTO selected` — set selectedMode=ILLUMINANCE_AUTO, verify `illuminance_control` test tag visible
       - `illuminance control hidden for other modes` — set selectedMode=SYSTEM, verify `illuminance_control` NOT visible
       - Use `createAndroidComposeRule<ComponentActivity>`. Use MockK for EntitlementManager.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.ThemeStudioTest" --tests "*.AutoSwitchModeContentTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>ThemeStudio: max-12 banner/disable enforced (4 UI tests), all 8 theme properties accessible. AutoSwitchModeContent: lock icons on SOLAR_AUTO/ILLUMINANCE_AUTO when ungated, illuminance control conditionally shown (5 UI tests). 9 total behavioral tests pass.</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.GradientStopRowTest" --tests "*.ThemeStudioTest" --tests "*.AutoSwitchModeContentTest" --console=plain
</verification>

<success_criteria>
- All 7 theme composables compile
- GradientStopRow enforces min 2/max 5 boundaries (4 tests pass)
- ThemeStudio: max-12 banner + disabled action (4 tests pass), 8 properties accessible
- AutoSwitchModeContent: lock icons on SOLAR_AUTO/ILLUMINANCE_AUTO, illuminance conditional (5 tests pass)
- InlineColorPicker uses ColorConversion pure functions
- ThemeStudio auto-saves via LaunchedEffect
- IlluminanceThresholdControl uses LuxMapping
- 13+ tests pass total across 3 test files
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-06-SUMMARY.md`
</output>
