---
phase: 11-theme-ui-diagnostics-onboarding
plan: 05
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioStateHolder.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioStateHolderTest.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelectorTest.kt
autonomous: true
requirements:
  - F4.6
  - F4.7
  - F4.9
  - F4.10
  - F4.12
  - F4.13

must_haves:
  truths:
    - "ThemeSelector shows free themes first, then custom, then premium"
    - "Theme preview times out after 60s and reverts"
    - "ThemeStudioStateHolder tracks isDirty correctly via derivedStateOf"
    - "Max 12 custom themes enforced"
    - "Preview-regardless-of-entitlement: gated themes are previewable but gate at persistence"
    - "Clone built-in to custom creates a copy with new ID"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioStateHolder.kt"
      provides: "Decomposed theme state holder with isDirty, auto-save, max-12 limit"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt"
      provides: "Theme browser with free-first ordering, preview lifecycle, clone"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioStateHolderTest.kt"
      provides: "State holder tests (isDirty, auto-save, max themes)"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelectorTest.kt"
      provides: "Selector tests (ordering, preview timeout, clone, entitlement)"
  key_links:
    - from: "ThemeSelector.kt"
      to: "ThemeCoordinator"
      via: "preview/apply/revert callbacks"
      pattern: "onPreviewTheme|onApplyTheme|onClearPreview"
    - from: "ThemeStudioStateHolder.kt"
      to: "ThemeJsonParser"
      via: "buildCustomTheme output"
      pattern: "buildCustomTheme"
---

<objective>
Implement ThemeSelector composable with free-first ordering and preview lifecycle, plus ThemeStudioStateHolder for decomposed custom theme editing state.

Purpose: These are the core logic-heavy components of the theme UI cluster. ThemeSelector handles the critical caller-managed preview pattern (replication advisory section 3) and 60s timeout. ThemeStudioStateHolder decomposes the god-composable problem from the old codebase.

Output: ThemeSelector + ThemeStudioStateHolder with comprehensive tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@.planning/migration/replication-advisory.md
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinator.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: ThemeStudioStateHolder + tests</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioStateHolder.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudioStateHolderTest.kt
  </files>
  <action>
    Implement `ThemeStudioStateHolder` in package `app.dqxn.android.feature.settings.theme`:

    ```kotlin
    class ThemeStudioStateHolder(initialTheme: DashboardThemeDefinition?) {
        // 8 mutable color states
        var primaryTextColor by mutableStateOf(initialTheme?.primaryTextColor ?: Color.White)
        var secondaryTextColor by mutableStateOf(initialTheme?.secondaryTextColor ?: Color.White.copy(alpha = 0.7f))
        var accentColor by mutableStateOf(initialTheme?.accentColor ?: Color.Cyan)
        var highlightColor by mutableStateOf(initialTheme?.highlightColor ?: Color.Cyan)
        var widgetBorderColor by mutableStateOf(initialTheme?.widgetBorderColor ?: Color.White.copy(alpha = 0.2f))
        var backgroundBrush by mutableStateOf(initialTheme?.backgroundBrush ?: /* solid black */)
        var widgetBackgroundBrush by mutableStateOf(initialTheme?.widgetBackgroundBrush ?: /* solid dark */)
        var isDark by mutableStateOf(initialTheme?.isDark ?: true)

        // Saved state for isDirty comparison
        private val savedPrimaryTextColor = initialTheme?.primaryTextColor ?: Color.White
        // ... same for all

        val isDirty: Boolean by derivedStateOf {
            primaryTextColor != savedPrimaryTextColor ||
            secondaryTextColor != savedSecondaryTextColor ||
            accentColor != savedAccentColor ||
            highlightColor != savedHighlightColor ||
            widgetBorderColor != savedWidgetBorderColor ||
            isDark != savedIsDark
            // Note: brush comparison may need special handling
        }

        fun buildCustomTheme(themeId: String): DashboardThemeDefinition { ... }
    }
    ```

    Create `ThemeStudioStateHolderTest.kt` with JUnit5:
    1. `isDirty is false when no changes made` — create from initialTheme, verify isDirty == false
    2. `isDirty is true when color changed` — modify primaryTextColor, verify isDirty == true
    3. `buildCustomTheme produces valid definition` — modify colors, build, verify all fields match
    4. `null initialTheme uses defaults` — create with null, verify no crash, default colors applied
    5. `buildCustomTheme uses provided themeId` — verify themeId in output matches input

    Note: `derivedStateOf` requires Compose runtime. Test can read `isDirty` directly since it's a `State<Boolean>` backed property. Use `@get:Rule val composeTestRule = createComposeRule()` if needed for Compose state reading, or read the property directly if the test framework supports it.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.ThemeStudioStateHolderTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>ThemeStudioStateHolder: isDirty derivation works, buildCustomTheme produces valid output, 5 tests pass</done>
</task>

<task type="auto">
  <name>Task 2: ThemeSelector composable + tests</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelectorTest.kt
  </files>
  <action>
    Implement `ThemeSelector` composable:

    Key behaviors:
    1. **Free-first ordering** (F4.13): Sort themes as `freeThemes + customThemes + premiumThemes`. Free = requiredAnyEntitlement is null/empty and no custom prefix. Custom = themeId starts with "custom_". Premium = has requiredAnyEntitlement and not custom.
    2. **Preview lifecycle** (F4.6): `LaunchedEffect(previewTheme?.themeId)` with 60s timeout → `onClearPreview()` + toast. Key on themeId so new preview resets timer.
    3. **Preview-regardless-of-entitlement** (F4.9): All themes previewable on tap. Lock icon shown on gated themes. Entitlement check only at apply (not preview).
    4. **Clone built-in to custom** (F4.12): Long-press on built-in → `onCloneToCustom(theme)`. Creates copy with `"custom_${System.currentTimeMillis()}"` ID.
    5. **Entitlement revocation** (F4.10): React to `EntitlementManager.entitlementChanges` — if previewing a revoked theme, clear preview and revert.
    6. **Dual cleanup for preview** (replication advisory section 3): `DisposableEffect(Unit) { onDispose { onClearPreview() } }` in ThemeSelector.

    Callback-based API — ThemeSelector does NOT call ThemeCoordinator directly:
    ```kotlin
    @Composable
    fun ThemeSelector(
        allThemes: ImmutableList<DashboardThemeDefinition>,
        previewTheme: DashboardThemeDefinition?,
        customThemeCount: Int,
        entitlementManager: EntitlementManager,
        onPreviewTheme: (DashboardThemeDefinition) -> Unit,
        onApplyTheme: (String) -> Unit,
        onClearPreview: () -> Unit,
        onCloneToCustom: (DashboardThemeDefinition) -> Unit,
        onOpenStudio: (DashboardThemeDefinition) -> Unit,
        onDeleteCustom: (String) -> Unit,
        onShowToast: (String) -> Unit,
        onClose: () -> Unit,
        modifier: Modifier = Modifier,
    )
    ```

    Wrap in OverlayScaffold(overlayType = OverlayType.Preview). Use OverlayTitleBar.

    Create `ThemeSelectorTest.kt` with Compose UI test (JUnit4 + `createAndroidComposeRule<ComponentActivity>`):
    1. `themes ordered free first then custom then premium` — provide mixed list, assert semantic order via test tags
    2. `preview timeout clears preview after 60s` — set preview, advance clock by 60_001ms, verify onClearPreview called (use `advanceTimeBy` on test clock)
    3. `lock icon shown on gated themes` — provide premium theme, verify lock icon semantics
    4. `clone creates custom copy` — long-press built-in, verify onCloneToCustom called
    5. `preview cleared on dispose` — compose ThemeSelector, remove from composition, verify onClearPreview called
    6. `gated theme is previewable` — tap gated theme, verify onPreviewTheme called (not blocked)

    Note: The 60s timeout test needs virtual time control. Use `StandardTestDispatcher` if possible with the Compose test rule, or accept that the timeout test verifies the LaunchedEffect structure via semantics assertions rather than actual time advancement.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.ThemeSelectorTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>ThemeSelector: free-first ordering verified, preview timeout, lock icons, clone, disposal cleanup — 6 tests pass</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.ThemeStudioStateHolderTest" --tests "*.ThemeSelectorTest" --console=plain
</verification>

<success_criteria>
- ThemeSelector renders themes in free-first order
- 60s preview timeout fires and reverts
- ThemeStudioStateHolder isDirty derivation correct
- Clone-to-custom creates new ID
- Gate-at-persistence, not gate-at-preview
- 11+ tests pass across both test files
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-05-SUMMARY.md`
</output>
