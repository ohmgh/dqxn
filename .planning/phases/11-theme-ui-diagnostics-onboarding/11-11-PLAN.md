---
phase: 11-theme-ui-diagnostics-onboarding
plan: 11
type: execute
wave: 1
depends_on: ["11-09"]
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostRouteTest.kt
autonomous: true
gap_closure: true
requirements: [F4.6, F4.7, F4.12]

must_haves:
  truths:
    - "ThemeSelector onCloneToCustom navigates to ThemeStudioRoute with the source theme"
    - "ThemeSelector onOpenStudio navigates to ThemeStudioRoute with the existing theme"
    - "ThemeSelector onDeleteCustom clears preview and dispatches DeleteCustomTheme command"
    - "ThemeSelector onShowToast delivers messages to NotificationCoordinator.showToast()"
    - "ThemeStudioRoute renders ThemeStudio composable with correct callback wiring"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt"
      provides: "ThemeStudioRoute data class with nullable themeId parameter"
      contains: "ThemeStudioRoute"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt"
      provides: "composable<ThemeStudioRoute> block wiring ThemeStudio composable"
      contains: "composable<ThemeStudioRoute>"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt"
      provides: "SaveCustomTheme and DeleteCustomTheme command variants"
      contains: "SaveCustomTheme"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostRouteTest.kt"
      provides: "Updated route tests covering 9 routes and ThemeStudioRoute"
      contains: "ThemeStudioRoute"
  key_links:
    - from: "OverlayNavHost ThemeSelectorRoute onCloneToCustom"
      to: "navController.navigate(ThemeStudioRoute)"
      via: "Navigation to ThemeStudioRoute with themeId"
      pattern: "onCloneToCustom.*navigate.*ThemeStudioRoute"
    - from: "OverlayNavHost ThemeSelectorRoute onShowToast"
      to: "NotificationCoordinator.showToast"
      via: "onShowToast callback from DashboardScreen"
      pattern: "onShowToast.*showToast"
    - from: "DashboardViewModel routeCommand"
      to: "SaveCustomTheme/DeleteCustomTheme handling"
      via: "when branch in routeCommand"
      pattern: "is DashboardCommand.SaveCustomTheme"
---

<objective>
Close two verification gaps from 11-VERIFICATION.md: (1) ThemeStudio is unreachable because ThemeSelectorRoute's onCloneToCustom/onOpenStudio/onDeleteCustom are no-ops, (2) toast messages from ThemeSelector are silently dropped because onShowToast is a no-op.

Purpose: Make the fully implemented ThemeStudio composable reachable from ThemeSelector, and connect toast notifications so users see feedback on preview timeout, max-themes limit, and entitlement gates.

Output: ThemeStudioRoute added to OverlayRoutes.kt, composable<ThemeStudioRoute> wired in OverlayNavHost.kt, DashboardCommand extended with SaveCustomTheme/DeleteCustomTheme, toast callback threaded from DashboardScreen, route tests updated.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-09-SUMMARY.md
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt
@android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeStudio.kt
@android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt
@android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostRouteTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ThemeStudioRoute + DashboardCommand variants + toast callback + OverlayNavHost wiring</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt
  </files>
  <action>
    **Step 1: Add ThemeStudioRoute to OverlayRoutes.kt**

    Add after ThemeSelectorRoute:

    ```kotlin
    /**
     * Theme studio overlay -- preview-type transitions (sub-screen of ThemeSelector).
     *
     * [themeId] is the ID of the theme being edited. Null means "create new custom theme".
     * When navigated from clone action, [themeId] is the source theme's ID and ThemeStudio
     * creates a copy with a new custom ID.
     *
     * popEnter from ThemeStudioRoute back to ThemeSelector uses fadeIn(150ms) -- same
     * pattern as ThemeSelector popEnter to prevent double-slide.
     */
    @Serializable
    public data class ThemeStudioRoute(val themeId: String? = null)
    ```

    **Step 2: Add DashboardCommand variants for custom theme operations**

    In DashboardCommand.kt, add two new command variants after `CycleThemeMode`:

    ```kotlin
    public data class SaveCustomTheme(
      val theme: DashboardThemeDefinition,
      override val traceId: String? = null,
    ) : DashboardCommand

    public data class DeleteCustomTheme(
      val themeId: String,
      override val traceId: String? = null,
    ) : DashboardCommand
    ```

    **Step 3: Handle new commands in DashboardViewModel.routeCommand()**

    In the `when` block in `routeCommand()`, add after the `CycleThemeMode` handler:

    ```kotlin
    is DashboardCommand.SaveCustomTheme -> {
      // Custom theme persistence -- future (JSON files in internal storage)
      // For now, preview the saved theme so it's immediately visible
      themeCoordinator.handlePreviewTheme(command.theme)
      recordSessionEvent(EventType.THEME_CHANGE, "customTheme=${command.theme.themeId}")
    }
    is DashboardCommand.DeleteCustomTheme -> {
      // Custom theme deletion -- future (remove JSON file)
      // Clear preview if deleted theme was being previewed
      val currentPreview = themeCoordinator.themeState.value.previewTheme
      if (currentPreview?.themeId == command.themeId) {
        themeCoordinator.handlePreviewTheme(null)
      }
      recordSessionEvent(EventType.THEME_CHANGE, "deleteCustom=${command.themeId}")
    }
    ```

    **Step 4: Add onShowToast parameter to OverlayNavHost signature**

    Add `onShowToast: (String) -> Unit` parameter to OverlayNavHost after `onCommand`:

    ```kotlin
    @Composable
    public fun OverlayNavHost(
      // ... existing params ...
      onCommand: (DashboardCommand) -> Unit,
      onShowToast: (String) -> Unit,
      modifier: Modifier = Modifier,
    )
    ```

    **Step 5: Wire ThemeSelectorRoute callbacks in OverlayNavHost**

    Replace the three no-op callbacks in the ThemeSelectorRoute composable block:

    ```kotlin
    onCloneToCustom = { sourceTheme ->
      // Clone: navigate to ThemeStudio. ThemeStudio uses existingTheme param
      // to create a copy with a new custom ID.
      onCommand(DashboardCommand.PreviewTheme(sourceTheme))
      navController.navigate(ThemeStudioRoute(themeId = sourceTheme.themeId))
    },
    onOpenStudio = { existingTheme ->
      // Edit: navigate to ThemeStudio with the existing custom theme
      onCommand(DashboardCommand.PreviewTheme(existingTheme))
      navController.navigate(ThemeStudioRoute(themeId = existingTheme.themeId))
    },
    onDeleteCustom = { themeId ->
      // Delete: clear preview first (advisory section 3 delete-while-previewing fix),
      // then dispatch delete command
      onCommand(DashboardCommand.PreviewTheme(null))
      onCommand(DashboardCommand.DeleteCustomTheme(themeId))
    },
    ```

    Replace the onShowToast no-op:

    ```kotlin
    onShowToast = onShowToast,
    ```

    **Step 6: Add composable<ThemeStudioRoute> to OverlayNavHost**

    Add after the ThemeSelectorRoute block. ThemeStudio is a sub-screen of ThemeSelector, so:
    - enterTransition: previewEnter (slide up like other preview overlays)
    - exitTransition: previewExit
    - popEnterTransition: fadeIn(150ms) -- same as ThemeSelector popEnter to prevent double-slide
    - popExitTransition: previewExit

    ```kotlin
    // Theme studio -- preview transitions (sub-screen of ThemeSelector)
    // popEnter uses fadeIn(150ms) NOT previewEnter to prevent double-slide
    composable<ThemeStudioRoute>(
      enterTransition = { DashboardMotion.previewEnter },
      exitTransition = { DashboardMotion.previewExit },
      popEnterTransition = { fadeIn(tween(150)) },
      popExitTransition = { DashboardMotion.previewExit },
    ) { backStackEntry ->
      val route = backStackEntry.toRoute<ThemeStudioRoute>()
      val existingTheme = allThemes.firstOrNull { it.themeId == route.themeId }

      ThemeStudio(
        existingTheme = existingTheme,
        customThemeCount = customThemeCount,
        onAutoSave = { theme -> onCommand(DashboardCommand.SaveCustomTheme(theme)) },
        onDelete = { themeId ->
          // Delete-while-previewing: clear preview BEFORE delete (advisory section 3)
          onCommand(DashboardCommand.PreviewTheme(null))
          onCommand(DashboardCommand.DeleteCustomTheme(themeId))
          navController.popBackStack()
        },
        onClearPreview = { onCommand(DashboardCommand.PreviewTheme(null)) },
        onClose = { navController.popBackStack() },
      )
    }
    ```

    Also add a `THEME_STUDIO_ROUTE_PATTERN` constant at the bottom alongside the others:
    ```kotlin
    private val THEME_STUDIO_ROUTE_PATTERN = ThemeStudioRoute::class.qualifiedName!!
    ```

    Also update ThemeSelectorRoute's exitTransition to handle navigation to ThemeStudioRoute -- it should use fadeOut(100ms) same as Settings->ThemeSelector (smooth cross-fade for sub-screen push):

    In the ThemeSelectorRoute composable definition, add exit/popEnter handling. The current ThemeSelectorRoute uses static `previewEnter`/`previewExit`. Change to source-varying:

    ```kotlin
    composable<ThemeSelectorRoute>(
      enterTransition = { DashboardMotion.previewEnter },
      exitTransition = {
        val target = targetState.destination.route ?: ""
        when {
          target.contains(THEME_STUDIO_ROUTE_PATTERN) -> fadeOut(tween(100))
          else -> DashboardMotion.previewExit
        }
      },
      popEnterTransition = {
        val source = initialState.destination.route ?: ""
        when {
          source.contains(THEME_STUDIO_ROUTE_PATTERN) -> fadeIn(tween(150))
          else -> fadeIn(tween(150))
        }
      },
      popExitTransition = { DashboardMotion.previewExit },
    )
    ```

    Note: popEnterTransition is fadeIn(150ms) for ALL sources (both back from ThemeStudio and direct pop to Settings), so the `when` branches are identical. This is correct and intentional -- keep the when for documentation clarity showing the ThemeStudio pattern is considered.

    **Step 7: Update DashboardScreen to pass onShowToast to OverlayNavHost**

    In DashboardScreen.kt, in the OverlayNavHost call site, add the toast callback. Import `InAppNotification` and `NotificationPriority`:

    ```kotlin
    OverlayNavHost(
      // ... existing params ...
      onCommand = onCommand,
      onShowToast = { message ->
        viewModel.notificationCoordinator.showToast(
          InAppNotification.Toast(
            id = "theme_toast_${System.currentTimeMillis()}",
            priority = NotificationPriority.NORMAL,
            timestamp = System.currentTimeMillis(),
            message = message,
            durationMs = 3000L,
          )
        )
      },
    )
    ```

    Add necessary imports to DashboardScreen.kt:
    ```kotlin
    import app.dqxn.android.sdk.contracts.notification.InAppNotification
    import app.dqxn.android.sdk.contracts.notification.NotificationPriority
    ```

    **Step 8: Update OverlayNavHost KDoc**

    Update the route table comment at the top of OverlayNavHost to include ThemeStudioRoute:
    ```
    * - [ThemeStudioRoute] -- custom theme editor, preview transitions, popEnter=fadeIn(150ms)
    ```

    Total route count is now 9 (8 + ThemeStudioRoute).

    **Step 9: Update SettingsRoute source-varying transitions**

    In the SettingsRoute exit/popEnter transitions, add ThemeStudioRoute pattern matching alongside ThemeSelectorRoute. If Settings navigates to ThemeStudioRoute directly (unlikely but defensive), use same fadeOut/fadeIn as ThemeSelector:

    Actually -- Settings never navigates directly to ThemeStudio (it goes Settings -> ThemeSelector -> ThemeStudio), so no change needed to SettingsRoute transitions. Skip this step.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
    <sampling_rate>after task commit, before task 2</sampling_rate>
  </verify>
  <done>
    ThemeStudioRoute exists in OverlayRoutes.kt. composable<ThemeStudioRoute> wired in OverlayNavHost. ThemeSelectorRoute callbacks are no longer no-ops: onCloneToCustom/onOpenStudio navigate to ThemeStudioRoute, onDeleteCustom clears preview and dispatches DeleteCustomTheme, onShowToast delegates to NotificationCoordinator. DashboardCommand has SaveCustomTheme and DeleteCustomTheme variants. DashboardViewModel routes them. Compilation succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update route tests + fix test compilation for new OverlayNavHost signature</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostRouteTest.kt
  </files>
  <action>
    **Step 1: Update route count and add ThemeStudioRoute to OverlayNavHostRouteTest.kt**

    In `all 8 routes have distinct qualified names` test:
    - Rename to `all 9 routes have distinct qualified names`
    - Add `ThemeStudioRoute::class.qualifiedName` to the list
    - Change `hasSize(8)` to `hasSize(9)`

    In `all route qualified names are under the layer package` test:
    - Add `ThemeStudioRoute::class` to the routes list

    In `hub-type routes are WidgetPicker, Setup, Diagnostics, Onboarding` test -- no change needed (ThemeStudio is preview-type).

    In `preview-type routes are Settings, WidgetSettings, ThemeSelector` test:
    - Add `ThemeStudioRoute::class.qualifiedName` to the list
    - Change `hasSize(3)` to `hasSize(4)`

    In `data object routes are singletons` test -- no change needed (ThemeStudioRoute is a data class, not data object).

    **Step 2: Add ThemeStudioRoute-specific tests**

    Add a new test for ThemeStudioRoute parameter:

    ```kotlin
    @Test
    fun `ThemeStudioRoute carries optional themeId parameter`() {
      val editRoute = ThemeStudioRoute(themeId = "custom_123")
      assertThat(editRoute.themeId).isEqualTo("custom_123")

      val newRoute = ThemeStudioRoute()
      assertThat(newRoute.themeId).isNull()
    }
    ```

    Add test for ThemeStudio route pattern distinguishability from ThemeSelector:

    ```kotlin
    @Test
    fun `theme_studio route pattern is distinguishable from theme_selector`() {
      val studioPattern = ThemeStudioRoute::class.qualifiedName!!
      val selectorPattern = ThemeSelectorRoute::class.qualifiedName!!

      assertThat(studioPattern).isNotEqualTo(selectorPattern)
      assertThat(studioPattern).contains("ThemeStudioRoute")
      assertThat(selectorPattern).contains("ThemeSelectorRoute")
    }
    ```

    **Step 3: Fix any test compilation errors from OverlayNavHost signature change**

    If other test files construct OverlayNavHost directly (e.g., OverlayNavHostTest.kt), they will fail compilation because of the new `onShowToast` parameter. Add `onShowToast = {}` to those call sites.

    Check files:
    - `android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHostTest.kt`
    - Any other files that reference OverlayNavHost directly

    Add the missing parameter with a no-op lambda in test call sites.

    Also fix any DashboardViewModelTest.kt or SessionEventEmissionTest.kt compilation from new DashboardCommand variants (the `when` in routeCommand must be exhaustive -- but since DashboardCommand is a sealed interface, the compiler enforces this. No test changes needed for that -- the command routing is in DashboardViewModel, not mocked).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --console=plain 2>&1 | tail -20</automated>
    <sampling_rate>after task commit</sampling_rate>
  </verify>
  <done>
    OverlayNavHostRouteTest updated: 9 routes with distinct names, ThemeStudioRoute in preview-type list, ThemeStudioRoute parameter test, pattern distinguishability test. All existing tests still pass. Any test files referencing OverlayNavHost updated for new onShowToast parameter.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain` -- compilation passes with all changes
2. `cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:dashboard:testDebugUnitTest --console=plain` -- all route tests pass
3. Verify ThemeStudioRoute exists in OverlayRoutes.kt: `grep "ThemeStudioRoute" android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayRoutes.kt`
4. Verify no remaining no-ops in ThemeSelectorRoute callbacks: `grep -n "{ _ ->" android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt` should return 0 results for ThemeSelectorRoute region
5. Verify SaveCustomTheme and DeleteCustomTheme in DashboardCommand: `grep "SaveCustomTheme\|DeleteCustomTheme" android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt`
</verification>

<success_criteria>
- ThemeStudioRoute defined as `@Serializable data class ThemeStudioRoute(val themeId: String? = null)` in OverlayRoutes.kt
- composable<ThemeStudioRoute> renders ThemeStudio with correct callbacks in OverlayNavHost.kt
- onCloneToCustom navigates to ThemeStudioRoute with source theme ID
- onOpenStudio navigates to ThemeStudioRoute with existing theme ID
- onDeleteCustom clears preview then dispatches DeleteCustomTheme command
- onShowToast delivers messages to NotificationCoordinator.showToast() via callback from DashboardScreen
- DashboardCommand has SaveCustomTheme and DeleteCustomTheme variants
- DashboardViewModel.routeCommand() handles both new commands
- All existing route tests pass plus new ThemeStudioRoute tests
- Zero no-op callbacks remain in ThemeSelectorRoute wiring
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-11-SUMMARY.md`
</output>
