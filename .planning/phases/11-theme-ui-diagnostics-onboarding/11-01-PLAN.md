---
phase: 11-theme-ui-diagnostics-onboarding
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ColorConversion.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ColorConversionTest.kt
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/LuxMapping.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/LuxMappingTest.kt
autonomous: true
requirements:
  - F4.7
  - F4.8

must_haves:
  truths:
    - "colorToHsl round-trips with +-1/255 accuracy for all primary colors and achromatic grays"
    - "parseHexToColor handles 6-digit and 8-digit hex strings and returns null for invalid input"
    - "luxToPosition and positionToLux are inverse functions within floating-point tolerance"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ColorConversion.kt"
      provides: "Pure color conversion functions (colorToHsl, colorToHex, parseHexToColor)"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ColorConversionTest.kt"
      provides: "Color conversion unit tests covering boundary conditions"
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/LuxMapping.kt"
      provides: "Logarithmic lux-to-position mapping functions"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/LuxMappingTest.kt"
      provides: "Lux mapping inverse property tests"
  key_links:
    - from: "ColorConversion.kt"
      to: "InlineColorPicker (Plan 11-06)"
      via: "import of pure functions"
      pattern: "colorToHsl|colorToHex|parseHexToColor"
    - from: "LuxMapping.kt"
      to: "IlluminanceThresholdControl (Plan 11-06)"
      via: "import of pure functions"
      pattern: "luxToPosition|positionToLux"
---

<objective>
TDD implementation of color conversion utilities and logarithmic lux mapping — the two highest-value pure-function test targets in Phase 11.

Purpose: These pure functions underpin InlineColorPicker (HSL sliders + hex editor) and IlluminanceThresholdControl (Canvas lux meter). Extracting and testing them first prevents subtle boundary bugs (hue wrap at 360, achromatic grays, log(0) edge case) from propagating into UI composables.

Output: 4 files — 2 source + 2 test files with comprehensive boundary coverage.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD ColorConversion — RED then GREEN</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ColorConversion.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ColorConversionTest.kt
  </files>
  <action>
    RED phase: Create `ColorConversionTest.kt` in package `app.dqxn.android.feature.settings.theme` with JUnit5 tests:

    1. `colorToHsl` tests:
       - Black (0,0,0) → H=0, S=0, L=0
       - White (1,1,1) → H=0, S=0, L=1
       - Pure red (1,0,0) → H=0, S=1, L=0.5
       - Pure green (0,1,0) → H=120, S=1, L=0.5
       - Pure blue (0,0,1) → H=240, S=1, L=0.5
       - Achromatic gray (0.5, 0.5, 0.5) → H=0, S=0, L=0.5
       - Hue boundary: yellow (1,1,0) → H=60, S=1, L=0.5
       - Hue boundary: cyan (0,1,1) → H=180, S=1, L=0.5
       - Hue boundary: magenta (1,0,1) → H=300, S=1, L=0.5

    2. `colorToHex` tests:
       - White → "#FFFFFFFF"
       - Black → "#FF000000"
       - Transparent red → "#80FF0000" (alpha=0.5)

    3. `parseHexToColor` tests:
       - "#FF0000" → red (6-digit, no alpha)
       - "#80FF0000" → semi-transparent red (8-digit)
       - "#invalid" → null
       - "#GG0000" → null (bad hex chars)
       - "" → null
       - "#12345" → null (5-digit)

    4. Round-trip property test:
       - For 10+ known Color values, verify `parseHexToColor(colorToHex(color))` equals original within +-1/255 per channel
       - For primary colors, verify `hslToColor(colorToHsl(color))` round-trip (need hslToColor helper in source)

    Create stub `ColorConversion.kt` with function signatures returning dummy values. Run tests — they MUST fail.

    GREEN phase: Implement the functions per the research code examples:
    - `colorToHsl(color: Color): FloatArray` — handle achromatic (delta==0), hue wrap at 360
    - `hslToColor(hsl: FloatArray): Color` — inverse of colorToHsl for round-trip support
    - `colorToHex(color: Color): String` — #AARRGGBB format
    - `parseHexToColor(hex: String): Color?` — 6-digit (#RRGGBB) and 8-digit (#AARRGGBB), null on failure

    All functions are `internal` (used within `:feature:settings` only). Package: `app.dqxn.android.feature.settings.theme`. No Compose UI dependencies — only `androidx.compose.ui.graphics.Color` for the type.

    Use `assertWithMessage()` for Truth assertions (not `.named()` which is deprecated).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.ColorConversionTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>All ColorConversion tests pass: colorToHsl boundary conditions, colorToHex formatting, parseHexToColor parsing + null safety, round-trip accuracy within +-1/255</done>
</task>

<task type="auto">
  <name>Task 2: TDD LuxMapping — RED then GREEN</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/LuxMapping.kt
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/LuxMappingTest.kt
  </files>
  <action>
    RED phase: Create `LuxMappingTest.kt` with JUnit5 tests:

    1. `luxToPosition` boundary tests:
       - 0 lux → 0.0 (or near-zero, handle log(0) edge case)
       - MAX_LUX (10000) → 1.0 (or near 1.0)
       - Negative lux → clamped to 0.0
       - Typical indoor (~300 lux) → position between 0 and 1

    2. `positionToLux` boundary tests:
       - 0.0 → 0 (or minimum lux)
       - 1.0 → MAX_LUX
       - Negative position → clamped to minimum
       - Position > 1.0 → clamped to MAX_LUX

    3. Inverse property test:
       - For a range of lux values (1, 10, 100, 500, 1000, 5000, 10000), verify `positionToLux(luxToPosition(lux))` is within 1% tolerance
       - For positions (0.1, 0.25, 0.5, 0.75, 0.9), verify `luxToPosition(positionToLux(pos))` is within 0.01 absolute tolerance

    Create stub `LuxMapping.kt` with function signatures. Run tests — MUST fail.

    GREEN phase: Implement logarithmic mapping:
    - `luxToPosition(lux: Float): Float` — logarithmic scale from 0 to MAX_LUX, clamped [0, 1]
    - `positionToLux(position: Float): Float` — inverse logarithmic, clamped [0, MAX_LUX]
    - `MAX_LUX = 10_000f` constant
    - `MIN_LUX = 1f` constant (avoid log(0))

    Formula: `position = log10(max(lux, MIN_LUX)) / log10(MAX_LUX)` and inverse `lux = 10^(position * log10(MAX_LUX))`.
    Both functions `internal`. Package: `app.dqxn.android.feature.settings.theme`.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.LuxMappingTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>All LuxMapping tests pass: boundary conditions at 0 and MAX_LUX, clamping for out-of-range inputs, inverse property within 1% tolerance</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.ColorConversionTest" --tests "*.LuxMappingTest" --console=plain
</verification>

<success_criteria>
- ColorConversion: 15+ tests covering all boundary conditions, round-trip accuracy within +-1/255
- LuxMapping: 10+ tests covering boundary values, clamping, inverse property within 1%
- Both files are pure functions with no Compose UI dependencies
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-01-SUMMARY.md`
</output>
