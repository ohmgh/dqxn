---
phase: 11-theme-ui-diagnostics-onboarding
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/diagnostics/build.gradle.kts
  - android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/SessionRecorder.kt
  - android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/SessionEvent.kt
  - android/feature/diagnostics/src/test/kotlin/app/dqxn/android/feature/diagnostics/SessionRecorderTest.kt
autonomous: true
requirements:
  - F13.3

must_haves:
  truths:
    - "SessionRecorder captures events only when recording is enabled"
    - "Ring buffer overflow evicts oldest events (max 10,000)"
    - "snapshot() returns an ImmutableList without blocking recording"
  artifacts:
    - path: "android/feature/diagnostics/build.gradle.kts"
      provides: "Diagnostics module build configuration with correct dependencies"
    - path: "android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/SessionRecorder.kt"
      provides: "Ring buffer session recorder with toggle"
    - path: "android/feature/diagnostics/src/test/kotlin/app/dqxn/android/feature/diagnostics/SessionRecorderTest.kt"
      provides: "Unit tests for ring buffer, toggle, overflow, snapshot"
  key_links:
    - from: "SessionRecorder.kt"
      to: "DiagnosticsViewModel (Plan 11-07)"
      via: "Hilt @Singleton injection"
      pattern: "@Singleton.*SessionRecorder"
---

<objective>
Set up `:feature:diagnostics` build configuration and implement SessionRecorder — the novel ring-buffer event capture service for F13.3.

Purpose: Diagnostics is the only entirely new module in Phase 11. Getting the build config right early and implementing the highest-risk novel component (SessionRecorder — no old codebase reference) unblocks all diagnostics UI work.

Output: Working `:feature:diagnostics` module with SessionRecorder + tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@.planning/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnostics module build config + SessionEvent types</name>
  <files>
    android/feature/diagnostics/build.gradle.kts
    android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/SessionEvent.kt
  </files>
  <action>
    Update `feature/diagnostics/build.gradle.kts` to add required dependencies per ARCHITECTURE.md:
    ```kotlin
    plugins { id("dqxn.android.feature") }
    android { namespace = "app.dqxn.android.feature.diagnostics" }
    dependencies {
        implementation(project(":core:design"))
        implementation(project(":data"))
        implementation(project(":sdk:analytics"))

        testImplementation(libs.compose.ui.test.junit4)
        debugImplementation(libs.compose.ui.test.manifest)
    }
    ```

    Note: `:sdk:contracts`, `:sdk:common`, `:sdk:ui`, `:sdk:observability` are auto-wired by `dqxn.android.feature` convention plugin.

    Create `SessionEvent.kt` in package `app.dqxn.android.feature.diagnostics`:
    ```kotlin
    @Immutable
    data class SessionEvent(
        val timestamp: Long,
        val type: EventType,
        val details: String = "",
    )

    enum class EventType {
        TAP, MOVE, RESIZE, NAVIGATE, EDIT_MODE_ENTER, EDIT_MODE_EXIT, THEME_CHANGE, WIDGET_ADD, WIDGET_REMOVE
    }
    ```

    Both types are `public` (consumed by other modules recording events via SessionRecorder interface).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:diagnostics:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>`:feature:diagnostics` compiles with all dependency wiring correct</done>
</task>

<task type="auto">
  <name>Task 2: SessionRecorder implementation + tests</name>
  <files>
    android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/SessionRecorder.kt
    android/feature/diagnostics/src/test/kotlin/app/dqxn/android/feature/diagnostics/SessionRecorderTest.kt
  </files>
  <action>
    Implement `SessionRecorder` as `@Singleton` per research pattern:
    - `ArrayDeque<SessionEvent>` ring buffer with `MAX_EVENTS = 10_000`
    - `MutableStateFlow<Boolean>` for `isRecording` toggle
    - `record(event: SessionEvent)` — no-op if not recording, synchronized buffer access, evicts oldest at capacity
    - `startRecording()` / `stopRecording()` toggle methods
    - `snapshot(): ImmutableList<SessionEvent>` — synchronized copy to ImmutableList
    - `clear()` — clears buffer

    Create `SessionRecorderTest.kt` with JUnit5:
    1. `record does nothing when not recording` — record 5 events, snapshot is empty
    2. `record captures events when recording` — start, record 3, snapshot has 3
    3. `ring buffer evicts oldest on overflow` — record MAX_EVENTS + 10, verify size == MAX_EVENTS and oldest events gone (check first event timestamp)
    4. `snapshot returns immutable copy` — record, snapshot, record more, first snapshot unchanged
    5. `stop recording prevents further capture` — start, record 2, stop, record 2 more, snapshot has 2
    6. `clear removes all events` — record, clear, snapshot empty, isRecording unchanged
    7. `isRecording flow reflects state` — use Turbine to verify initial false, start -> true, stop -> false

    Use `@Tag("fast")` on the test class for fast-test filtering.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:diagnostics:testDebugUnitTest --tests "*.SessionRecorderTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>All 7 SessionRecorder tests pass: toggle gating, ring buffer overflow, snapshot immutability, clear, flow state</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:diagnostics:testDebugUnitTest --console=plain
</verification>

<success_criteria>
- `:feature:diagnostics` builds with correct dependency graph per ARCHITECTURE.md
- SessionRecorder ring buffer handles 10,000 events with overflow eviction
- Recording toggle gates capture; snapshot returns immutable copy
- 7+ tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-02-SUMMARY.md`
</output>
