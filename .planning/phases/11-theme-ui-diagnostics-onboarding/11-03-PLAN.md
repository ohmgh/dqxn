---
phase: 11-theme-ui-diagnostics-onboarding
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/onboarding/build.gradle.kts
  - android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
  - android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryImpl.kt
  - android/data/src/test/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryTest.kt
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/ProgressiveTipManager.kt
  - android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/ProgressiveTipManagerTest.kt
autonomous: true
requirements:
  - F11.1
  - F11.5
  - F12.5

must_haves:
  truths:
    - "UserPreferencesRepository exposes onboarding flags (hasCompletedOnboarding, hasSeenDisclaimer, tip keys)"
    - "ProgressiveTipManager tracks 4 tip types and marks each as seen"
    - "hasCompletedOnboarding defaults to false and persists to true after set"
  artifacts:
    - path: "android/feature/onboarding/build.gradle.kts"
      provides: "Onboarding module build configuration"
    - path: "android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt"
      provides: "Extended interface with onboarding preference flows"
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/ProgressiveTipManager.kt"
      provides: "Tip state tracker for 4 progressive tip types"
  key_links:
    - from: "ProgressiveTipManager.kt"
      to: "UserPreferencesRepository"
      via: "Hilt injection for tip persistence"
      pattern: "UserPreferencesRepository"
    - from: "UserPreferencesRepository.kt"
      to: "OnboardingViewModel (Plan 11-08)"
      via: "hasCompletedOnboarding flow"
      pattern: "hasCompletedOnboarding"
---

<objective>
Set up `:feature:onboarding` build configuration, extend UserPreferencesRepository with onboarding flags, and implement ProgressiveTipManager.

Purpose: Onboarding depends on persistence of first-run state (hasCompletedOnboarding, hasSeenDisclaimer, tip tracking). This plan lays the data foundation and tip tracking logic before composable UI work.

Output: Working `:feature:onboarding` module, extended UserPreferencesRepository, ProgressiveTipManager with tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
@android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryImpl.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Onboarding build config + UserPreferencesRepository extensions</name>
  <files>
    android/feature/onboarding/build.gradle.kts
    android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepository.kt
    android/data/src/main/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryImpl.kt
    android/data/src/test/kotlin/app/dqxn/android/data/preferences/UserPreferencesRepositoryTest.kt
  </files>
  <action>
    1. Update `feature/onboarding/build.gradle.kts`:
    ```kotlin
    plugins { id("dqxn.android.feature") }
    android { namespace = "app.dqxn.android.feature.onboarding" }
    dependencies {
        implementation(project(":data"))
        implementation(project(":core:design"))
        implementation(project(":sdk:analytics"))

        testImplementation(libs.compose.ui.test.junit4)
        debugImplementation(libs.compose.ui.test.manifest)
    }
    ```

    2. Add to `UserPreferencesRepository` interface:
    - `val hasCompletedOnboarding: Flow<Boolean>` (default false)
    - `val hasSeenDisclaimer: Flow<Boolean>` (default false)
    - `suspend fun setHasCompletedOnboarding(completed: Boolean)`
    - `suspend fun setHasSeenDisclaimer(seen: Boolean)`
    - `suspend fun hasSeenTip(tipKey: String): Flow<Boolean>` — reads per-tip preference key
    - `suspend fun markTipSeen(tipKey: String)` — writes per-tip preference key

    3. Implement in `UserPreferencesRepositoryImpl`:
    - Add `PreferenceKeys`: `HAS_COMPLETED_ONBOARDING = booleanPreferencesKey("has_completed_onboarding")`, `HAS_SEEN_DISCLAIMER = booleanPreferencesKey("has_seen_disclaimer")`
    - Tip keys use dynamic key: `booleanPreferencesKey("tip_seen_$tipKey")`
    - All default to false

    4. Add tests to existing `UserPreferencesRepositoryTest.kt`:
    - `default hasCompletedOnboarding is false`
    - `setHasCompletedOnboarding persists true`
    - `default hasSeenDisclaimer is false`
    - `setHasSeenDisclaimer persists true`
    - `hasSeenTip defaults to false for unknown key`
    - `markTipSeen persists true for specific key`
    - `tip keys are independent` — marking tip A doesn't affect tip B
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :data:testDebugUnitTest --tests "*.UserPreferencesRepositoryTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>UserPreferencesRepository has onboarding flows, `:feature:onboarding` compiles, 7 new preference tests pass</done>
</task>

<task type="auto">
  <name>Task 2: ProgressiveTipManager + tests</name>
  <files>
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/ProgressiveTipManager.kt
    android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/ProgressiveTipManagerTest.kt
  </files>
  <action>
    Implement `ProgressiveTipManager` as `@Singleton`:
    ```kotlin
    @Singleton
    class ProgressiveTipManager @Inject constructor(
        private val userPreferencesRepository: UserPreferencesRepository,
    ) {
        companion object {
            const val TIP_FIRST_LAUNCH = "first_launch"
            const val TIP_EDIT_MODE = "edit_mode"
            const val TIP_WIDGET_FOCUS = "widget_focus"
            const val TIP_WIDGET_SETTINGS = "widget_settings"
        }

        fun shouldShowTip(tipKey: String): Flow<Boolean>
        suspend fun dismissTip(tipKey: String)
    }
    ```

    - `shouldShowTip` returns `userPreferencesRepository.hasSeenTip(tipKey).map { !it }` — show if NOT seen
    - `dismissTip` calls `userPreferencesRepository.markTipSeen(tipKey)`

    Create `ProgressiveTipManagerTest.kt` with JUnit5 + MockK:
    1. `shouldShowTip returns true for unseen tip` — mock hasSeenTip returns flow(false)
    2. `shouldShowTip returns false for seen tip` — mock hasSeenTip returns flow(true)
    3. `dismissTip calls markTipSeen` — verify mock interaction
    4. `all 4 tip keys are distinct constants` — assert TIP_FIRST_LAUNCH != TIP_EDIT_MODE != TIP_WIDGET_FOCUS != TIP_WIDGET_SETTINGS
    5. `shouldShowTip reacts to preference changes` — use Turbine, emit false then true on mock flow, verify tip manager reflects changes

    Use `@Tag("fast")` on test class.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:onboarding:testDebugUnitTest --tests "*.ProgressiveTipManagerTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>ProgressiveTipManager delegates to UserPreferencesRepository correctly, all 5 tests pass</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :data:testDebugUnitTest --tests "*.UserPreferencesRepositoryTest" :feature:onboarding:testDebugUnitTest --console=plain
</verification>

<success_criteria>
- `:feature:onboarding` builds with correct dependency graph
- UserPreferencesRepository has 6 new onboarding-related fields/methods
- ProgressiveTipManager tracks 4 tip types
- All tests pass (7 preference + 5 tip manager)
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-03-SUMMARY.md`
</output>
