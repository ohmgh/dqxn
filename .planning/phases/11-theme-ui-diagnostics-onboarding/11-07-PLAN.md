---
phase: 11-theme-ui-diagnostics-onboarding
plan: 07
type: execute
wave: 2
depends_on: ["11-02", "11-04"]
files_modified:
  - android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticsViewModel.kt
  - android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/ProviderHealthDashboard.kt
  - android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/ProviderDetailScreen.kt
  - android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticSnapshotViewer.kt
  - android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/SessionRecorderViewer.kt
  - android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/ObservabilityDashboard.kt
  - android/feature/diagnostics/src/test/kotlin/app/dqxn/android/feature/diagnostics/ProviderHealthDashboardTest.kt
autonomous: true
requirements:
  - F3.13
  - F7.6
  - F13.3

must_haves:
  truths:
    - "Provider Health dashboard renders provider list with staleness indicators"
    - "Provider detail shows connection event log (rolling 50 events)"
    - "Session recorder viewer shows text-based timeline"
    - "DiagnosticSnapshotViewer browses snapshots by type"
  artifacts:
    - path: "android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticsViewModel.kt"
      provides: "Hilt ViewModel aggregating provider statuses, connection events, metrics"
    - path: "android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/ProviderHealthDashboard.kt"
      provides: "Provider list with staleness, connection state, error count"
    - path: "android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/ProviderDetailScreen.kt"
      provides: "Connection event log (F7.6) with retry button"
    - path: "android/feature/diagnostics/src/test/kotlin/app/dqxn/android/feature/diagnostics/ProviderHealthDashboardTest.kt"
      provides: "UI tests for provider list rendering and staleness"
  key_links:
    - from: "DiagnosticsViewModel.kt"
      to: "ProviderStatusProvider"
      via: "Hilt constructor injection"
      pattern: "ProviderStatusProvider"
    - from: "DiagnosticsViewModel.kt"
      to: "ConnectionEventStore"
      via: "Hilt constructor injection"
      pattern: "ConnectionEventStore"
    - from: "ProviderDetailScreen.kt"
      to: "DiagnosticsViewModel"
      via: "connection events flow"
      pattern: "connectionEvents"
---

<objective>
Build diagnostics UI composables: ProviderHealthDashboard, ProviderDetailScreen, DiagnosticSnapshotViewer, SessionRecorderViewer, ObservabilityDashboard, and the DiagnosticsViewModel.

Purpose: Completes `:feature:diagnostics` with all 4 dashboard views reading from existing observability infrastructure (F3.13, F7.6) plus the SessionRecorder from Plan 11-02.

Output: DiagnosticsViewModel + 5 composable screens + ProviderHealthDashboard UI test.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-02-SUMMARY.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: DiagnosticsViewModel + ProviderHealthDashboard + ProviderDetailScreen</name>
  <files>
    android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticsViewModel.kt
    android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/ProviderHealthDashboard.kt
    android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/ProviderDetailScreen.kt
    android/feature/diagnostics/src/test/kotlin/app/dqxn/android/feature/diagnostics/ProviderHealthDashboardTest.kt
  </files>
  <action>
    1. **DiagnosticsViewModel** (`@HiltViewModel`):
       - Inject: `ProviderStatusProvider`, `ConnectionEventStore`, `DiagnosticSnapshotCapture`, `MetricsCollector`, `SessionRecorder`
       - Expose:
         - `providerStatuses: StateFlow<Map<String, ProviderStatus>>` via `stateIn(WhileSubscribed(5_000), emptyMap())`
         - `connectionEvents: StateFlow<ImmutableList<ConnectionEvent>>` via `stateIn(WhileSubscribed(5_000), persistentListOf())`
         - `isRecording: StateFlow<Boolean>` from SessionRecorder
       - Methods: `toggleRecording()`, `getSessionSnapshot(): ImmutableList<SessionEvent>`

    2. **ProviderHealthDashboard** (F3.13):
       - `LazyColumn` of provider status rows
       - Each row: provider name, connection state (green/red dot), last update time (relative: "3s ago", "2m ago"), error description if present
       - Staleness indicator: if `elapsed > 10_000ms` (STALENESS_THRESHOLD), show amber warning icon
       - Tap row → navigate to ProviderDetailScreen
       - Empty state: "No providers registered" text
       - Test tags: `provider_health_list`, `provider_row_{providerId}`, `staleness_indicator_{providerId}`

    3. **ProviderDetailScreen** (F7.6):
       - Provider name + current status header
       - Connection event log (`LazyColumn`): timestamp, event type, details — rolling 50 events from `ConnectionEventStore`
       - "Retry Connection" button at bottom (fires callback to WidgetBindingCoordinator via command)
       - Empty state: "No connection events" text
       - Test tags: `provider_detail`, `connection_event_{index}`, `retry_button`

    4. **ProviderHealthDashboardTest** (Compose UI test):
       - `renders provider list with statuses` — provide 3 mock statuses, verify 3 rows rendered with correct names
       - `staleness indicator shown for stale provider` — provide status with old timestamp, verify staleness semantics
       - `connected provider shows green indicator` — verify connected state renders correctly
       - `empty state shows message` — empty status map, verify "No providers" text
       - `tap navigates to detail` — tap row, verify navigation callback fired

    Use `createAndroidComposeRule<ComponentActivity>` for UI tests.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:diagnostics:testDebugUnitTest --tests "*.ProviderHealthDashboardTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>DiagnosticsViewModel wired, ProviderHealthDashboard renders provider list with staleness, ProviderDetailScreen shows connection log — 5 UI tests pass</done>
</task>

<task type="auto">
  <name>Task 2: DiagnosticSnapshotViewer + SessionRecorderViewer + ObservabilityDashboard</name>
  <files>
    android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/DiagnosticSnapshotViewer.kt
    android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/SessionRecorderViewer.kt
    android/feature/diagnostics/src/main/kotlin/app/dqxn/android/feature/diagnostics/ObservabilityDashboard.kt
  </files>
  <action>
    1. **DiagnosticSnapshotViewer**:
       - Browse snapshots from `DiagnosticSnapshotCapture`
       - Filter chips: ALL, CRASH, ANR, ANOMALY, CHAOS
       - Sorted by timestamp (newest first)
       - Each snapshot row: type badge, timestamp, summary text
       - Tap to expand and show full snapshot details (JSON-like formatted text)
       - Test tags: `snapshot_viewer`, `snapshot_filter_{type}`, `snapshot_row_{index}`

    2. **SessionRecorderViewer** (F13.3):
       - Recording toggle button at top (shows red dot when recording)
       - Text-based timeline: scrollable list of `SessionEvent`s
       - Each event: relative timestamp, type badge (TAP/MOVE/RESIZE/NAVIGATE/etc.), details string
       - "Clear" button to reset buffer
       - Event count display (e.g., "342 / 10,000 events")
       - Test tags: `session_viewer`, `recording_toggle`, `session_event_{index}`, `clear_button`

    3. **ObservabilityDashboard**:
       - Frame time metrics from `MetricsCollector`: P50, P95, P99 display
       - Jank percentage indicator
       - Memory usage display (Runtime.freeMemory / totalMemory)
       - Simple text-based display — no charts at V1
       - Test tags: `observability_dashboard`, `frame_time_p50`, `frame_time_p95`, `jank_percent`

    All three are read-only displays consuming existing observability infrastructure. No new data sources needed. Keep scope minimal per research recommendation.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:diagnostics:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>DiagnosticSnapshotViewer, SessionRecorderViewer, ObservabilityDashboard all compile with correct observability API usage</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:diagnostics:testDebugUnitTest --console=plain
</verification>

<success_criteria>
- DiagnosticsViewModel aggregates all observability data via Hilt injection
- ProviderHealthDashboard renders status list with staleness (5 UI tests pass)
- ProviderDetailScreen shows connection event log (F7.6)
- SessionRecorderViewer shows text timeline with toggle
- All composables compile with correct dependency usage
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-07-SUMMARY.md`
</output>
