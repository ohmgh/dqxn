---
phase: 11-theme-ui-diagnostics-onboarding
plan: 08
type: execute
wave: 2
depends_on: ["11-03"]
files_modified:
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/OnboardingViewModel.kt
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/ProgressiveTip.kt
  - android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowTest.kt
  - android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimerTest.kt
autonomous: true
requirements:
  - F11.1
  - F11.2
  - F11.6
  - F11.7
  - F12.5
  - NF-D3

must_haves:
  truths:
    - "Analytics consent is opt-IN on first launch (shown before data collection begins)"
    - "First-launch disclaimer shown once and dismissable"
    - "First-run flow includes theme selection with free themes only"
    - "Progressive tips shown once per encounter and tracked via preferences"
    - "Permission requests are lazy — not triggered during onboarding splash"
  artifacts:
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/OnboardingViewModel.kt"
      provides: "First-run orchestration ViewModel"
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt"
      provides: "Analytics opt-IN consent step (F12.5)"
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt"
      provides: "Informational-only disclaimer (NF-D3)"
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
      provides: "Paginated onboarding: consent → disclaimer → theme → edit mode tour"
    - path: "android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowTest.kt"
      provides: "Flow navigation tests (page progression, skip, completion)"
    - path: "android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimerTest.kt"
      provides: "Disclaimer display + dismiss tests"
  key_links:
    - from: "OnboardingViewModel.kt"
      to: "UserPreferencesRepository"
      via: "hasCompletedOnboarding, analyticsConsent flows"
      pattern: "hasCompletedOnboarding|setAnalyticsConsent"
    - from: "FirstRunFlow.kt"
      to: "BuiltInThemes"
      via: "freeThemes for theme selection step"
      pattern: "freeThemes"
---

<objective>
Build onboarding flow composables: OnboardingViewModel, AnalyticsConsentStep, FirstLaunchDisclaimer, FirstRunFlow, and ProgressiveTip.

Purpose: Completes `:feature:onboarding` with the full first-run experience (F11.1, F11.2, F12.5, NF-D3). Analytics consent MUST happen before any data collection (PDPA/GDPR compliance). Progressive tips integrate with dashboard composables via ProgressiveTipManager from Plan 11-03.

Output: OnboardingViewModel + 4 composable screens + 2 test files.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-RESEARCH.md
@.planning/phases/11-theme-ui-diagnostics-onboarding/11-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: OnboardingViewModel + AnalyticsConsentStep + FirstLaunchDisclaimer</name>
  <files>
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/OnboardingViewModel.kt
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt
    android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimerTest.kt
  </files>
  <action>
    1. **OnboardingViewModel** (`@HiltViewModel`):
       - Inject: `UserPreferencesRepository`, `AnalyticsTracker`, `BuiltInThemes`
       - Expose:
         - `hasCompletedOnboarding: StateFlow<Boolean>` via stateIn
         - `analyticsConsent: StateFlow<Boolean>` via stateIn
         - `freeThemes: ImmutableList<DashboardThemeDefinition>` from BuiltInThemes.freeThemes
       - Methods:
         - `setAnalyticsConsent(enabled: Boolean)` — follows ordering pattern: if enabling, persist THEN enable tracker; if disabling, disable tracker THEN persist
         - `setHasSeenDisclaimer()` — calls userPreferencesRepository.setHasSeenDisclaimer(true)
         - `completeOnboarding()` — calls userPreferencesRepository.setHasCompletedOnboarding(true)
         - `selectTheme(themeId: String)` — persists selected theme as light or dark theme

    2. **AnalyticsConsentStep** (F12.5):
       - Explains data collected: anonymous usage data, crash reports, performance metrics
       - Explains purpose: improve app quality, no PII
       - Explains rights: revoke anytime in Settings → Data & Privacy
       - Two buttons: "Enable Analytics" (accent) and "Skip" (secondary)
       - "Enable" calls onConsent(true), "Skip" calls onConsent(false)
       - Both advance to next onboarding step
       - Test tags: `analytics_consent_step`, `consent_enable`, `consent_skip`

    3. **FirstLaunchDisclaimer** (NF-D3):
       - Brief text: "Speed, navigation, and speed limit data are for informational purposes only and do not replace dedicated vehicle instruments. Always refer to your vehicle speedometer and posted signs."
       - Single "Got it" dismiss button
       - Test tags: `first_launch_disclaimer`, `disclaimer_dismiss`

    4. **FirstLaunchDisclaimerTest** (Compose UI test):
       - `disclaimer text is displayed` — verify disclaimer text node exists
       - `dismiss button calls callback` — tap "Got it", verify onDismiss called
       - `disclaimer uses correct test tag` — verify `first_launch_disclaimer` tag present

    Use string resources for all user-facing text. Follow DashboardMotion animations.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:onboarding:testDebugUnitTest --tests "*.FirstLaunchDisclaimerTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>OnboardingViewModel orchestrates first-run, AnalyticsConsentStep gates collection, FirstLaunchDisclaimer renders and dismisses — 3 UI tests pass</done>
</task>

<task type="auto">
  <name>Task 2: FirstRunFlow + ProgressiveTip composable + tests</name>
  <files>
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/ProgressiveTip.kt
    android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowTest.kt
  </files>
  <action>
    1. **FirstRunFlow** — paginated onboarding (F11.1, F11.2):
       - 4 steps via `AnimatedContent` with horizontal slide transitions:
         1. AnalyticsConsentStep → advance regardless of choice
         2. FirstLaunchDisclaimer → dismiss to advance
         3. Theme selection — simplified grid of free themes only (from BuiltInThemes.freeThemes). Tap to select. "Continue" button
         4. Edit mode tour — brief "Tap Edit to customize" + "Long-press to move widgets" + "Use corners to resize" explainer cards. "Done" button → completes onboarding
       - Page indicator dots at bottom
       - Back navigation: BackHandler goes to previous page (page > 0) or dismisses (page == 0)
       - On completion: `viewModel.completeOnboarding()` sets flag to prevent re-show
       - NO permission requests in this flow (F11.6 — lazy)

    2. **ProgressiveTip** — reusable tip composable:
       ```kotlin
       @Composable
       fun ProgressiveTip(
           tipKey: String,
           message: String,
           tipManager: ProgressiveTipManager,
           modifier: Modifier = Modifier,
       )
       ```
       - Observes `tipManager.shouldShowTip(tipKey)` flow
       - AnimatedVisibility with expandEnter/expandExit (DashboardMotion)
       - Card with message text and "Got it" dismiss button
       - Dismiss calls `tipManager.dismissTip(tipKey)`
       - Test tags: `tip_$tipKey`, `tip_dismiss_$tipKey`

    3. **FirstRunFlowTest** (Compose UI test):
       - `starts on analytics consent step` — verify consent step visible
       - `advances to disclaimer after consent` — tap skip/enable, verify disclaimer
       - `advances to theme selection after disclaimer` — dismiss disclaimer, verify theme grid
       - `theme selection shows free themes only` — verify free theme count matches BuiltInThemes.freeThemes size
       - `advances to tour after theme selection` — select theme + continue, verify tour step
       - `completing tour marks onboarding done` — finish tour, verify completeOnboarding called
       - `back from page 2 returns to page 1` — navigate to page 2, press back, verify page 1

    Use MockK for ViewModel/ProgressiveTipManager mocking in tests.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:onboarding:testDebugUnitTest --tests "*.FirstRunFlowTest" --console=plain 2>&1 | tail -20</automated>
  </verify>
  <done>FirstRunFlow: 4-step paginated onboarding with free-theme selection, ProgressiveTip reusable component — 7 UI tests pass</done>
</task>

</tasks>

<verification>
cd /Users/ohm/Workspace/dqxn/android && ./gradlew :feature:onboarding:testDebugUnitTest --console=plain
</verification>

<success_criteria>
- FirstRunFlow has 4 steps: consent → disclaimer → theme → tour
- Analytics consent is opt-IN, fires before any collection
- Free themes listed first (F11.2)
- No permission requests in onboarding (F11.6)
- ProgressiveTip dismisses and persists via ProgressiveTipManager
- 10+ tests pass (3 disclaimer + 7 flow)
</success_criteria>

<output>
After completion, create `.planning/phases/11-theme-ui-diagnostics-onboarding/11-08-SUMMARY.md`
</output>
