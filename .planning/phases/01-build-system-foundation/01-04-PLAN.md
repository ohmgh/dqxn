---
phase: 01-build-system-foundation
plan: 04
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - android/build-logic/convention/src/test/kotlin/AndroidLibraryPluginTest.kt
  - android/build-logic/convention/src/test/kotlin/AndroidComposePluginTest.kt
  - android/build-logic/convention/src/test/kotlin/AndroidHiltPluginTest.kt
  - android/build-logic/convention/src/test/kotlin/PackPluginTest.kt
  - android/build-logic/convention/src/test/kotlin/AndroidTestPluginTest.kt
  - android/build-logic/convention/src/test/kotlin/VersionCatalogCompletenessTest.kt
  - .planning/STATE.md
autonomous: true
requirements:
  - F13.10
  - NF27
  - NF28
  - NF35

must_haves:
  truths:
    - "Gradle TestKit validates compileSdk=36, minSdk=31, targetSdk=36 are set by convention plugins"
    - "TestKit validates Compose is enabled in dqxn.android.compose modules and NOT in plain library modules"
    - "TestKit validates dqxn.pack auto-wires all :sdk:* dependencies"
    - "TestKit validates fastTest and composeTest tasks exist with correct tag filtering"
    - "Version catalog completeness assertion confirms all required dependency aliases exist"
    - "Throwaway validations resolve open questions: Proto DataStore + JDK 25, EXTOL SDK, testFixtures, Compose compiler"
    - "Pack stub compiles with empty :codegen:plugin KSP processor"
    - "STATE.md updated with toolchain compatibility results"
  artifacts:
    - path: "android/build-logic/convention/src/test/kotlin/AndroidLibraryPluginTest.kt"
      provides: "TestKit validation of SDK version configuration (NF27, NF28)"
      contains: "minSdk"
    - path: "android/build-logic/convention/src/test/kotlin/AndroidTestPluginTest.kt"
      provides: "TestKit validation of JUnit5 test infrastructure (F13.10)"
      contains: "fastTest"
    - path: "android/build-logic/convention/src/test/kotlin/VersionCatalogCompletenessTest.kt"
      provides: "Assertion that all required dependency aliases exist in version catalog"
      contains: "libs.versions.toml"
  key_links:
    - from: "android/build-logic/convention/src/test/kotlin/PackPluginTest.kt"
      to: "android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt"
      via: "TestKit applies dqxn.pack and verifies :sdk:* dependency wiring"
      pattern: "sdk:contracts"
    - from: ".planning/STATE.md"
      to: "Throwaway validation results"
      via: "Updated Decisions section records Proto/EXTOL/testFixtures/Compose compatibility"
      pattern: "Proto DataStore|EXTOL|testFixtures|Compose"
---

<objective>
Validate convention plugins via Gradle TestKit assertions and resolve all toolchain compatibility open questions via throwaway module experiments. This is the quality gate: if plugins misconfigure SDK versions, tag filtering, or dependency wiring, we catch it here — not 7 phases later.

Purpose: Catch convention plugin misconfigurations early. Resolve JDK 25 / Kotlin 2.3+ / AGP 9 compatibility questions that block future phases. Update STATE.md with findings.
Output: Passing TestKit tests, resolved open questions, updated STATE.md.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/migration/phase-01.md
@.planning/phases/01-build-system-foundation/01-RESEARCH.md
@.planning/phases/01-build-system-foundation/01-01-SUMMARY.md
@.planning/phases/01-build-system-foundation/01-02-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Gradle TestKit tests for convention plugins and version catalog</name>
  <files>
    android/build-logic/convention/src/test/kotlin/AndroidLibraryPluginTest.kt
    android/build-logic/convention/src/test/kotlin/AndroidComposePluginTest.kt
    android/build-logic/convention/src/test/kotlin/AndroidHiltPluginTest.kt
    android/build-logic/convention/src/test/kotlin/PackPluginTest.kt
    android/build-logic/convention/src/test/kotlin/AndroidTestPluginTest.kt
    android/build-logic/convention/src/test/kotlin/VersionCatalogCompletenessTest.kt
  </files>
  <action>
    Write Gradle TestKit-based tests that validate convention plugin behavior. These tests create temporary Gradle projects, apply convention plugins, and assert correct configuration.

    **`AndroidLibraryPluginTest`** (validates NF27, NF28):
    - Test `dqxn_android_library_sets_compileSdk_36`: Create temp project with `dqxn.android.library`, run a custom task that prints `android.compileSdk`, assert output contains `36`
    - Test `dqxn_android_library_sets_minSdk_31`: Assert minSdk = 31
    - Test `dqxn_android_library_does_not_enable_compose`: Assert `buildFeatures.compose` is not enabled (Compose is opt-in)
    - Test `dqxn_android_library_configures_unit_test_options`: Assert `unitTests.isIncludeAndroidResources` is true

    NOTE: TestKit tests for Android plugins are tricky because `GradleRunner` needs the Android SDK. The approach is:
    1. Create the temp project with proper `local.properties` pointing to `ANDROID_HOME`
    2. Include `build-logic` as an included build in the test project's settings
    3. Use a custom Gradle task that prints configuration values (e.g., `tasks.register("printConfig") { doLast { println("compileSdk=${android.compileSdk}") } }`)
    4. Run `GradleRunner.create().withArguments("printConfig").build()` and assert on output

    Alternative approach if full Android plugin application in TestKit is too heavy: Parse the plugin source to verify hardcoded values. But TestKit is preferred because it catches runtime plugin application errors.

    If full TestKit with Android SDK proves infeasible in CI (no SDK), fall back to programmatic assertions that read plugin source code constants. Document the approach used.

    **`AndroidComposePluginTest`**:
    - Test `dqxn_android_compose_enables_compose`: Apply `dqxn.android.library` + `dqxn.android.compose`, verify `buildFeatures.compose = true`
    - Test `dqxn_android_compose_applies_compose_compiler_plugin`: Verify the compose compiler plugin is in the applied plugins list

    **`AndroidHiltPluginTest`**:
    - Test `dqxn_android_hilt_applies_ksp_and_hilt_plugins`: Apply `dqxn.android.library` + `dqxn.android.hilt`, verify both KSP and Hilt plugins are applied
    - Test `dqxn_android_hilt_adds_hilt_dependencies`: Verify hilt-android in implementation and hilt-compiler in ksp configurations

    **`PackPluginTest`** (critical — validates the most complex plugin):
    - Test `dqxn_pack_wires_all_sdk_modules`: Apply `dqxn.pack`, run `:dependencies --configuration debugCompileClasspath`, assert output contains `:sdk:contracts`, `:sdk:common`, `:sdk:ui`, `:sdk:observability`, `:sdk:analytics`
    - Test `dqxn_pack_applies_compose_and_hilt_and_ksp`: Verify all 3 plugins are applied
    - Test `dqxn_pack_applies_serialization`: Verify kotlinx.serialization plugin is applied
    - NOTE: This test needs a multi-module test project setup (temp project with stub :sdk:* modules). This is more complex but validates the real dependency graph.

    **`AndroidTestPluginTest`** (validates F13.10):
    - Test `dqxn_android_test_registers_fastTest_task`: Apply `dqxn.android.library` + `dqxn.android.test`, run `tasks --all`, assert output contains `fastTest`
    - Test `dqxn_android_test_registers_composeTest_task`: Assert output contains `composeTest`
    - Test `dqxn_android_test_configures_junit_platform`: Verify JUnit Platform is configured
    - Ideally: Create a test project with both `@Tag("fast")` and `@Tag("compose")` test methods, run `fastTest`, verify only fast-tagged tests execute. This validates the tag filtering actually works (not just that the task exists). If this level of validation is too complex for TestKit, skip and document as deferred to Phase 2's first real test run.

    **`VersionCatalogCompletenessTest`** (validates NF35 — catalog supports build infrastructure):
    - Parse `gradle/libs.versions.toml` directly (not via Gradle — just file parsing)
    - Assert required version entries exist: `agp`, `kotlin`, `ksp`, `hilt`, `compose-bom`, `coroutines`, `junit`, `mockk`, `truth`, `turbine`, `jqwik`, `robolectric`, `protobuf`, `spotless`, `lint`, `firebase-bom`, `kotlinpoet`, `leakcanary`
    - Assert required library entries exist (spot check critical ones): `hilt-android`, `hilt-compiler`, `compose-runtime`, `junit-jupiter-api`, `junit-vintage-engine`, `kotlinx-collections-immutable`, `datastore-proto`, `datastore-preferences`
    - Assert required plugin entries exist: `android-application`, `android-library`, `ksp`, `hilt`, `compose-compiler`, `serialization`
    - This is a TOML file parsing test — no Gradle runner needed. Use simple string/regex matching on file contents.
  </action>
  <verify>
    <automated>cd android && ./gradlew :build-logic:convention:test --console=plain 2>&amp;1 | tail -10</automated>
  </verify>
  <done>All TestKit tests pass. SDK versions (NF27=minSdk 31, NF28=targetSdk 36) validated. fastTest/composeTest tasks exist (F13.10). Pack dependency wiring validated. Version catalog completeness confirmed.</done>
</task>

<task type="auto">
  <name>Task 2: Run throwaway toolchain validations and update STATE.md</name>
  <files>
    .planning/STATE.md
  </files>
  <action>
    Run throwaway module validations against real modules/stubs to resolve open questions from RESEARCH.md. These are quick go/no-go checks.

    **1. Pack stub compilation with empty KSP processor:**
    ```bash
    cd android && ./gradlew :pack:essentials:compileDebugKotlin --console=plain
    ```
    Expected: Succeeds. KSP with empty `:codegen:plugin` (JVM stub) should be a no-op.
    If fails: The issue is likely cross-platform (Android consumer + JVM processor) stub wiring. Fix the `:codegen:plugin` stub.

    **2. fastTest/composeTest tag filtering validation (F13.10):**
    Verify that `fastTest` and `testDebugUnitTest` produce correct results when run in the same Gradle invocation. This confirms the independent task registration from 01-01 works correctly and that `tasks.withType<Test>()` matches AGP 9's `AndroidUnitTest` variant tasks.
    - Create a temporary test class in any test-enabled module (e.g., `:sdk:common`):
      ```kotlin
      // sdk/common/src/test/kotlin/app/dqxn/android/sdk/common/TagFilteringCheck.kt
      package app.dqxn.android.sdk.common
      import org.junit.jupiter.api.Tag
      import org.junit.jupiter.api.Test
      class TagFilteringCheck {
          @Test @Tag("fast") fun fastTagged() { assert(true) }
          @Test fun untagged() { assert(true) }
      }
      ```
    - Run: `./gradlew :sdk:common:fastTest --console=plain` — should run ONLY `fastTagged`
    - Run: `./gradlew :sdk:common:testDebugUnitTest --console=plain` — should run BOTH tests
    - Run: `./gradlew :sdk:common:fastTest :sdk:common:testDebugUnitTest --console=plain` — both tasks in same invocation, verify fastTest runs 1 test and testDebugUnitTest runs 2 tests
    Expected: Tag isolation works correctly. If `fastTest` runs both tests or `testDebugUnitTest` runs only tagged tests, the independent task registration in `AndroidTestConventionPlugin` needs fixing.
    Delete the temporary test file after validation.

    **3. AGP 9 Compose throwaway validation:**
    Create a temporary Kotlin file in any Compose-enabled module (e.g., `:sdk:ui`):
    ```kotlin
    // sdk/ui/src/main/kotlin/app/dqxn/android/sdk/ui/ComposeCheck.kt
    package app.dqxn.android.sdk.ui
    import androidx.compose.runtime.Composable
    @Composable fun ComposeCheck() { }
    ```
    Run: `./gradlew :sdk:ui:compileDebugKotlin --console=plain`
    Expected: Succeeds — Compose compiler processes the `@Composable` function.
    Delete the file after validation.

    **4. Proto DataStore throwaway validation (JDK 25 + protoc):**
    Create a temporary module or use `:data` stub. Add protobuf plugin and a stub `.proto` file:
    - Temporarily modify `:data/build.gradle.kts` to add `id("com.google.protobuf")` and protobuf configuration
    - Create `data/src/main/proto/test_throwaway.proto` with a simple message
    - Run: `./gradlew :data:compileDebugKotlin --console=plain`
    - Check: Generated Kotlin files present in `data/build/generated/source/proto/`
    Expected: Succeeds. If protoc binary is incompatible with JDK 25, this catches it.
    Revert `:data/build.gradle.kts` and delete the proto file after validation.

    **5. testFixtures throwaway validation:**
    Temporarily modify `:sdk:contracts/build.gradle.kts` to enable test fixtures:
    ```kotlin
    android { testFixtures.enable = true }
    ```
    Create `sdk/contracts/src/testFixtures/kotlin/app/dqxn/android/sdk/contracts/TestHelper.kt`:
    ```kotlin
    package app.dqxn.android.sdk.contracts
    class TestHelper { fun helper() = true }
    ```
    Run: `./gradlew :sdk:contracts:testFixturesClasses --console=plain`
    Expected: Succeeds under AGP 9 with `android.experimental.enableTestFixturesKotlinSupport=true`.
    Revert changes after validation.

    **6. EXTOL SDK throwaway validation:**
    Check if EXTOL SDK is available in any repository. If a Maven coordinate exists:
    - Temporarily add `implementation("sg.gov.lta:extol:X.Y.Z")` to a module
    - Run `./gradlew :module:assembleDebug`
    If the SDK is not publicly available (likely private/government SDK):
    - Record in STATE.md: "EXTOL SDK: Not available in public repositories. sg-erp2 pack deferred until SDK access is obtained."
    - This is a 2-minute check. If the dependency doesn't resolve, that's the answer.

    **7. Full build validation (NF35):**
    Run `./gradlew assembleDebug --console=plain` on the stub project. Time it.
    This validates all convention plugins work together across all 25 modules.

    **8. Update `.planning/STATE.md`:**
    Add results to the Decisions section:
    - Proto DataStore + JDK 25: [PASS/FAIL + details]
    - EXTOL SDK: [PASS/FAIL/NOT_AVAILABLE + details]
    - testFixtures + AGP 9: [PASS/FAIL + whether experimental flag is still needed]
    - Compose compiler + AGP 9: [PASS/FAIL + which mechanism works]
    - Pack stub + empty KSP: [PASS/FAIL]
    - fastTest/composeTest tag isolation: [PASS/FAIL + whether independent Test tasks work or need alternative approach]
    - Clean build time with stubs: [N seconds]

    Update Phase 1 status in the Progress table to "In Progress" or "Complete" based on results.

    CRITICAL: If any throwaway fails, do NOT just record the failure — investigate and fix if possible. The purpose of throwaways is to catch issues NOW, not defer them. Only record as a blocker if the fix requires upstream changes (e.g., protoc binary doesn't support JDK 25 and the only fix is downgrading JDK).

    Clean up ALL throwaway files after validation. No temporary code should remain in the repository.
  </action>
  <verify>
    <automated>cd android && ./gradlew assembleDebug --console=plain 2>&amp;1 | tail -10</automated>
    <manual>Verify STATE.md has been updated with toolchain compatibility results</manual>
  </verify>
  <done>All throwaway validations complete. STATE.md updated with results. Pack stub compiles with empty KSP. Compose compiler works under AGP 9. fastTest tag isolation validated — running fastTest then testDebugUnitTest in same invocation produces correct results. Proto/testFixtures/EXTOL status documented. Full build with stubs succeeds. All throwaway files cleaned up.</done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :build-logic:convention:test --console=plain` — all TestKit tests pass
2. `cd android && ./gradlew assembleDebug --console=plain` — full stub build succeeds
3. `cd android && ./gradlew :pack:essentials:dependencies --configuration debugCompileClasspath --console=plain` — shows all `:sdk:*` modules
4. `cd android && ./gradlew spotlessCheck --console=plain` — formatting clean
5. `.planning/STATE.md` updated with throwaway results
6. No throwaway files remain in the repository
</verification>

<success_criteria>
- TestKit tests validate: compileSdk=36, minSdk=31 (NF27), targetSdk=36 (NF28), fastTest/composeTest exist (F13.10), pack deps wired, version catalog complete
- Full stub build (`assembleDebug`) completes (NF35 — build infrastructure works)
- All throwaway validations resolve open questions from RESEARCH.md
- STATE.md documents all findings
- No temporary files remain
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-system-foundation/01-04-SUMMARY.md`
</output>
