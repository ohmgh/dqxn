---
phase: 01-build-system-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - android/lint-rules/build.gradle.kts
  - android/lint-rules/src/main/kotlin/app/dqxn/android/lint/KaptDetectionDetector.kt
  - android/lint-rules/src/main/kotlin/app/dqxn/android/lint/NoHardcodedSecretsDetector.kt
  - android/lint-rules/src/main/kotlin/app/dqxn/android/lint/ModuleBoundaryViolationDetector.kt
  - android/lint-rules/src/main/kotlin/app/dqxn/android/lint/ComposeInNonUiModuleDetector.kt
  - android/lint-rules/src/main/kotlin/app/dqxn/android/lint/AgenticMainThreadBanDetector.kt
  - android/lint-rules/src/main/kotlin/app/dqxn/android/lint/DqxnIssueRegistry.kt
  - android/lint-rules/src/main/resources/META-INF/services/com.android.tools.lint.client.api.IssueRegistry
  - android/lint-rules/src/test/kotlin/app/dqxn/android/lint/KaptDetectionDetectorTest.kt
  - android/lint-rules/src/test/kotlin/app/dqxn/android/lint/NoHardcodedSecretsDetectorTest.kt
  - android/lint-rules/src/test/kotlin/app/dqxn/android/lint/ModuleBoundaryViolationDetectorTest.kt
  - android/lint-rules/src/test/kotlin/app/dqxn/android/lint/ComposeInNonUiModuleDetectorTest.kt
  - android/lint-rules/src/test/kotlin/app/dqxn/android/lint/AgenticMainThreadBanDetectorTest.kt
autonomous: true
requirements:
  - NF27  # Module boundary + Compose scope enforcement. NF35 removed — kapt detector supports it indirectly but primary NF35 coverage is in 01-01/01-04.

must_haves:
  truths:
    - "KaptDetection fires on any build.gradle.kts applying kapt plugin"
    - "NoHardcodedSecrets fires on API keys, tokens, and credentials in Kotlin source"
    - "ModuleBoundaryViolation fires when pack module imports from :feature:* or :core:*"
    - "ComposeInNonUiModule fires on Compose imports in non-UI modules"
    - "AgenticMainThreadBan fires on Dispatchers.Main usage in agentic command handlers"
    - "All 5 detectors have passing positive AND negative test cases"
  artifacts:
    - path: "android/lint-rules/src/main/kotlin/app/dqxn/android/lint/DqxnIssueRegistry.kt"
      provides: "Lint issue registry registering all 5 detectors"
      contains: "IssueRegistry"
    - path: "android/lint-rules/src/main/kotlin/app/dqxn/android/lint/KaptDetectionDetector.kt"
      provides: "Kapt detection lint rule"
      contains: "KaptDetection"
    - path: "android/lint-rules/src/main/resources/META-INF/services/com.android.tools.lint.client.api.IssueRegistry"
      provides: "Service loader registration for lint issue registry"
      contains: "DqxnIssueRegistry"
  key_links:
    - from: "android/lint-rules/src/main/resources/META-INF/services/com.android.tools.lint.client.api.IssueRegistry"
      to: "android/lint-rules/src/main/kotlin/app/dqxn/android/lint/DqxnIssueRegistry.kt"
      via: "ServiceLoader discovers the registry class"
      pattern: "app\\.dqxn\\.android\\.lint\\.DqxnIssueRegistry"
---

<objective>
Implement all 5 custom lint rules with comprehensive positive/negative unit tests. These rules enforce critical architectural constraints: no KAPT (config cache), no hardcoded secrets, module boundary isolation, Compose compiler scope, and agentic threading safety.

Purpose: Automated enforcement of architectural constraints that would otherwise drift silently. Lint rules are the cheapest form of architectural fitness function.
Output: Lint module with 5 detectors, 10+ test cases, passing `./gradlew :lint-rules:test`.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/migration/phase-01.md
@.planning/phases/01-build-system-foundation/01-RESEARCH.md
@.planning/arch/build-system.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 5 lint detectors and issue registry</name>
  <files>
    android/lint-rules/build.gradle.kts
    android/lint-rules/src/main/kotlin/app/dqxn/android/lint/KaptDetectionDetector.kt
    android/lint-rules/src/main/kotlin/app/dqxn/android/lint/NoHardcodedSecretsDetector.kt
    android/lint-rules/src/main/kotlin/app/dqxn/android/lint/ModuleBoundaryViolationDetector.kt
    android/lint-rules/src/main/kotlin/app/dqxn/android/lint/ComposeInNonUiModuleDetector.kt
    android/lint-rules/src/main/kotlin/app/dqxn/android/lint/AgenticMainThreadBanDetector.kt
    android/lint-rules/src/main/kotlin/app/dqxn/android/lint/DqxnIssueRegistry.kt
    android/lint-rules/src/main/resources/META-INF/services/com.android.tools.lint.client.api.IssueRegistry
  </files>
  <action>
    1. Update `android/lint-rules/build.gradle.kts` (stub exists from Plan 02):
       - Should already have `dqxn.kotlin.jvm` plugin
       - Add dependencies:
         ```kotlin
         dependencies {
             compileOnly(libs.lint.api)
             compileOnly(libs.lint.checks)  // for built-in detector base classes
             testImplementation(libs.lint.api)
             testImplementation(libs.lint.checks)
             testImplementation(libs.lint.tests)
             testImplementation(libs.junit.jupiter.api)
             testRuntimeOnly(libs.junit.jupiter.engine)
         }
         ```
       - Configure `tasks.withType<Test> { useJUnitPlatform() }`
       - Set `jar { manifest { attributes("Lint-Registry-v2" to "app.dqxn.android.lint.DqxnIssueRegistry") } }`

    2. **`KaptDetectionDetector`** — `GradleScanner`:
       - Severity: ERROR. Category: CORRECTNESS.
       - Scope: `Scope.GRADLE_SCOPE`
       - Detection: Override `checkDslPropertyAssignment` — detect `kapt` in dependency configurations. Also check `checkMethodCall` for `plugins { id("kotlin-kapt") }` or `apply plugin: 'kotlin-kapt'`.
       - Message: "KAPT is not allowed — use KSP instead. KAPT breaks Gradle configuration cache."
       - Brief: "KAPT detected — use KSP"

    3. **`NoHardcodedSecretsDetector`** — `SourceCodeScanner` (UastScanner):
       - Severity: ERROR. Category: SECURITY.
       - Scope: `Scope.JAVA_FILE_SCOPE`
       - Detection: Visit string literals in Kotlin/Java source. Flag patterns:
         - Strings matching `(?i)(api[_-]?key|secret[_-]?key|access[_-]?token|auth[_-]?token|client[_-]?secret|private[_-]?key)\\s*=\\s*"[^"]{8,}"` in assignments
         - String constants with suspicious names (API_KEY, SECRET, TOKEN, etc.) containing non-placeholder values (length > 8, not "YOUR_KEY_HERE" style placeholders)
         - Do NOT flag: string resources references, BuildConfig references, test files
       - Message: "Hardcoded secret detected. Use local.properties or secrets plugin instead."

    4. **`ModuleBoundaryViolationDetector`** — `SourceCodeScanner`:
       - Severity: ERROR. Category: CORRECTNESS.
       - Scope: `Scope.JAVA_FILE_SCOPE`
       - Detection: Check import statements. If the current file is in a `pack.*` package:
         - Flag imports from `app.dqxn.android.feature.*` — "Pack modules cannot import from :feature:* modules"
         - Flag imports from `app.dqxn.android.core.*` — "Pack modules cannot import from :core:* modules"
         - Flag imports from `app.dqxn.android.data.*` — "Pack modules cannot import from :data module"
         - ALLOW: `app.dqxn.android.sdk.*`, `app.dqxn.android.pack.*.snapshots.*` (own snapshots)
       - Brief: "Pack module boundary violation"

    5. **`ComposeInNonUiModuleDetector`** — `SourceCodeScanner`:
       - Severity: ERROR. Category: CORRECTNESS.
       - Scope: `Scope.JAVA_FILE_SCOPE`
       - Detection: Check import statements. If the current file is in a module that should NOT have Compose (infer from package: `sdk.contracts`, `sdk.common`, `sdk.observability`, `sdk.analytics`, `core.thermal`, `core.firebase`, `core.agentic`, `data`):
         - Flag imports from `androidx.compose.*` (except `androidx.compose.runtime.Immutable` and `androidx.compose.runtime.Stable` and `androidx.compose.runtime.Composable` in `:sdk:contracts` — those come via compileOnly)
         - Note: This is a heuristic based on package naming. The lint check works because module→package mapping follows the namespace convention.
       - Brief: "Compose import in non-UI module"

    6. **`AgenticMainThreadBanDetector`** — `SourceCodeScanner`:
       - Severity: ERROR. Category: PERFORMANCE.
       - Scope: `Scope.JAVA_FILE_SCOPE`
       - Detection: In files under `core.agentic` package or classes implementing `CommandHandler`:
         - Flag references to `Dispatchers.Main` or `Dispatchers.Main.immediate`
         - Flag `withContext(Dispatchers.Main)`
       - Message: "Dispatchers.Main is banned in agentic command handlers. Use Dispatchers.Default or Dispatchers.IO."
       - Brief: "Main dispatcher in agentic handler"

    7. **`DqxnIssueRegistry`** — extends `IssueRegistry`:
       - Override `issues` to return all 5 issue instances
       - Override `api` to return `CURRENT_API`
       - Override `minApi` to return `CURRENT_API` (latest lint API)

    8. Create `META-INF/services/com.android.tools.lint.client.api.IssueRegistry` file containing:
       `app.dqxn.android.lint.DqxnIssueRegistry`
  </action>
  <verify>
    <automated>cd android && ./gradlew :lint-rules:assemble --console=plain 2>&amp;1 | tail -5</automated>
    <manual>Verify all 5 detector .kt files and the registry file exist</manual>
  </verify>
  <done>All 5 lint detectors compile. Issue registry registers all 5 issues. META-INF service file points to registry class. lint-rules JAR can be produced.</done>
</task>

<task type="auto">
  <name>Task 2: Write lint detector unit tests (positive and negative cases)</name>
  <files>
    android/lint-rules/src/test/kotlin/app/dqxn/android/lint/KaptDetectionDetectorTest.kt
    android/lint-rules/src/test/kotlin/app/dqxn/android/lint/NoHardcodedSecretsDetectorTest.kt
    android/lint-rules/src/test/kotlin/app/dqxn/android/lint/ModuleBoundaryViolationDetectorTest.kt
    android/lint-rules/src/test/kotlin/app/dqxn/android/lint/ComposeInNonUiModuleDetectorTest.kt
    android/lint-rules/src/test/kotlin/app/dqxn/android/lint/AgenticMainThreadBanDetectorTest.kt
  </files>
  <action>
    Write unit tests for all 5 detectors using `LintDetectorTest` base class from `com.android.tools.lint:lint-tests`. Each test class must have both positive (lint fires) and negative (lint does not fire) test cases.

    **`KaptDetectionDetectorTest`:**
    - Positive: `build.gradle.kts` with `kapt("some.dep:artifact:1.0")` → expect error
    - Positive: `build.gradle.kts` with `plugins { id("kotlin-kapt") }` → expect error
    - Negative: `build.gradle.kts` with `ksp("some.dep:artifact:1.0")` → clean

    **`NoHardcodedSecretsDetectorTest`:**
    - Positive: `val API_KEY = "sk-1234567890abcdef"` → expect error
    - Positive: `private const val SECRET_TOKEN = "ghp_abcdefghij1234567890"` → expect error
    - Negative: `val API_KEY = BuildConfig.API_KEY` → clean
    - Negative: `val API_KEY = "YOUR_KEY_HERE"` → clean (placeholder)
    - Negative: test file with hardcoded key → clean (test files excluded)

    **`ModuleBoundaryViolationDetectorTest`:**
    - Positive: File in `app.dqxn.android.pack.essentials.widgets` importing `app.dqxn.android.feature.dashboard.SomeClass` → expect error
    - Positive: File in `app.dqxn.android.pack.essentials` importing `app.dqxn.android.core.design.Theme` → expect error
    - Negative: File in `app.dqxn.android.pack.essentials` importing `app.dqxn.android.sdk.contracts.WidgetRenderer` → clean
    - Negative: File in `app.dqxn.android.feature.dashboard` importing `app.dqxn.android.core.design.Theme` → clean (features CAN import core)

    **`ComposeInNonUiModuleDetectorTest`:**
    - Positive: File in `app.dqxn.android.sdk.common` importing `androidx.compose.material3.Text` → expect error
    - Positive: File in `app.dqxn.android.data` importing `androidx.compose.foundation.layout.Box` → expect error
    - Negative: File in `app.dqxn.android.sdk.ui` importing `androidx.compose.material3.Text` → clean
    - Negative: File in `app.dqxn.android.sdk.contracts` importing `androidx.compose.runtime.Composable` → clean (allowed in contracts)
    - Negative: File in `app.dqxn.android.pack.essentials` importing `androidx.compose.material3.Text` → clean (packs have Compose)

    **`AgenticMainThreadBanDetectorTest`:**
    - Positive: File in `app.dqxn.android.core.agentic` with `withContext(Dispatchers.Main)` → expect error
    - Positive: File in `app.dqxn.android.core.agentic` referencing `Dispatchers.Main.immediate` → expect error
    - Negative: File in `app.dqxn.android.core.agentic` with `withContext(Dispatchers.Default)` → clean
    - Negative: File in `app.dqxn.android.feature.dashboard` with `withContext(Dispatchers.Main)` → clean (only banned in agentic)

    Use `LintDetectorTest`'s `lint().files(kotlin(...)).run().expect(...)` API pattern. Each test method clearly named: `test_[positive|negative]_[scenario]`.
  </action>
  <verify>
    <automated>cd android && ./gradlew :lint-rules:test --console=plain 2>&amp;1 | tail -10</automated>
  </verify>
  <done>All 5 detector test classes pass with both positive and negative cases. `./gradlew :lint-rules:test` exits 0. At least 2 test methods per detector (1 positive, 1 negative minimum — more is better).</done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :lint-rules:test --console=plain` — all tests pass
2. Each detector has at least 1 positive and 1 negative test case
3. Issue registry contains all 5 issues
4. META-INF service file correctly references the registry class
</verification>

<success_criteria>
- `./gradlew :lint-rules:test` passes with 10+ test cases
- All 5 detectors implemented: KaptDetection, NoHardcodedSecrets, ModuleBoundaryViolation, ComposeInNonUiModule, AgenticMainThreadBan
- Each detector catches its violation (positive case) and allows clean code (negative case)
- Issue registry registers all 5 issues
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-system-foundation/01-03-SUMMARY.md`
</output>
