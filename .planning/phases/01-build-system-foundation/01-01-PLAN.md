---
phase: 01-build-system-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/gradlew
  - android/gradlew.bat
  - android/gradle/wrapper/gradle-wrapper.jar
  - android/gradle/wrapper/gradle-wrapper.properties
  - android/gradle.properties
  - android/build.gradle.kts
  - android/gradle/libs.versions.toml
  - android/build-logic/settings.gradle.kts
  - android/build-logic/convention/build.gradle.kts
  - android/build-logic/convention/src/main/kotlin/AndroidApplicationConventionPlugin.kt
  - android/build-logic/convention/src/main/kotlin/AndroidLibraryConventionPlugin.kt
  - android/build-logic/convention/src/main/kotlin/AndroidComposeConventionPlugin.kt
  - android/build-logic/convention/src/main/kotlin/AndroidHiltConventionPlugin.kt
  - android/build-logic/convention/src/main/kotlin/AndroidTestConventionPlugin.kt
  - android/build-logic/convention/src/main/kotlin/AndroidFeatureConventionPlugin.kt
  - android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt
  - android/build-logic/convention/src/main/kotlin/SnapshotConventionPlugin.kt
  - android/build-logic/convention/src/main/kotlin/KotlinJvmConventionPlugin.kt
autonomous: true
requirements:
  - F13.10
  - NF27
  - NF28
  - NF35

must_haves:
  truths:
    - "All 9 convention plugins resolve without error when applied to a project"
    - "Version catalog contains every dependency alias needed through Phase 13"
    - "Convention plugins set compileSdk=36, minSdk=31, targetSdk=36"
    - "dqxn.android.test registers fastTest and composeTest as independent Test tasks (not mutating testDebugUnitTest) with JUnit5 tag filtering"
    - "Build properties enable configuration cache, parallel execution, and KSP incremental"
  artifacts:
    - path: "android/gradle/libs.versions.toml"
      provides: "Complete version catalog for all 13 phases"
      contains: "agp = "
    - path: "android/build-logic/convention/build.gradle.kts"
      provides: "Convention plugin project with all AGP/KGP/KSP/Hilt/Compose plugin API dependencies"
      contains: "gradlePlugin"
    - path: "android/build-logic/convention/src/main/kotlin/AndroidTestConventionPlugin.kt"
      provides: "JUnit5 platform configuration + fastTest/composeTest tag-filtered tasks"
      contains: "fastTest"
    - path: "android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt"
      provides: "Pack convention plugin auto-wiring all :sdk:* deps"
      contains: "sdk:contracts"
    - path: "android/gradle.properties"
      provides: "Build performance configuration"
      contains: "org.gradle.configuration-cache=true"
  key_links:
    - from: "android/build-logic/convention/build.gradle.kts"
      to: "android/gradle/libs.versions.toml"
      via: "compileOnly dependencies referencing plugin libraries from version catalog"
      pattern: "compileOnly.*libs\\."
    - from: "android/build-logic/convention/src/main/kotlin/AndroidLibraryConventionPlugin.kt"
      to: "AGP LibraryExtension"
      via: "extensions.configure<LibraryExtension> setting compileSdk/minSdk"
      pattern: "compileSdk.*=.*36"
---

<objective>
Create the Gradle build infrastructure: wrapper, root build files, complete version catalog, gradle.properties, and all 9 convention plugins. This is the foundation every module and every subsequent phase depends on.

Purpose: Nothing compiles without this. Convention plugins enforce SDK versions (NF27, NF28), build performance (NF35), and test infrastructure (F13.10) across all modules.
Output: Buildable `build-logic/convention` module with all plugins registered, complete `libs.versions.toml`, configured `gradle.properties`.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/migration/phase-01.md
@.planning/phases/01-build-system-foundation/01-RESEARCH.md
@.planning/arch/build-system.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gradle wrapper, root build files, version catalog, and gradle.properties</name>
  <files>
    android/gradlew
    android/gradlew.bat
    android/gradle/wrapper/gradle-wrapper.jar
    android/gradle/wrapper/gradle-wrapper.properties
    android/gradle.properties
    android/build.gradle.kts
    android/gradle/libs.versions.toml
    android/build-logic/settings.gradle.kts
    android/build-logic/convention/build.gradle.kts
  </files>
  <action>
    1. Create the `android/` directory structure. Run `gradle wrapper --gradle-version 9.3.1` from `android/` (or download wrapper files if Gradle not installed locally).

    2. Create `android/gradle.properties` with ALL of these properties:
       - `org.gradle.caching=true`
       - `org.gradle.configuration-cache=true`
       - `org.gradle.parallel=true`
       - `org.gradle.jvmargs=-Xmx4g -XX:+UseZGC`
       - `ksp.incremental=true`
       - `android.useAndroidX=true`
       - `android.nonTransitiveRClass=true`
       - `android.experimental.enableTestFixturesKotlinSupport=true` (safety flag — may be stable in AGP 9 but harmless if so)
       - `android.defaults.buildfeatures.buildconfig=false` (opt-in per module via convention plugin)
       - Do NOT set `org.gradle.java.home` — convention plugins use `jvmToolchain(25)` instead

    3. Create `android/build.gradle.kts` — root project. Apply no plugins at root level. Use `plugins { alias(...) apply false }` for all plugins that convention plugins will apply (AGP, Kotlin serialization, Hilt, KSP, Compose compiler, Spotless, android-junit). This ensures Gradle resolves plugin classpath once at root.

    4. Create `android/gradle/libs.versions.toml` — COMPLETE version catalog covering ALL phases (Phase 1-13). Categories:
       - **[versions]**: agp (9.0.1), kotlin (discover latest stable 2.3.x at implementation time — if 2.3.x not yet stable, use latest 2.2.x AGP supports), ksp (matching Kotlin version, e.g., 2.3.0-2.0.2), hilt (2.59.2), compose-bom (latest 2026.xx.xx), coroutines (1.10.x+), spotless (latest 6.x), mannodermaus-junit (2.0.1), protobuf-plugin (0.9.6), kotlinx-serialization (matching Kotlin), kotlinx-collections-immutable (0.3.8+), mockk (1.13.14+), truth (1.4.2+), turbine (1.2.0+), jqwik (1.9.3), robolectric (4.16.1+), leakcanary (latest), firebase-bom (latest), lint (major = AGP major + 23, so 32.x), kotlinpoet (1.18.1+), play-services-location (latest), window (latest — foldable APIs)
       - **[libraries]**: All library entries. Include plugin libraries for build-logic consumption (e.g., `android-gradlePlugin = { group = "com.android.tools.build", name = "gradle", version.ref = "agp" }`). Include `compose-runtime` standalone (for `:sdk:contracts` compileOnly). Include JUnit BOM, jupiter-api, jupiter-engine, jupiter-params, vintage-engine. Include datastore-proto, datastore-preferences, protobuf-kotlin-lite, protoc.
       - **[plugins]**: Plugin aliases for root build.gradle.kts `apply false` declarations.

    5. Create `android/build-logic/settings.gradle.kts`:
       ```kotlin
       dependencyResolutionManagement {
           repositories {
               google()
               mavenCentral()
               gradlePluginPortal()
           }
           versionCatalogs {
               create("libs") {
                   from(files("../gradle/libs.versions.toml"))
               }
           }
       }
       rootProject.name = "build-logic"
       include(":convention")
       ```

    6. Create `android/build-logic/convention/build.gradle.kts`:
       - Apply `kotlin-dsl` plugin
       - Set `java { toolchain { languageVersion = JavaLanguageVersion.of(25) } }` (or appropriate JDK for Gradle daemon)
       - Add `compileOnly` dependencies for ALL plugin APIs convention plugins need: AGP gradle plugin, Kotlin gradle plugin, Compose compiler gradle plugin, KSP gradle plugin, Hilt gradle plugin, android-junit gradle plugin, Spotless gradle plugin, Kotlin serialization gradle plugin
       - Register all 9 plugins in `gradlePlugin { plugins { ... } }` block with IDs: `dqxn.android.application`, `dqxn.android.library`, `dqxn.android.compose`, `dqxn.android.hilt`, `dqxn.android.test`, `dqxn.android.feature`, `dqxn.pack`, `dqxn.snapshot`, `dqxn.kotlin.jvm`
       - Add `testImplementation` for Gradle TestKit, JUnit5, Truth (for Plan 04's tests — but the dependency is declared now)

    CRITICAL AGP 9 NOTES:
    - Do NOT apply `org.jetbrains.kotlin.android` anywhere — AGP 9 manages Kotlin
    - Use unparameterized `CommonExtension` — type parameters removed in AGP 9
    - Use `kotlin { compilerOptions {} }` not `android.kotlinOptions {}`
    - Hilt version MUST be 2.59.1+ (ComponentTreeDeps bug fix)
    - Spotless + ktfmt: use `ktfmt()` without explicit version to let Spotless choose compatible bundled version, OR pin to a version known compatible with the Spotless version used. Check Spotless changelog.
  </action>
  <verify>
    <automated>cd android && ./gradlew :build-logic:convention:assemble --console=plain 2>&amp;1 | tail -5</automated>
    <manual>Verify libs.versions.toml has entries for agp, kotlin, ksp, hilt, compose-bom, coroutines, junit, mockk, truth, turbine, jqwik, protobuf, firebase-bom, spotless, lint</manual>
  </verify>
  <done>build-logic/convention compiles. Version catalog has all dependency entries for Phases 1-13. gradle.properties has config cache + parallel + KSP incremental enabled. Gradle wrapper is 9.3.1.</done>
</task>

<task type="auto">
  <name>Task 2: Implement all 9 convention plugins</name>
  <files>
    android/build-logic/convention/src/main/kotlin/AndroidApplicationConventionPlugin.kt
    android/build-logic/convention/src/main/kotlin/AndroidLibraryConventionPlugin.kt
    android/build-logic/convention/src/main/kotlin/AndroidComposeConventionPlugin.kt
    android/build-logic/convention/src/main/kotlin/AndroidHiltConventionPlugin.kt
    android/build-logic/convention/src/main/kotlin/AndroidTestConventionPlugin.kt
    android/build-logic/convention/src/main/kotlin/AndroidFeatureConventionPlugin.kt
    android/build-logic/convention/src/main/kotlin/PackConventionPlugin.kt
    android/build-logic/convention/src/main/kotlin/SnapshotConventionPlugin.kt
    android/build-logic/convention/src/main/kotlin/KotlinJvmConventionPlugin.kt
  </files>
  <action>
    Implement all 9 convention plugins as Kotlin class-based plugins. Each implements `Plugin<Project>`. Use `project.extensions.getByType<VersionCatalogsExtension>().named("libs")` for programmatic catalog access.

    **`AndroidApplicationConventionPlugin` (`dqxn.android.application`):**
    - Apply `com.android.application`
    - Configure `ApplicationExtension`: compileSdk=36, minSdk=31, targetSdk=36
    - `jvmToolchain(25)` via `extensions.configure<KotlinAndroidProjectExtension>`
    - Enable `buildConfig = true` via `buildFeatures`
    - Configure release build type: `isMinifyEnabled = true`, `isShrinkResources = true`, proguard `proguard-android-optimize.txt` + project-level `proguard-rules.pro`
    - Apply `dqxn.android.compose` (application always has Compose)

    **`AndroidLibraryConventionPlugin` (`dqxn.android.library`):**
    - Apply `com.android.library`
    - Configure `LibraryExtension`: compileSdk=36, minSdk=31
    - `jvmToolchain(25)` via `extensions.configure<KotlinAndroidProjectExtension>`
    - `testOptions { unitTests.isIncludeAndroidResources = true; unitTests.isReturnDefaultValues = true }`
    - Does NOT enable Compose — that's opt-in via `dqxn.android.compose`

    **`AndroidComposeConventionPlugin` (`dqxn.android.compose`):**
    - Apply `org.jetbrains.kotlin.plugin.compose` — still required with AGP 9
    - Configure `CommonExtension` (unparameterized): `buildFeatures { compose = true }`
    - Add Compose BOM + core deps via catalog: compose-ui, compose-ui-graphics, compose-material3, compose-ui-tooling-preview (implementation), compose-ui-tooling (debugImplementation)
    - Configure `ComposeCompilerGradlePluginExtension`: `stabilityConfigurationFile` → `rootProject.layout.projectDirectory.file("sdk/common/compose_compiler_config.txt")`. `reportsDestination` → `layout.buildDirectory.dir("compose_compiler")`
    - Create an empty `android/sdk/common/compose_compiler_config.txt` placeholder file

    **`AndroidHiltConventionPlugin` (`dqxn.android.hilt`):**
    - Apply `com.google.devtools.ksp` and `com.google.dagger.hilt.android`
    - Add `implementation(hilt-android)` and `ksp(hilt-compiler)` from catalog

    **`AndroidTestConventionPlugin` (`dqxn.android.test`):** (addresses F13.10)
    - Apply `de.mannodermaus.android-junit` (plugin ID: `de.mannodermaus.android-junit`)
    - Add test dependencies from catalog: junit-bom (platform), junit-jupiter-api, junit-jupiter-params (testImplementation), junit-jupiter-engine, junit-vintage-engine (testRuntimeOnly), mockk, truth, turbine, coroutines-test, robolectric, jqwik (testImplementation)
    - Configure ALL `Test` tasks: `useJUnitPlatform()`, structured output to `layout.buildDirectory.dir("test-results/${name}")`
    - Register `fastTest` and `composeTest` as genuinely independent `Test` tasks — NOT wrappers that mutate `testDebugUnitTest`. The approach:

      Use `androidComponents.onVariants` to intercept the debug unit test variant, then register new `Test` tasks that clone the classpath from the debug unit test task but apply their own tag filter. Concretely:

      ```kotlin
      // After the project is evaluated, AGP has registered testDebugUnitTest.
      // Use afterEvaluate ONLY for task wiring (not configuration), or better:
      // use tasks.named to lazily reference testDebugUnitTest's properties.
      plugins.withId("com.android.library") {
          val debugTestTask = tasks.named<Test>("testDebugUnitTest")

          tasks.register<Test>("fastTest") {
              description = "Run only @Tag(\"fast\") tests"
              group = "verification"
              // Clone classpath and source from debug unit test
              classpath = debugTestTask.get().classpath
              testClassesDirs = debugTestTask.get().testClassesDirs
              // Independent JUnit Platform config with tag filter
              useJUnitPlatform { includeTags("fast") }
              reports.junitXml.outputLocation.set(
                  layout.buildDirectory.dir("test-results/fastTest")
              )
          }

          tasks.register<Test>("composeTest") {
              description = "Run only @Tag(\"compose\") tests"
              group = "verification"
              classpath = debugTestTask.get().classpath
              testClassesDirs = debugTestTask.get().testClassesDirs
              useJUnitPlatform { includeTags("compose") }
              reports.junitXml.outputLocation.set(
                  layout.buildDirectory.dir("test-results/composeTest")
              )
          }
      }
      // Also handle com.android.application variant:
      plugins.withId("com.android.application") {
          // Same pattern — register fastTest/composeTest copying from testDebugUnitTest
      }
      ```

      CRITICAL: These are independent `Test` task instances with their OWN `useJUnitPlatform` configuration. Running `fastTest` then `testDebugUnitTest` in the same Gradle invocation MUST produce correct results — `fastTest` runs only fast-tagged tests, `testDebugUnitTest` runs all tests. If `tasks.named<Test>` does not resolve AGP 9's `AndroidUnitTest` (which extends `Test`), use `tasks.named("testDebugUnitTest")` with an untyped reference and cast inside the configuration block. The key constraint is: the default `testDebugUnitTest` task's `useJUnitPlatform {}` block must NEVER be mutated by `fastTest`/`composeTest` registration.

    **`AndroidFeatureConventionPlugin` (`dqxn.android.feature`):**
    - Apply `dqxn.android.library`, `dqxn.android.compose`, `dqxn.android.hilt`, `dqxn.android.test`
    - Auto-wire: `:sdk:contracts`, `:sdk:common`, `:sdk:ui`, `:sdk:observability` (implementation)
    - Add: lifecycle-runtime-compose, lifecycle-viewmodel-compose, hilt-navigation-compose, navigation-compose from catalog

    **`PackConventionPlugin` (`dqxn.pack`):**
    - Apply `dqxn.android.library`, `dqxn.android.compose`, `dqxn.android.hilt`, `dqxn.android.test`
    - Apply `com.google.devtools.ksp` (additional, beyond what hilt adds) and `org.jetbrains.kotlin.plugin.serialization`
    - Auto-wire ALL `:sdk:*` deps: `:sdk:contracts`, `:sdk:common`, `:sdk:ui`, `:sdk:observability`, `:sdk:analytics` (implementation)
    - Add `ksp(project(":codegen:plugin"))` for @DashboardWidget/@DashboardDataProvider processing
    - Add `implementation(kotlinx-collections-immutable)`, `implementation(kotlinx-coroutines-core)`, `implementation(kotlinx-serialization-json)`
    - Configure KSP args: `themesDir` → `"${projectDir}/src/main/resources/themes/"` (no afterEvaluate — use `extensions.configure<KspExtension>`)

    **`SnapshotConventionPlugin` (`dqxn.snapshot`):**
    - Apply `dqxn.android.library` (Android library container — required for `api()` scope with Android library `:sdk:contracts`)
    - Add `api(project(":sdk:contracts"))` as the ONLY project dependency
    - Does NOT apply Compose compiler, Hilt, KSP, or serialization
    - No test plugin either — snapshot modules contain only data classes

    **`KotlinJvmConventionPlugin` (`dqxn.kotlin.jvm`):**
    - Apply `org.jetbrains.kotlin.jvm`
    - Set `jvmToolchain(25)` via `kotlin { jvmToolchain(25) }` extension
    - No Android, no Compose, no Hilt
    - Used by `:codegen:plugin` and `:codegen:agentic`

    CRITICAL: Use `extensions.configure<KotlinAndroidProjectExtension>` (not `KotlinProjectExtension`) for Android modules. Use `extensions.configure<KotlinJvmProjectExtension>` for JVM modules. These are the AGP 9 Kotlin extension types.
  </action>
  <verify>
    <automated>cd android && ./gradlew :build-logic:convention:assemble --console=plain 2>&amp;1 | tail -5</automated>
    <manual>Verify all 9 .kt files exist in build-logic/convention/src/main/kotlin/ and contain Plugin&lt;Project&gt; implementations</manual>
  </verify>
  <done>All 9 convention plugins compile. AndroidTestConventionPlugin registers fastTest and composeTest as independent Test tasks with their own useJUnitPlatform tag filters — NOT mutating testDebugUnitTest (F13.10). Running `fastTest` then `testDebugUnitTest` in the same Gradle invocation must produce correct tag-isolated vs all-tests results. AndroidLibrary/Application plugins set minSdk=31 (NF27) and targetSdk=36 (NF28). gradle.properties configures build performance properties (NF35).</done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :build-logic:convention:assemble --console=plain` — convention plugin project compiles
2. All 9 plugin classes exist and implement `Plugin<Project>`
3. `libs.versions.toml` contains entries for every library/plugin needed through Phase 13
4. `gradle.properties` has `org.gradle.configuration-cache=true`, `org.gradle.parallel=true`, `ksp.incremental=true`
5. No `org.jetbrains.kotlin.android` plugin applied anywhere
</verification>

<success_criteria>
- build-logic/convention assembles without errors
- All 9 convention plugins are registered with correct IDs in gradlePlugin block
- Version catalog is complete (all phases covered)
- gradle.properties enables config cache, parallel builds, KSP incremental
- AndroidTestConventionPlugin has fastTest/composeTest task registration (F13.10)
- SDK versions hardcoded: compileSdk=36, minSdk=31, targetSdk=36 (NF27, NF28)
</success_criteria>

<output>
After completion, create `.planning/phases/01-build-system-foundation/01-01-SUMMARY.md`
</output>
