---
phase: 06-deployable-app-agentic-framework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/core/agentic/build.gradle.kts
  - android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/AgenticCommand.kt
  - android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/CommandHandler.kt
  - android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/CommandParams.kt
  - android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/CommandResult.kt
  - android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/AgenticCommandRouter.kt
  - android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/SemanticsOwnerHolder.kt
  - android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/SemanticsSnapshot.kt
  - android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/SemanticsFilter.kt
  - android/core/agentic/src/test/kotlin/app/dqxn/android/core/agentic/AgenticCommandRouterTest.kt
  - android/core/agentic/src/test/kotlin/app/dqxn/android/core/agentic/SemanticsOwnerHolderTest.kt
autonomous: true
requirements: [F13.2, F13.11]

must_haves:
  truths:
    - "AgenticCommandRouter routes named commands to correct handlers"
    - "Unknown command returns structured error JSON"
    - "SemanticsOwnerHolder provides access to Compose semantics tree when registered"
    - "SemanticsOwnerHolder returns empty/null when no owner registered (safe pre-Phase 7)"
  artifacts:
    - path: "android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/AgenticCommand.kt"
      provides: "@AgenticCommand annotation with SOURCE retention"
      contains: "@Retention(AnnotationRetention.SOURCE)"
    - path: "android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/CommandHandler.kt"
      provides: "Handler interface matching codegen:agentic stubs"
      contains: "interface CommandHandler"
    - path: "android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/AgenticCommandRouter.kt"
      provides: "Router dispatching commands by name"
      contains: "class AgenticCommandRouter"
    - path: "android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/SemanticsOwnerHolder.kt"
      provides: "Singleton holder for Compose semantics tree access"
      contains: "class SemanticsOwnerHolder"
  key_links:
    - from: "android/core/agentic/src/main/kotlin/.../AgenticCommandRouter.kt"
      to: "android/core/agentic/src/main/kotlin/.../CommandHandler.kt"
      via: "Set<CommandHandler> constructor injection, associateBy { it.name }"
      pattern: "Set<.*CommandHandler>"
    - from: "android/codegen/agentic/src/main/kotlin/.../AgenticProcessor.kt"
      to: "android/core/agentic/src/main/kotlin/.../AgenticCommand.kt"
      via: "FQN string reference in KSP processor"
      pattern: "app.dqxn.android.core.agentic.AgenticCommand"
---

<objective>
Create the `:core:agentic` module infrastructure: `@AgenticCommand` annotation, `CommandHandler` interface, `AgenticCommandRouter`, `CommandParams`/`CommandResult` types, and `SemanticsOwnerHolder` for Compose semantics tree access.

Purpose: Provides the real annotation and handler interface that `:codegen:agentic` KSP processor already references (currently compile-testing stubs only). Enables ADB-driven automation and semantics-based UI verification for all subsequent phases.

Output: Compilable `:core:agentic` module with tested command routing and semantics access infrastructure.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-deployable-app-agentic-framework/06-RESEARCH.md
@android/codegen/agentic/src/test/kotlin/app/dqxn/android/codegen/agentic/AgenticStubs.kt
@android/codegen/agentic/src/main/kotlin/app/dqxn/android/codegen/agentic/AgenticProcessor.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core agentic types and AgenticCommandRouter</name>
  <files>
    android/core/agentic/build.gradle.kts
    android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/AgenticCommand.kt
    android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/CommandHandler.kt
    android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/CommandParams.kt
    android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/CommandResult.kt
    android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/AgenticCommandRouter.kt
    android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/SemanticsOwnerHolder.kt
    android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/SemanticsSnapshot.kt
    android/core/agentic/src/main/kotlin/app/dqxn/android/core/agentic/SemanticsFilter.kt
  </files>
  <action>
    Update `core/agentic/build.gradle.kts`:
    - Add dependencies: `implementation(project(":sdk:observability"))`, `implementation(project(":sdk:common"))`, `implementation(libs.kotlinx.serialization.json)`, `implementation(libs.kotlinx.collections.immutable)`, `compileOnly(libs.compose.ui)` (for SemanticsOwner reference), `compileOnly(libs.compose.ui.test)` (for RootForTest)
    - Note: This module uses `dqxn.android.library` + `dqxn.android.hilt` + `dqxn.android.test` (already present)

    Create `AgenticCommand.kt` — Package: `app.dqxn.android.core.agentic`
    - `@Retention(AnnotationRetention.SOURCE)` `@Target(AnnotationTarget.CLASS)` annotation
    - Properties: `name: String`, `description: String`, `category: String = ""`
    - MUST match the stub shape in `codegen/agentic/src/test/.../AgenticStubs.kt` exactly (name, description, category fields)

    Create `CommandHandler.kt` — interface matching codegen stubs:
    - Properties: `val name: String`, `val description: String`, `val category: String`, `val aliases: List<String>`
    - `suspend fun execute(params: CommandParams, commandId: String): CommandResult`
    - `fun paramsSchema(): Map<String, String>` (parameter name -> description)
    - **Signature rationale:** Two-parameter `execute(params, commandId)` is the chosen shape, consistent with the codegen stubs which define `execute(params: Any, commandId: String): Any`. The `commandId` is passed by the router (extracted from `params.traceId`) and enables per-invocation tracing. Research sketch used one parameter but stubs were finalized with two — stubs are truth.
    - Note: The codegen stubs use `Any` params/return. The real interface uses typed `CommandParams`/`CommandResult`. The KSP processor references FQN strings only and generates @Binds with CommandHandler interface type — the method signatures in generated code are inherited, so this mismatch is safe.

    Create `CommandParams.kt`:
    - `data class CommandParams(val raw: Map<String, String> = emptyMap(), val traceId: String)`
    - Extension: `fun CommandParams.getString(key: String): String?` = raw[key]
    - Extension: `fun CommandParams.requireString(key: String): String` = raw[key] ?: throw IllegalArgumentException("Missing required param: $key")

    Create `CommandResult.kt`:
    - `sealed interface CommandResult`
    - `data class Success(val data: String) : CommandResult` — data is JSON string
    - `data class Error(val message: String, val code: String = "UNKNOWN") : CommandResult`
    - Extension: `fun CommandResult.toJson(): String` — serializes to `{"status":"ok","data":...}` or `{"status":"error","message":"...","code":"..."}`

    Create `AgenticCommandRouter.kt`:
    - `class AgenticCommandRouter @Inject constructor(private val handlers: Set<@JvmSuppressWildcards CommandHandler>)`
    - `private val handlerMap: Map<String, CommandHandler> by lazy { handlers.associateBy { it.name } }`
    - `suspend fun route(method: String, params: CommandParams): String` — looks up handler, calls `handler.execute(params, params.traceId)`, wraps result in `toJson()`. Unknown command returns error JSON. The `commandId` parameter to `execute()` is `params.traceId` — the router extracts and forwards it.
    - Catch exceptions from handler.execute() and wrap in error result with exception message.
    - Internal — NOT exported to pack modules.

    Create `SemanticsOwnerHolder.kt`:
    - `@Singleton class SemanticsOwnerHolder @Inject constructor()`
    - Uses `WeakReference` to hold semantics owner (not strong reference — avoids memory leak per research Pitfall 6)
    - `fun register(owner: Any)` — stores WeakReference. Owner is typed as `Any` to avoid hard compile dep on compose.ui.test at runtime.
    - `fun unregister()` — clears reference
    - `fun snapshot(): SemanticsSnapshot?` — captures current semantics tree if owner available, null otherwise
    - `fun query(filter: SemanticsFilter): List<SemanticsSnapshot.Node>` — filtered query
    - Thread-safe via `@Volatile` + synchronized for register/unregister.

    Create `SemanticsSnapshot.kt`:
    - `@Serializable data class SemanticsSnapshot(val nodes: ImmutableList<Node>, val capturedAtMs: Long)`
    - `@Serializable data class Node(val id: Int, val testTag: String?, val text: String?, val contentDescription: String?, val bounds: Bounds?, val children: ImmutableList<Node>, val actions: ImmutableList<String>)`
    - `@Serializable data class Bounds(val left: Float, val top: Float, val right: Float, val bottom: Float)`

    Create `SemanticsFilter.kt`:
    - `data class SemanticsFilter(val testTag: String? = null, val text: String? = null, val contentDescription: String? = null, val hasAction: String? = null)`
    - `fun SemanticsFilter.matches(node: SemanticsSnapshot.Node): Boolean` — checks all non-null fields match
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :core:agentic:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
    <manual>Verify AgenticCommand annotation matches codegen stubs shape (name, description, category)</manual>
    <sampling_rate>run after task commits</sampling_rate>
  </verify>
  <done>`:core:agentic` compiles with all 9 source files. @AgenticCommand annotation, CommandHandler interface, AgenticCommandRouter, SemanticsOwnerHolder, and supporting types all defined.</done>
</task>

<task type="auto">
  <name>Task 2: AgenticCommandRouter and SemanticsOwnerHolder unit tests</name>
  <files>
    android/core/agentic/src/test/kotlin/app/dqxn/android/core/agentic/AgenticCommandRouterTest.kt
    android/core/agentic/src/test/kotlin/app/dqxn/android/core/agentic/SemanticsOwnerHolderTest.kt
  </files>
  <action>
    Create `AgenticCommandRouterTest.kt`:
    - JUnit5 test class with @Tag("fast")
    - Create a `FakeCommandHandler` implementing CommandHandler with configurable behavior
    - Test: single handler registered, route by name -> success result
    - Test: unknown command name -> error JSON with "Unknown command: xyz"
    - Test: handler throws exception -> error JSON with exception message
    - Test: empty handler set -> all commands return unknown error
    - Test: multiple handlers with distinct names -> correct dispatch
    - Test: trace ID propagated to handler
    - Use `runTest { }` for coroutine tests

    Create `SemanticsOwnerHolderTest.kt`:
    - JUnit5 test class with @Tag("fast")
    - Test: snapshot() returns null when no owner registered
    - Test: query() returns empty list when no owner registered
    - Test: register/unregister lifecycle (register -> unregister -> snapshot returns null)
    - Note: Can't easily test actual SemanticsOwner capture without Compose test runtime. Test the null/empty paths and register/unregister state management.
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :core:agentic:testDebugUnitTest --console=plain 2>&1 | tail -10</automated>
    <sampling_rate>run after task commits</sampling_rate>
  </verify>
  <done>All AgenticCommandRouter tests pass (route success, unknown command error, exception handling, trace propagation). SemanticsOwnerHolder tests pass (null safety, lifecycle). Test XML present in build/test-results/.</done>
</task>

</tasks>

<verification>
1. `./gradlew :core:agentic:compileDebugKotlin --console=plain` succeeds
2. `./gradlew :core:agentic:testDebugUnitTest --console=plain` passes all tests
3. `@AgenticCommand` annotation shape matches `codegen/agentic` stubs (name, description, category fields)
4. `CommandHandler` interface compatible with KSP-generated `@Binds @IntoSet` module
</verification>

<success_criteria>
- `:core:agentic` compiles and all unit tests pass
- AgenticCommandRouter correctly dispatches to handlers by name
- SemanticsOwnerHolder safely handles absent/present semantics owner
- Types are compatible with `:codegen:agentic` KSP processor expectations
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployable-app-agentic-framework/06-01-SUMMARY.md`
</output>
