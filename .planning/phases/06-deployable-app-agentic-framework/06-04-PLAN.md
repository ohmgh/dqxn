---
phase: 06-deployable-app-agentic-framework
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/FrameStatsOverlay.kt
  - android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/WidgetHealthOverlay.kt
  - android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/ThermalTrendingOverlay.kt
  - android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
  - .planning/phases/06-deployable-app-agentic-framework/VALIDATION-PIPELINE.md
autonomous: true
requirements: [F13.4, F13.5, F13.9, NF21, NF22]

must_haves:
  truths:
    - "assembleRelease succeeds without ClassNotFoundException for KSP/proto-generated classes"
    - "Debug overlays compose without crashing when toggled on with empty state"
    - "Release APK contains zero agentic code (ContentProvider, handlers, overlays absent)"
    - "Tiered validation pipeline documented for agentic development workflow"
  artifacts:
    - path: "android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/FrameStatsOverlay.kt"
      provides: "Frame timing debug overlay composable"
      contains: "@Composable"
    - path: "android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/WidgetHealthOverlay.kt"
      provides: "Widget health debug overlay composable"
      contains: "@Composable"
    - path: "android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/ThermalTrendingOverlay.kt"
      provides: "Thermal trending debug overlay composable"
      contains: "@Composable"
    - path: "android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt"
      provides: "No-op release module (empty, reserves namespace)"
      contains: "@InstallIn(SingletonComponent::class)"
    - path: ".planning/phases/06-deployable-app-agentic-framework/VALIDATION-PIPELINE.md"
      provides: "Tiered validation pipeline documentation (F13.9)"
      contains: "compile check"
  key_links:
    - from: "android/app/proguard-rules.pro"
      to: "android/data/proto/src/main/proto/*.proto"
      via: "R8 keep rules for proto-generated classes"
      pattern: "-keep class app.dqxn.android.data.proto"
---

<objective>
Complete Phase 6 with debug overlays (3 composables), release build validation (R8/ProGuard), release module placeholder, and tiered validation pipeline documentation.

Purpose: Validates the release build path early — R8 stripping KSP/proto classes is a known pitfall (Research Pitfall 2, 7). Debug overlays provide visual diagnostics for Phase 7+. Validation pipeline doc fulfills F13.9 for agentic development workflow.

Output: 3 debug overlay composables, validated release APK, ReleaseModule placeholder, and VALIDATION-PIPELINE.md.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-deployable-app-agentic-framework/06-RESEARCH.md
@.planning/phases/06-deployable-app-agentic-framework/06-02-SUMMARY.md
@.planning/phases/06-deployable-app-agentic-framework/06-03-SUMMARY.md
@android/app/proguard-rules.pro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug overlays + ReleaseModule + validation pipeline doc</name>
  <files>
    android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/FrameStatsOverlay.kt
    android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/WidgetHealthOverlay.kt
    android/app/src/debug/kotlin/app/dqxn/android/debug/overlays/ThermalTrendingOverlay.kt
    android/app/src/release/kotlin/app/dqxn/android/release/ReleaseModule.kt
    .planning/phases/06-deployable-app-agentic-framework/VALIDATION-PIPELINE.md
  </files>
  <action>
    Create 3 debug overlay composables in `app/src/debug/.../overlays/`. Package: `app.dqxn.android.debug.overlays`. These are V1 skeleton overlays — they read from observability singletons and render basic text/lists. Real rich UI comes as coordinators land in Phase 7. Per ARCHITECTURE.md, V1 ships three overlays (not the 6 listed in phase-06.md).

    **FrameStatsOverlay.kt:**
    - `@Composable internal fun FrameStatsOverlay(metricsCollector: MetricsCollector, modifier: Modifier = Modifier)`
    - Semi-transparent dark background overlay positioned at top-right
    - Shows: FPS counter (derived from frame histogram), frame time P50/P95/P99, jank frame count
    - Uses `derivedStateOf` to defer reads. `graphicsLayer` for isolation.
    - At Phase 6, metricsCollector will have empty data — overlay shows "No data" or zeros.

    **WidgetHealthOverlay.kt:**
    - `@Composable internal fun WidgetHealthOverlay(healthMonitor: WidgetHealthMonitor, modifier: Modifier = Modifier)`
    - Semi-transparent dark background overlay positioned at bottom-left
    - Shows: per-widget health status (ACTIVE, STALE, ERROR, UNBOUND), stalled render count
    - At Phase 6, no widgets exist — overlay shows "No widgets"

    **ThermalTrendingOverlay.kt:**
    - `@Composable internal fun ThermalTrendingOverlay(thermalMonitor: ThermalMonitor, modifier: Modifier = Modifier)`
    - Semi-transparent dark background overlay positioned at bottom-right
    - Shows: current thermal level (NORMAL/WARM/DEGRADED/CRITICAL), target FPS, glow enabled, headroom value
    - Reads `thermalMonitor.thermalLevel` and `thermalMonitor.renderConfig` flows via `collectAsState()`

    All overlays:
    - Use `@Stable` on any parameter data classes
    - Use `remember` for draw objects
    - Respect `LocalDashboardTheme` for text colors where appropriate
    - Small text (12-14sp), minimal layout footprint
    - Toggleable via agentic command (future — Phase 7 adds toggle handler)

    **ReleaseModule.kt** — Package: `app.dqxn.android.release`
    - `@Module @InstallIn(SingletonComponent::class) object ReleaseModule`
    - Empty for now — placeholder for release-only bindings if needed in future phases
    - This file ensures the release source set has at least one Kotlin file for namespace registration

    **VALIDATION-PIPELINE.md** — `.planning/phases/06-deployable-app-agentic-framework/VALIDATION-PIPELINE.md`
    - Document the tiered validation pipeline per F13.9:
      1. **Compile check** (~8s): `./gradlew :module:compileDebugKotlin --console=plain` — catches type errors, missing imports
      2. **Fast tests** (~12s): `./gradlew :module:fastTest --console=plain` — unit tests tagged @Tag("fast")
      3. **Full module tests** (~30s): `./gradlew :module:testDebugUnitTest --console=plain` — all unit tests including compose/integration
      4. **Dependent module tests** (~60s): `./gradlew test --console=plain` — all tests across all modules
      5. **On-device smoke** (~30s): `./gradlew :app:installDebug && adb shell content call --uri content://app.dqxn.android.debug.agentic --method ping` — deploy + agentic startup probe
      6. **Full suite**: `./gradlew assembleDebug test lintDebug --console=plain` — complete CI gate
    - Include example agentic verification commands:
      - `adb shell content call --uri content://app.dqxn.android.debug.agentic --method list-commands`
      - `adb shell content call --uri content://app.dqxn.android.debug.agentic --method dump-semantics`
      - `adb shell content call --uri content://app.dqxn.android.debug.agentic --method dump-health`
    - Note: response is in file pointed to by `filePath` in returned Bundle. Read with: `adb shell cat <filePath>`
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :app:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
    <sampling_rate>run after task commits</sampling_rate>
  </verify>
  <done>3 debug overlays compile in debug source set. ReleaseModule placeholder exists. VALIDATION-PIPELINE.md documents all 6 tiers.</done>
</task>

<task type="auto">
  <name>Task 2: Release build validation — assembleRelease + R8 verification</name>
  <files>
    android/app/proguard-rules.pro
  </files>
  <action>
    Run `./gradlew assembleRelease --console=plain` and verify:
    1. Build succeeds without errors
    2. R8 doesn't strip proto-generated classes (covered by proguard-rules.pro from Plan 02)
    3. R8 doesn't strip KSP-generated classes (PackManifest, AgenticHiltModule — though AgenticHiltModule should be absent from release entirely since `:core:agentic` is `debugImplementation`)
    4. Release APK does NOT contain AgenticContentProvider, handlers, or debug overlays

    If `assembleRelease` fails:
    - Check R8 output for missing class errors
    - Add keep rules to `proguard-rules.pro` as needed
    - Common fixes: `-dontwarn` for proto reflection, `-keep` for serializable classes
    - Retry until release build succeeds

    If `assembleRelease` succeeds, also verify:
    - Run `./gradlew :app:compileReleaseKotlin --console=plain` to confirm release compilation path
    - Check that no `core.agentic` imports exist in main source set files (they should all be in debug source set)

    Also run the full Phase 6 validation gate:
    - `./gradlew :app:testDebugUnitTest :core:agentic:testDebugUnitTest --console=plain` — all Phase 6 tests pass
    - `./gradlew :app:lintDebug --console=plain` — no lint errors (NF20 secrets check included)

    If ProGuard rules need adjustment, update `proguard-rules.pro` with the minimal required rules.

    **F13.4 + NF22 verification:** Demo mode and demo providers use source set separation (same pattern as agentic). Demo code will live in `src/debug/` when Phase 9 implements it. For Phase 6, verify the pattern works: confirm that all `src/debug/` classes (AgenticContentProvider, handlers, overlays) are absent from the release APK. This proves the source set gate works for both agentic (NF21) and future demo providers (F13.4, NF22).
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew assembleRelease --console=plain 2>&1 | tail -10 && APK=$(find app/build/outputs/apk/release -name "*.apk" | head -1) && echo "--- Checking release APK for debug-only classes ---" && (apkanalyzer dex packages "$APK" 2>/dev/null || "$ANDROID_HOME/cmdline-tools/latest/bin/apkanalyzer" dex packages "$APK" 2>/dev/null || echo "apkanalyzer not found, falling back to grep on dex listing" && unzip -p "$APK" classes.dex | strings | grep -c "AgenticContentProvider") | grep -i "AgenticContentProvider" && echo "FAIL: AgenticContentProvider found in release APK" && exit 1 || echo "PASS: No AgenticContentProvider in release APK"</automated>
    <manual>Verify release APK doesn't contain debug-only classes (AgenticContentProvider, handlers, overlays)</manual>
    <sampling_rate>run after task commits, before next plan begins</sampling_rate>
  </verify>
  <done>assembleRelease succeeds. Automated apkanalyzer/dex check confirms AgenticContentProvider is absent from release APK. R8-processed APK would install without ClassNotFoundException. ProGuard rules cover proto-generated and KSP-generated classes. All Phase 6 unit tests and lint pass. Source set separation verified — debug-only code absent from release artifact (validates F13.4/NF22 pattern for Phase 9 demo providers).</done>
</task>

</tasks>

<verification>
1. `./gradlew assembleRelease --console=plain` succeeds
2. `./gradlew :app:testDebugUnitTest :core:agentic:testDebugUnitTest --console=plain` all pass
3. `./gradlew :app:lintDebug --console=plain` no errors
4. Debug overlays compile in debug source set only
5. Release source set contains only ReleaseModule (no agentic code)
6. VALIDATION-PIPELINE.md documents all 6 tiers with example commands
</verification>

<success_criteria>
- Release build succeeds with R8 processing
- No ClassNotFoundException for proto or KSP-generated classes in release
- Zero agentic code in release APK
- Debug overlays render without crash with empty state
- Tiered validation pipeline fully documented
- All Phase 6 tests and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployable-app-agentic-framework/06-04-SUMMARY.md`
</output>
