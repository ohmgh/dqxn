---
phase: 06-deployable-app-agentic-framework
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/build.gradle.kts
  - android/app/src/main/kotlin/app/dqxn/android/DqxnApplication.kt
  - android/app/src/main/kotlin/app/dqxn/android/MainActivity.kt
  - android/app/src/main/kotlin/app/dqxn/android/di/AppModule.kt
  - android/app/src/main/kotlin/app/dqxn/android/AlertSoundManager.kt
  - android/app/src/main/kotlin/app/dqxn/android/CrashRecovery.kt
  - android/app/src/main/kotlin/app/dqxn/android/StubEntitlementManager.kt
  - android/app/src/main/AndroidManifest.xml
  - android/app/proguard-rules.pro
  - android/app/src/test/kotlin/app/dqxn/android/CrashRecoveryTest.kt
  - android/app/src/test/kotlin/app/dqxn/android/AlertSoundManagerTest.kt
  - android/app/src/test/kotlin/app/dqxn/android/StubEntitlementManagerTest.kt
autonomous: true
requirements: [F1.1, F1.13, F1.23, F13.8, NF20, NF23]

must_haves:
  truths:
    - "App compiles and links against all SDK/core/data/feature module stubs"
    - "Empty multibinding sets resolve — app starts with zero packs"
    - "CrashRecovery detects >= 4 crashes in 60s as safe mode"
    - "AlertSoundManager implements AlertEmitter contract"
    - "StubEntitlementManager returns free-only entitlements"
    - "Manifest declares resizeableActivity=false and BT neverForLocation"
  artifacts:
    - path: "android/app/src/main/kotlin/app/dqxn/android/DqxnApplication.kt"
      provides: "@HiltAndroidApp Application class"
      contains: "@HiltAndroidApp"
    - path: "android/app/src/main/kotlin/app/dqxn/android/MainActivity.kt"
      provides: "Single-activity shell with edge-to-edge blank canvas"
      contains: "enableEdgeToEdge"
    - path: "android/app/src/main/kotlin/app/dqxn/android/di/AppModule.kt"
      provides: "Empty multibinding sets + singleton providers"
      contains: "@Multibinds"
    - path: "android/app/src/main/kotlin/app/dqxn/android/CrashRecovery.kt"
      provides: "Crash timestamp tracking for safe mode"
      contains: "class CrashRecovery"
    - path: "android/app/src/main/AndroidManifest.xml"
      provides: "Permissions, resizeableActivity, BT flags"
      contains: "neverForLocation"
  key_links:
    - from: "android/app/src/main/kotlin/.../di/AppModule.kt"
      to: "android/sdk/contracts/src/main/kotlin/.../WidgetRenderer.kt"
      via: "@Multibinds Set<WidgetRenderer>"
      pattern: "@Multibinds.*WidgetRenderer"
    - from: "android/app/src/main/kotlin/.../StubEntitlementManager.kt"
      to: "android/sdk/contracts/src/main/kotlin/.../EntitlementManager.kt"
      via: "implements EntitlementManager"
      pattern: "EntitlementManager"
    - from: "android/app/src/main/kotlin/.../AlertSoundManager.kt"
      to: "android/sdk/contracts/src/main/kotlin/.../AlertEmitter.kt"
      via: "implements AlertEmitter"
      pattern: "AlertEmitter"
---

<objective>
Create the minimal deployable `:app` module: `DqxnApplication`, `MainActivity` with edge-to-edge blank canvas, `AppModule` with empty multibinding sets and singleton providers, `CrashRecovery`, `AlertSoundManager`, `StubEntitlementManager`, and AndroidManifest with required permissions.

Purpose: First compilable app shell that links all modules together. Empty multibinding sets allow startup with zero packs. CrashRecovery provides safe mode foundation. AlertSoundManager and StubEntitlementManager fulfill Phase 2 contract implementations needed before Phase 7.

Output: Compilable `:app` module with DI assembly, tested CrashRecovery/AlertSoundManager, and correct manifest permissions.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-deployable-app-agentic-framework/06-RESEARCH.md
@.planning/oldcodebase/app-module.md
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/notification/AlertEmitter.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/entitlement/EntitlementManager.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/provider/DataProviderInterceptor.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/theme/ThemeProvider.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: App shell — Application, Activity, AppModule, manifest, and ProGuard</name>
  <files>
    android/app/build.gradle.kts
    android/app/src/main/kotlin/app/dqxn/android/DqxnApplication.kt
    android/app/src/main/kotlin/app/dqxn/android/MainActivity.kt
    android/app/src/main/kotlin/app/dqxn/android/di/AppModule.kt
    android/app/src/main/kotlin/app/dqxn/android/AlertSoundManager.kt
    android/app/src/main/kotlin/app/dqxn/android/CrashRecovery.kt
    android/app/src/main/kotlin/app/dqxn/android/StubEntitlementManager.kt
    android/app/src/main/AndroidManifest.xml
    android/app/proguard-rules.pro
  </files>
  <action>
    Update `app/build.gradle.kts`:
    - Keep existing convention plugins: `dqxn.android.application`, `dqxn.android.hilt`, `dqxn.android.test`
    - Add `id("dqxn.android.compose")` for Compose in Activity
    - Keep existing module dependencies (feature/*, pack/essentials, core/firebase, data, sdk/*)
    - Add: `implementation(project(":core:thermal"))`, `implementation(project(":core:design"))`, `implementation(project(":sdk:contracts"))`
    - Add: `debugImplementation(project(":core:agentic"))` — agentic is debug-only (NF21)
    - Add: `implementation(libs.androidx.core.splashscreen)`, `implementation(libs.androidx.activity.compose)`
    - Add: `debugImplementation(libs.leakcanary)` if available in catalog
    - NOTE: `dqxn.android.application` convention plugin already applies `com.android.application`. DO NOT re-apply it.
    - NOTE: No BuildConfig fields needed. Demo mode gating uses source set separation (same pattern as agentic): demo code lives in `src/debug/`, absent from release. F13.4 and NF22 are satisfied structurally in Phase 9 when demo providers land in `src/debug/`.

    Create `DqxnApplication.kt` — Package: `app.dqxn.android`
    - `@HiltAndroidApp class DqxnApplication : Application()`
    - In `onCreate()`: set up crash recovery UncaughtExceptionHandler that wraps the default handler, calls `crashRecovery.recordCrash()` before delegating. Access CrashRecovery via `@EntryPoint` pattern (same as old codebase CdmPresenceActivator pattern).
    - Set up `CrashEvidenceWriter` (from :sdk:observability) in the UncaughtExceptionHandler chain as well.
    - Keep it minimal — no CDM, no theme engine (Phase 7/10).

    Create `MainActivity.kt`:
    - `@AndroidEntryPoint class MainActivity : ComponentActivity()`
    - `installSplashScreen()` before `super.onCreate()`
    - `enableEdgeToEdge()` for full-screen edge-to-edge rendering (F1.1)
    - `WindowInsetsControllerCompat(window, window.decorView).apply { systemBarsBehavior = BEHAVIOR_SHOW_TRANSIENT_BARS_BY_SWIPE; isAppearanceLightStatusBars = false; isAppearanceLightNavigationBars = false }`
    - `setContent { Box(modifier = Modifier.fillMaxSize().background(Color(0xFF0F172A)).testTag("dashboard_grid")) }` — blank canvas placeholder, dark navy, with `dashboard_grid` test tag for semantics verification
    - This is the F1.13 dashboard-as-shell skeleton — Layer 0 placeholder. Real dashboard composable lands in Phase 7.

    Create `AppModule.kt` — Package: `app.dqxn.android.di`
    - `@Module @InstallIn(SingletonComponent::class) abstract class AppModule`
    - Empty multibinding sets via `@Multibinds`:
      - `abstract fun widgetRenderers(): Set<WidgetRenderer>`
      - `abstract fun dataProviders(): Set<@JvmSuppressWildcards DataProvider<*>>`
      - `abstract fun themeProviders(): Set<ThemeProvider>`
      - `abstract fun dataProviderInterceptors(): Set<DataProviderInterceptor>`
      - `abstract fun packManifests(): Set<DashboardPackManifest>`
    - Companion object with `@Provides @Singleton`:
      - `fun provideAlertEmitter(...)`: AlertSoundManager : AlertEmitter
      - `fun provideCrashRecovery(@ApplicationContext context: Context)`: CrashRecovery using `context.getSharedPreferences("crash_recovery", Context.MODE_PRIVATE)`
      - `fun provideEntitlementManager()`: StubEntitlementManager : EntitlementManager
    - CRITICAL: Use `@Multibinds` abstract functions (NOT `@Provides` returning `emptySet()`). Research Pitfall 3 explains why.

    Create `AlertSoundManager.kt`:
    - Implements `AlertEmitter` from `:sdk:contracts`
    - Constructor: `@Inject constructor()` — actual SoundPool/AudioManager/Vibrator injection deferred until Phase 7 when NotificationCoordinator lands. For now, returns `AlertResult.UNAVAILABLE` for all fire() calls (no audio infrastructure wired yet).
    - This is a placeholder that fulfills the DI contract. Real implementation with SoundPool lands incrementally.

    Create `CrashRecovery.kt`:
    - `class CrashRecovery(private val prefs: SharedPreferences)`
    - `fun recordCrash()`: reads existing timestamps, filters to WINDOW_MS (60_000L), appends current, writes back with `commit()` (NOT `apply()` — must survive process death)
    - `fun isInSafeMode(): Boolean`: count timestamps within WINDOW_MS >= THRESHOLD (4)
    - `fun clearCrashHistory()`: removes timestamps key with `apply()`
    - Private `readTimestamps()`: parse comma-separated longs from SharedPreferences
    - Constants: `WINDOW_MS = 60_000L`, `THRESHOLD = 4`, `KEY_TIMESTAMPS = "crash_timestamps"`

    Create `StubEntitlementManager.kt`:
    - Implements `EntitlementManager` from `:sdk:contracts`
    - Returns `free` tier only for all queries
    - All purchase/restore methods return failure or no-op
    - Phase 10 replaces with Play Billing implementation

    Update `AndroidManifest.xml`:
    - `<uses-permission android:name="android.permission.BLUETOOTH_SCAN" android:usesPermissionFlags="neverForLocation" />` (NF23)
    - `<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />`
    - `<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />`
    - `<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />`
    - `<uses-permission android:name="android.permission.INTERNET" />`
    - `<uses-feature android:name="android.hardware.bluetooth_le" android:required="false" />`
    - `<uses-feature android:name="android.software.companion_device_setup" android:required="true" />` (NF29 — won't enforce at install time since required=true is for the feature flag)
    - `<activity android:name=".MainActivity" android:exported="true" android:launchMode="singleTask" android:resizeableActivity="false" android:screenOrientation="landscape">`
    - Add intent-filter for MAIN/LAUNCHER
    - `<application android:name=".DqxnApplication" ...>`

    Create `proguard-rules.pro`:
    - `-keep class app.dqxn.android.data.proto.** { *; }` (proto-generated classes)
    - `-keepclassmembers class * extends com.google.protobuf.GeneratedMessageLite { *; }`
    - `-keep class app.dqxn.android.**.PackManifest { *; }` (KSP-generated manifests)
    - `-keep class * implements app.dqxn.android.sdk.contracts.widget.WidgetRenderer { *; }`
    - `-keep class * implements app.dqxn.android.sdk.contracts.provider.DataProvider { *; }`
    - `-keepnames class * extends app.dqxn.android.sdk.contracts.pack.DashboardPackManifest`
    - `-keep,allowobfuscation @kotlinx.serialization.Serializable class * { *; }`
    - Standard R8 rules for kotlinx.serialization
  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :app:compileDebugKotlin --console=plain 2>&1 | tail -10</automated>
    <manual>Verify AndroidManifest.xml has resizeableActivity="false" and neverForLocation on BT scan</manual>
    <sampling_rate>run after task commits</sampling_rate>
  </verify>
  <done>`:app` compiles with Hilt DI graph resolving. DqxnApplication, MainActivity (edge-to-edge blank canvas), AppModule (5 empty multibinding sets + 3 singleton providers), manifest with required permissions, and ProGuard rules all in place.</done>
</task>

<task type="auto">
  <name>Task 2: CrashRecovery, AlertSoundManager, and StubEntitlementManager tests</name>
  <files>
    android/app/src/test/kotlin/app/dqxn/android/CrashRecoveryTest.kt
    android/app/src/test/kotlin/app/dqxn/android/AlertSoundManagerTest.kt
    android/app/src/test/kotlin/app/dqxn/android/StubEntitlementManagerTest.kt
  </files>
  <action>
    Create `CrashRecoveryTest.kt`:
    - JUnit5 @Tag("fast")
    - Use FakeSharedPreferences (from Phase 3 :sdk:observability test utilities pattern — inline a minimal implementation or import if accessible)
    - Test: 3 crashes in 60s window -> isInSafeMode() returns false
    - Test: 4 crashes in 60s window -> isInSafeMode() returns true
    - Test: crashes >60s apart -> counter resets, not safe mode
    - Test: boundary condition — crash at exactly 60_001ms after first -> first excluded, not safe mode with only 3 recent
    - Test: clearCrashHistory() -> isInSafeMode() returns false
    - Test: empty prefs -> isInSafeMode() returns false
    - Test: corrupted prefs string -> gracefully returns false (no crash)

    Create `AlertSoundManagerTest.kt`:
    - JUnit5 @Tag("fast")
    - Test: fire() returns UNAVAILABLE (stub behavior for Phase 6)
    - Test: implements AlertEmitter interface (compile-time check via type assertion)

    Create `StubEntitlementManagerTest.kt`:
    - JUnit5 @Tag("fast")
    - Test: hasEntitlement("free") returns true
    - Test: hasEntitlement("plus") returns false
    - Test: hasEntitlement("themes") returns false
    - Test: availableEntitlements returns set containing only "free"

  </action>
  <verify>
    <automated>cd /Users/ohm/Workspace/dqxn/android && ./gradlew :app:testDebugUnitTest --console=plain 2>&1 | tail -10</automated>
    <sampling_rate>run after task commits</sampling_rate>
  </verify>
  <done>CrashRecovery tests pass (threshold detection, boundary conditions, corruption handling). AlertSoundManager stub test passes. StubEntitlementManager tests pass (free-only behavior). All test XML in build/test-results/.</done>
</task>

</tasks>

<verification>
1. `./gradlew :app:compileDebugKotlin --console=plain` succeeds — all module dependencies resolve
2. `./gradlew :app:testDebugUnitTest --console=plain` passes all tests
3. AndroidManifest.xml contains `resizeableActivity="false"` and `neverForLocation`
4. AppModule uses `@Multibinds` (not `@Provides`) for all 5 empty sets
5. CrashRecovery uses `commit()` not `apply()` for crash recording
</verification>

<success_criteria>
- `:app` compiles with Hilt DI graph fully resolving (all multibinding sets, all singleton providers)
- CrashRecovery correctly detects >= 4 crashes in 60s as safe mode
- AlertSoundManager and StubEntitlementManager fulfill SDK contract interfaces
- Manifest has correct permissions, flags, and activity attributes
- ProGuard rules cover proto classes, KSP-generated classes, and serializable types
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployable-app-agentic-framework/06-02-SUMMARY.md`
</output>
