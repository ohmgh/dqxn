---
phase: 14-ui-visual-interactive-parity
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetStatusOverlay.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlot.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetStatusOverlayTest.kt
autonomous: true
requirements: [F2.5, F3.14, F11.7]

must_haves:
  truths:
    - "Status overlays use theme accent color for icon tint"
    - "Overlays respect widget corner radius via RoundedCornerShape clip"
    - "SetupRequired overlay is tappable (routes to setup wizard)"
    - "EntitlementRevoked overlay is tappable (routes to upgrade)"
    - "Disconnected overlay uses corner positioning (not centered)"
    - "Per-type icon sizes: SetupRequired=32dp, Disconnected=20dp, ConnectionError=32dp, EntitlementRevoked=32dp, ProviderMissing=32dp"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetStatusOverlay.kt"
      provides: "Themed status overlays with per-type differentiation"
      contains: "accentColor"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlot.kt"
      provides: "Tap handlers on SetupRequired and EntitlementRevoked overlays"
      contains: "OpenWidgetSettings"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt"
      provides: "OpenWidgetSettings command variant"
      contains: "OpenWidgetSettings"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetStatusOverlayTest.kt"
      provides: "Status overlay tests"
  key_links:
    - from: "WidgetStatusOverlay.kt"
      to: "LocalDashboardTheme"
      via: "theme.accentColor for icon tint"
      pattern: "accentColor"
    - from: "WidgetSlot.kt"
      to: "WidgetStatusOverlay.kt"
      via: "onSetupTap, onEntitlementTap callbacks"
      pattern: "onSetupTap"
---

<objective>
Restore themed, per-type-differentiated widget status overlays with tap handlers.

Purpose: F2.5 requires themed overlays for entitlement, setup, and connection issues. F3.14 requires
tappable "Setup Required" overlay routing to setup wizard. F11.7 requires the permission flow entry
point. Current implementation uses generic white icons at 24dp, no corner radius, no tap handlers, and
all states are centered. Old codebase had accent-colored icons, per-type sizes and positions, corner
radius respect, and tappable states.

Output: Themed overlays with correct visual differentiation and tap routing.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetStatusOverlay.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlot.kt

<interfaces>
<!-- WidgetRenderState sealed interface: Ready, SetupRequired, ConnectionError, Disconnected,
     EntitlementRevoked, ProviderMissing, DataTimeout, DataStale -->
<!-- SetupRequired has requirementType, iconName, message fields -->
<!-- EntitlementRevoked has upgradeEntitlement, iconName fields -->
<!-- LocalDashboardTheme provides DashboardThemeDefinition with accentColor: Color -->
<!-- CardSize from :core:design provides cornerRadius categories: SMALL=8dp, MEDIUM=12dp, LARGE=16dp -->
<!-- DashboardCommand.OpenWidgetSettings(widgetId) — added by THIS plan (14-04) to DashboardCommand sealed interface -->

Old overlay spec from research:
Status             Scrim    Icon                   IconSize  Position    Clickable
SetupRequired      60%      themed settings icon   32dp      centered    yes -> widget info
Disconnected       15%      corner block icon      20dp      corner      yes -> widget info
ConnectionError    30%      Warning icon           32dp      centered    no
EntitlementRevoked 60%      Star icon              32dp      centered    yes -> widget info
ProviderMissing    60%      Warning icon           32dp      centered    no
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite WidgetStatusOverlay with themed per-type differentiation</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetStatusOverlay.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlot.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt
  </files>
  <action>
**Rewrite WidgetStatusOverlay.kt:**

1. Add callback parameters for tappable states:
```kotlin
@Composable
internal fun WidgetStatusOverlay(
    renderState: WidgetRenderState,
    cornerRadiusDp: Float = 12f, // Default MEDIUM from CardSize
    onSetupTap: (() -> Unit)? = null,
    onEntitlementTap: (() -> Unit)? = null,
    modifier: Modifier = Modifier,
)
```

2. Get theme accent color:
```kotlin
val theme = LocalDashboardTheme.current
val accentColor = theme.accentColor
```

3. Replace the generic Triple approach with a `when` block that produces per-type UI. Each variant needs:
   - Correct scrim alpha
   - Correct icon (Material Filled)
   - Correct icon size (32dp or 20dp for Disconnected)
   - Correct position (centered or corner for Disconnected)
   - Theme accent color for icon tint
   - Tap handler for SetupRequired and EntitlementRevoked

```kotlin
val shape = RoundedCornerShape(cornerRadiusDp.dp)

when (renderState) {
    is WidgetRenderState.SetupRequired -> {
        Box(
            modifier = modifier
                .fillMaxSize()
                .clip(shape)
                .background(Color.Black.copy(alpha = 0.60f))
                .then(
                    if (onSetupTap != null) Modifier.clickable(onClick = onSetupTap)
                    else Modifier
                )
                .testTag("status_setup_required"),
            contentAlignment = Alignment.Center,
        ) {
            Column(horizontalAlignment = Alignment.CenterHorizontally) {
                Icon(
                    imageVector = Icons.Filled.Settings,
                    contentDescription = renderState.message ?: "Setup required",
                    modifier = Modifier.size(32.dp),
                    tint = accentColor,
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = renderState.message ?: "Setup required",
                    style = MaterialTheme.typography.labelSmall,
                    color = Color.White.copy(alpha = 0.9f),
                )
            }
        }
    }

    is WidgetRenderState.Disconnected -> {
        // Corner-positioned (top-end), not centered
        Box(
            modifier = modifier
                .fillMaxSize()
                .clip(shape)
                .background(Color.Black.copy(alpha = 0.15f))
                .testTag("status_disconnected"),
            contentAlignment = Alignment.TopEnd,
        ) {
            Icon(
                imageVector = Icons.Filled.Block,
                contentDescription = "Disconnected",
                modifier = Modifier
                    .padding(4.dp)
                    .size(20.dp),
                tint = accentColor,
            )
        }
    }

    is WidgetRenderState.ConnectionError -> {
        Box(
            modifier = modifier
                .fillMaxSize()
                .clip(shape)
                .background(Color.Black.copy(alpha = 0.30f))
                .testTag("status_connection_error"),
            contentAlignment = Alignment.Center,
        ) {
            Column(horizontalAlignment = Alignment.CenterHorizontally) {
                Icon(
                    imageVector = Icons.Filled.ErrorOutline,
                    contentDescription = renderState.message ?: "Connection error",
                    modifier = Modifier.size(32.dp),
                    tint = accentColor,
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = renderState.message ?: "Connection error",
                    style = MaterialTheme.typography.labelSmall,
                    color = Color.White.copy(alpha = 0.9f),
                )
            }
        }
    }

    is WidgetRenderState.EntitlementRevoked -> {
        Box(
            modifier = modifier
                .fillMaxSize()
                .clip(shape)
                .background(Color.Black.copy(alpha = 0.60f))
                .then(
                    if (onEntitlementTap != null) Modifier.clickable(onClick = onEntitlementTap)
                    else Modifier
                )
                .testTag("status_entitlement_revoked"),
            contentAlignment = Alignment.Center,
        ) {
            Column(horizontalAlignment = Alignment.CenterHorizontally) {
                Icon(
                    imageVector = Icons.Filled.Lock,
                    contentDescription = "Upgrade required",
                    modifier = Modifier.size(32.dp),
                    tint = accentColor,
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = "Upgrade required",
                    style = MaterialTheme.typography.labelSmall,
                    color = Color.White.copy(alpha = 0.9f),
                )
            }
        }
    }

    is WidgetRenderState.ProviderMissing -> {
        Box(
            modifier = modifier
                .fillMaxSize()
                .clip(shape)
                .background(Color.Black.copy(alpha = 0.60f))
                .testTag("status_provider_missing"),
            contentAlignment = Alignment.Center,
        ) {
            Column(horizontalAlignment = Alignment.CenterHorizontally) {
                Icon(
                    imageVector = Icons.Filled.Warning,
                    contentDescription = "No data provider",
                    modifier = Modifier.size(32.dp),
                    tint = accentColor,
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = "No data provider",
                    style = MaterialTheme.typography.labelSmall,
                    color = Color.White.copy(alpha = 0.9f),
                )
            }
        }
    }

    is WidgetRenderState.DataTimeout -> {
        Box(
            modifier = modifier
                .fillMaxSize()
                .clip(shape)
                .background(Color.Black.copy(alpha = 0.30f))
                .testTag("status_data_timeout"),
            contentAlignment = Alignment.Center,
        ) {
            Column(horizontalAlignment = Alignment.CenterHorizontally) {
                Icon(
                    imageVector = Icons.Filled.HourglassEmpty,
                    contentDescription = renderState.message ?: "Waiting for data",
                    modifier = Modifier.size(32.dp),
                    tint = accentColor,
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = renderState.message ?: "Waiting for data",
                    style = MaterialTheme.typography.labelSmall,
                    color = Color.White.copy(alpha = 0.9f),
                )
            }
        }
    }

    is WidgetRenderState.DataStale -> {
        Box(
            modifier = modifier
                .fillMaxSize()
                .clip(shape)
                .background(Color.Black.copy(alpha = 0.15f))
                .testTag("status_data_stale"),
            contentAlignment = Alignment.Center,
        ) {
            Icon(
                imageVector = Icons.Filled.Warning,
                contentDescription = "Data may be stale",
                modifier = Modifier.size(20.dp),
                tint = accentColor.copy(alpha = 0.7f),
            )
        }
    }

    else -> return // Ready or unknown
}
```

Add imports: `import androidx.compose.ui.draw.clip`, `import androidx.compose.foundation.shape.RoundedCornerShape`, `import androidx.compose.foundation.layout.padding`, `import androidx.compose.ui.platform.testTag`, `import app.dqxn.android.sdk.ui.theme.LocalDashboardTheme`.

**Add `OpenWidgetSettings` to `DashboardCommand` sealed interface:**

In `android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/command/DashboardCommand.kt`, add after the `FocusWidget` variant:

```kotlin
public data class OpenWidgetSettings(
    val widgetId: String,
    override val traceId: String? = null,
) : DashboardCommand
```

DashboardViewModel routes this command to the widget settings overlay/route. If no handler exists yet, add a no-op `TODO` log in the ViewModel's `when` block — downstream phases wire the actual navigation.

**Update WidgetSlot.kt:**

Update the WidgetStatusOverlay call to pass tap handlers and corner radius. Both tappable overlays fire `DashboardCommand.OpenWidgetSettings`:

```kotlin
// Status overlay (F3.14)
if (overlayState != WidgetRenderState.Ready && !isConnectionError) {
    WidgetStatusOverlay(
        renderState = overlayState,
        cornerRadiusDp = 12f, // CardSize.MEDIUM
        onSetupTap = {
            onCommand(DashboardCommand.OpenWidgetSettings(widget.instanceId))
        },
        onEntitlementTap = {
            onCommand(DashboardCommand.OpenWidgetSettings(widget.instanceId))
        },
    )
}
```
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>
    - WidgetStatusOverlay uses theme accent color for icons
    - Corner radius clips overlay via RoundedCornerShape
    - Per-type icon sizes (32dp centered, 20dp corner for Disconnected)
    - SetupRequired and EntitlementRevoked are tappable
    - All status types have test tags for verification
    - Compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add status overlay tests</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetStatusOverlayTest.kt
  </files>
  <action>
Create a Compose UI test verifying each status overlay variant:

```kotlin
package app.dqxn.android.feature.dashboard.ui

import androidx.compose.runtime.CompositionLocalProvider
import androidx.compose.ui.test.assertIsDisplayed
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.compose.ui.test.onNodeWithTag
import androidx.compose.ui.test.performClick
import com.google.common.truth.Truth.assertThat
import org.junit.Rule
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config
import app.dqxn.android.sdk.contracts.status.WidgetRenderState
import app.dqxn.android.sdk.ui.theme.LocalDashboardTheme

@RunWith(RobolectricTestRunner::class)
@Config(sdk = [34])
class WidgetStatusOverlayTest {

    @get:Rule
    val composeTestRule = createComposeRule()

    // Use a test theme that provides accentColor. If LocalDashboardTheme requires a real
    // DashboardThemeDefinition, provide one from BuiltInThemes or create a test stub.
    // The overlay reads LocalDashboardTheme.current.accentColor.

    @Test
    fun `setup required overlay is tappable`() {
        var tapped = false

        composeTestRule.setContent {
            WidgetStatusOverlay(
                renderState = WidgetRenderState.SetupRequired(message = "Setup needed"),
                onSetupTap = { tapped = true },
            )
        }

        composeTestRule.onNodeWithTag("status_setup_required").assertExists()
        composeTestRule.onNodeWithTag("status_setup_required").performClick()
        assertThat(tapped).isTrue()
    }

    @Test
    fun `entitlement revoked overlay is tappable`() {
        var tapped = false

        composeTestRule.setContent {
            WidgetStatusOverlay(
                renderState = WidgetRenderState.EntitlementRevoked(upgradeEntitlement = "plus"),
                onEntitlementTap = { tapped = true },
            )
        }

        composeTestRule.onNodeWithTag("status_entitlement_revoked").assertExists()
        composeTestRule.onNodeWithTag("status_entitlement_revoked").performClick()
        assertThat(tapped).isTrue()
    }

    @Test
    fun `disconnected overlay renders in corner position`() {
        composeTestRule.setContent {
            WidgetStatusOverlay(
                renderState = WidgetRenderState.Disconnected,
            )
        }

        composeTestRule.onNodeWithTag("status_disconnected").assertExists()
    }

    @Test
    fun `connection error overlay renders centered`() {
        composeTestRule.setContent {
            WidgetStatusOverlay(
                renderState = WidgetRenderState.ConnectionError(message = "Failed"),
            )
        }

        composeTestRule.onNodeWithTag("status_connection_error").assertExists()
    }

    @Test
    fun `provider missing overlay renders`() {
        composeTestRule.setContent {
            WidgetStatusOverlay(
                renderState = WidgetRenderState.ProviderMissing,
            )
        }

        composeTestRule.onNodeWithTag("status_provider_missing").assertExists()
    }

    @Test
    fun `data stale overlay renders`() {
        composeTestRule.setContent {
            WidgetStatusOverlay(
                renderState = WidgetRenderState.DataStale,
            )
        }

        composeTestRule.onNodeWithTag("status_data_stale").assertExists()
    }

    @Test
    fun `ready state renders nothing`() {
        composeTestRule.setContent {
            WidgetStatusOverlay(
                renderState = WidgetRenderState.Ready,
            )
        }

        // None of the status tags should exist
        composeTestRule.onNodeWithTag("status_setup_required").assertDoesNotExist()
        composeTestRule.onNodeWithTag("status_disconnected").assertDoesNotExist()
        composeTestRule.onNodeWithTag("status_connection_error").assertDoesNotExist()
        composeTestRule.onNodeWithTag("status_entitlement_revoked").assertDoesNotExist()
        composeTestRule.onNodeWithTag("status_provider_missing").assertDoesNotExist()
    }
}
```

If `LocalDashboardTheme` is not provided, the test may crash. Wrap test content in `CompositionLocalProvider(LocalDashboardTheme provides testTheme)` where `testTheme` is a minimal `DashboardThemeDefinition`. Check how other tests handle this (e.g., WidgetSlotTest). If a test theme utility exists in testFixtures, use it; otherwise create an inline test theme with default colors.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.WidgetStatusOverlayTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - All 7 status overlay tests pass
    - SetupRequired tap handler verified
    - EntitlementRevoked tap handler verified
    - Disconnected corner position verified
    - Ready state produces no overlay
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain` -- compiles
2. `cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.WidgetStatusOverlayTest" --console=plain` -- all tests pass
3. `cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.WidgetSlotTest" --console=plain` -- existing tests still pass
</verification>

<success_criteria>
- Theme accent color used on overlay icons
- Corner radius clipping on all overlays
- Disconnected: corner-positioned, 20dp icon
- SetupRequired + EntitlementRevoked: tappable
- All 7 status overlay tests pass
- Existing WidgetSlotTest tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-04-SUMMARY.md`
</output>
