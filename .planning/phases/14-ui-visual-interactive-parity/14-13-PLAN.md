---
phase: 14-ui-visual-interactive-parity
plan: 13
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/DesignTokenWiringTest.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/DesignTokenWiringTest.kt
  - android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/DesignTokenWiringTest.kt
autonomous: true
requirements: []

must_haves:
  truths:
    - "DesignTokenWiringTest exists in :feature:settings, :feature:dashboard, and :feature:onboarding"
    - "Each test scans ALL .kt files under the module's src/main/kotlin directory recursively"
    - "Tests assert no MaterialTheme.typography references in any source file (excluding diagnostics module)"
    - "Tests assert no MaterialTheme.colorScheme references in any source file (excluding diagnostics module)"
    - "Tests assert no raw import of androidx.compose.material3.MaterialTheme in any source file (excluding diagnostics module)"
    - ":feature:settings test has an allowlist for NfD1Disclaimer.kt (legitimate MaterialTheme usage until migrated)"
    - ":feature:dashboard test has an allowlist for files that have legitimate MaterialTheme usage (ConfirmationDialog, WidgetErrorFallback, DashboardButtonBar, CriticalBannerHost, NotificationBannerHost, WidgetStatusOverlay) -- these are OTHER phase 14 plans' responsibility"
    - ":feature:onboarding test has an allowlist for ProgressiveTip.kt"
    - "Allowlisted files are documented with the plan number responsible for their migration"
    - "Tests use Truth assertions with named() for clear failure messages"
    - "Tests are source-scanning (File I/O), not Compose UI tests -- no ComposeTestRule needed"
  artifacts:
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/DesignTokenWiringTest.kt"
      provides: "Source-scanning test verifying :feature:settings uses dashboard tokens"
      contains: "DesignTokenWiringTest"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/DesignTokenWiringTest.kt"
      provides: "Source-scanning test verifying :feature:dashboard uses dashboard tokens"
      contains: "DesignTokenWiringTest"
    - path: "android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/DesignTokenWiringTest.kt"
      provides: "Source-scanning test verifying :feature:onboarding uses dashboard tokens"
      contains: "DesignTokenWiringTest"
---

<objective>
Create source-scanning tests that verify design token consistency across feature modules.

Purpose: Phase 14 migrates multiple feature modules from MaterialTheme tokens to dashboard design tokens (DashboardTypography, DashboardSpacing, LocalDashboardTheme). Without automated enforcement, regressions are invisible -- a single MaterialTheme.typography reference slips through and nobody notices. This plan creates DesignTokenWiringTest in each target module that scans source files and asserts no prohibited MaterialTheme usage, with explicit allowlists for files not yet migrated (owned by other plans).

These tests serve as a regression gate: once a file is migrated by its owning plan, it stays migrated.

Output: 3 test files (one per module) with source-scanning assertions.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Current MaterialTheme usage by module (as of pre-Phase-14):

     :feature:settings (1 file uses MaterialTheme):
       - NfD1Disclaimer.kt -- MaterialTheme.typography, MaterialTheme.colorScheme
       (All other settings files already use DashboardTypography/LocalDashboardTheme)

     :feature:dashboard (6 files use MaterialTheme):
       - ConfirmationDialog.kt -- MaterialTheme.typography, MaterialTheme.colorScheme
       - WidgetErrorFallback.kt -- MaterialTheme.typography, MaterialTheme.colorScheme
       - DashboardButtonBar.kt -- MaterialTheme.colorScheme
       - CriticalBannerHost.kt -- MaterialTheme.typography, MaterialTheme.colorScheme
       - NotificationBannerHost.kt -- MaterialTheme.typography, MaterialTheme.colorScheme
       - WidgetStatusOverlay.kt -- MaterialTheme.typography, MaterialTheme.colorScheme

     :feature:onboarding (4 files use MaterialTheme, 3 migrated by plan 14-11):
       - FirstRunFlow.kt -- MIGRATED by plan 14-11
       - AnalyticsConsentStep.kt -- MIGRATED by plan 14-11
       - FirstLaunchDisclaimer.kt -- MIGRATED by plan 14-11
       - ProgressiveTip.kt -- NOT yet migrated

     :feature:diagnostics -- EXCLUDED entirely. Diagnostics is a developer-facing debug tool,
     not part of the dashboard UX. MaterialTheme usage there is acceptable.
-->

<!-- Prohibited patterns to scan for:
     1. "MaterialTheme.typography" -- should use DashboardTypography.*
     2. "MaterialTheme.colorScheme" -- should use LocalDashboardTheme.current.*
     3. "import androidx.compose.material3.MaterialTheme" -- the import itself
-->

<!-- Allowlist strategy:
     Files that legitimately still use MaterialTheme because their migration belongs to
     a different plan (or is deferred). Each allowlisted file gets a comment documenting:
     1. WHY it's allowlisted (which plan migrates it)
     2. WHEN the allowlist entry should be removed (after that plan executes)
     This creates a shrinking allowlist -- as plans execute, entries are removed.
-->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DesignTokenWiringTest in :feature:settings</name>
  <files>
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/DesignTokenWiringTest.kt
  </files>
  <action>
Create a new test file that scans all `.kt` source files in `:feature:settings` for prohibited MaterialTheme usage.

```kotlin
package app.dqxn.android.feature.settings

import com.google.common.truth.Truth.assertThat
import java.io.File
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner

/**
 * Source-scanning tests verifying :feature:settings uses dashboard design tokens
 * (DashboardTypography, DashboardSpacing, LocalDashboardTheme) instead of MaterialTheme.
 *
 * Allowlisted files are owned by other plans and will be migrated separately.
 * Remove allowlist entries as their owning plans execute.
 */
@RunWith(RobolectricTestRunner::class)
class DesignTokenWiringTest {

    private val sourceDir = File(
        System.getProperty("user.dir"),
        "feature/settings/src/main/kotlin"
    )

    /**
     * Files with legitimate MaterialTheme usage pending migration by other plans.
     * Each entry documents the owning plan. Remove after plan execution.
     */
    private val allowlist = setOf(
        "NfD1Disclaimer.kt",  // Disclaimer dialog -- not in Phase 14 scope
    )

    private fun scanSourceFiles(): List<File> {
        check(sourceDir.isDirectory) { "Source dir not found: ${sourceDir.absolutePath}" }
        return sourceDir.walk()
            .filter { it.extension == "kt" }
            .filter { it.name !in allowlist }
            .toList()
    }

    @Test
    fun `no MaterialTheme typography in settings source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not use MaterialTheme.typography -- use DashboardTypography instead")
                .doesNotContain("MaterialTheme.typography")
        }
    }

    @Test
    fun `no MaterialTheme colorScheme in settings source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not use MaterialTheme.colorScheme -- use LocalDashboardTheme instead")
                .doesNotContain("MaterialTheme.colorScheme")
        }
    }

    @Test
    fun `no MaterialTheme import in settings source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not import MaterialTheme")
                .doesNotContain("import androidx.compose.material3.MaterialTheme")
        }
    }

    @Test
    fun `allowlist files actually exist`() {
        // Verify allowlisted files exist, preventing stale entries
        allowlist.forEach { fileName ->
            val found = sourceDir.walk().any { it.name == fileName }
            assertThat(found)
                .named("Allowlisted file $fileName should exist in source tree")
                .isTrue()
        }
    }

    @Test
    fun `allowlist is minimal -- verify files still need MaterialTheme`() {
        // If an allowlisted file no longer uses MaterialTheme, the entry is stale -- remove it
        allowlist.forEach { fileName ->
            val file = sourceDir.walk().first { it.name == fileName }
            val content = file.readText()
            val usesMaterialTheme = content.contains("MaterialTheme.typography") ||
                content.contains("MaterialTheme.colorScheme") ||
                content.contains("import androidx.compose.material3.MaterialTheme")
            assertThat(usesMaterialTheme)
                .named("Allowlisted $fileName should still use MaterialTheme -- remove from allowlist if migrated")
                .isTrue()
        }
    }
}
```
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.DesignTokenWiringTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - DesignTokenWiringTest created in :feature:settings
    - Scans all .kt files under src/main/kotlin
    - Asserts no MaterialTheme.typography, no MaterialTheme.colorScheme, no MaterialTheme import
    - NfD1Disclaimer.kt allowlisted with migration note
    - Allowlist validation: files exist, files still need MaterialTheme
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DesignTokenWiringTest in :feature:dashboard and :feature:onboarding</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/DesignTokenWiringTest.kt
    android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/DesignTokenWiringTest.kt
  </files>
  <action>
**A. Create :feature:dashboard DesignTokenWiringTest:**

```kotlin
package app.dqxn.android.feature.dashboard

import com.google.common.truth.Truth.assertThat
import java.io.File
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner

/**
 * Source-scanning tests verifying :feature:dashboard uses dashboard design tokens
 * instead of MaterialTheme.
 *
 * Allowlisted files are owned by other Phase 14 plans and will be migrated separately.
 * Remove allowlist entries as their owning plans execute.
 */
@RunWith(RobolectricTestRunner::class)
class DesignTokenWiringTest {

    private val sourceDir = File(
        System.getProperty("user.dir"),
        "feature/dashboard/src/main/kotlin"
    )

    /**
     * Files with legitimate MaterialTheme usage pending migration by other Phase 14 plans.
     *
     * - ConfirmationDialog.kt -- used by widget delete/reset flows, migrated by plan 14-07
     * - WidgetErrorFallback.kt -- widget crash fallback UI, migrated by plan 14-04
     * - DashboardButtonBar.kt -- bottom bar styling, migrated by plan 14-02
     * - CriticalBannerHost.kt -- thermal/critical banner UI, migrated by plan 14-05
     * - NotificationBannerHost.kt -- notification banner UI, migrated by plan 14-05
     * - WidgetStatusOverlay.kt -- widget status overlays, migrated by plan 14-04
     */
    private val allowlist = setOf(
        "ConfirmationDialog.kt",
        "WidgetErrorFallback.kt",
        "DashboardButtonBar.kt",
        "CriticalBannerHost.kt",
        "NotificationBannerHost.kt",
        "WidgetStatusOverlay.kt",
    )

    private fun scanSourceFiles(): List<File> {
        check(sourceDir.isDirectory) { "Source dir not found: ${sourceDir.absolutePath}" }
        return sourceDir.walk()
            .filter { it.extension == "kt" }
            .filter { it.name !in allowlist }
            .toList()
    }

    @Test
    fun `no MaterialTheme typography in dashboard source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not use MaterialTheme.typography -- use DashboardTypography instead")
                .doesNotContain("MaterialTheme.typography")
        }
    }

    @Test
    fun `no MaterialTheme colorScheme in dashboard source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not use MaterialTheme.colorScheme -- use LocalDashboardTheme instead")
                .doesNotContain("MaterialTheme.colorScheme")
        }
    }

    @Test
    fun `no MaterialTheme import in dashboard source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not import MaterialTheme")
                .doesNotContain("import androidx.compose.material3.MaterialTheme")
        }
    }

    @Test
    fun `allowlist files actually exist`() {
        allowlist.forEach { fileName ->
            val found = sourceDir.walk().any { it.name == fileName }
            assertThat(found)
                .named("Allowlisted file $fileName should exist in source tree")
                .isTrue()
        }
    }

    @Test
    fun `allowlist is minimal -- verify files still need MaterialTheme`() {
        allowlist.forEach { fileName ->
            val file = sourceDir.walk().first { it.name == fileName }
            val content = file.readText()
            val usesMaterialTheme = content.contains("MaterialTheme.typography") ||
                content.contains("MaterialTheme.colorScheme") ||
                content.contains("import androidx.compose.material3.MaterialTheme")
            assertThat(usesMaterialTheme)
                .named("Allowlisted $fileName should still use MaterialTheme -- remove from allowlist if migrated")
                .isTrue()
        }
    }
}
```

**B. Create :feature:onboarding DesignTokenWiringTest:**

```kotlin
package app.dqxn.android.feature.onboarding

import com.google.common.truth.Truth.assertThat
import java.io.File
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner

/**
 * Source-scanning tests verifying :feature:onboarding uses dashboard design tokens
 * instead of MaterialTheme.
 *
 * Plan 14-11 migrates FirstRunFlow, AnalyticsConsentStep, FirstLaunchDisclaimer.
 * ProgressiveTip is allowlisted (not in Phase 14 scope).
 */
@RunWith(RobolectricTestRunner::class)
class DesignTokenWiringTest {

    private val sourceDir = File(
        System.getProperty("user.dir"),
        "feature/onboarding/src/main/kotlin"
    )

    /**
     * Files with legitimate MaterialTheme usage pending migration.
     *
     * - ProgressiveTip.kt -- tooltip composable, not in Phase 14 scope
     */
    private val allowlist = setOf(
        "ProgressiveTip.kt",
    )

    private fun scanSourceFiles(): List<File> {
        check(sourceDir.isDirectory) { "Source dir not found: ${sourceDir.absolutePath}" }
        return sourceDir.walk()
            .filter { it.extension == "kt" }
            .filter { it.name !in allowlist }
            .toList()
    }

    @Test
    fun `no MaterialTheme typography in onboarding source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not use MaterialTheme.typography -- use DashboardTypography instead")
                .doesNotContain("MaterialTheme.typography")
        }
    }

    @Test
    fun `no MaterialTheme colorScheme in onboarding source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not use MaterialTheme.colorScheme -- use LocalDashboardTheme instead")
                .doesNotContain("MaterialTheme.colorScheme")
        }
    }

    @Test
    fun `no MaterialTheme import in onboarding source`() {
        scanSourceFiles().forEach { file ->
            val content = file.readText()
            assertThat(content)
                .named("${file.name} should not import MaterialTheme")
                .doesNotContain("import androidx.compose.material3.MaterialTheme")
        }
    }

    @Test
    fun `allowlist files actually exist`() {
        allowlist.forEach { fileName ->
            val found = sourceDir.walk().any { it.name == fileName }
            assertThat(found)
                .named("Allowlisted file $fileName should exist in source tree")
                .isTrue()
        }
    }

    @Test
    fun `allowlist is minimal -- verify files still need MaterialTheme`() {
        allowlist.forEach { fileName ->
            val file = sourceDir.walk().first { it.name == fileName }
            val content = file.readText()
            val usesMaterialTheme = content.contains("MaterialTheme.typography") ||
                content.contains("MaterialTheme.colorScheme") ||
                content.contains("import androidx.compose.material3.MaterialTheme")
            assertThat(usesMaterialTheme)
                .named("Allowlisted $fileName should still use MaterialTheme -- remove from allowlist if migrated")
                .isTrue()
        }
    }
}
```

**IMPORTANT notes for executor:**
- These tests will initially FAIL if run before plans 14-06, 14-09, and 14-11 execute (since those plans haven't migrated the files yet). This plan is Wave 1 alongside those plans. The tests are designed to pass in the post-migration state.
- If the tests fail due to files that are already non-allowlisted but still have MaterialTheme, add them to the allowlist with a TODO comment documenting which plan owns them.
- If a test fails because an allowlisted file has already been migrated (allowlist staleness check), remove it from the allowlist.
- The `System.getProperty("user.dir")` path resolves to `android/` when run via `./gradlew` from the android directory.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.DesignTokenWiringTest" :feature:dashboard:testDebugUnitTest --tests "*.DesignTokenWiringTest" :feature:onboarding:testDebugUnitTest --tests "*.DesignTokenWiringTest" --console=plain 2>&1 | tail -15</automated>
  </verify>
  <done>
    - DesignTokenWiringTest created in :feature:dashboard
    - DesignTokenWiringTest created in :feature:onboarding
    - :feature:dashboard allowlist covers 6 files owned by plans 14-02, 14-04, 14-05, 14-07
    - :feature:onboarding allowlist covers ProgressiveTip.kt
    - Each test scans recursively, asserts no MaterialTheme.typography/colorScheme/import
    - Allowlist validation tests ensure entries are valid and not stale
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.DesignTokenWiringTest" --console=plain` -- passes
2. `cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.DesignTokenWiringTest" --console=plain` -- passes
3. `cd android && ./gradlew :feature:onboarding:testDebugUnitTest --tests "*.DesignTokenWiringTest" --console=plain` -- passes
</verification>

<success_criteria>
- DesignTokenWiringTest exists in all 3 feature modules
- Tests scan all .kt files recursively under src/main/kotlin
- Tests assert zero MaterialTheme.typography, zero MaterialTheme.colorScheme, zero MaterialTheme import
- Allowlists are documented with owning plan numbers
- Allowlist validation: files exist + files still actually use MaterialTheme
- All 3 test suites pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-13-SUMMARY.md`
</output>
