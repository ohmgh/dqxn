---
phase: 14-ui-visual-interactive-parity
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt
  - android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowTest.kt
autonomous: true
requirements: [F11.7]

must_haves:
  truths:
    - "FirstRunFlow uses dashboard theme tokens (DashboardTypography, DashboardSpacing, theme colors) instead of MaterialTheme"
    - "AnalyticsConsentStep uses DashboardTypography and theme.primaryTextColor/accentColor instead of MaterialTheme.typography and MaterialTheme.colorScheme"
    - "FirstLaunchDisclaimer uses DashboardTypography and theme colors instead of MaterialTheme"
    - "ThemeSelectionStep uses DashboardTypography, DashboardSpacing, and theme colors"
    - "EditModeTourStep uses DashboardTypography and theme colors with dashboard-style cards"
    - "Theme cards in onboarding show gradient background via theme.backgroundBrush (matching ThemeSelector style)"
    - "PageIndicator dots use theme.accentColor for active and theme.secondaryTextColor for inactive"
    - "Buttons use theme.accentColor as container color instead of MaterialTheme.colorScheme.primary"
  artifacts:
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
      provides: "Onboarding flow using dashboard theme tokens"
      contains: "DashboardTypography"
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt"
      provides: "Consent step with dashboard theming"
      contains: "LocalDashboardTheme"
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt"
      provides: "Disclaimer with dashboard theming"
      contains: "DashboardTypography"
    - path: "android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowTest.kt"
      provides: "Tests verifying dashboard theme token usage"
  key_links:
    - from: "FirstRunFlow.kt"
      to: "LocalDashboardTheme"
      via: "CompositionLocal providing theme colors"
      pattern: "LocalDashboardTheme.current"
---

<objective>
Migrate onboarding UI from MaterialTheme tokens to dashboard theme tokens.

Purpose: Current FirstRunFlow and its sub-composables (AnalyticsConsentStep, FirstLaunchDisclaimer,
ThemeSelectionStep, EditModeTourStep) use MaterialTheme.typography, MaterialTheme.colorScheme, and
Material Card/Button defaults. This makes the onboarding look like a generic Material 3 app rather than
DQXN's branded dashboard experience. The old codebase had no dedicated onboarding screen, but user wants
the onboarding to use dashboard visual language -- DashboardTypography, DashboardSpacing, theme colors
from LocalDashboardTheme, and theme card styling matching the ThemeSelector.

Output: All onboarding composables themed with dashboard tokens. Theme cards match ThemeSelector visual
style (gradient background, color dots, accent border on selection).
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt
@android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt
@android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt
@android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowTest.kt

<interfaces>
<!-- Dashboard theme tokens available (from :core:design and :sdk:ui):
     DashboardTypography:
       .title (17sp), .sectionHeader (13sp), .caption, .description,
       .itemTitle, .primaryButtonLabel
     DashboardSpacing:
       .SpaceXXS (4dp), .SpaceXS (8dp), .SpaceS (12dp), .SpaceM (16dp),
       .SpaceL (24dp), .SpaceXL (48dp), .ItemGap (12dp), .SectionGap (24dp),
       .InGroupGap (8dp), .ScreenEdgePadding (16dp)
     TextEmphasis:
       .High (1.0f), .Medium (0.7f), .Disabled (0.4f)
     CardSize:
       .SMALL (8dp radius), .MEDIUM (12dp radius), .LARGE (16dp radius)
     LocalDashboardTheme.current → DashboardThemeDefinition:
       .primaryTextColor, .secondaryTextColor, .accentColor, .highlightColor,
       .backgroundBrush, .widgetBackgroundBrush, .widgetBorderColor
-->

<!-- Current onboarding uses:
     MaterialTheme.typography.headlineMedium → replace with DashboardTypography.title
     MaterialTheme.typography.bodyMedium → replace with DashboardTypography.description
     MaterialTheme.typography.bodySmall → replace with DashboardTypography.caption
     MaterialTheme.typography.titleSmall → replace with DashboardTypography.itemTitle
     MaterialTheme.colorScheme.primary → replace with theme.accentColor
     MaterialTheme.colorScheme.primaryContainer → replace with theme.accentColor.copy(alpha=0.15f)
     MaterialTheme.colorScheme.surfaceVariant → replace with theme.widgetBorderColor.copy(alpha=0.1f)
     MaterialTheme.colorScheme.onSurfaceVariant → replace with theme.secondaryTextColor
     MaterialTheme.colorScheme.outlineVariant → replace with theme.secondaryTextColor.copy(alpha=0.3f)
     Card() → Box with RoundedCornerShape + background
     Button() → Button with ButtonDefaults.buttonColors(containerColor = theme.accentColor)
     OutlinedButton() → OutlinedButton with colors(contentColor = theme.accentColor)
-->

<!-- :feature:onboarding already depends on :sdk:ui (has LocalDashboardTheme available)
     and :core:design (has DashboardTypography, DashboardSpacing). Verify in build.gradle.kts.
     If missing, add them. The dqxn.android.feature convention plugin should provide :sdk:ui
     and :core:design, but verify. -->

<!-- Theme card in ThemeSelector (from plan 14-06 rework):
     - aspectRatio(2f), background = theme.backgroundBrush, selected = 2dp highlightColor border
     - 4 color swatch dots (8dp): primaryTextColor, secondaryTextColor, accentColor, highlightColor
     - star icon for premium (not applicable in onboarding -- free themes only)
     The onboarding ThemeCard should match this visual style. -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate FirstRunFlow, AnalyticsConsentStep, and FirstLaunchDisclaimer to dashboard tokens</name>
  <files>
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt
  </files>
  <action>
**1. Verify build dependencies** -- Check `android/feature/onboarding/build.gradle.kts` for `:core:design` and `:sdk:ui` dependencies. The `dqxn.android.feature` convention plugin may already provide them. If not, add:
```kotlin
implementation(project(":core:design"))
implementation(project(":sdk:ui"))
```

**2. Update AnalyticsConsentStep.kt** -- Replace all MaterialTheme references:

Replace imports:
```kotlin
// REMOVE:
import androidx.compose.material3.MaterialTheme

// ADD:
import app.dqxn.android.core.design.token.DashboardSpacing
import app.dqxn.android.core.design.token.DashboardTypography
import app.dqxn.android.core.design.token.TextEmphasis
import app.dqxn.android.sdk.ui.theme.LocalDashboardTheme
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.OutlinedButton
```

Add theme access at top of composable:
```kotlin
val theme = LocalDashboardTheme.current
```

Replace typography and color usages:
- `MaterialTheme.typography.headlineMedium` → `DashboardTypography.title`
- `MaterialTheme.typography.bodyMedium` → `DashboardTypography.description`
- Title text color: `theme.primaryTextColor`
- Body text color: `theme.primaryTextColor.copy(alpha = TextEmphasis.Medium)`
- Button container color: `ButtonDefaults.buttonColors(containerColor = theme.accentColor, contentColor = if (theme.accentColor.luminance() > 0.5f) Color.Black else Color.White)`
- OutlinedButton content color: `ButtonDefaults.outlinedButtonColors(contentColor = theme.accentColor)`

Replace padding:
- `24.dp` padding → `DashboardSpacing.SpaceL`
- `16.dp` spacer → `DashboardSpacing.SpaceM`
- `12.dp` button spacing → `DashboardSpacing.ItemGap`

Import `androidx.compose.ui.graphics.Color` and `androidx.compose.ui.graphics.luminance` for the luminance check.

**3. Update FirstLaunchDisclaimer.kt** -- Replace all MaterialTheme references:

Same import replacement pattern as AnalyticsConsentStep.

Add theme access:
```kotlin
val theme = LocalDashboardTheme.current
```

Replace:
- `MaterialTheme.typography.bodyMedium` → `DashboardTypography.description`
- Text color → `theme.primaryTextColor.copy(alpha = TextEmphasis.Medium)`
- Button colors → `ButtonDefaults.buttonColors(containerColor = theme.accentColor, contentColor = ...)`
- `24.dp` → `DashboardSpacing.SpaceL`
- `16.dp` → `DashboardSpacing.SpaceM`

**4. Update FirstRunFlow.kt** -- Replace all MaterialTheme references in ThemeSelectionStep, ThemeCard, EditModeTourStep, TourCard, and PageIndicator:

Add imports:
```kotlin
import app.dqxn.android.core.design.token.CardSize
import app.dqxn.android.core.design.token.DashboardSpacing
import app.dqxn.android.core.design.token.DashboardTypography
import app.dqxn.android.core.design.token.TextEmphasis
import app.dqxn.android.sdk.ui.theme.LocalDashboardTheme
import androidx.compose.foundation.border
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.ButtonDefaults
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.luminance
```

Remove:
```kotlin
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.MaterialTheme
```

a) **ThemeSelectionStep**: Replace MaterialTheme typography and colors:
```kotlin
val theme = LocalDashboardTheme.current
```
- Title: `DashboardTypography.title`, color `theme.primaryTextColor`
- `24.dp` padding → `DashboardSpacing.SpaceL`
- `12.dp` spacing → `DashboardSpacing.ItemGap`
- Button: accent-colored

b) **ThemeCard** -- Rework to match ThemeSelector style:
Replace the Card composable with a Box-based layout matching ThemeSelector's theme cards:

```kotlin
@Composable
private fun ThemeCard(
    theme: DashboardThemeDefinition,
    isSelected: Boolean,
    onClick: () -> Unit,
    modifier: Modifier = Modifier,
) {
    val dashTheme = LocalDashboardTheme.current
    val cornerShape = RoundedCornerShape(CardSize.SMALL.cornerRadius)
    val borderColor = if (isSelected) dashTheme.highlightColor else Color.Transparent

    Column(
        modifier = modifier
            .width(100.dp)
            .testTag("theme_card_${theme.themeId}")
            .clip(cornerShape)
            .border(2.dp, borderColor, cornerShape)
            .clickable(onClick = onClick)
            .padding(4.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
    ) {
        // Gradient background swatch
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .aspectRatio(2f)
                .clip(cornerShape)
                .background(theme.backgroundBrush)
                .testTag("theme_swatch_${theme.themeId}"),
        )

        // Theme name
        Text(
            text = theme.displayName,
            style = DashboardTypography.caption,
            color = dashTheme.primaryTextColor,
            maxLines = 1,
        )

        // 4 color dots
        Row(
            horizontalArrangement = Arrangement.spacedBy(4.dp),
            modifier = Modifier.padding(top = 2.dp),
        ) {
            listOf(
                theme.primaryTextColor,
                theme.secondaryTextColor,
                theme.accentColor,
                theme.highlightColor,
            ).forEach { color ->
                Box(
                    modifier = Modifier
                        .size(8.dp)
                        .clip(CircleShape)
                        .background(color),
                )
            }
        }

        // Dark/Light label
        Text(
            text = if (theme.isDark) "Dark" else "Light",
            style = DashboardTypography.caption,
            color = dashTheme.secondaryTextColor,
        )
    }
}
```

c) **EditModeTourStep**: Replace MaterialTheme:
```kotlin
val theme = LocalDashboardTheme.current
```
- Title: `DashboardTypography.title`, color `theme.primaryTextColor`
- Button: accent-colored

d) **TourCard**: Replace Card with Box:
```kotlin
@Composable
private fun TourCard(
    text: String,
    modifier: Modifier = Modifier,
) {
    val theme = LocalDashboardTheme.current
    val shape = RoundedCornerShape(CardSize.MEDIUM.cornerRadius)

    Box(
        modifier = modifier
            .fillMaxWidth()
            .clip(shape)
            .background(theme.widgetBorderColor.copy(alpha = 0.1f)),
    ) {
        Text(
            text = text,
            style = DashboardTypography.description,
            color = theme.primaryTextColor,
            modifier = Modifier.padding(DashboardSpacing.SpaceM),
        )
    }
}
```

e) **PageIndicator**: Replace MaterialTheme colors:
```kotlin
@Composable
private fun PageIndicator(
    pageCount: Int,
    currentPage: Int,
    modifier: Modifier = Modifier,
) {
    val theme = LocalDashboardTheme.current

    Row(
        modifier = modifier.testTag("page_indicator"),
        horizontalArrangement = Arrangement.Center,
    ) {
        repeat(pageCount) { index ->
            val color = if (index == currentPage) theme.accentColor
                else theme.secondaryTextColor.copy(alpha = 0.3f)
            Box(
                modifier = Modifier
                    .padding(horizontal = 4.dp)
                    .size(8.dp)
                    .clip(CircleShape)
                    .background(color),
            )
        }
    }
}
```

f) **FirstRunFlow background**: Add a background modifier to the root Column:
```kotlin
val theme = LocalDashboardTheme.current

Column(
    modifier = modifier
        .fillMaxSize()
        .background(theme.backgroundBrush) // Dashboard gradient background
        .testTag("first_run_flow"),
)
```

**5. Ensure `@OptIn(ExperimentalLayoutApi::class)` is preserved** on ThemeSelectionStep since it still uses FlowRow for the theme grid. If switching to a different layout (e.g., LazyVerticalGrid), remove the annotation.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:onboarding:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>
    - AnalyticsConsentStep uses DashboardTypography and theme colors
    - FirstLaunchDisclaimer uses DashboardTypography and theme colors
    - ThemeSelectionStep uses dashboard tokens and spacing
    - ThemeCard shows gradient background, 4 color dots, accent border on selection
    - EditModeTourStep uses DashboardTypography and theme colors
    - TourCard uses Box with dashboard-style card background
    - PageIndicator uses theme.accentColor/secondaryTextColor
    - Buttons use theme.accentColor as container color
    - FirstRunFlow has dashboard gradient background
    - All MaterialTheme references removed from onboarding composables
    - Compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests verifying dashboard theme token usage in onboarding</name>
  <files>
    android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowTest.kt
  </files>
  <action>
Update FirstRunFlowTest.kt to verify dashboard theme token usage. Add source-based verification tests alongside existing behavioral tests.

**1. Source-based verification tests:**

```kotlin
@Test
fun `onboarding uses DashboardTypography not MaterialTheme typography`() {
    val projectDir = File(System.getProperty("user.dir"))
    val files = listOf(
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt",
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt",
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt",
    )

    files.forEach { path ->
        val content = File(projectDir, path).readText()
        assertThat(content).contains("DashboardTypography")
        assertThat(content).doesNotContain("MaterialTheme.typography")
    }
}

@Test
fun `onboarding uses LocalDashboardTheme not MaterialTheme colorScheme`() {
    val projectDir = File(System.getProperty("user.dir"))
    val files = listOf(
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt",
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/AnalyticsConsentStep.kt",
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstLaunchDisclaimer.kt",
    )

    files.forEach { path ->
        val content = File(projectDir, path).readText()
        assertThat(content).contains("LocalDashboardTheme")
        assertThat(content).doesNotContain("MaterialTheme.colorScheme")
    }
}

@Test
fun `theme cards use gradient background`() {
    val projectDir = File(System.getProperty("user.dir"))
    val content = File(
        projectDir,
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
    ).readText()
    assertThat(content).contains("backgroundBrush")
    assertThat(content).contains("theme_swatch_")
}

@Test
fun `theme cards show color dots`() {
    val projectDir = File(System.getProperty("user.dir"))
    val content = File(
        projectDir,
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
    ).readText()
    assertThat(content).contains("primaryTextColor")
    assertThat(content).contains("secondaryTextColor")
    assertThat(content).contains("accentColor")
    assertThat(content).contains("highlightColor")
}

@Test
fun `page indicator uses theme accent color`() {
    val projectDir = File(System.getProperty("user.dir"))
    val content = File(
        projectDir,
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
    ).readText()
    // PageIndicator uses theme.accentColor for active dot
    assertThat(content).contains("theme.accentColor")
}

@Test
fun `no Material Card composables used`() {
    val projectDir = File(System.getProperty("user.dir"))
    val content = File(
        projectDir,
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
    ).readText()
    // Card replaced with Box + background
    assertThat(content).doesNotContain("import androidx.compose.material3.Card")
    assertThat(content).doesNotContain("CardDefaults")
}

@Test
fun `first run flow has dashboard background`() {
    val projectDir = File(System.getProperty("user.dir"))
    val content = File(
        projectDir,
        "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
    ).readText()
    assertThat(content).contains("background(theme.backgroundBrush)")
}
```

**2. Update existing behavioral tests** -- if they rely on MaterialTheme token assertions, update. Existing tests that verify test tags and click behavior should still pass unchanged since test tags are preserved. The helper function wrapping FirstRunFlow in tests may need to wrap with a `CompositionLocalProvider(LocalDashboardTheme provides ...)` if tests set up their own theme. Check the existing test setup:
- If tests use `createComposeRule().setContent { FirstRunFlow(...) }` without providing `LocalDashboardTheme`, the composable will use `DefaultDashboardTheme` from `LocalDashboardTheme.current`'s default. This should work if a default is defined.
- If tests crash with "CompositionLocal LocalDashboardTheme not provided", wrap in `CompositionLocalProvider(LocalDashboardTheme provides DefaultTheme.dark)` using the default theme from `:sdk:ui`.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:onboarding:testDebugUnitTest --tests "*.FirstRunFlowTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - Source verification: DashboardTypography used, MaterialTheme.typography absent
    - Source verification: LocalDashboardTheme used, MaterialTheme.colorScheme absent
    - Theme cards verified: gradient background, color dots
    - Page indicator verified: theme.accentColor usage
    - No Material Card composables used
    - Dashboard background on FirstRunFlow verified
    - Existing behavioral tests still pass
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:onboarding:compileDebugKotlin --console=plain` -- compiles
2. `cd android && ./gradlew :feature:onboarding:testDebugUnitTest --tests "*.FirstRunFlowTest" --console=plain` -- all tests pass
3. `cd android && ./gradlew :feature:onboarding:testDebugUnitTest --console=plain` -- no regressions
4. `cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain` -- OverlayNavHost onboarding route still compiles
</verification>

<success_criteria>
- All 3 onboarding composables use DashboardTypography instead of MaterialTheme.typography
- All 3 use LocalDashboardTheme.current colors instead of MaterialTheme.colorScheme
- Theme cards show gradient background + 4 color dots (matching ThemeSelector style)
- PageIndicator uses theme.accentColor/secondaryTextColor
- Buttons use theme.accentColor container color
- TourCard uses Box with dashboard-style background instead of Material Card
- FirstRunFlow root has dashboard gradient background
- No MaterialTheme references remain in onboarding source files
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-11-SUMMARY.md`
</output>
