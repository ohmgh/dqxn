---
phase: 14-ui-visual-interactive-parity
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
  - android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowThemeTest.kt
autonomous: true
requirements: []

must_haves:
  truths:
    - "FirstRunFlow renders using dashboard theme tokens (DashboardTypography, LocalDashboardTheme) instead of MaterialTheme"
    - "Onboarding route in OverlayNavHost wraps FirstRunFlow in CompositionLocalProvider with essentials theme"
    - "The essentials theme selected matches system dark/light mode (minimalist for light, slate for dark)"
    - "FirstRunFlow uses OverlayScaffold(type=Hub) as its root container"
  artifacts:
    - path: "android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
      provides: "FirstRunFlow using dashboard theme tokens and OverlayScaffold"
      contains: "DashboardTypography"
    - path: "android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowThemeTest.kt"
      provides: "Tests verifying dashboard theme usage in onboarding"
  key_links:
    - from: "OverlayNavHost.kt"
      to: "FirstRunFlow.kt"
      via: "CompositionLocalProvider(LocalDashboardTheme provides onboardingTheme)"
      pattern: "LocalDashboardTheme"
---

<objective>
Apply dashboard theme to onboarding flow and wrap in OverlayScaffold.

Purpose: Current FirstRunFlow uses `MaterialTheme.typography.*` and `MaterialTheme.colorScheme.*`
(system Material colors), producing a jarring visual mismatch with the rest of the dashboard UI.
The old codebase styled onboarding using the dashboard's own theme system. This plan replaces
MaterialTheme references with DashboardTypography/LocalDashboardTheme and wraps the flow in
OverlayScaffold for consistent visual structure.

The essentials theme (minimalist for light system mode, slate for dark) is provided to FirstRunFlow
via CompositionLocalProvider at the OverlayNavHost onboarding route level.

Output: Visually consistent onboarding using dashboard design tokens.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
@android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/OnboardingViewModel.kt

<interfaces>
<!-- FirstRunFlow currently uses MaterialTheme.typography.headlineMedium, .titleSmall, .bodyMedium, .bodySmall -->
<!-- and MaterialTheme.colorScheme.primary, .primaryContainer, .surfaceVariant, .onSurfaceVariant, .outlineVariant -->
<!-- DashboardTypography available: title, sectionHeader, itemTitle, description, caption, label, primaryButtonLabel -->
<!-- LocalDashboardTheme provides: accentColor, primaryTextColor, secondaryTextColor, backgroundBrush, etc. -->
<!-- BuiltInThemes has: slate (dark), minimalist (light), freeThemes = [slate, minimalist] -->
<!-- OnboardingViewModel has: freeThemes (from builtInThemes.freeThemes) -->
<!-- OverlayNavHost's OnboardingRoute currently renders FirstRunFlow directly without theme wrapping -->
<!-- OverlayScaffold(title, overlayType=Hub, onClose) provides consistent container styling -->
<!-- isSystemInDarkTheme() from Compose gives system dark mode state -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace MaterialTheme with dashboard tokens in FirstRunFlow</name>
  <files>
    android/feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt
  </files>
  <action>
1. **Update imports**: Replace MaterialTheme imports with dashboard token imports:
```kotlin
// REMOVE or reduce:
import androidx.compose.material3.MaterialTheme

// ADD:
import app.dqxn.android.core.design.token.DashboardTypography
import app.dqxn.android.core.design.token.DashboardSpacing
import app.dqxn.android.core.design.token.TextEmphasis
import app.dqxn.android.core.design.token.CardSize
import app.dqxn.android.sdk.ui.theme.LocalDashboardTheme
```

Keep `MaterialTheme` import if Button/Card still use M3 defaults for shape/elevation (those are
fine -- only text and color references should use dashboard tokens).

2. **Wrap FirstRunFlow root in OverlayScaffold**. Replace the outer `Column.fillMaxSize()` with
   OverlayScaffold(type=Hub). The onboarding flow doesn't have a close button (it must be
   completed), so pass an empty onClose or use a dedicated "Skip" action. However, OverlayScaffold's
   TitleBar shows a close button -- for onboarding, we may want to hide it. Two options:

   **Option A (preferred):** Add a `showCloseButton: Boolean = true` parameter to OverlayScaffold
   and set it false for onboarding. If this is too invasive, use Option B.

   **Option B:** Don't use OverlayScaffold. Instead, apply the same background and padding manually
   using `LocalDashboardTheme.current.backgroundBrush` and `DashboardSpacing.ScreenEdgePadding`.
   This gives visual consistency without the close button.

   Go with **Option B** for minimal disruption -- apply the dashboard background and spacing tokens
   directly, matching OverlayScaffold's visual output without the TitleBar:

```kotlin
@Composable
public fun FirstRunFlow(
  freeThemes: ImmutableList<DashboardThemeDefinition>,
  onConsent: (Boolean) -> Unit,
  onDismissDisclaimer: () -> Unit,
  onSelectTheme: (String) -> Unit,
  onComplete: () -> Unit,
  modifier: Modifier = Modifier,
) {
  val theme = LocalDashboardTheme.current
  var currentPage by rememberSaveable { mutableIntStateOf(0) }
  // ... existing state ...

  Column(
    modifier = modifier
      .fillMaxSize()
      .background(theme.backgroundBrush)
      .padding(DashboardSpacing.ScreenEdgePadding)
      .testTag("first_run_flow"),
  ) {
    // ... rest of content ...
  }
}
```

3. **Replace all MaterialTheme.typography references** with DashboardTypography equivalents:
   - `MaterialTheme.typography.headlineMedium` -> `DashboardTypography.title`
   - `MaterialTheme.typography.titleSmall` -> `DashboardTypography.itemTitle`
   - `MaterialTheme.typography.bodyMedium` -> `DashboardTypography.description`
   - `MaterialTheme.typography.bodySmall` -> `DashboardTypography.caption`

4. **Replace all MaterialTheme.colorScheme references** with theme token equivalents:
   - `MaterialTheme.colorScheme.primary` -> `theme.accentColor`
   - `MaterialTheme.colorScheme.primaryContainer` -> `theme.accentColor.copy(alpha = 0.2f)`
   - `MaterialTheme.colorScheme.surfaceVariant` -> `theme.widgetBackgroundColor` (or a slight variation)
   - `MaterialTheme.colorScheme.onSurfaceVariant` -> `theme.secondaryTextColor`
   - `MaterialTheme.colorScheme.outlineVariant` -> `theme.secondaryTextColor.copy(alpha = TextEmphasis.Disabled)`

5. **Update ThemeCard** to use dashboard tokens:
```kotlin
@Composable
private fun ThemeCard(
  theme: DashboardThemeDefinition,
  isSelected: Boolean,
  onClick: () -> Unit,
  modifier: Modifier = Modifier,
) {
  val dashTheme = LocalDashboardTheme.current
  val shape = RoundedCornerShape(CardSize.SMALL.cornerRadius)
  val backgroundColor = if (isSelected) dashTheme.accentColor.copy(alpha = 0.2f)
    else dashTheme.widgetBackgroundColor

  Card(
    modifier = modifier
      .testTag("theme_card_${theme.themeId}")
      .clickable(onClick = onClick),
    colors = CardDefaults.cardColors(containerColor = backgroundColor),
    shape = shape,
  ) {
    Column(modifier = Modifier.padding(16.dp)) {
      Text(
        text = theme.displayName,
        style = DashboardTypography.itemTitle,
        color = dashTheme.primaryTextColor,
      )
      Text(
        text = if (theme.isDark) "Dark" else "Light",
        style = DashboardTypography.caption,
        color = dashTheme.secondaryTextColor,
      )
    }
  }
}
```

6. **Update TourCard** similarly:
```kotlin
@Composable
private fun TourCard(text: String, modifier: Modifier = Modifier) {
  val theme = LocalDashboardTheme.current
  Card(
    modifier = modifier.fillMaxWidth(),
    colors = CardDefaults.cardColors(containerColor = theme.widgetBackgroundColor),
    shape = RoundedCornerShape(CardSize.SMALL.cornerRadius),
  ) {
    Text(
      text = text,
      style = DashboardTypography.description,
      color = theme.primaryTextColor,
      modifier = Modifier.padding(16.dp),
    )
  }
}
```

7. **Update PageIndicator** to use dashboard theme colors:
```kotlin
val color = if (index == currentPage) theme.accentColor
  else theme.secondaryTextColor.copy(alpha = TextEmphasis.Disabled)
```

The `theme` variable should be obtained from `LocalDashboardTheme.current` in each composable
that references it.

8. **Button styling**: Material3 Button uses MaterialTheme colors by default. To match dashboard
   theme, set explicit colors:
```kotlin
Button(
  onClick = onContinue,
  colors = ButtonDefaults.buttonColors(
    containerColor = theme.accentColor,
    contentColor = if (theme.isDark) Color.Black else Color.White,
  ),
  modifier = Modifier.fillMaxWidth().testTag("theme_continue"),
) { ... }
```

Add `import androidx.compose.material3.ButtonDefaults` and `import androidx.compose.ui.graphics.Color` if needed.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:onboarding:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>
    - All MaterialTheme.typography.* replaced with DashboardTypography.*
    - All MaterialTheme.colorScheme.* replaced with LocalDashboardTheme.current.* tokens
    - Background uses theme.backgroundBrush
    - Padding uses DashboardSpacing.ScreenEdgePadding
    - Cards use dashboard token colors and CardSize corner radius
    - PageIndicator uses theme.accentColor
    - Buttons use theme.accentColor
    - Compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Provide dashboard theme to onboarding route in OverlayNavHost + tests</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
    android/feature/onboarding/src/test/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlowThemeTest.kt
  </files>
  <action>
1. **Wrap FirstRunFlow in CompositionLocalProvider** at the OverlayNavHost onboarding route.
   Determine the appropriate essentials theme based on system dark mode:

Find the `composable<OnboardingRoute>` block in OverlayNavHost.kt and wrap the FirstRunFlow
invocation:

```kotlin
composable<OnboardingRoute>(
  enterTransition = { DashboardMotion.hubEnter },
  exitTransition = { DashboardMotion.hubExit },
  popEnterTransition = { DashboardMotion.hubEnter },
  popExitTransition = { DashboardMotion.hubExit },
) {
  val onboardingVm = hiltViewModel<OnboardingViewModel>()
  val scope = rememberCoroutineScope()

  // Resolve essentials theme matching system light/dark
  val isSystemDark = isSystemInDarkTheme()
  val onboardingTheme = remember(isSystemDark) {
    if (isSystemDark) themeCoordinator.builtInThemes.slate
    else themeCoordinator.builtInThemes.minimalist
  }

  CompositionLocalProvider(LocalDashboardTheme provides onboardingTheme) {
    FirstRunFlow(
      freeThemes = onboardingVm.freeThemes,
      onConsent = onboardingVm::setAnalyticsConsent,
      onDismissDisclaimer = onboardingVm::setHasSeenDisclaimer,
      onSelectTheme = onboardingVm::selectTheme,
      onComplete = {
        scope.launch {
          onboardingVm.completeOnboarding()
          navController.popBackStack(EmptyRoute, inclusive = false)
        }
      },
    )
  }
}
```

Add `import androidx.compose.foundation.isSystemInDarkTheme` and
`import androidx.compose.runtime.CompositionLocalProvider` if not already imported.

If `themeCoordinator.builtInThemes` is not directly accessible (it might be private), pass
`builtInThemes` as a parameter to OverlayNavHost, or resolve from the OnboardingViewModel's
`freeThemes` list (find by isDark). Simplest approach:

```kotlin
val onboardingTheme = remember(isSystemDark) {
  onboardingVm.freeThemes.firstOrNull { it.isDark == isSystemDark }
    ?: onboardingVm.freeThemes.first()
}
```

This avoids needing to access `builtInThemes` from `themeCoordinator`.

2. **Create FirstRunFlowThemeTest**:

```kotlin
package app.dqxn.android.feature.onboarding

import com.google.common.truth.Truth.assertThat
import org.junit.jupiter.api.Test
import java.io.File

class FirstRunFlowThemeTest {

    private val projectDir = File(System.getProperty("user.dir"))

    @Test
    fun `FirstRunFlow uses DashboardTypography not MaterialTheme typography`() {
        val file = File(
            projectDir,
            "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
        )
        val content = file.readText()
        assertThat(content).contains("DashboardTypography")
        // Should not reference MaterialTheme.typography for text styling
        assertThat(content).doesNotContain("MaterialTheme.typography")
    }

    @Test
    fun `FirstRunFlow uses LocalDashboardTheme for colors`() {
        val file = File(
            projectDir,
            "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
        )
        val content = file.readText()
        assertThat(content).contains("LocalDashboardTheme")
        // Should not reference MaterialTheme.colorScheme for color values
        assertThat(content).doesNotContain("MaterialTheme.colorScheme")
    }

    @Test
    fun `FirstRunFlow applies dashboard background brush`() {
        val file = File(
            projectDir,
            "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
        )
        val content = file.readText()
        assertThat(content).contains("backgroundBrush")
    }

    @Test
    fun `OverlayNavHost provides onboarding theme via CompositionLocalProvider`() {
        val file = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt"
        )
        val content = file.readText()
        assertThat(content).contains("onboardingTheme")
        assertThat(content).contains("LocalDashboardTheme provides")
        assertThat(content).contains("isSystemInDarkTheme")
    }

    @Test
    fun `PageIndicator uses dashboard theme accent not MaterialTheme primary`() {
        val file = File(
            projectDir,
            "feature/onboarding/src/main/kotlin/app/dqxn/android/feature/onboarding/FirstRunFlow.kt"
        )
        val content = file.readText()
        assertThat(content).contains("accentColor")
    }
}
```
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:onboarding:testDebugUnitTest --tests "*.FirstRunFlowThemeTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - OverlayNavHost wraps onboarding in CompositionLocalProvider with system-appropriate theme
    - Essentials theme resolved: minimalist for light, slate for dark
    - All 5 theme verification tests pass
    - No MaterialTheme.typography or MaterialTheme.colorScheme references remain in FirstRunFlow
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:onboarding:compileDebugKotlin --console=plain` -- compiles
2. `cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain` -- OverlayNavHost compiles
3. `cd android && ./gradlew :feature:onboarding:testDebugUnitTest --tests "*.FirstRunFlowThemeTest" --console=plain` -- all tests pass
4. `cd android && ./gradlew :feature:onboarding:testDebugUnitTest --console=plain` -- no regressions in existing onboarding tests
</verification>

<success_criteria>
- FirstRunFlow renders with dashboard theme tokens (DashboardTypography, LocalDashboardTheme colors)
- No MaterialTheme.typography or MaterialTheme.colorScheme references in FirstRunFlow
- Background uses theme.backgroundBrush
- Essentials theme (minimalist/slate) provided via CompositionLocalProvider at OverlayNavHost
- System dark mode correctly selects slate (dark) or minimalist (light)
- Cards, buttons, and page indicator use dashboard theme tokens
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-11-SUMMARY.md`
</output>
