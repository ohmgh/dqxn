---
phase: 14-ui-visual-interactive-parity
plan: 08
type: execute
wave: 3
depends_on: [14-01, 14-02, 14-03, 14-04, 14-05, 14-06, 14-07, 14-09, 14-10, 14-11, 14-12]
files_modified:
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/Phase14RegressionTest.kt
autonomous: true
requirements: [F1.21, F1.29, F2.5, F2.18]

must_haves:
  truths:
    - "All Phase 7-13 tests still pass after Phase 14 changes"
    - "Widget add/remove animations verified with correct specs (spring StiffnessMediumLow)"
    - "Profile switching via swipe and bottom bar tap works"
    - "9 of 11 phase requirement IDs explicitly asserted in regression gate (10 tests); F2.18 and F3.14 covered by plan-specific tests (FocusOverlayToolbarTest, WidgetStatusOverlayTest)"
  artifacts:
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/Phase14RegressionTest.kt"
      provides: "Phase 14 regression gate validating no regressions from visual changes"
  key_links:
    - from: "Phase14RegressionTest.kt"
      to: "DashboardGrid.kt"
      via: "Validates animation specs haven't changed from F1.21"
      pattern: "StiffnessMediumLow"
---

<objective>
Phase 14 regression gate: verify all existing tests pass after visual/interactive changes, and verify
already-implemented requirements (F1.21 widget animations, F1.29 profile switching) haven't regressed.

Purpose: Phase 14 touches DashboardGrid, DashboardScreen, DashboardButtonBar, WidgetSlot,
WidgetStatusOverlay, OverlayNavHost, and ThemeCoordinator. Changes to these central files could break
existing behavior. This plan runs the full test suite and adds a regression test verifying the Phase 14
requirements that were already implemented (F1.21 add/remove animations, F1.29 profile switching)
haven't changed.

Output: Clean regression gate, Phase 14 requirement coverage verification.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- F1.21: Widget add/remove animations correctly implemented in DashboardGrid via
     AnimatedVisibility with spring(StiffnessMediumLow). Verified in Phase 7. -->
<!-- F1.29: Profile switching via horizontal swipe and bottom bar tap. Implemented in Phase 7
     (ProfilePageTransition + ProfileCoordinator). -->
<!-- F2.5: WidgetStatusCache overlays -- now themed (Plan 14-04). -->
<!-- F2.18: Focus interaction model -- now with toolbar (Plan 14-07). -->

Requirement ID -> Plan mapping for this phase:
- F1.8  -> 14-07 (focus overlay toolbar)
- F1.9  -> 14-02 (auto-hide bottom bar)
- F1.11 -> 14-03 (corner brackets)
- F1.20 -> 14-03 (grid snap overlay)
- F1.21 -> 14-08 (regression verification -- already implemented)
- F1.29 -> 14-08 (regression verification -- already implemented)
- F2.5  -> 14-04 (widget status overlay parity)
- F2.18 -> 14-07 (focus interaction model)
- F3.14 -> 14-04 (provider setup failure UX)
- F4.6  -> 14-05 + 14-06 (preview overlay + remove timeout per old codebase)
- F11.7 -> 14-04 (permission flow -- setup overlay tap)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 14 regression test and run full suite</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/Phase14RegressionTest.kt
  </files>
  <action>
1. Create a regression test that verifies the Phase 14 requirements map is complete and the key
invariants from already-implemented requirements haven't changed:

```kotlin
package app.dqxn.android.feature.dashboard

import com.google.common.truth.Truth.assertThat
import org.junit.jupiter.api.Test
import java.io.File

/**
 * Phase 14 regression gate: validates that UI visual/interactive parity changes
 * haven't broken existing implementations and all requirements are covered.
 */
class Phase14RegressionTest {

    private val projectDir = File(System.getProperty("user.dir"))

    @Test
    fun `F1_21 widget add-remove animations use spring StiffnessMediumLow`() {
        // F1.21: Widget add/remove animations must use spring(StiffnessMediumLow)
        val gridFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt"
        )
        assertThat(gridFile.exists()).isTrue()
        val content = gridFile.readText()

        // Verify AnimatedVisibility with spring stiffness for add/remove
        assertThat(content).contains("StiffnessMediumLow")
        assertThat(content).contains("AnimatedVisibility")
        assertThat(content).contains("scaleIn")
        assertThat(content).contains("scaleOut")
        assertThat(content).contains("fadeIn")
        assertThat(content).contains("fadeOut")
    }

    @Test
    fun `F1_29 profile switching infrastructure exists`() {
        // F1.29: Profile switching via swipe and bottom bar tap
        val profileTransitionFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/profile/ProfilePageTransition.kt"
        )
        assertThat(profileTransitionFile.exists()).isTrue()

        val buttonBarFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/DashboardButtonBar.kt"
        )
        assertThat(buttonBarFile.exists()).isTrue()
        val barContent = buttonBarFile.readText()
        assertThat(barContent).contains("onProfileClick")
        assertThat(barContent).contains("profile_")
    }

    @Test
    fun `F1_8 focus overlay toolbar exists`() {
        val toolbarFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/FocusOverlayToolbar.kt"
        )
        assertThat(toolbarFile.exists()).isTrue()
        val content = toolbarFile.readText()
        assertThat(content).contains("FocusOverlayToolbar")
        assertThat(content).contains("onDelete")
        assertThat(content).contains("onSettings")
    }

    @Test
    fun `F1_9 auto-hide timer state exists in DashboardScreen`() {
        val screenFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardScreen.kt"
        )
        assertThat(screenFile.exists()).isTrue()
        val content = screenFile.readText()
        assertThat(content).contains("isBarVisible")
        assertThat(content).contains("lastInteractionTime")
    }

    @Test
    fun `F1_11 corner brackets use Canvas draw not scale`() {
        val gridFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt"
        )
        val content = gridFile.readText()
        // Must use Canvas drawLine for brackets, NOT scaleX/scaleY for bracketScale
        assertThat(content).contains("drawLine")
        assertThat(content).contains("bracketStrokeWidth")
        // The old broken bracketScale should not be used for scaleX/Y
        assertThat(content).doesNotContain("scaleX = bracketScale")
        assertThat(content).doesNotContain("scaleY = bracketScale")
    }

    @Test
    fun `F1_20 grid overlay renders during drag`() {
        val gridFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/grid/DashboardGrid.kt"
        )
        val content = gridFile.readText()
        assertThat(content).contains("drawBehind")
    }

    @Test
    fun `F2_5 widget status overlays use accent color`() {
        val overlayFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/ui/WidgetStatusOverlay.kt"
        )
        val content = overlayFile.readText()
        assertThat(content).contains("accentColor")
    }

    @Test
    fun `F4_6 theme preview has no timeout -- stays active while selector is open`() {
        // F4.6: Per old codebase, theme preview has NO timeout. Preview stays active
        // for the entire duration the ThemeSelector sheet is open. Plan 14-06 removed
        // the 60s timeout that was incorrectly added. Verify it stays removed.
        val themeSelectorFile = File(
            projectDir,
            "../settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt"
        )
        assertThat(themeSelectorFile.exists()).isTrue()
        val content = themeSelectorFile.readText()
        assertThat(content).doesNotContain("PREVIEW_TIMEOUT_MS")
        assertThat(content).doesNotContain("60_000")
    }

    @Test
    fun `F11_7 widget status overlay routes to OpenWidgetSettings`() {
        // F11.7: Permission flow entry point -- SetupRequired/EntitlementRevoked tap â†’ OpenWidgetSettings
        val slotFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/binding/WidgetSlot.kt"
        )
        assertThat(slotFile.exists()).isTrue()
        val content = slotFile.readText()
        assertThat(content).contains("OpenWidgetSettings")
    }

    @Test
    fun `PreviewOverlay composable exists for dashboard-peek pattern`() {
        val previewFile = File(
            projectDir,
            "feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/PreviewOverlay.kt"
        )
        assertThat(previewFile.exists()).isTrue()
        val content = previewFile.readText()
        assertThat(content).contains("previewFraction")
        assertThat(content).contains("onDismiss")
    }
}
```

2. Run the full test suite to verify no regressions:

```bash
cd android && ./gradlew test --console=plain
```

If any failures occur, they must be investigated and fixed. The regression test also serves as a
checklist that all Phase 14 requirement artifacts exist.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.Phase14RegressionTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - All 10 Phase 14 regression assertions pass
    - F1.21 animation spec verified (StiffnessMediumLow, not changed)
    - F1.29 profile infrastructure verified
    - F1.8 focus toolbar verified
    - F1.9 auto-hide timer verified
    - F1.11 Canvas brackets verified (no bracketScale)
    - F2.5 accent color overlays verified
    - F4.6 preview no-timeout verified (removed per old codebase)
    - F11.7 OpenWidgetSettings routing verified
    - PreviewOverlay verified
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite as regression gate</name>
  <files>
    <!-- No files modified by this task. Failures are diagnosed and fixed in source plans (14-02 through 14-07), not here. -->
  </files>
  <action>
Run the complete test suite to verify no Phase 7-13 tests were broken by Phase 14 changes:

```bash
cd android && ./gradlew test --console=plain 2>&1 | tail -30
```

If any test failures occur:
1. Identify which plan's changes caused the failure
2. Fix the issue in the affected file
3. Re-run the failing test to confirm fix
4. Re-run full suite to confirm no cascade

Common areas to check:
- DashboardGridTest: may need updates for new Box wrapper and Canvas children
- WidgetSlotTest: may need updates for new WidgetStatusOverlay parameters
- OverlayNavHostTest / OverlayNavHostRouteTest: may need updates for PreviewOverlay wrapping
- ThemeCoordinatorTest: may need updates for new scope/timeout fields
- DashboardViewModelTest: may need updates for auto-hide state changes

DO NOT mark this task as done if any test fails. Fix all failures first.
  </action>
  <verify>
    <automated>cd android && ./gradlew test --console=plain 2>&1 | grep -E "BUILD (SUCCESS|FAILURE)|tests? (passed|failed)" | tail -5</automated>
  </verify>
  <done>
    - Full `./gradlew test` passes with BUILD SUCCESS
    - Zero test failures
    - All Phase 7-13 existing tests pass alongside Phase 14 changes
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.Phase14RegressionTest" --console=plain` -- all 10 assertions pass
2. `cd android && ./gradlew test --console=plain` -- BUILD SUCCESS with zero failures
</verification>

<success_criteria>
- Phase14RegressionTest covers 9 of 11 requirement IDs across 10 tests (F2.18 and F3.14 covered by plan-specific tests)
- Full test suite passes (BUILD SUCCESS)
- No regressions from Phase 14 visual changes
- F1.21 animation specs preserved
- F1.29 profile switching preserved
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-08-SUMMARY.md`
</output>
