---
phase: 14-ui-visual-interactive-parity
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/PreviewOverlay.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/PreviewOverlayTest.kt
autonomous: true
requirements: [F4.6]

must_haves:
  truths:
    - "Overlay sheets show dashboard-peek zone at top (transparent, tap-to-dismiss)"
    - "Settings sheet occupies 85% of screen (previewFraction = 0.15)"
    - "WidgetSettings sheet occupies 62% of screen (previewFraction = 0.38)"
    - "ThemeSelector sheet occupies 85% of screen (previewFraction = 0.15)"
    - "ThemeStudio sheet occupies 85% of screen (previewFraction = 0.15)"
    - "Tap on dashboard-peek zone dismisses overlay"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/PreviewOverlay.kt"
      provides: "PreviewOverlay composable with dashboard-peek zone"
      contains: "previewFraction"
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt"
      provides: "Routes wrapped in PreviewOverlay"
      contains: "PreviewOverlay"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/PreviewOverlayTest.kt"
      provides: "Preview overlay tests"
  key_links:
    - from: "OverlayNavHost.kt"
      to: "PreviewOverlay.kt"
      via: "PreviewOverlay wrapping route content"
      pattern: "PreviewOverlay"
---

<objective>
Implement PreviewOverlay dashboard-peek pattern for overlay sheets.

Purpose: Old codebase had a transparent tap-to-dismiss zone at the top of overlay sheets, showing the
dashboard behind. This lets users peek at theme changes and widget state while an overlay is open. The
new OverlayNavHost renders routes fullscreen with no peek zone. F4.6 theme preview requires seeing the
dashboard while previewing.

Output: PreviewOverlay composable with configurable peek fraction, wrapped around Settings,
WidgetSettings, ThemeSelector, and ThemeStudio routes.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt

<interfaces>
<!-- OverlayNavHost has 9 routes: Empty, WidgetPicker, Settings, WidgetSettings, Setup,
     ThemeSelector, ThemeStudio, Diagnostics, Onboarding -->
<!-- Routes that need PreviewOverlay: Settings, WidgetSettings, ThemeSelector, ThemeStudio -->
<!-- Routes that do NOT: Empty, WidgetPicker (hub), Setup (hub), Diagnostics (hub), Onboarding (hub) -->
<!-- Hub routes use scale+fade transitions; preview routes use vertical slide -->
<!-- navController.popBackStack(EmptyRoute, inclusive = false) dismisses to empty -->

Preview fractions from old codebase:
- Settings: 0.15f (85% of screen)
- WidgetSettings: 0.38f (62% of screen)
- ThemeSelector: 0.15f (85% of screen)
- ThemeStudio: 0.15f (85% of screen)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PreviewOverlay composable and wrap overlay routes</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/PreviewOverlay.kt
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt
  </files>
  <action>
**Create PreviewOverlay.kt** in `android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/`:

```kotlin
package app.dqxn.android.feature.dashboard.layer

import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxHeight
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.testTag

/**
 * Overlay wrapper that leaves a transparent tap-to-dismiss zone at the top showing the dashboard.
 *
 * [previewFraction] controls how much of the screen height remains transparent at the top.
 * - 0.15f = 15% transparent, 85% content (Settings, ThemeSelector, ThemeStudio)
 * - 0.38f = 38% transparent, 62% content (WidgetSettings)
 *
 * Tap on the transparent zone calls [onDismiss]. Content is anchored to the bottom.
 * Uses `clickable(indication = null)` to consume taps without visual ripple.
 *
 * Per Pitfall 4 in research: uses `clickable` (tap only), NOT `pointerInput`, to avoid
 * intercepting drag gestures meant for dashboard widgets visible in the peek zone.
 */
@Composable
public fun PreviewOverlay(
    previewFraction: Float,
    onDismiss: () -> Unit,
    modifier: Modifier = Modifier,
    content: @Composable () -> Unit,
) {
    Box(modifier = modifier.fillMaxSize()) {
        // Transparent zone: tap to dismiss
        Box(
            modifier = Modifier
                .fillMaxSize()
                .clickable(
                    indication = null,
                    interactionSource = remember { MutableInteractionSource() },
                    onClick = onDismiss,
                )
                .testTag("preview_dismiss_zone"),
        )

        // Content anchored to bottom, filling (1 - previewFraction) of screen height
        Box(
            modifier = Modifier
                .fillMaxHeight(1f - previewFraction)
                .fillMaxWidth()
                .align(Alignment.BottomCenter)
                .testTag("preview_content"),
        ) {
            content()
        }
    }
}
```

**Update OverlayNavHost.kt** to wrap the 4 preview routes:

1. **Settings route**: Wrap `MainSettings` call in `PreviewOverlay(previewFraction = 0.15f, ...)`:
```kotlin
composable<SettingsRoute>(...) {
    LaunchedEffect(Unit) { onCommand(DashboardCommand.PreviewTheme(null)) }
    // ... existing state collection ...

    PreviewOverlay(
        previewFraction = 0.15f,
        onDismiss = { navController.popBackStack(EmptyRoute, inclusive = false) },
    ) {
        MainSettings(
            // ... existing params ...
        )
    }
}
```

2. **WidgetSettings route**: Wrap in `PreviewOverlay(previewFraction = 0.38f, ...)`:
```kotlin
composable<WidgetSettingsRoute>(...) { backStackEntry ->
    val route = backStackEntry.toRoute<WidgetSettingsRoute>()

    PreviewOverlay(
        previewFraction = 0.38f,
        onDismiss = { navController.popBackStack(EmptyRoute, inclusive = false) },
    ) {
        WidgetSettingsSheet(
            // ... existing params ...
        )
    }
}
```

3. **ThemeSelector route**: Wrap in `PreviewOverlay(previewFraction = 0.15f, ...)`:
```kotlin
composable<ThemeSelectorRoute>(...) {
    val themeState by themeCoordinator.themeState.collectAsState()

    PreviewOverlay(
        previewFraction = 0.15f,
        onDismiss = {
            onCommand(DashboardCommand.PreviewTheme(null))
            navController.popBackStack()
        },
    ) {
        ThemeSelector(
            // ... existing params ...
        )
    }
}
```

4. **ThemeStudio route**: Wrap in `PreviewOverlay(previewFraction = 0.15f, ...)`:
```kotlin
composable<ThemeStudioRoute>(...) { backStackEntry ->
    val route = backStackEntry.toRoute<ThemeStudioRoute>()
    val existingTheme = allThemes.firstOrNull { it.themeId == route.themeId }

    PreviewOverlay(
        previewFraction = 0.15f,
        onDismiss = {
            onCommand(DashboardCommand.PreviewTheme(null))
            navController.popBackStack()
        },
    ) {
        ThemeStudio(
            // ... existing params ...
        )
    }
}
```

**Key:** The dismiss handlers for theme routes clear preview theme before popping. Settings dismiss pops to EmptyRoute. The existing `onClose` lambdas in each composable still work for their own dismiss buttons -- PreviewOverlay adds the tap-on-peek-zone dismissal path.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>
    - PreviewOverlay composable created with previewFraction and tap-to-dismiss
    - Settings, WidgetSettings, ThemeSelector, ThemeStudio wrapped in PreviewOverlay
    - Correct fractions: 0.15f for Settings/ThemeSelector/ThemeStudio, 0.38f for WidgetSettings
    - Hub routes (WidgetPicker, Setup, Diagnostics, Onboarding) not wrapped
    - Compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PreviewOverlay tests</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/layer/PreviewOverlayTest.kt
  </files>
  <action>
Create Compose UI tests for PreviewOverlay:

```kotlin
package app.dqxn.android.feature.dashboard.layer

import androidx.compose.material3.Text
import androidx.compose.ui.test.assertIsDisplayed
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.compose.ui.test.onNodeWithTag
import androidx.compose.ui.test.onNodeWithText
import androidx.compose.ui.test.performClick
import com.google.common.truth.Truth.assertThat
import org.junit.Rule
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config

@RunWith(RobolectricTestRunner::class)
@Config(sdk = [34])
class PreviewOverlayTest {

    @get:Rule
    val composeTestRule = createComposeRule()

    @Test
    fun `content is displayed`() {
        composeTestRule.setContent {
            PreviewOverlay(
                previewFraction = 0.15f,
                onDismiss = {},
            ) {
                Text("Sheet content", modifier = androidx.compose.ui.Modifier.testTag("sheet_content"))
            }
        }

        composeTestRule.onNodeWithTag("sheet_content").assertExists()
        composeTestRule.onNodeWithTag("preview_content").assertExists()
    }

    @Test
    fun `dismiss zone tap calls onDismiss`() {
        var dismissed = false

        composeTestRule.setContent {
            PreviewOverlay(
                previewFraction = 0.15f,
                onDismiss = { dismissed = true },
            ) {
                Text("Content")
            }
        }

        composeTestRule.onNodeWithTag("preview_dismiss_zone").performClick()
        assertThat(dismissed).isTrue()
    }

    @Test
    fun `preview content zone exists`() {
        composeTestRule.setContent {
            PreviewOverlay(
                previewFraction = 0.38f,
                onDismiss = {},
            ) {
                Text("Widget settings")
            }
        }

        composeTestRule.onNodeWithTag("preview_content").assertExists()
        composeTestRule.onNodeWithTag("preview_dismiss_zone").assertExists()
    }
}
```
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.PreviewOverlayTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - All 3 PreviewOverlay tests pass
    - Dismiss zone tap verified
    - Content zone rendered
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain` -- compiles
2. `cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.PreviewOverlayTest" --console=plain` -- all tests pass
3. `cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.OverlayNavHostTest" --console=plain` -- existing tests still pass
</verification>

<success_criteria>
- PreviewOverlay composable with configurable previewFraction
- 4 routes wrapped with correct fractions
- Tap-to-dismiss on peek zone works
- Hub routes NOT wrapped
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-05-SUMMARY.md`
</output>
