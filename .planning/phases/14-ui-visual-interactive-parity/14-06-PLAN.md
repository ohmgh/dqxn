---
phase: 14-ui-visual-interactive-parity
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelectorTest.kt
autonomous: true
requirements: [F4.6]

must_haves:
  truths:
    - "Theme preview stays active for the entire duration the ThemeSelector sheet is open -- NO timeout"
    - "Preview is cleared on ThemeSelector disposal via DisposableEffect (already exists)"
    - "Preview is cleared on Settings entry via LaunchedEffect in OverlayNavHost (already exists)"
    - "Entitlement revocation still clears preview of revoked themes (F4.10)"
    - "PREVIEW_TIMEOUT_MS constant and timeout LaunchedEffect are removed from ThemeSelector.kt"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt"
      provides: "Theme preview without timeout -- preview active while selector is open"
      contains: "DisposableEffect"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelectorTest.kt"
      provides: "Tests verifying no timeout, disposal cleanup, entitlement revocation"
  key_links:
    - from: "ThemeSelector.kt"
      to: "OverlayNavHost.kt"
      via: "onClearPreview callback clears preview via DashboardCommand.PreviewTheme(null)"
      pattern: "onClearPreview"
---

<objective>
Remove the 60-second theme preview timeout from ThemeSelector.kt.

Purpose: The old codebase has NO theme preview timeout. Preview stays active for the entire duration
the ThemeSelector sheet is open, cleared only when the user exits (via DisposableEffect on disposal
and LaunchedEffect on Settings entry). The new codebase incorrectly added a 60s timeout at
ThemeSelector.kt lines 47-48 and 87-93. This must be removed to match old codebase behavior.

The F4.6 requirement says "Preview times out after 60 seconds" -- but the old codebase source is
truth and has no timeout. The DisposableEffect cleanup (line 110) and entitlement revocation
(lines 96-107) must be preserved. No changes to ThemeCoordinator needed (it has no timeout code).

Output: PREVIEW_TIMEOUT_MS removed, timeout LaunchedEffect removed, tests verifying correct behavior.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/layer/OverlayNavHost.kt

<interfaces>
<!-- ThemeSelector.kt currently has:
     Line 46: import kotlinx.coroutines.delay
     Line 47-48: PREVIEW_TIMEOUT_MS = 60_000L constant
     Lines 87-93: LaunchedEffect(previewTheme?.themeId) timeout block that calls delay(PREVIEW_TIMEOUT_MS)
     Lines 96-107: Entitlement revocation LaunchedEffect -- KEEP this
     Line 110: DisposableEffect(Unit) { onDispose { onClearPreview() } } -- KEEP this
-->
<!-- OverlayNavHost.kt line 141: LaunchedEffect(Unit) { onCommand(DashboardCommand.PreviewTheme(null)) }
     on Settings entry -- this is a separate safety net and is already correct -->
<!-- ThemeCoordinator has NO timeout code (verified: no PREVIEW_TIMEOUT_MS or onPreviewTimeout) -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove timeout constant and LaunchedEffect from ThemeSelector</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt
  </files>
  <action>
1. **Remove the `PREVIEW_TIMEOUT_MS` constant** (lines 47-48):
```kotlin
// DELETE these lines:
/** Preview timeout duration in milliseconds (60 seconds). */
internal const val PREVIEW_TIMEOUT_MS: Long = 60_000L
```

2. **Remove the timeout LaunchedEffect** (lines 87-93):
```kotlin
// DELETE this entire block:
  // -- Preview timeout: 60s auto-revert keyed on themeId (F4.6) --
  LaunchedEffect(previewTheme?.themeId) {
    if (previewTheme != null) {
      delay(PREVIEW_TIMEOUT_MS)
      onClearPreview()
      onShowToast("Preview timed out")
    }
  }
```

3. **Remove the unused `kotlinx.coroutines.delay` import** (line 46) -- no longer needed after removing the timeout.

4. **Update the KDoc** on ThemeSelector to remove timeout reference. Change:
```
 * - **Preview lifecycle**: 60s timeout auto-reverts via [LaunchedEffect] keyed on themeId (F4.6).
```
to:
```
 * - **Preview lifecycle**: Active while selector is open; cleared on disposal (F4.6).
```

5. **Keep all other code unchanged**:
   - DisposableEffect cleanup (line 110): `DisposableEffect(Unit) { onDispose { onClearPreview() } }`
   - Entitlement revocation (lines 96-107): the `LaunchedEffect(currentEntitlements, previewTheme)` block
   - The `onShowToast` parameter (still used by entitlement revocation and clone limit)
   - Sort logic, card rendering, etc.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>
    - PREVIEW_TIMEOUT_MS constant removed
    - Timeout LaunchedEffect removed
    - `delay` import removed
    - KDoc updated to reflect no-timeout behavior
    - DisposableEffect and entitlement revocation preserved
    - Compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests verifying no-timeout behavior and cleanup paths</name>
  <files>
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelectorTest.kt
  </files>
  <action>
Create or update ThemeSelectorTest to verify the correct preview lifecycle:

```kotlin
package app.dqxn.android.feature.settings.theme

import androidx.compose.runtime.mutableStateOf
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.compose.ui.test.onNodeWithTag
import androidx.compose.ui.test.assertIsDisplayed
import app.dqxn.android.sdk.contracts.entitlement.EntitlementManager
import app.dqxn.android.sdk.ui.theme.DashboardThemeDefinition
import app.dqxn.android.sdk.ui.theme.LocalDashboardTheme
import com.google.common.truth.Truth.assertThat
import io.mockk.every
import io.mockk.mockk
import kotlinx.collections.immutable.persistentListOf
import kotlinx.coroutines.flow.MutableStateFlow
import org.junit.Rule
import org.junit.Test
import java.io.File

class ThemeSelectorTest {

    @get:Rule
    val composeRule = createComposeRule()

    @Test
    fun `PREVIEW_TIMEOUT_MS constant does not exist in ThemeSelector source`() {
        // Verify the timeout constant was removed -- source-level verification
        val projectDir = File(System.getProperty("user.dir"))
        val selectorFile = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt"
        )
        assertThat(selectorFile.exists()).isTrue()
        val content = selectorFile.readText()
        assertThat(content).doesNotContain("PREVIEW_TIMEOUT_MS")
        assertThat(content).doesNotContain("Preview timed out")
        // delay import should be removed (no longer needed)
        assertThat(content).doesNotContain("import kotlinx.coroutines.delay")
    }

    @Test
    fun `DisposableEffect cleanup is present in ThemeSelector source`() {
        val projectDir = File(System.getProperty("user.dir"))
        val selectorFile = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt"
        )
        val content = selectorFile.readText()
        // DisposableEffect must still be present for cleanup on disposal
        assertThat(content).contains("DisposableEffect")
        assertThat(content).contains("onClearPreview")
    }

    @Test
    fun `entitlement revocation cleanup is present in ThemeSelector source`() {
        val projectDir = File(System.getProperty("user.dir"))
        val selectorFile = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/theme/ThemeSelector.kt"
        )
        val content = selectorFile.readText()
        // Entitlement revocation LaunchedEffect must be preserved
        assertThat(content).contains("currentEntitlements")
        assertThat(content).contains("Theme no longer available")
    }

    @Test
    fun `preview stays active indefinitely while selector is displayed`() {
        val previewTheme = mockk<DashboardThemeDefinition>(relaxed = true).also {
            every { it.themeId } returns "test-theme"
            every { it.isDark } returns false
            every { it.displayName } returns "Test"
            every { it.requiredAnyEntitlement } returns null
        }
        val clearCount = mutableStateOf(0)

        val entitlementManager = mockk<EntitlementManager>(relaxed = true).also {
            every { it.entitlementChanges } returns MutableStateFlow(emptySet())
            every { it.getActiveEntitlements() } returns emptySet()
            every { it.hasEntitlement(any()) } returns true
        }

        val theme = mockk<DashboardThemeDefinition>(relaxed = true).also {
            every { it.accentColor } returns androidx.compose.ui.graphics.Color.Blue
            every { it.primaryTextColor } returns androidx.compose.ui.graphics.Color.White
            every { it.secondaryTextColor } returns androidx.compose.ui.graphics.Color.Gray
            every { it.backgroundBrush } returns mockk(relaxed = true)
            every { it.widgetBorderColor } returns androidx.compose.ui.graphics.Color.Gray
        }

        composeRule.setContent {
            androidx.compose.runtime.CompositionLocalProvider(
                LocalDashboardTheme provides theme,
            ) {
                ThemeSelector(
                    allThemes = persistentListOf(previewTheme),
                    previewTheme = previewTheme,
                    customThemeCount = 0,
                    entitlementManager = entitlementManager,
                    onPreviewTheme = {},
                    onApplyTheme = {},
                    onClearPreview = { clearCount.value++ },
                    onCloneToCustom = {},
                    onOpenStudio = {},
                    onDeleteCustom = {},
                    onShowToast = {},
                    onClose = {},
                )
            }
        }

        // Advance well past 60 seconds -- preview should NOT be auto-cleared
        composeRule.mainClock.advanceTimeBy(120_000L)
        composeRule.waitForIdle()

        // onClearPreview should NOT have been called by a timeout
        // (it may be called once by DisposableEffect if the composable was recomposed, but
        // NOT by a timeout mechanism)
        assertThat(clearCount.value).isEqualTo(0)

        // Selector should still be displayed
        composeRule.onNodeWithTag("theme_selector").assertIsDisplayed()
    }
}
```

Adapt the mock setup to match actual DashboardThemeDefinition fields. The key test is
`preview stays active indefinitely` -- it advances 120 seconds and verifies no timeout callback fired.

If there is an existing ThemeSelectorTest file, merge these tests into it rather than replacing.
Check first with `find` or `ls`. If existing tests reference PREVIEW_TIMEOUT_MS, update them.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.ThemeSelectorTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - 4 tests pass
    - Source-level verification: no PREVIEW_TIMEOUT_MS, no "Preview timed out", no delay import
    - DisposableEffect and entitlement revocation preserved
    - Preview stays active past 120s without timeout callback
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:settings:compileDebugKotlin --console=plain` -- compiles
2. `cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.ThemeSelectorTest" --console=plain` -- all tests pass
3. `cd android && ./gradlew :feature:settings:testDebugUnitTest --console=plain` -- no regressions in settings tests
</verification>

<success_criteria>
- PREVIEW_TIMEOUT_MS constant removed from ThemeSelector.kt
- Timeout LaunchedEffect removed
- delay import removed
- DisposableEffect cleanup preserved
- Entitlement revocation check preserved
- Preview stays active indefinitely while ThemeSelector is displayed
- All 4 theme selector tests pass
- Existing settings tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-06-SUMMARY.md`
</output>
