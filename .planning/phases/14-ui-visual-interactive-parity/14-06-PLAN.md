---
phase: 14-ui-visual-interactive-parity
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinator.kt
  - android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/DashboardViewModel.kt
  - android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemePreviewTimeoutTest.kt
autonomous: true
requirements: [F4.6]

must_haves:
  truths:
    - "Theme preview automatically reverts after 60 seconds"
    - "Toast 'Theme preview ended.' fires on timeout"
    - "Explicitly clearing preview cancels the timeout"
    - "Setting a new theme while previewing cancels preview"
  artifacts:
    - path: "android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinator.kt"
      provides: "60-second preview timeout with auto-revert"
      contains: "PREVIEW_TIMEOUT_MS"
    - path: "android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemePreviewTimeoutTest.kt"
      provides: "Preview timeout tests"
  key_links:
    - from: "ThemeCoordinator.kt"
      to: "ThemeState.previewTheme"
      via: "Timeout auto-clears previewTheme after 60s"
      pattern: "PREVIEW_TIMEOUT_MS"
---

<objective>
Add 60-second theme preview timeout with auto-revert and toast notification.

Purpose: F4.6 requires theme preview to time out after 60 seconds with toast "Theme preview ended."
and revert to the committed theme. Currently ThemeCoordinator has previewTheme StateFlow but no
timeout mechanism. Without a timeout, a user could leave the preview active indefinitely.

Output: Timeout coroutine in ThemeCoordinator, toast callback, and automated tests.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinator.kt

<interfaces>
<!-- ThemeCoordinator owns _themeState: MutableStateFlow<ThemeState> -->
<!-- handlePreviewTheme(theme: DashboardThemeDefinition?) sets/clears preview -->
<!-- initialize(scope: CoroutineScope) called from ViewModel init -->
<!-- ThemeState.displayTheme returns previewTheme ?: currentTheme -->
<!-- Toast shown via viewModel.notificationCoordinator.showToast() in DashboardScreen -->
<!-- Need: callback from ThemeCoordinator -> ViewModel -> toast display -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement preview timeout in ThemeCoordinator</name>
  <files>
    android/feature/dashboard/src/main/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemeCoordinator.kt
  </files>
  <action>
Add a preview timeout mechanism to ThemeCoordinator:

1. Add a `Job` field to track the timeout coroutine:
```kotlin
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay

private var previewTimeoutJob: Job? = null
```

2. Add a toast callback that the ViewModel can set:
```kotlin
/** Callback invoked when preview times out. Typically shows a toast. */
public var onPreviewTimeout: (() -> Unit)? = null
```

3. Add a companion constant:
```kotlin
public companion object {
    /** Preview timeout in milliseconds (60 seconds). */
    public const val PREVIEW_TIMEOUT_MS: Long = 60_000L
}
```

4. Modify `handlePreviewTheme` to manage the timeout:
```kotlin
public fun handlePreviewTheme(theme: DashboardThemeDefinition?) {
    // Cancel any existing timeout
    previewTimeoutJob?.cancel()
    previewTimeoutJob = null

    _themeState.update { it.copy(previewTheme = theme) }

    if (theme != null) {
        // Start timeout: auto-revert after 60 seconds
        previewTimeoutJob = scope.launch {
            delay(PREVIEW_TIMEOUT_MS)
            // Timeout reached: revert preview and notify
            _themeState.update { it.copy(previewTheme = null) }
            onPreviewTimeout?.invoke()
            logger.info(LogTags.THEME) { "Preview timed out after ${PREVIEW_TIMEOUT_MS}ms" }
        }
        logger.info(LogTags.THEME) { "Preview theme set: ${theme.themeId}" }
    } else {
        logger.info(LogTags.THEME) { "Preview theme cleared" }
    }
}
```

5. Modify `handleSetTheme` to also cancel the preview timeout (setting a theme while previewing should clear preview):
```kotlin
public suspend fun handleSetTheme(themeId: String) {
    val theme = builtInThemes.resolveById(themeId) ?: return

    // Cancel preview timeout if active
    previewTimeoutJob?.cancel()
    previewTimeoutJob = null

    _themeState.update { it.copy(currentTheme = theme, previewTheme = null) }

    // Persist to the appropriate slot...
    // (rest unchanged)
}
```

6. Store the scope from `initialize()` so `handlePreviewTheme` can launch:
```kotlin
private lateinit var scope: CoroutineScope

public fun initialize(scope: CoroutineScope) {
    this.scope = scope
    // ... existing flow collections ...
}
```

The `scope` field may already exist if needed by existing code. If `initialize()` already stores a scope, reuse it. If not, add `private lateinit var scope: CoroutineScope` and store it in `initialize()`.

**Wire the toast callback in DashboardViewModel** (or wherever ThemeCoordinator is initialized):

In DashboardViewModel (or wherever `themeCoordinator.initialize(viewModelScope)` is called), add:
```kotlin
themeCoordinator.onPreviewTimeout = {
    notificationCoordinator.showToast(
        InAppNotification.Toast(
            id = "preview_timeout_${System.currentTimeMillis()}",
            priority = NotificationPriority.NORMAL,
            timestamp = System.currentTimeMillis(),
            message = "Theme preview ended.",
            durationMs = 3000L,
        )
    )
}
```

If the ViewModel file is in a different plan's ownership, note that the wiring should be done alongside the ThemeCoordinator change. Since DashboardViewModel is not exclusively owned by another Wave 1 plan, it's safe to modify.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>
    - PREVIEW_TIMEOUT_MS = 60_000L constant defined
    - previewTimeoutJob launched on preview set, cancelled on clear or theme commit
    - onPreviewTimeout callback fires toast "Theme preview ended."
    - handleSetTheme clears preview and cancels timeout
    - Compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add preview timeout tests</name>
  <files>
    android/feature/dashboard/src/test/kotlin/app/dqxn/android/feature/dashboard/coordinator/ThemePreviewTimeoutTest.kt
  </files>
  <action>
Create JUnit5 tests with virtual time for the preview timeout:

```kotlin
package app.dqxn.android.feature.dashboard.coordinator

import app.dqxn.android.core.design.theme.BuiltInThemes
import app.dqxn.android.core.design.theme.ThemeAutoSwitchEngine
import app.dqxn.android.data.preferences.UserPreferencesRepository
import app.dqxn.android.sdk.observability.log.DqxnLogger
import app.dqxn.android.sdk.ui.theme.DashboardThemeDefinition
import com.google.common.truth.Truth.assertThat
import io.mockk.every
import io.mockk.mockk
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.test.StandardTestDispatcher
import kotlinx.coroutines.test.TestScope
import kotlinx.coroutines.test.advanceTimeBy
import kotlinx.coroutines.test.runTest
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test

@OptIn(ExperimentalCoroutinesApi::class)
class ThemePreviewTimeoutTest {

    private val testScheduler = StandardTestDispatcher()
    private val testScope = TestScope(testScheduler)

    private val builtInThemes = mockk<BuiltInThemes>(relaxed = true)
    private val themeAutoSwitchEngine = mockk<ThemeAutoSwitchEngine>(relaxed = true).also {
        every { it.isDarkActive } returns MutableStateFlow(false)
    }
    private val userPreferencesRepository = mockk<UserPreferencesRepository>(relaxed = true).also {
        every { it.autoSwitchMode } returns MutableStateFlow(app.dqxn.android.sdk.contracts.theme.AutoSwitchMode.SYSTEM)
        every { it.lightThemeId } returns MutableStateFlow("minimalist")
        every { it.darkThemeId } returns MutableStateFlow("slate")
    }
    private val logger = mockk<DqxnLogger>(relaxed = true)

    private val testTheme = mockk<DashboardThemeDefinition>(relaxed = true).also {
        every { it.themeId } returns "test-theme"
        every { it.isDark } returns false
    }

    private lateinit var coordinator: ThemeCoordinator

    @BeforeEach
    fun setUp() {
        every { builtInThemes.minimalist } returns mockk(relaxed = true)
        every { builtInThemes.slate } returns mockk(relaxed = true)

        coordinator = ThemeCoordinator(
            themeAutoSwitchEngine = themeAutoSwitchEngine,
            builtInThemes = builtInThemes,
            userPreferencesRepository = userPreferencesRepository,
            logger = logger,
        )
        coordinator.initialize(testScope)
    }

    @Test
    fun `preview theme set successfully`() = testScope.runTest {
        coordinator.handlePreviewTheme(testTheme)

        assertThat(coordinator.themeState.value.previewTheme).isEqualTo(testTheme)
    }

    @Test
    fun `preview reverts after 60 seconds`() = testScope.runTest {
        coordinator.handlePreviewTheme(testTheme)
        assertThat(coordinator.themeState.value.previewTheme).isNotNull()

        advanceTimeBy(ThemeCoordinator.PREVIEW_TIMEOUT_MS + 1)
        testScheduler.runCurrent()

        assertThat(coordinator.themeState.value.previewTheme).isNull()
    }

    @Test
    fun `timeout callback fires on expiry`() = testScope.runTest {
        var timeoutFired = false
        coordinator.onPreviewTimeout = { timeoutFired = true }

        coordinator.handlePreviewTheme(testTheme)
        advanceTimeBy(ThemeCoordinator.PREVIEW_TIMEOUT_MS + 1)
        testScheduler.runCurrent()

        assertThat(timeoutFired).isTrue()
    }

    @Test
    fun `clearing preview cancels timeout`() = testScope.runTest {
        var timeoutFired = false
        coordinator.onPreviewTimeout = { timeoutFired = true }

        coordinator.handlePreviewTheme(testTheme)
        advanceTimeBy(30_000L) // 30 seconds in
        coordinator.handlePreviewTheme(null) // Clear

        advanceTimeBy(40_000L) // Past original timeout
        testScheduler.runCurrent()

        assertThat(timeoutFired).isFalse()
        assertThat(coordinator.themeState.value.previewTheme).isNull()
    }

    @Test
    fun `setting new preview resets timeout`() = testScope.runTest {
        val secondTheme = mockk<DashboardThemeDefinition>(relaxed = true).also {
            every { it.themeId } returns "second-theme"
        }

        coordinator.handlePreviewTheme(testTheme)
        advanceTimeBy(50_000L) // 50s into first preview
        coordinator.handlePreviewTheme(secondTheme) // Reset timer

        advanceTimeBy(30_000L) // 30s into second preview (80s total)
        testScheduler.runCurrent()

        // Should still be previewing (only 30s into second timeout)
        assertThat(coordinator.themeState.value.previewTheme).isEqualTo(secondTheme)

        advanceTimeBy(31_000L) // Now 61s into second preview
        testScheduler.runCurrent()

        // Should have timed out
        assertThat(coordinator.themeState.value.previewTheme).isNull()
    }
}
```

Adapt mock setup to match actual constructor parameters. If `builtInThemes.minimalist` or `builtInThemes.slate` are vals (not funs), mock them appropriately. The key test patterns: virtual time advancement with StandardTestDispatcher, verifying state changes after timeout.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.ThemePreviewTimeoutTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - All 5 preview timeout tests pass
    - Timeout at 60s verified with virtual time
    - Callback fires on expiry
    - Clearing preview cancels timeout
    - New preview resets timer
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain` -- compiles
2. `cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.ThemePreviewTimeoutTest" --console=plain` -- all tests pass
3. `cd android && ./gradlew :feature:dashboard:testDebugUnitTest --tests "*.ThemeCoordinatorTest" --console=plain` -- existing tests still pass
</verification>

<success_criteria>
- Preview reverts after exactly 60 seconds
- Toast callback fires on timeout
- Clearing preview cancels timeout
- Setting theme clears preview
- New preview resets timer
- All 5 timeout tests pass
- Existing ThemeCoordinatorTest still passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-06-SUMMARY.md`
</output>
