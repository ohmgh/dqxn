---
phase: 14-ui-visual-interactive-parity
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
  - android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerLayoutTest.kt
autonomous: true
requirements: []

must_haves:
  truths:
    - "Widget picker uses LazyVerticalStaggeredGrid with adaptive min-120dp columns"
    - "Wide widgets (aspectRatio > 1.5) span full line"
    - "Per-widget preview scale computed from aspect ratio (not hardcoded 0.5f)"
    - "Pack headers use displayName from DashboardPackManifest (via Set<DashboardPackManifest> injection) or capitalized packId as fallback"
    - "Lock icons, HW badges, description text, entitlement gating preserved from current implementation"
  artifacts:
    - path: "android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
      provides: "Adaptive multi-column staggered grid widget picker"
      contains: "LazyVerticalStaggeredGrid"
    - path: "android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerLayoutTest.kt"
      provides: "Tests for adaptive layout, spanning, and scale computation"
  key_links:
    - from: "WidgetPicker.kt"
      to: "WidgetRenderer.kt"
      via: "aspectRatio from WidgetSpec determines spanning and preview scale"
      pattern: "aspectRatio"
---

<objective>
Replace hardcoded 2-column FlowRow widget picker with adaptive LazyVerticalStaggeredGrid.

Purpose: Current WidgetPicker uses a hardcoded 2-column FlowRow with fixed 0.5f preview scale.
Old codebase used `LazyVerticalStaggeredGrid(columns = StaggeredGridCells.Adaptive(minSize = 120.dp))`
with variable-height cards, computed scale, and intelligent spanning (wide widgets span full line).
The new implementation should adapt to screen size while preserving the existing entitlement badges,
hardware icons, description text, and live preview features.

Key change: FlowRow -> LazyVerticalStaggeredGrid. This requires removing the outer scrollable Column
wrapper (the staggered grid handles its own scrolling). The Phase 10 decision that chose FlowRow over
LazyVerticalGrid was due to unbounded constraints in a scrollable Column -- by removing the scrollable
Column and letting the grid scroll directly, this issue is avoided.

Output: Adaptive column count, per-widget scale, wide-widget full-line spanning.
</objective>

<execution_context>
@/Users/ohm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/widget/WidgetSpec.kt
@android/sdk/contracts/src/main/kotlin/app/dqxn/android/sdk/contracts/pack/DashboardPackManifest.kt

<interfaces>
<!-- WidgetSpec.aspectRatio: Float? -- null means no specific ratio (use 1:1 default) -->
<!-- WidgetSpec.priority: Int -- higher = more prominent -->
<!-- WidgetRenderer extends WidgetSpec + Gated -->
<!-- DashboardPackManifest has displayName for pack header text -->
<!-- WidgetPicker receives WidgetRegistry and EntitlementManager -->
<!-- Set<DashboardPackManifest> can be injected via Hilt multibinding in OverlayNavHost -->
<!-- Current WidgetPicker is inside OverlayScaffold which provides bounded height via Column -->
<!-- FlowRow issue: LazyVerticalGrid gets 0 height inside scrollable Column -->
<!-- Solution: Remove scrollable Column wrapper, let LazyVerticalStaggeredGrid scroll directly -->

<!-- LazyVerticalStaggeredGrid API:
     import androidx.compose.foundation.lazy.staggeredgrid.*
     LazyVerticalStaggeredGrid(
       columns = StaggeredGridCells.Adaptive(minSize = 120.dp),
       ...
     ) {
       item(span = StaggeredGridItemSpan.FullLine) { PackHeader(...) }
       items(...) { widget -> WidgetPickerCard(...) }
     }
-->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace FlowRow with LazyVerticalStaggeredGrid in WidgetPicker</name>
  <files>
    android/feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt
  </files>
  <action>
1. **Update imports**: Replace FlowRow imports with staggered grid imports:
```kotlin
// REMOVE:
import androidx.compose.foundation.layout.ExperimentalLayoutApi
import androidx.compose.foundation.layout.FlowRow
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll

// ADD:
import androidx.compose.foundation.lazy.staggeredgrid.LazyVerticalStaggeredGrid
import androidx.compose.foundation.lazy.staggeredgrid.StaggeredGridCells
import androidx.compose.foundation.lazy.staggeredgrid.StaggeredGridItemSpan
import androidx.compose.foundation.lazy.staggeredgrid.items
import androidx.compose.foundation.lazy.staggeredgrid.rememberLazyStaggeredGridState
```

2. **Add pack manifest parameter** (optional -- for display names):
```kotlin
@Composable
public fun WidgetPicker(
  widgetRegistry: WidgetRegistry,
  entitlementManager: EntitlementManager,
  packManifests: Set<DashboardPackManifest> = emptySet(), // NEW: for display names
  onSelectWidget: (String) -> Unit,
  onDismiss: () -> Unit,
  modifier: Modifier = Modifier,
  onRevocationToast: ((String) -> Unit)? = null,
)
```

If adding a parameter is too disruptive to call sites, keep using `packId.replaceFirstChar { it.uppercase() }`
as the fallback and add a `resolvePackName` helper:
```kotlin
private fun resolvePackName(
  packId: String,
  manifests: Set<DashboardPackManifest>,
): String {
  return manifests.firstOrNull { it.packId == packId }?.displayName
    ?: packId.replaceFirstChar { it.uppercase() }
}
```

3. **Sort widgets within each pack**: Compact widgets first (aspectRatio <= 1.5 or null), then by
   priority descending, then alphabetically by displayName:
```kotlin
val sortedWidgetsByPack: ImmutableMap<String, List<WidgetRenderer>> =
  remember(allWidgets) {
    allWidgets
      .groupBy { it.typeId.substringBefore(':') }
      .mapValues { (_, widgets) ->
        widgets.sortedWith(
          compareBy<WidgetRenderer> { (it.aspectRatio ?: 1f) > 1.5f } // compact first
            .thenByDescending { it.priority }
            .thenBy { it.displayName }
        )
      }
      .toImmutableMap()
  }
```

4. **Replace the scrollable Column + FlowRow** with `LazyVerticalStaggeredGrid`. The grid goes
   directly inside the OverlayScaffold content lambda (no wrapping Column with verticalScroll):

```kotlin
OverlayScaffold(
  title = stringResource(R.string.widget_picker_title),
  overlayType = OverlayType.Hub,
  onClose = onDismiss,
  modifier = modifier.fillMaxSize(),
) {
  LazyVerticalStaggeredGrid(
    columns = StaggeredGridCells.Adaptive(minSize = 120.dp),
    contentPadding = PaddingValues(vertical = DashboardSpacing.ItemGap),
    horizontalArrangement = Arrangement.spacedBy(DashboardSpacing.ItemGap),
    verticalItemSpacing = DashboardSpacing.ItemGap,
    modifier = Modifier
      .fillMaxSize()
      .testTag("widget_picker_grid"),
  ) {
    sortedWidgetsByPack.forEach { (packId, widgets) ->
      // Pack header -- always spans full line
      item(
        key = "header_$packId",
        span = StaggeredGridItemSpan.FullLine,
      ) {
        Text(
          text = resolvePackName(packId, packManifests),
          style = DashboardTypography.sectionHeader,
          color = theme.secondaryTextColor,
          modifier = Modifier
            .padding(vertical = DashboardSpacing.InGroupGap)
            .testTag("pack_header_$packId"),
        )
      }

      // Widget cards -- wide widgets span full line
      items(
        items = widgets,
        key = { it.typeId },
        span = { widget ->
          if ((widget.aspectRatio ?: 1f) > 1.5f) {
            StaggeredGridItemSpan.FullLine
          } else {
            StaggeredGridItemSpan.SingleLane
          }
        },
      ) { widget ->
        WidgetPickerCard(
          widget = widget,
          entitlementManager = entitlementManager,
          theme = theme,
          onSelect = { typeId ->
            if (widget.isAccessible(entitlementManager::hasEntitlement)) {
              onSelectWidget(typeId)
            }
          },
        )
      }
    }
  }
}
```

5. **Update WidgetPickerCard** to compute preview scale from aspect ratio instead of hardcoded 0.5f:

Remove the `previewHeight: Dp` parameter. Instead, compute dimensions inside the card:

```kotlin
@Composable
private fun WidgetPickerCard(
  widget: WidgetRenderer,
  entitlementManager: EntitlementManager,
  theme: DashboardThemeDefinition,
  onSelect: (String) -> Unit,
  modifier: Modifier = Modifier,
) {
  val isAccessible = widget.isAccessible(entitlementManager::hasEntitlement)
  val shape = RoundedCornerShape(CardSize.MEDIUM.cornerRadius)
  val widgetAspectRatio = widget.aspectRatio ?: 1f

  Column(
    modifier = modifier
      .sizeIn(minHeight = 76.dp)
      .clip(shape)
      .border(1.dp, theme.widgetBorderColor.copy(alpha = 0.3f), shape)
      .clickable { onSelect(widget.typeId) }
      .padding(DashboardSpacing.InGroupGap)
      .testTag("widget_card_${widget.typeId}"),
    horizontalAlignment = Alignment.CenterHorizontally,
  ) {
    // Live preview area -- uses aspectRatio modifier now that we're NOT inside
    // a scrollable Column (staggered grid handles its own scrolling, so
    // intrinsic measurement from aspectRatio is safe here)
    Box(
      modifier = Modifier
        .fillMaxWidth()
        .aspectRatio(widgetAspectRatio.coerceIn(0.5f, 3f))
        .clip(RoundedCornerShape(CardSize.SMALL.cornerRadius))
        .background(theme.widgetBackgroundBrush, RoundedCornerShape(CardSize.SMALL.cornerRadius))
        .clipToBounds()
        .testTag("widget_preview_${widget.typeId}"),
      contentAlignment = Alignment.Center,
    ) {
      // Live widget preview -- scale computed to fit
      // Preview renders at natural size then scaled down to fit the preview box
      CompositionLocalProvider(LocalWidgetData provides WidgetData.Empty) {
        val previewScale = 0.45f // Slightly smaller than old 0.5f for better visual fit in adaptive grid
        Box(
          modifier = Modifier
            .graphicsLayer {
              scaleX = previewScale
              scaleY = previewScale
            },
          contentAlignment = Alignment.Center,
        ) {
          widget.Render(
            isEditMode = false,
            style = WidgetStyle.Default,
            settings = persistentMapOf(),
            modifier = Modifier,
          )
        }
      }

      // Lock icon overlay for gated widgets (centered, on top of preview)
      // ... (keep existing lock icon code unchanged) ...

      // Hardware requirement icon badge (bottom-end corner)
      // ... (keep existing HW badge code unchanged) ...
    }

    // Widget display name + description
    // ... (keep existing text code unchanged) ...
  }
}
```

**IMPORTANT**: The key insight is that `Modifier.aspectRatio()` is now safe because we are inside
`LazyVerticalStaggeredGrid` (which provides bounded constraints to each cell), NOT inside a
`Column.verticalScroll()` (which gave unbounded height, causing the 0-height issue from Phase 10).

6. **Remove `@OptIn(ExperimentalLayoutApi::class)`** from WidgetPicker (no longer using FlowRow).

7. **Remove `PREVIEW_ASPECT_RATIO` constant** at the bottom of the file (no longer needed -- each
   widget uses its own aspectRatio from WidgetSpec).

8. **Remove the `LocalConfiguration.current.screenWidthDp` computation** -- no longer needed since
   the staggered grid handles column sizing adaptively.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:compileDebugKotlin --console=plain 2>&1 | tail -5</automated>
  </verify>
  <done>
    - FlowRow replaced with LazyVerticalStaggeredGrid
    - StaggeredGridCells.Adaptive(minSize = 120.dp) for adaptive column count
    - Wide widgets (aspectRatio > 1.5) span StaggeredGridItemSpan.FullLine
    - Pack headers span FullLine
    - Widgets sorted: compact first, then by priority desc, then alphabetically
    - Preview scale no longer hardcoded 0.5f
    - Modifier.aspectRatio() used safely inside staggered grid cells
    - Scrollable Column wrapper removed
    - Lock icons, HW badges, description text, entitlement gating all preserved
    - Compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for adaptive layout logic</name>
  <files>
    android/feature/settings/src/test/kotlin/app/dqxn/android/feature/settings/WidgetPickerLayoutTest.kt
  </files>
  <action>
Create tests verifying the layout changes:

```kotlin
package app.dqxn.android.feature.settings

import com.google.common.truth.Truth.assertThat
import org.junit.jupiter.api.Test
import java.io.File

class WidgetPickerLayoutTest {

    private val projectDir = File(System.getProperty("user.dir"))

    @Test
    fun `uses LazyVerticalStaggeredGrid not FlowRow`() {
        val file = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
        )
        val content = file.readText()
        assertThat(content).contains("LazyVerticalStaggeredGrid")
        assertThat(content).doesNotContain("FlowRow")
        assertThat(content).contains("StaggeredGridCells.Adaptive")
        assertThat(content).contains("120.dp")
    }

    @Test
    fun `wide widgets span full line`() {
        val file = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
        )
        val content = file.readText()
        assertThat(content).contains("StaggeredGridItemSpan.FullLine")
        assertThat(content).contains("1.5f")
    }

    @Test
    fun `pack headers span full line`() {
        val file = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
        )
        val content = file.readText()
        // Pack header uses FullLine span
        assertThat(content).contains("header_")
        assertThat(content).contains("StaggeredGridItemSpan.FullLine")
    }

    @Test
    fun `no hardcoded PREVIEW_ASPECT_RATIO constant`() {
        val file = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
        )
        val content = file.readText()
        assertThat(content).doesNotContain("PREVIEW_ASPECT_RATIO")
    }

    @Test
    fun `widget sort order is compact first then priority then name`() {
        val file = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
        )
        val content = file.readText()
        assertThat(content).contains("sortedWith")
        assertThat(content).contains("priority")
        assertThat(content).contains("displayName")
    }

    @Test
    fun `preserves lock icon and hardware badge functionality`() {
        val file = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
        )
        val content = file.readText()
        assertThat(content).contains("widget_lock_")
        assertThat(content).contains("widget_hw_")
        assertThat(content).contains("HardwareRequirement")
    }

    @Test
    fun `no scrollable Column wrapper around grid`() {
        val file = File(
            projectDir,
            "feature/settings/src/main/kotlin/app/dqxn/android/feature/settings/WidgetPicker.kt"
        )
        val content = file.readText()
        // verticalScroll should not be used (grid handles its own scrolling)
        assertThat(content).doesNotContain("verticalScroll")
        assertThat(content).doesNotContain("rememberScrollState")
    }
}
```

Also update any existing WidgetPicker tests that reference FlowRow or the old layout structure.
  </action>
  <verify>
    <automated>cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetPickerLayoutTest" --console=plain 2>&1 | tail -10</automated>
  </verify>
  <done>
    - All 7 layout tests pass
    - LazyVerticalStaggeredGrid usage confirmed
    - Wide widget spanning confirmed
    - Pack header spanning confirmed
    - Sort order confirmed
    - Lock/HW badges preserved
    - No scrollable Column wrapper
  </done>
</task>

</tasks>

<verification>
1. `cd android && ./gradlew :feature:settings:compileDebugKotlin --console=plain` -- compiles
2. `cd android && ./gradlew :feature:settings:testDebugUnitTest --tests "*.WidgetPickerLayoutTest" --console=plain` -- all tests pass
3. `cd android && ./gradlew :feature:settings:testDebugUnitTest --console=plain` -- no regressions
4. `cd android && ./gradlew :feature:dashboard:compileDebugKotlin --console=plain` -- OverlayNavHost still compiles (call site may need update for new param)
</verification>

<success_criteria>
- LazyVerticalStaggeredGrid with Adaptive(120.dp) replaces FlowRow
- Wide widgets (aspectRatio > 1.5) span full line
- Compact widgets first, then priority desc, then alphabetical within each pack
- Pack headers span full line
- No hardcoded 0.5f scale or PREVIEW_ASPECT_RATIO constant
- Lock icons, HW badges, description text, entitlement gating all preserved
- No scrollable Column wrapper (grid scrolls directly)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-visual-interactive-parity/14-10-SUMMARY.md`
</output>
